import{dC as k,I as G,h as S,aG as B,l as A,db as Y,ai as Q,s as J,pR as L,hJ as x,cy as X,cG as Z,cH as K,cN as ee,cO as te,w as v,ct as U,cF as W,cz as se,dk as re,cV as ie,dV as ae,e9 as ne,ea as oe,cZ as le,eb as he,cX as de,ec as ce,cY as ue,dH as me,pO as pe,j as ye,aH as fe,pG as _e,pH as ve,b5 as we,pS as ge,H as Re,aw as Me,pT as xe,e as T,g as q,n as Te,bd as Ce}from"./index.f5fb6b4d.js";import{a as Ee}from"./mediaUtils.b14f7d96.js";import{W as Ve}from"./brushes.e5622ff7.js";import{I as $e}from"./Utils.cfa3e151.js";import{a as be}from"./WGLContainer.51623c6d.js";import{f as Se}from"./LayerView2D.6e98822d.js";import{u as qe}from"./LayerView.7cdf36e9.js";import"./normalizeUtilsSync.4bd14c75.js";import"./pixelUtils.96348421.js";import"./definitions.8fc39ccc.js";import"./ProgramTemplate.44984610.js";import"./MaterialKey.60c2c315.js";import"./alignmentUtils.63b4d661.js";import"./utils.8844d0fd.js";import"./number.08b65821.js";import"./StyleDefinition.5774ff26.js";import"./enums.05a6ea95.js";import"./GeometryUtils.8166011b.js";import"./Container.42f5d0eb.js";import"./EffectView.8649e1d9.js";class Ae extends k{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(G(()=>this.elementView.element.opacity,e=>this.opacity=e,S),G(()=>[this.elementView.coords],()=>{this.requestRender()},S),B(()=>this.elementView.element.loaded,()=>{const e=this.elementView.element;this.ready(),e.type==="video"&&A(e.content)&&this._handles.push(Y(e.content,"play",()=>this.requestRender()))},S)),t.element.load().catch(e=>{Q.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new J("element-load-error","Element cannot be displayed",{element:t,error:e}))})}destroy(){var t;this._handles.forEach(e=>e.remove()),(t=this.texture)==null||t.dispose(),this.texture=null}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:e}=t,s=this.elementView.element.content;if(A(s)){const i=s instanceof HTMLImageElement,a=s instanceof HTMLVideoElement,n=i?s.naturalWidth:a?s.videoWidth:s.width,h=i?s.naturalHeight:a?s.videoHeight:s.height;this.texture?a&&!s.paused&&(this.texture.setData(s),this.requestRender(),(L(e.gl)||x(n)&&x(h))&&this.texture.generateMipmap()):(this.texture=new X(e,{pixelFormat:Z.RGBA,dataType:K.UNSIGNED_BYTE,samplingMode:ee.LINEAR,wrapMode:te.CLAMP_TO_EDGE,width:n,height:h},s),(L(e.gl)||x(n)&&x(h))&&this.texture.generateMipmap(),a&&!s.paused&&this.requestRender())}super.beforeRender(t)}_createTransforms(){return null}updateDrawCoords(t,e){const s=this.elementView.coords;if(v(s))return;const[i,a,n,h]=s.rings[0],m=this._vertices,{x:o,y:l}=t,c=e!==0;c?m.set([a[0]-o,a[1]-l,i[0]-o,i[1]-l,n[0]-o,n[1]-l,h[0]-o,h[1]-l,h[0]-o,h[1]-l,a[0]+e-o,a[1]-l,a[0]+e-o,a[1]-l,i[0]+e-o,i[1]-l,n[0]+e-o,n[1]-l,h[0]+e-o,h[1]-l]):m.set([a[0]-o,a[1]-l,i[0]-o,i[1]-l,n[0]-o,n[1]-l,h[0]-o,h[1]-l]),this.isWrapAround=c}getVAO(t,e,s){if(v(this.elementView.coords))return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=U.createVertex(t,W.DYNAMIC_DRAW,i);const a=U.createVertex(t,W.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new se(t,s,e,{geometry:this._geometryVbo,tex:a})}return this._vao}}class De extends be{constructor(){super(...arguments),this._localOrigin=re(0,0),this._viewStateId=-1,this._dvsMat3=ie(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const e of this.children)e.beforeRender(t)}prepareRenderPasses(t){const e=t.registerRenderPass({name:"overlay",brushes:[Ve.overlay],target:()=>this.children,drawPhase:$e.MAP});return[...super.prepareRenderPasses(t),e]}_updateMatrices(t){const{state:e}=t,{id:s,size:i,pixelRatio:a,resolution:n,rotation:h,viewpoint:m,displayMat3:o}=e;if(this._viewStateId===s)return;const l=Math.PI/180*h,c=a*i[0],y=a*i[1],{x:w,y:C}=m.targetGeometry,E=ae(w,e.spatialReference);this._localOrigin.x=E,this._localOrigin.y=C;const g=n*c,f=n*y,d=ne(this._dvsMat3);oe(d,d,o),le(d,d,he(c/2,y/2)),de(d,d,ce(c/g,-y/f,1)),ue(d,d,-l),this._viewStateId=s}_updateOverlays(t,e){const{state:s}=t,{rotation:i,spatialReference:a,worldScreenWidth:n,size:h,viewpoint:m}=s,o=this._localOrigin;let l=0;if(a.isWrappable){const c=h[0],y=h[1],w=180/Math.PI*i,C=Math.abs(Math.cos(w)),E=Math.abs(Math.sin(w)),g=Math.round(c*C+y*E),[f,d]=me(a).valid,u=pe(a),{x:D,y:j}=m.targetGeometry,z=[D,j],V=[0,0];s.toScreen(V,z);const R=[0,0];let $;$=g>n?.5*n:.5*g;const I=Math.floor((D+.5*u)/u),F=f+I*u,N=d+I*u,b=[V[0]+$,0];s.toMap(R,b),R[0]>N&&(l=u),b[0]=V[0]-$,s.toMap(R,b),R[0]<F&&(l=-u);for(const M of e){const O=M.elementView.bounds;if(v(O))continue;const[P,,H]=O;P<f&&H>f?M.updateDrawCoords(o,u):H>d&&P<d?M.updateDrawCoords(o,-u):M.updateDrawCoords(o,l)}}else for(const c of e)c.updateDrawCoords(o,l)}}let p=class extends Se(qe){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new ye}attach(){this.handles.add(fe(()=>this.layer.source,"refresh",()=>{for(const r of this._tileStrategy.tiles)this._updateTile(r);this.requestUpdate()})),this._overlayContainer=new De,this.container.addChild(this._overlayContainer),this._fetchQueue=new _e({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(r,t)=>this._queryElements(r,t)}),this._tileStrategy=new ve({cachePolicy:"purge",resampling:!0,acquireTile:r=>this._acquireTile(r),releaseTile:r=>this._releaseTile(r),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear()}supportsSpatialReference(r){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(r){this._tileStrategy.update(r)}async hitTest(r,t){var i;const e=[],s=[r.x,r.y];for(const a of this.elements){const n=(i=we(a.georeference))==null?void 0:i.coords;A(n)&&ge(n.rings,s)&&e.push({type:"media",element:a,layer:this.layer,mapPoint:r})}return e.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){}_acquireTile(r){const t=new Ie(r.clone());return this._updateTile(t),t}_updateTile(r){this.updatingHandles.addPromise(this._fetchQueue.push(r.key).then(t=>{const[e,s]=r.setElements(t);this._acquireElements(r,e),this._releaseElements(r,s),this.requestUpdate()},t=>{Re(t)||Q.getLogger(this.declaredClass).error(t)}))}_releaseTile(r){this._fetchQueue.abort(r.key.id),r.elements&&this._releaseElements(r,r.elements),this.requestUpdate()}async _queryElements(r,t){const e=this.layer.source;if(v(e))return[];this.view.featuresTilingScheme.getTileBounds(_,r,!0);const s=new Me({xmin:_[0],ymin:_[1],xmax:_[2],ymax:_[3],spatialReference:this.view.spatialReference});return e.queryElements(s,t)}_acquireElements(r,t){const e=this.layer.source,s=this.view.spatialReference;if(!v(e))for(const i of t)xe(this._elementReferences,i.uid,()=>{const a=new Ee({element:i,spatialReference:s}),n=new Ae(a);return this._overlayContainer.addChild(n),this.elements.add(i),{tiles:new Set,projectedElement:a,overlay:n}}).tiles.add(r)}_releaseElements(r,t){for(const e of t){const s=this._elementReferences.get(e.uid);s.tiles.delete(r),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e))}}};T([q()],p.prototype,"_fetchQueue",void 0),T([q()],p.prototype,"layer",void 0),T([q({readOnly:!0})],p.prototype,"elements",void 0),p=T([Te("esri.views.2d.layers.MediaLayerView2D")],p);const _=Ce();class Ie{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const e=[],s=new Set(this.elements);this.elements=t;for(const i of t)s.has(i)?s.delete(i):e.push(i);return this.isReady=!0,[e,Array.from(s)]}}const tt=p;export{tt as default};
