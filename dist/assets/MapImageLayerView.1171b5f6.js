import{l as j,c2 as B,k0 as D,eY as Z,e as a,g as l,k1 as q,cd as z,aw as U,k as W,cb as Y,n as F,fJ as _,k2 as C,i as k,fW as H,eU as K,k3 as X,bS as ee,bJ as te,k4 as re,k5 as se,U as oe,jJ as ie,s as J,w as ae,ag as ne,g8 as V,jz as le,E as pe,b9 as ue}from"./index.586dfff9.js";import{c as ye}from"./ExportImageParameters.cf402f70.js";import{n as R}from"./floorFilterUtils.69500d62.js";import{i as ce}from"./sublayerUtils.ca79d148.js";import{d as me,s as de}from"./popupUtils.df63e0e6.js";const A=o=>o.spatialReference.wkid||JSON.stringify(o.spatialReference);function fe(o,t){const{dpi:r,gdbVersion:s,geometry:e,geometryPrecision:n,height:f,layerOption:p,mapExtent:i,maxAllowableOffset:m,returnFieldName:y,returnGeometry:d,returnUnformattedValues:g,returnZ:N,spatialReference:P,timeExtent:E,tolerance:u,width:v}=o.toJSON(),{dynamicLayers:w,layerDefs:h,layerIds:b}=he(o),O=t&&j(t.geometry)?t.geometry:null,x={geometryPrecision:n,maxAllowableOffset:m,returnFieldName:y,returnGeometry:d,returnUnformattedValues:g,returnZ:N,tolerance:u},$=O&&O.toJSON()||e;if(x.imageDisplay=`${v},${f},${r}`,s&&(x.gdbVersion=s),$&&(delete $.spatialReference,x.geometry=JSON.stringify($),x.geometryType=B($)),P?x.sr=P.wkid||JSON.stringify(P):$&&$.spatialReference?x.sr=A($):i&&i.spatialReference&&(x.sr=A(i)),x.time=E?[E.start,E.end].join(","):null,i){const{xmin:G,ymin:Q,xmax:T,ymax:L}=i;x.mapExtent=`${G},${Q},${T},${L}`}return h&&(x.layerDefs=h),w&&!h&&(x.dynamicLayers=w),x.layers=p==="popup"?"visible":p,b&&!w&&(x.layers+=`:${b.join(",")}`),x}function he(o){var P,E;const{mapExtent:t,floors:r,width:s,sublayers:e,layerIds:n,layerOption:f,gdbVersion:p}=o,i=(E=(P=e==null?void 0:e.find(u=>u.layer!=null))==null?void 0:P.layer)==null?void 0:E.serviceSublayers,m=f==="popup",y={},d=D({extent:t,width:s,spatialReference:t==null?void 0:t.spatialReference}),g=[],N=u=>{const v=d===0,w=u.minScale===0||d<=u.minScale,h=u.maxScale===0||d>=u.maxScale;if(u.visible&&(v||w&&h))if(u.sublayers)u.sublayers.forEach(N);else{if((n==null?void 0:n.includes(u.id))===!1||m&&(!u.popupTemplate||!u.popupEnabled))return;g.unshift(u)}};if(e==null||e.forEach(N),e&&!g.length)y.layerIds=[];else{const u=ce(g,i,p),v=g.map(w=>{const h=R(r,w);return w.toExportImageJSON(h)});if(u)y.dynamicLayers=JSON.stringify(v);else{if(e){let h=g.map(({id:b})=>b);n&&(h=h.filter(b=>n.includes(b))),y.layerIds=h}else n!=null&&n.length&&(y.layerIds=n);const w=ge(r,g);if(j(w)&&w.length){const h={};for(const b of w)b.definitionExpression&&(h[b.id]=b.definitionExpression);Object.keys(h).length&&(y.layerDefs=JSON.stringify(h))}}}return y}function ge(o,t){const r=!!(o!=null&&o.length),s=t.filter(e=>e.definitionExpression!=null||r&&e.floorInfo!=null);return s.length?s.map(e=>{const n=R(o,e),f=Z(n,e.definitionExpression);return{id:e.id,definitionExpression:f}}):null}var S;let c=S=class extends _{constructor(o){super(o),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(o){return C(S,o)}};a([l({type:Number,json:{write:!0}})],c.prototype,"dpi",void 0),a([l()],c.prototype,"floors",void 0),a([l({type:String,json:{write:!0}})],c.prototype,"gdbVersion",void 0),a([l({types:q,json:{read:z,write:!0}})],c.prototype,"geometry",void 0),a([l({type:Number,json:{write:!0}})],c.prototype,"geometryPrecision",void 0),a([l({type:Number,json:{write:!0}})],c.prototype,"height",void 0),a([l({type:[Number],json:{write:!0}})],c.prototype,"layerIds",void 0),a([l({type:["top","visible","all","popup"],json:{write:!0}})],c.prototype,"layerOption",void 0),a([l({type:U,json:{write:!0}})],c.prototype,"mapExtent",void 0),a([l({type:Number,json:{write:!0}})],c.prototype,"maxAllowableOffset",void 0),a([l({type:Boolean,json:{write:!0}})],c.prototype,"returnFieldName",void 0),a([l({type:Boolean,json:{write:!0}})],c.prototype,"returnGeometry",void 0),a([l({type:Boolean,json:{write:!0}})],c.prototype,"returnM",void 0),a([l({type:Boolean,json:{write:!0}})],c.prototype,"returnUnformattedValues",void 0),a([l({type:Boolean,json:{write:!0}})],c.prototype,"returnZ",void 0),a([l({type:W,json:{write:!0}})],c.prototype,"spatialReference",void 0),a([l()],c.prototype,"sublayers",void 0),a([l({type:Y,json:{write:!0}})],c.prototype,"timeExtent",void 0),a([l({type:Number,json:{write:!0}})],c.prototype,"tolerance",void 0),a([l({type:Number,json:{write:!0}})],c.prototype,"width",void 0),c=S=a([F("esri.rest.support.IdentifyParameters")],c);const M=c;let I=class extends _{constructor(o){super(o),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(o,t){return k.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(o,t){if(!o)return;const{attributes:r,geometry:s}=o;r&&(t.attributes={...r}),j(s)&&(t.geometry=s.toJSON(),t.geometryType=X.toJSON(s.type))}};a([l({type:String,json:{write:!0}})],I.prototype,"displayFieldName",void 0),a([l({type:k})],I.prototype,"feature",void 0),a([H("feature",["attributes","geometry"])],I.prototype,"readFeature",null),a([K("feature")],I.prototype,"writeFeature",null),a([l({type:Number,json:{write:!0}})],I.prototype,"layerId",void 0),a([l({type:String,json:{write:!0}})],I.prototype,"layerName",void 0),I=a([F("esri.rest.support.IdentifyResult")],I);const we=I;async function be(o,t,r){const s=(t=ve(t)).geometry?[t.geometry]:[],e=ee(o);return e.path+="/identify",te(s).then(n=>{const f=fe(t,{geometry:n&&n[0]}),p=re({...e.query,f:"json",...f}),i=se(p,r);return oe(e.path,i).then(xe).then(m=>Pe(m,t.sublayers))})}function xe(o){const t=o.data;t.results=t.results||[];const r={results:[]};return r.results=t.results.map(s=>we.fromJSON(s)),r}function ve(o){return o=M.from(o)}function Pe(o,t){if(!(t!=null&&t.length))return o;const r=new Map;function s(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(s)}t.forEach(s);for(const e of o.results)e.feature.sourceLayer=r.get(e.layerId);return o}const Oe=o=>{let t=class extends o{initialize(){this.exportImageParameters=new ye({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var r;return(r=this.exportImageParameters)==null||r.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(r,s){var f,p,i,m,y,d;const{layer:e}=this;if(!r)throw new J("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:e});const n=(i=(p=(f=this.layer.capabilities)==null?void 0:f.operations)==null?void 0:p.supportsQuery)!=null?i:!0;if(!(((d=(y=(m=this.layer.capabilities)==null?void 0:m.operations)==null?void 0:y.supportsIdentify)!=null?d:!0)&&this.layer.version>=10.5)&&!n)throw new J("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:e});return n?this._fetchPopupFeaturesUsingQueries(r,s):this._fetchPopupFeaturesUsingIdentify(r,s)}canResume(){var r;return!!super.canResume()&&!((r=this.timeExtent)!=null&&r.isEmpty)}async _fetchPopupFeaturesUsingIdentify(r,s){const e=await this._createIdentifyParameters(r,s);if(ae(e))return[];const{results:n}=await be(this.layer.parsedUrl,e);return n.map(f=>f.feature)}async _createIdentifyParameters(r,s){var E,u;const{floors:e,spatialReference:n,scale:f}=this.view,p=j(s)?s.event:null,i=await this._collectPopupProviders(this.layer.sublayers,f,s);if(!i.length)return null;await Promise.all(i.map(({sublayer:v})=>v.load().catch(()=>{})));const m=Math.min(ne("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((v,w)=>w.renderer?V({renderer:w.renderer,event:p}):v,2)),y=this.createFetchPopupFeaturesQueryGeometry(r,m),d=le(f,n),g=Math.round(y.width/d),N=new U({xmin:y.center.x-d*g,ymin:y.center.y-d*g,xmax:y.center.x+d*g,ymax:y.center.y+d*g,spatialReference:y.spatialReference}),P=((u=(E=this.layer.capabilities)==null?void 0:E.operations)==null?void 0:u.supportsQuery)===!1||await new Promise(v=>{let w=!1;Promise.all(i.map(async({popupTemplate:h})=>{if(h){const b=await this._loadArcadeModules(h);if(w)return;(b==null?void 0:b.arcadeUtils.hasGeometryOperations(h))&&(w=!0,v(!0))}})).finally(()=>v(!1))});return new M({floors:e,gdbVersion:this.layer.gdbVersion,geometry:r,height:g,layerOption:"popup",mapExtent:N,maxAllowableOffset:P?0:d,returnGeometry:!0,spatialReference:n,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:m,width:g})}async _fetchPopupFeaturesUsingQueries(r,s){const e=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,s),n=j(s)?s.event:null,f=e.map(async({sublayer:p,popupTemplate:i})=>{var N,P;await p.load().catch(()=>{});const m=p.createQuery(),y=V({renderer:p.renderer,event:n}),d=this.createFetchPopupFeaturesQueryGeometry(r,y);if(m.geometry=d,m.outFields=await me(p,i),"floors"in this.view){const E=(P=(N=this.view)==null?void 0:N.floors)==null?void 0:P.clone(),u=R(E,p);j(u)&&(m.where=m.where?`(${m.where}) AND (${u})`:u)}const g=await this._loadArcadeModules(i);return g&&g.arcadeUtils.hasGeometryOperations(i)||(m.maxAllowableOffset=d.width/y),(await p.queryFeatures(m)).features});return(await pe(f)).reduce((p,i)=>i.value?[...p,...i.value]:p,[]).filter(p=>p!=null)}async _collectPopupProviders(r,s,e){const n=[],f=async i=>{const m=i.minScale===0||s<=i.minScale,y=i.maxScale===0||s>=i.maxScale;if(i.visible&&m&&y){if(i.sublayers)i.sublayers.forEach(f);else if(i.popupEnabled){const d=de(i,{...e,defaultPopupTemplateEnabled:!1});j(d)&&n.unshift({sublayer:i,popupTemplate:d})}}},p=r.toArray().reverse().map(f);return await Promise.all(p),n}_loadArcadeModules(r){var s;if(((s=r.expressionInfos)==null?void 0:s.length)||Array.isArray(r.content)&&r.content.some(e=>e.type==="expression"))return ue()}};return a([l()],t.prototype,"exportImageParameters",void 0),a([l({readOnly:!0})],t.prototype,"exportImageVersion",null),a([l()],t.prototype,"layer",void 0),a([l()],t.prototype,"suspended",void 0),a([l(ie)],t.prototype,"timeExtent",void 0),t=a([F("esri.views.layers.MapImageLayerView")],t),t};export{Oe as x};
