import{bJ as Pt,no as Xe,nn as Ot,kS as De,nE as be,nF as qt,nG as ot,i_ as ie,i$ as Ht,iW as ct,nH as Ut,nI as dt,bg as ze,al as Pe,nJ as Ye,nK as Wt,nL as Ie,jw as yt,s as jt,cd as Gt,n2 as ht,$ as v,a0 as C,a1 as de,a2 as ut,am as Le,cq as Oe,dz as fe,dY as Jt,c_ as q,R as $,cO as Qt,dU as Xt,h as Ce,nM as Yt,nN as Zt,nO as U,ei as Kt,U as Ze,ew as ne,cz as ei,nP as ti,nQ as ii,nR as si,nS as ri,nb as li,nT as ai,nU as ni,nV as oi,nW as Ke,nX as ci,bc as di,n6 as yi,nY as hi,nZ as ui,r as Ee,n_ as pi,n$ as et,S as se,o0 as mi,a9 as fi,jx as xe,eN as c,o1 as he,o2 as gi,o3 as bi,o4 as vi,o5 as _i,o6 as Li,o7 as wi,o8 as tt,o9 as Te,oa as Si,y as O,eO as Ae,eL as ve,ob as Ii,eM as qe,oc as ge,od as Ci,oe as Ei,of as D,co as Ri,fE as $i}from"./index.52935b46.js";import{h as Vi}from"./EffectView.d573d8e0.js";import{c as zi}from"./ExportImageParameters.21510e73.js";import{o as xi}from"./rendererConversion.add823be.js";import{getSymbolLayerFill as Ti}from"./previewSymbol3D.955b997c.js";import"./floorFilterUtils.69500d62.js";import"./sublayerUtils.6d16b5d3.js";import"./webStyleSymbolUtils.20127335.js";import"./devEnvironmentUtils.8c6e6b72.js";const Ai=(e,t)=>{const i=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t!=null&&t.levels?t.levels[i]:null};function ki(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const i=e.visualVariables.find(s=>s.type==="size"),r=Ai(t,i);return r?new Pt({field:i.field,minSize:r[2].size,minDataValue:r[2].value,maxSize:r[3].size,maxDataValue:r[3].value}):null}const it={HH:315,HL:45,LL:135,LH:225},Fi={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function Mi(e){if(!e)return;const{type:t}=e;if(t.includes("3d"))return Ti(e.symbolLayers.getItemAt(0));if(t==="simple-line"){const i=Xe(e);return i&&i.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const i=Xe(e);return i&&i.color}return Ot(e)}function Bi(e,t){const i=t.HH.label,r=t.LL.label,s=t.HL.label,l=t.LH.label;switch(e){case"HH":default:return{top:i,bottom:r,left:s,right:l};case"HL":return{top:s,bottom:l,left:r,right:i};case"LL":return{top:r,bottom:i,left:l,right:s};case"LH":return{top:l,bottom:s,left:i,right:r}}}function Ni(e){const{focus:t,infos:i,numClasses:r}=e,s=Fi[r],l={};i.forEach(n=>{l[n.value]={label:n.label,fill:Mi(n.symbol)}});const a=[];for(let n=0;n<r;n++){const o=[];for(let d=0;d<r;d++){const y=l[s[n][d]];o.push(y.fill)}a.push(o)}return{type:"relationship-ramp",numClasses:r,focus:t,colors:a,labels:Bi(t,l),rotation:pt(t)}}function pt(e){let t=it[e];return e&&t==null&&(t=it.HH),t||0}const ke=30,Fe=12,mt=[255,255,255],ft=[200,200,200],te=[128,128,128],Di=20,Pi=5;function Oi(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function qi(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function Hi(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function Ui(e){return e.declaredClass==="esri.symbols.TextSymbol"}function Wi(e,t){const i=e.length-1;return e.map((r,s)=>Wt(r,s,i,t))}async function ji(e,t,i,r,s,l){const a=t.legendOptions,n=a&&a.customValues,o=await Qi(e,i),d=!!o,y=!!n,p=t.minSize!=null&&t.maxSize!=null,h=t.stops&&t.stops.length>1,m=!!t.target;if(!d||!y&&!(p||h&&!m))return;const f=De(o);let _=null,g=null,u=null;g=f&&!h?be([t.minDataValue,t.maxDataValue]):n||await Yi(t,o,r,s);const w=e==null?void 0:e.authoringInfo,S=(w==null?void 0:w.type)==="univariate-color-size",I=S&&(w==null?void 0:w.univariateTheme)==="above-and-below";if(!g&&h&&(g=t.stops.map(V=>V.value),_=t.stops.some(V=>!!V.label),e.type==="flow"&&(g=be(g)),_&&(u=t.stops.map(V=>V.label))),f&&(g==null?void 0:g.length)>2&&!I&&(g=[g[0],g[g.length-1]]),!g)return null;S&&(g==null?void 0:g.length)!==5&&(g=vt({minSize:g[0],maxSize:g[g.length-1]}));const E=f?Gi(e,g):null,z=qt(o),k=_?null:Wi(g,l);return(await Promise.all(g.map(async(V,M)=>{const F=f?E[M]:await Z(t,o,V,r,s);return{value:V,symbol:es(I&&e.type==="class-breaks"?Ji(e,M):o,F),label:_?u[M]:k[M],size:F,outlineSize:z}}))).reverse()}function Gi(e,t){const i=e==null?void 0:e.authoringInfo,r=(i==null?void 0:i.type)==="univariate-color-size";let s=[Fe,ke];if(r){const l=t[0],a=t[t.length-1],n=Fe,o=ke;s=t.map(d=>n+(d-l)/(a-l)*(o-n))}return r&&(i==null?void 0:i.univariateTheme)==="below"&&s.reverse(),s}function Ji(e,t){const i=e.classBreakInfos,r=i.length,s=r<2||!(t>=2)?i[0].symbol.clone():i[r-1].symbol.clone();return e.visualVariables.some(l=>l.type==="color")&&(s.type.includes("3d")?gt(s):bt(s)),s}async function Qi(e,t){var s;if(e.type==="flow")return ot(e,t);if(e.type==="pie-chart")return new ie({color:null,outline:(s=e.outline)!=null&&s.width?e.outline:new Ht});let i=null,r=null;if(e.type==="simple")i=e.symbol;else if(e.type==="class-breaks"){const l=e.classBreakInfos;i=l&&l[0]&&l[0].symbol,r=l.length>1}else if(e.type==="unique-value"){const l=e.uniqueValueInfos;i=l&&l[0]&&l[0].symbol,r=l.length>1}return!i||Xi(i)?null:(i=i.clone(),(t||r)&&(i.type.includes("3d")?gt(i):bt(i)),i)}function Xi(e){return e?ct(e)?!!e.symbolLayers&&e.symbolLayers.some(t=>t&&t.type==="fill"):e.type.includes("fill"):!1}function gt(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:te}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource&&t.resource.href?t.material={color:ft}:(t.material={color:mt},t.outline={color:te,size:1.5})})}function bt(e){var i,r;const t=Ut();e.type==="cim"?dt(e,new ze(ft)):e.type.includes("line")?e.color=te:(e.color=t?te:mt,e.type==="simple-marker"&&(e.outline?((r=(i=e.outline)==null?void 0:i.color)==null?void 0:r.toHex())==="#ffffff"&&(e.outline.color=te):e.outline={color:te,width:1.5}))}async function Yi(e,t,i,r){const s=(await Pe(()=>import("./index.52935b46.js").then(n=>n.qm),["assets/index.52935b46.js","assets/index.be38f7b7.css"])).getSizeRangeAtScale(e,i,r),l=s&&vt(s);if(!s&&!l)return;let a=l.map(n=>Zi(n,e,s));a=be(a);for(let n=1;n<a.length-1;n++){const o=await Ki(e,t,a[n],a[n-1],i,r);o&&(a[n]=o[0],l[n]=o[1])}return a}function vt(e){const t=e.minSize,i=e.maxSize,r=Pi,s=(i-t)/(r-1),l=[];for(let a=0;a<r;a++)l.push(t+s*a);return l}function Zi(e,t,i){const r=i.minSize,s=i.maxSize,l=t.minDataValue,a=t.maxDataValue;let n=null;return e<=r?n=l:e>=s?n=a:n=(e-r)/(s-r)*(a-l)+l,n}async function Ki(e,t,i,r,s,l){const a=await Z(e,t,i,s,l),n=await Z(e,t,r,s,l),o=Ye(i),d=o.fractional,y=Di;let p=o.integer,h=null,m=null;i>0&&i<1&&(h=10**d,p=Ye(i*=h).integer);for(let f=p-1;f>=0;f--){const _=10**f;let g=Math.floor(i/_)*_,u=Math.ceil(i/_)*_;h!=null&&(g/=h,u/=h);let w=(g+u)/2;[,w]=be([g,w,u],{indexes:[1]});const S=await Z(e,t,g,s,l),I=await Z(e,t,u,s,l),E=await Z(e,t,w,s,l),z=Ie(a,S,n,null),k=Ie(a,I,n,null),V=Ie(a,E,n,null);let M=z.previous<=y,F=k.previous<=y;if(M&&F&&(z.previous<=k.previous?(M=!0,F=!1):(F=!0,M=!1)),M?m=[g,S]:F?m=[u,I]:V.previous<=y&&(m=[w,E]),m)break}return m}async function Z(e,t,i,r,s){const{getSize:l}=await Pe(()=>import("./index.52935b46.js").then(a=>a.qm),["assets/index.52935b46.js","assets/index.be38f7b7.css"]);return l(e,i,{scale:r,view:s,shape:t.type==="simple-marker"?t.style:null})}function es(e,t){const i=e.clone();if(ct(i))De(i)||i.symbolLayers.forEach(r=>{r.type!=="fill"&&(r.size=t)});else if(Oi(i))i.size=t;else if(qi(i)){const r=i.width,s=i.height;i.height=t,i.width=t*(r/s)}else Hi(i)?i.width=t:Ui(i)&&i.font&&(i.font.size=t);return i}function ts(e){const i=Math.floor(Math.log10(Math.abs(e)))+1,r=i<4||i>6?4:i,s=1e6,l=Math.abs(e)>=s?"compact":"standard";return yt(e,{notation:l,minimumSignificantDigits:2,maximumSignificantDigits:r})}const P=jt.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),is="https://utility.arcgis.com/sharing/tools/legend",ss="esri.layers.ImageryLayer",rs="esri.layers.ImageryTileLayer",ls="esri.layers.WCSLayer",ue=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,as=new Gt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),st={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},pe=new ie({size:6,outline:{color:[128,128,128,.5],width:.5}}),ns=new ht({style:"solid"});function Me(e){return e.type==="flow"}function _t(e){return e.type==="vector-field"}function Lt(e){return e.type==="raster-colormap"}function wt(e){return e.type==="raster-stretch"}function St(e){return e.type==="raster-shaded-relief"}function K(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function ee(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function Be(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function It(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function os(e){return He(e)||Ue(e)||We(e)||cs(e)}function cs(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function He(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function Ue(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function We(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Ct(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function Et(e){return e.declaredClass==="esri.renderers.PieChartRenderer"}function ds(e,t){return K(e)||ee(e)||Be(e)||It(e)||Ct(e)||Et(e)?t.type==="2d"||xi(e):wt(e)||Lt(e)||St(e)||He(e)||Ue(e)||We(e)||_t(e)||Me(e)}function rt(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function ys(e){return e.declaredClass==="esri.layers.VoxelLayer"}function hs(e){return e.declaredClass==="esri.layers.WMSLayer"}function us(e){return e.declaredClass==="esri.layers.WMTSLayer"}function lt(e){return e.declaredClass==="esri.layers.MapImageLayer"}function ps(e){return e.declaredClass==="esri.layers.TileLayer"}function ms(e){return e.declaredClass==="esri.layers.FeatureLayer"}function oe(e){return e.declaredClass===ss}function Re(e){return e.declaredClass===rs}function fs(e){return e.declaredClass===ls}function gs(e){return e.type==="stretch-ramp"}function bs(e){var t;return((t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo))==null?void 0:t.type)==="univariate-color-size"}function vs(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"&&(t==null?void 0:t.univariateTheme)==="above-and-below"}const _s=new ie({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let J={},x=class extends ut{constructor(e){super(e),this._handles=new Le,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new Oe,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([fe(()=>this.children,"change",t=>{const{added:i,removed:r}=t,s=this._handles;i.forEach(l=>{const a=`activeLayerInfo-ready-watcher-${l.layer.uid}`;s.add($(()=>l.ready,e,se),a)}),r.forEach(l=>s.remove(l.layer.uid)),e()})]),this.keepCacheOnDestroy||(J={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(J=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new Vi,t.effect=e.effect,t.end(),t.scale=this.scale),t}get opacity(){var s;const e=this.layer.opacity,t=(s=this.parent)==null?void 0:s.opacity,i=this.layer.parent,r=i&&"uid"in i?this._getParentLayerOpacity(i):null;return t!=null?t*e:r!=null?r*e:e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if(e.featureReduction.type==="cluster")return!0;if(e.featureReduction.type==="binning"&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,i=>{if(ms(i))return this._getRendererLegendElements(i.renderer,{title:i.title});if(i.featureSet&&i.featureSet.features.length){const r=i.layerDefinition,s=r&&r.drawingInfo,l=s&&Jt(s.renderer),a=as.read(r.geometryType);return l?this._getRendererLegendElements(l,{title:i.name,geometryType:a}):(P.warn("drawingInfo not available!"),null)}return null});try{const i=[];await q(t).then(r=>{r.forEach(({value:s})=>s&&i.push(...s))}),this.legendElements=i,this.notifyChange("ready")}catch(i){P.warn("error while building legend for layer!",i)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){P.warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){var t,i;const e=this.layer;if(ys(e))this._constructLegendElementsForVoxellayer();else if(us(e))this._constructLegendElementsForWMTSlayer();else if(hs(e))await this._constructLegendElementsForWMSSublayers();else if(rt(e))await this._constructLegendElementsForBuildingSceneLayer();else if(lt(e)||ps(e)||rt(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let r="default";oe(e)&&(r=(((t=e==null?void 0:e.renderingRule)==null?void 0:t.functionName)||"default")+"_"+((i=e.bandIds)!=null&&i.length?e.bandIds.join(""):"###")),await this._getLegendLayers(`${e.uid}-${r}`).then(async s=>{this.legendElements=[],this.notifyChange("ready");const l=s.map(async a=>{if(oe(e)||Re(e)){const o=$(()=>["renderingRule"in e&&e.renderingRule,e.bandIds],()=>Qt(async()=>{J.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this._handles.add(o,"imageryLayers-watcher")}const n=this._generateSymbolTableElementForLegendLayer(a);n&&n.infos.length&&(oe(e)&&(n.title=e.title),this.legendElements.push(n)),this.notifyChange("ready")});await q(l)}).catch(s=>{P.warn("Request to server for legend has failed!",s)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,i=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!i&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await Xt(()=>!t.updating);const r=i?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return r.geometry=this.view.extent,(i?"queryFeatureCount"in t&&await t.queryFeatureCount(r):"queryFeatureCount"in e&&await e.queryFeatureCount(r))!==0}_getParentLayerOpacity(e){let t=1;const i=e.parent;return i&&"uid"in i&&(t=this._getParentLayerOpacity(i)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some(t=>t.ready)}_isRendererScaleDriven(e){if(e.type==="dot-density")return!0;const t="valueExpression"in e&&e.valueExpression;if(ue.test(t))return!0;const i="visualVariables"in e&&e.visualVariables;return!!i&&i.some(r=>this._isScaleDrivenSizeVariable(r))}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,i=t.minSize,r=t.maxSize;return typeof i=="object"&&i?this._isScaleDrivenSizeVariable(i):typeof r=="object"&&r?this._isScaleDrivenSizeVariable(r):!!t.expression||ue.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(i=>this._isLayerScaleDriven(i));const t=e.parent;if(e.loaded===!1&&t&&lt(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const i of t.sourceJSON.layers)if(i.id===e.source.mapLayerId&&(i.minScale>0||i.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxellayer(){var l;this.legendElements=[],this._handles.remove("voxel-style-watcher");const e=this.layer;this._handles.add($(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");const t=Ce(e.getVariableStyle(null)),i=[];if(t){if((l=t.uniqueValues)!=null&&l.length){const a=[];t.uniqueValues.forEach(n=>{n.enabled&&a.push({label:n.label||`${n.value}`,value:n.value,symbol:new ht({color:n.color,outline:null})})}),a.length&&i.push({type:"symbol-table",title:t.label,infos:a})}else if(t.transferFunction){const{colorStops:a,stretchRange:n}=t.transferFunction,o=a.toArray().reverse(),d=n.map((p,h)=>`${h===0?Yt:Zt} ${ts(p)}`).reverse(),y=o.map(p=>({color:p.color,value:null,label:null}));y[0].label=d[0],y[y.length-1].label=d[1],i.push({type:"color-ramp",title:t.label,infos:y,preview:U(o.map(p=>p.color))})}}const r=e.opacity,s=i.reduce((a,n)=>a.concat(this._getAllInfos(n)),[]).filter(a=>!!(a!=null&&a.symbol)).map(a=>this._getSymbolPreview(a,r));await q(s),this.legendElements=i,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add($(()=>{const{layer:t}=this;return t&&"activeLayer"in t&&t.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some(i=>e.styleId===i.id&&(t=i.legendUrl,!0)),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add($(()=>{const{layer:i}=this;return i&&"sublayers"in i&&i.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const i=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const r=e.toArray();for(const s of r){const l=$(()=>[s.title,s.visible,s.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this._handles.add(l,"wms-sublayers-watcher"),!this.respectLayerVisibility||s.visible&&s.legendEnabled){const a=await this._generateSymbolTableElementForWMSSublayer(s,t);a&&a.infos.length&&i.unshift(a)}}return i}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const i=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(r=>r);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var a;let i=e.legendUrl;if(!i)return;const r={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(i=Kt(i,t));let s=null;const l=(a=e.layer)==null?void 0:a.opacity;try{s=(await Ze(i,{responseType:"image"})).data,s&&(s.style.opacity=l)}catch{}return r.infos.push({src:i,preview:s,opacity:l}),r}_getLegendLayers(e,t){const i=J&&J[e];return i?Promise.resolve(i):this._legendRequest(t).then(r=>{const s=r.layers;return J[e]=s,s})}_legendRequest(e){const t=this.layer;let i={f:"json",dynamicLayers:e};if(oe(t)){const s=t.exportImageServiceParameters.renderingRule;if(s&&(i.renderingRule=JSON.stringify(s.rasterFunctionDefinition||s.toJSON())),t.bandIds&&(i.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:l,viewId:a,customParameters:n}=t;i={raster:l,viewId:a,...i,...n}}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const s=r.indexOf("?");s>-1?r=r.substring(0,s)+"/legend"+r.substring(s):r+="/legend"}else{const s=r.toLowerCase().indexOf("/rest/"),l=r.substring(0,s)+r.substring(s+5,r.length);r=is+"?soapUrl="+encodeURI(l)+"&returnbytes=true"}return Ze(r,{query:i}).then(s=>s.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add($(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){P.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let i=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const r=e.toArray();for(const s of r){const l=$(()=>["renderer"in s&&s.renderer,s.opacity,s.title,s.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this._handles.add(l,"sublayers-watcher"),!this.respectLayerVisibility||s.visible){const a=s&&s.opacity!=null?s.opacity:null,n=a!=null?a*t:t;if(s.type==="building-group"){const o={type:"symbol-table",title:s.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(s.sublayers,n);o.infos.push(...d),i=[o,...i]}else s.renderer&&(i=[...await this._getRendererLegendElements(s.renderer,{title:s.title,opacity:n,sublayer:s}),...i])}}return i.filter(s=>!!s&&(!("infos"in s)||s.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add($(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){P.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForSublayers(e,t,i){const r=this.layer;let s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let l=e.toArray();!i&&this.sublayerIds&&this.sublayerIds.length&&(l=this.sublayerIds.map(a=>r.findSublayerById(a)).filter(Boolean));for(const a of l){const n=$(()=>[a.renderer,a.opacity,a.title,a.visible,a.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this._handles.add(n,"sublayers-watcher"),!this.respectLayerVisibility||a.visible&&a.legendEnabled&&this._isSublayerInScale(a)){const o=a&&a.opacity!=null?a.opacity:null,d=o!=null?o*t:t;if(a.renderer&&!a.sublayers&&a.originIdOf("renderer")>ne.SERVICE)await a.load(),s=[...await this._getRendererLegendElements(a.renderer,{title:a.title,opacity:d,sublayer:a}),...s];else{const y=await this._generateSymbolTableElementForSublayer(a,d,i);y&&s.unshift(y)}}}return s.filter(a=>!!a&&(!("infos"in a)||a.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,i){if(!i){i=new Map;const s=this.layer,l=e.source;let a=null;if(!(!l||l.type==="map-layer"&&l.mapLayerId===e.id&&(!l.gdbVersion||l.gdbVersion===("gdbVersion"in s&&s.gdbVersion)))||e.originIdOf("renderer")>ne.SERVICE||e.originIdOf("labelingInfo")>ne.SERVICE||e.originIdOf("labelsVisible")>ne.SERVICE){const o=new zi({layer:this.layer});a=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const n=a||`${s.uid}-default`;(await this._getLegendLayers(n,a)).forEach(o=>i.set(o.layerId,o))}const r=i.get(e.id);if((!r||(r==null?void 0:r.subLayerIds)&&r.defaultVisibility)&&e.sublayers){const s=await this._generateLegendElementsForSublayers(e.sublayers,t,i);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendLayer(r,e,t)}_generateSymbolTableElementForLegendLayer(e,t,i){var n;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const r=t==null?void 0:t.renderer;let s=(t==null?void 0:t.title)||e.layerName;if(r&&(!t||(t==null?void 0:t.originIdOf("renderer"))>ne.SERVICE)){const o=(t==null?void 0:t.title)||this._getRendererTitle(r,t);o&&(s&&typeof o!="string"&&"title"in o&&(o.title=s),s=o)}const l={type:"symbol-table",title:s,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return((n=e.legendGroups)==null?void 0:n.length)>0?e.legendGroups.forEach(o=>{var y;const d={type:"symbol-table",title:o.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter(p=>p.groupId===o.id),e.layerId,i)};((y=d.infos)==null?void 0:y.length)>0&&l.infos.push(d)}):l.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,i),l.infos.length>0?l:null}_generateSymbolTableElementInfosForLegendLayer(e,t,i){return e.map(r=>{let s=r.url;if(r.imageData&&r.imageData.length>0)s=`data:image/png;base64,${r.imageData}`;else{if(s.indexOf("http")===0)return null;s=ei(`${this.layer.url}/${t}/images/${s}`)}return{label:r.label,src:s,opacity:i==null?this.opacity:i,width:r.width,height:r.height}}).filter(r=>!!r)}_isSublayerInScale(e){const t=e.minScale||0,i=e.maxScale||0;return!(t>0&&t<this.scale||i>this.scale)}_isLegendLayerInScale(e,t){const i=t||this.layer;let r=null,s=null,l=!0;return!i.minScale&&i.minScale!==0||!i.maxScale&&i.maxScale!==0?(e.minScale===0&&i.tileInfo&&(r=i.tileInfo.lods[0].scale),e.maxScale===0&&i.tileInfo&&(s=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(r=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,s=Math.max(i.maxScale,e.maxScale)),(r>0&&r<this.scale||s>this.scale)&&(l=!1),l}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||e.length===0)return e;const i=t.renderer,r=e.some(a=>a.values);let s=null,l=null;return r&&e.some((a,n)=>(a.values||(s=n,l=a,l.label||(l.label="others")),l!=null)),i?i.type==="unique-value"?l&&(e.splice(s,1),e.push(l)):i.type==="class-breaks"&&(l&&e.splice(s,1),e.reverse(),l&&e.push(l)):l&&(e.splice(s,1),e.push(l)),e}async _getRendererLegendElements(e,t={}){return ds(e,this.view)?os(e)?this._constructPointCloudRendererLegendElements(e,t):Ct(e)?this._constructDotDensityRendererLegendElements(e):Et(e)?this._constructPieChartRendererLegendElements(e):this._constructRendererLegendElements(e,t):(P.warn(`Renderer of type '${e.type}' not supported!`),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const i=t.title,r=[];let s=null,l=null;if(He(e))s={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(n=>{s.infos.unshift({label:n.label||n.minValue+" - "+n.maxValue,value:[n.minValue,n.maxValue],symbol:this._getAppliedCloneSymbol(pe,n.color)})});else if(Ue(e)){const n=e.stops;let o=null;if(n.length&&(n.length===1&&(o=n[0].color),!o)){const y=n[0].value,p=n[n.length-1].value;y!=null&&p!=null&&(o=ti(y+(p-y)/2,n))}s={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(pe,o||pe.color)}]};const d=ii(e.stops);l={type:"color-ramp",title:i||this._getPointCloudRendererTitle(e),infos:d,preview:U(d.map(y=>y.color))}}else We(e)&&(s={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach(n=>{s.infos.push({label:n.label||n.values.join(", "),value:n.values.join(", "),symbol:this._getAppliedCloneSymbol(pe,n.color)})}));s&&s.infos.length&&r.push(s),l&&l.infos.length&&r.push(l);const a=r.reduce((n,o)=>n.concat(o.infos),[]).filter(n=>!!n.symbol).map(n=>this._getSymbolPreview(n,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return q(a).then(()=>r)}_getElementInfoForDotDensity(e,t){var h;const{backgroundColor:i,outline:r,dotSize:s}=e,l=(h=this.effectList)==null?void 0:h.effects.map(m=>m.toJSON()),a=si(l),n=s+"-"+t+"-"+i+"-"+(r&&JSON.stringify(r.toJSON()))+"-"+a,o=this._dotDensityUrlCache,d=o.has(n)?o.get(n):ri(e,t);o.set(n,d);const y={shape:{type:"image",x:0,y:0,width:d.width,height:d.height,src:d.src},fill:null,stroke:null,offset:[0,0]},p=li([[y]],[d.width,d.height],{effectView:this.effectList});return{opacity:1,src:d.src,preview:p,width:d.width,height:d.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),i=e.legendOptions&&e.legendOptions.unit,r={type:"symbol-table",title:{value:t&&Math.round(t),unit:i||""},infos:[]};return e.attributes.forEach(s=>{const l=this._getElementInfoForDotDensity(e,s.color);l.label=s.label||s.valueExpressionTitle||s.field,r.infos.push(l)}),Promise.resolve([r])}async _constructPieChartRendererLegendElements(e){var o,d,y,p;const t=this.layer.opacity,i=[],r="Others",s=e.outline;e.attributes.forEach(h=>{const m=new ie({color:h.color,outline:s}),f=h.label||h.valueExpressionTitle||h.field;i.push({label:f,symbol:m})});const l=i.length?[...i]:[];if(((o=e.othersCategory)==null?void 0:o.color)&&((d=e.othersCategory)==null?void 0:d.threshold)!==0){const h=new ie({color:e.othersCategory.color,outline:s});i.push({label:e.othersCategory.label||r,symbol:h})}if((y=e.defaultColor)!=null&&y.a){const h=new ie({color:e.defaultColor,outline:s});i.push({label:e.defaultLabel,symbol:h})}const a=await this._getVisualVariableLegendElements(e,this.layer)||[];if(i.length){a.unshift({type:"symbol-table",title:null,infos:i});const h=l.filter(f=>f.label!==r).map(f=>f.symbol.color).filter(Boolean),m=ai(h,{holePercentage:e.holePercentage,backgroundColor:(p=e.backgroundFillSymbol)==null?void 0:p.color,effectList:this.effectList,outline:s});a.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:i,preview:m})}const n=a.reduce((h,m)=>h.concat(this._getAllInfos(m)),[]).filter(h=>!!(h!=null&&h.symbol)&&!(h!=null&&h.preview)).map(h=>this._getSymbolPreview(h,t,{effectList:this.effectList}));return await q(n),a}async _constructRendererLegendElements(e,t={}){var g;const{title:i,sublayer:r}=t,s=r||this.layer;let l=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const a=await this._getVisualVariableLegendElements(l,s)||[],n={type:"symbol-table",title:i||this._getRendererTitle(l,s),infos:[]};let o=null,d=!1;const y=new Set;if(Me(l)&&!this._hasSizeRamp){const u=await ot(l);n.infos.push({label:null,symbol:u})}else if(bs(l)){let u=i;const w=vs(l)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",S=a.findIndex(V=>V.type==="color-ramp"),I=S!==-1?a.splice(S,1)[0]:null,E=a.findIndex(V=>V.type==="size-ramp"),z=E!==-1?a.splice(E,1)[0]:null,k=[];I&&(u=I.title,k.push(I)),z&&(u=z.title,k.push(z)),k.length>0&&a.push({type:w,title:u,infos:k})}else if(It(l)){const u=ni(l);a.push({type:"heatmap-ramp",title:i||((g=l.legendOptions)==null?void 0:g.title),infos:u,preview:U(u.map(w=>w.color),{effectList:this.effectList})})}else if(Be(l)){const u=l&&l.authoringInfo;if(u&&u.type==="relationship"){const{focus:w,numClasses:S,field1:I,field2:E}=u;if(S&&I&&E){const z=[I,E];let k=pt(w)||0;for(const M of z){const{field:F,normalizationField:ye,label:j}=M,Se=j||{field:this._getFieldAlias(F,s),normField:ye&&this._getFieldAlias(ye,s)},G=_s.clone();G.angle=k,n.infos.push({label:Se,symbol:G}),y.add(G),k+=90}const V=Ni({focus:w,numClasses:S,infos:l.uniqueValueInfos});a.unshift(V)}}else{const w=l.field;l.uniqueValueInfos.forEach(S=>{S.symbol&&n.infos.push({label:S.label||this._getDomainName(w,S.value,s)||S.value,value:S.value,symbol:S.symbol})})}l.defaultSymbol&&(n.infos.push({label:l.defaultLabel||"others",symbol:l.defaultSymbol}),d=!0)}else if(ee(l))o=this._isUnclassedRenderer(l),(!o||!this._hasSizeRamp)&&(l.classBreakInfos.forEach(u=>{u.symbol&&n.infos.unshift({label:u.label||(o?null:u.minValue+" - "+u.maxValue),value:[u.minValue,u.maxValue],symbol:u.symbol})}),o&&(n.title=null),this._updateInfosforClassedSizeRenderer(l,n.infos)),l.defaultSymbol&&!o&&(n.infos.push({label:l.defaultLabel||"others",symbol:l.defaultSymbol}),d=!0);else if(wt(l))if(Re(this.layer)||fs(this.layer)){const u=this._constructTileImageryStretchRendererElements(l);gs(u)?a.push(u):n.infos=u}else{const u=this.layer;let w,S;l.statistics&&l.statistics.length&&(w=l.statistics[0].min!=null?l.statistics[0].min:l.statistics[0][0],S=l.statistics[0].max!=null?l.statistics[0].max:l.statistics[0][1]);let I=[];const E=Ce(u.renderingRule?await u.generateRasterInfo(u.renderingRule):u.serviceRasterInfo),z=E.keyProperties.BandProperties,k=st[u.rasterInfo.pixelType.toLowerCase()];E.bandCount===1||u.bandIds&&u.bandIds.length===1?(w=w!=null?w:E.statistics?E.statistics[u.bandIds[0]].min:k[0],S=S!=null?S:E.statistics?E.statistics[u.bandIds[0]].max:k[1],w||S?a.push(this._getStretchLegendElements(l,{min:w,max:S})):this._getServerSideLegend()):E.bandCount>=3?z&&z.length>=E.bandCount?u.bandIds&&u.bandIds.length===3?(I=u.bandIds.map(V=>z[V].BandName),n.infos=this._createSymbolTableElementMultiBand(I)):u.format==="lerc"?(I=[0,1,2].map(V=>z[V].BandName),n.infos=this._createSymbolTableElementMultiBand(I)):this._getServerSideLegend():u.format==="lerc"?(I=["band1","band2","band3"],n.infos=this._createSymbolTableElementMultiBand(I)):this._getServerSideLegend():this._getServerSideLegend()}else if(Lt(l))l.colormapInfos.forEach(u=>{n.infos.push({label:u.label,value:u.value,symbol:this._getAppliedCloneSymbol(ns,u.color)})});else if(K(l)){let u=l.symbol;switch(t.geometryType){case"point":u="pointSymbol"in s&&s.pointSymbol;break;case"polyline":u="lineSymbol"in s&&s.lineSymbol;break;case"polygon":u="polygonSymbol"in s&&s.polygonSymbol}l.symbol&&!this._hasSizeRamp&&n.infos.push({label:l.label,symbol:u})}else if(_t(l)){l.outputUnit&&(this.title="("+l.toJSON().outputUnit+")"),n.title=l.attributeField;const u=l.getClassBreakInfos();u!=null&&u.length?u.forEach(w=>{n.infos.push({label:w.minValue+" - "+w.maxValue,symbol:w.symbol})}):n.infos.push({label:l.attributeField,symbol:l.getDefaultSymbol()})}else St(l)&&a.push(this._getStretchLegendElements(l,{min:0,max:255}));const p=l.defaultSymbol;!p||d||K(l)||o&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:l.defaultLabel||"others",symbol:p}]}),n.infos.length&&a.unshift(n);const h=t.opacity==null?this.opacity:t.opacity,m=this._isTallSymbol("visualVariables"in l&&l.visualVariables),f=oe(this.layer)||Re(this.layer),_=a.reduce((u,w)=>u.concat(this._getAllInfos(w)),[]).filter(u=>!!(u!=null&&u.symbol)).map(u=>this._getSymbolPreview(u,h,{isDefault:u.symbol===p,applyScaleDrivenSize:!y.has(u.symbol),symbolConfig:{isTall:m,isSquareFill:f},effectList:y.has(u.symbol)?null:this.effectList}));return l=null,await q(_),a}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e==null?void 0:e.infos;return t?t.reduce((i,r)=>i.concat(this._getAllInfos(r)),[]):[e]}_constructTileImageryStretchRendererElements(e){var y,p;const t=this.layer,i=t.rasterInfo,r=i.bandCount||e.statistics.length;let s,l,a=[];const n=i.keyProperties&&i.keyProperties.BandProperties,o=(y=e==null?void 0:e.statistics)!=null&&y.length?e.statistics:i==null?void 0:i.statistics;if(o)s=o[0].min!==void 0?o[0].min:o[0][0],l=o[0].max||o[0][1];else{const h=st[t.rasterInfo.pixelType.toLowerCase()];s=h[0],l=h[1]}if(t.hasStandardTime()&&(s=t.getStandardTimeValue(s),l=t.getStandardTimeValue(l)),i.bandCount===1||((p=t.bandIds)==null?void 0:p.length)===1)return this._getStretchLegendElements(e,{min:s,max:l});function d(h){var f;const m=((f=t==null?void 0:t.bandIds)!=null&&f.length?t.bandIds:Array.from(Array(Math.min(i.bandCount,3)).keys())).map(_=>h&&h[_]&&h[_].BandName||"band"+(_+1));return m.length<3?m.push(m[1]):m.length>3&&m.splice(3),m}return a=n&&n.length>=r?d(n):d(),this._createSymbolTableElementMultiBand(a)}_getStretchLegendElements(e,t){const i=e.colorRamp,r=oi(i,t);return{type:"stretch-ramp",title:"",infos:r,preview:U(r.map(s=>s.color))}}async _getSizeLegendElement(e,t,i,r){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await ji(i,t,await Ke(i),this.scale,this.view.type,r)}}_createSymbolTableElementMultiBand(e){const t=[],i=["red","green","blue"];return e.forEach((r,s)=>{var l;t.push({label:{colorName:i[s],bandName:r},src:ci[s],opacity:(l=this.opacity)!=null?l:1})}),t}_updateInfosforClassedSizeRenderer(e,t){const i=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",r=e.classBreakInfos.some(s=>De(s.symbol));if(i&&r){const s=ke,l=Fe,a=e.classBreakInfos.length,n=(s-l)/(a>1?a-1:a);t.forEach((o,d)=>{o.size=s-n*d})}}_isTallSymbol(e){let t=!1,i=!1;if(e)for(let r=0;r<e.length&&(!t||!i);r++){const s=e[r];s.type==="size"&&(s.axis==="height"&&(t=!0),s.axis==="width-and-depth"&&(i=!0))}return t&&i}async _getSymbolPreview(e,t,i){let r=!(i!=null&&i.isDefault)&&e.size==null&&this._hasSizeRamp?di(yi.size):e.size;if(this._scaleDrivenSizeVariable&&(i==null?void 0:i.applyScaleDrivenSize)){const{getSize:s}=await Pe(()=>import("./index.52935b46.js").then(l=>l.qm),["assets/index.52935b46.js","assets/index.be38f7b7.css"]);r=s(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return hi(e.symbol,{size:r,opacity:t,scale:!1,symbolConfig:i==null?void 0:i.symbolConfig,effectView:i==null?void 0:i.effectList}).then(s=>(e.preview=s,e)).catch(()=>(e.preview=null,e))}async _loadRenderer(e){var l,a;const t=[],i=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const r="visualVariables"in e&&((l=e.visualVariables)==null?void 0:l.some(n=>n.type==="size"&&n.target!=="outline"&&!ue.test(n.valueExpression)));if(e&&"visualVariables"in e&&!r&&"featureReduction"in i&&((a=i.featureReduction)==null?void 0:a.type)==="cluster"){const n=this.layerView._effectiveRenderer,o=Ce(ki(n,this.view));if(o){const d=i.featureReduction;if("clusterMinSize"in d&&"clusterMaxSize"in d){const{clusterMinSize:p,clusterMaxSize:h}=d;o.legendOptions=new ui({showLegend:p!==h})}const y=e.visualVariables||[];e.visualVariables=y.concat([o]),this._hasClusterSizeVariable=!0}}const s=await Ke(e);if(ee(e)||Be(e)){const n=(e.classBreakInfos||e.uniqueValueInfos).map(o=>this._fetchSymbol(o.symbol,s).then(d=>{o.symbol=d}).catch(()=>{o.symbol=null}));Array.prototype.push.apply(t,n)}return t.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:s).then(n=>{this._applySymbolToRenderer(e,n,K(e))}).catch(()=>{this._applySymbolToRenderer(e,null,K(e))})),q(t).then(()=>e)}_applySymbolToRenderer(e,t,i){i?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if(e.type==="web-style"){const i=this._webStyleSymbolCache;try{const r=await(this.view.type==="2d"?e.fetchCIMSymbol({cache:i}):e.fetchSymbol({cache:i}));return this._getAppliedCloneSymbol(r,t)}catch{throw P.warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const i=e.clone(),r=t&&t.toRgba();return i.type.includes("3d")?this._applyColorTo3dSymbol(i,r):i.type==="cim"?dt(i,t):i.color&&(i.color=new ze(r||i.color)),i}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(i=>{i&&(i.material||(i.material={}),i.material.color=new ze(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||e.type==="vector-field")return null;const i=e.visualVariables,r=[],s=[],l=[];for(const y of i)y.type==="color"?r.push(y):y.type==="size"?s.push(y):y.type==="opacity"&&l.push(y);const a=[...r,...s,...l];let n,o;if(r.length===0&&ee(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const y=e.classBreakInfos[0];n=y&&y.symbol}if(r.length===0&&K(e)&&(n=e.symbol),n)if(n.type.includes("3d")){const y=n.symbolLayers.getItemAt(0);y.type==="water"?Ee(y.color)&&(o=y.color):Ee(y.material)&&Ee(y.material.color)&&(o=y.material.color)}else n.url||(o=n.color);const d=this.effectList;return(await Promise.all(a.map(async y=>{if(!y.legendOptions||y.legendOptions.showLegend!==!1){const p=Me(e)?y.field:this._getRampTitle(y,t);let h=null;const m="getField"in t&&t.getField&&t.getField(y.field),f=m&&pi(m);if(y.type==="color"){const _=await et(y,null,f);h={type:"color-ramp",title:p,infos:_,preview:U(_.map(g=>g.color),{effectList:d})},this._hasColorRamp||(this._hasColorRamp=!(h.infos==null||!h.infos.length))}else if(y.type==="size"&&y.target!=="outline")ue.test(y.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=y):(h=await this._getSizeLegendElement(p,y,e,f),this._hasSizeRamp||(this._hasSizeRamp=!(h.infos==null||!h.infos.length)));else if(y.type==="opacity"){const _=await et(y,o,f);h={type:"opacity-ramp",title:p,infos:_,preview:U(_.map(g=>g.color),{effectList:d})},this._hasOpacityRamp||(this._hasOpacityRamp=!(h.infos==null||!h.infos.length))}return h&&h.infos?h:null}}))).filter(y=>!!y)}_getDomainName(e,t,i){if(e&&typeof e!="function"){const r="getField"in i&&i.getField&&i.getField(e),s=r&&"getFieldDomain"in i&&i.getFieldDomain?i.getFieldDomain(r.name):null;return s&&s.type==="coded-value"?s.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,i=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const r=t.featureReduction,s="popupTemplate"in r&&r.popupTemplate,l=s&&s.fieldInfos;if(l){for(const a of l)if(a.fieldName===i)return i==="cluster_count"?a.label||{showCount:!0}:a.label}}return{showCount:!0}}_getRampTitle(e,t){let i=e.field,r=e.normalizationField,s=!1,l=!1,a=!1,n=null;i=typeof i=="function"?null:i,r=typeof r=="function"?null:r;const o=e.legendOptions&&e.legendOptions.title;if(o!=null)n=o;else if(e.valueExpressionTitle)n=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const d=t.renderer.authoringInfo.visualVariables;for(let y=0;y<d.length;y++){const p=d[y];if(p.type==="color"){if(p.style==="ratio"){s=!0;break}if(p.style==="percent"){l=!0;break}if(p.style==="percent-of-total"){a=!0;break}}}}n={field:i&&this._getFieldAlias(i,t),normField:r&&this._getFieldAlias(r,t),ratio:s,ratioPercent:l,ratioPercentTotal:a}}return n}_getRendererTitle(e,t){const i=e;if(i.legendOptions&&i.legendOptions.title)return i.legendOptions.title;if(i.valueExpressionTitle)return i.valueExpressionTitle;let r=i.field,s=null,l=null;ee(i)&&(s=i.normalizationField,l=i.normalizationType==="percent-of-total"),r=typeof r=="function"?null:r,s=typeof s=="function"?null:s;let a=null;return(r||s)&&(a={field:r&&this._getFieldAlias(r,t),normField:s&&this._getFieldAlias(s,t),normByPct:l}),a}_getFieldAlias(e,t){const i="popupTemplate"in t&&t.popupTemplate,r=i&&i.fieldInfos;let s=null;r&&r.some(o=>e===o.fieldName&&(s=o,!0));let l=null;"getField"in t&&t.getField?l=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(l=t.fieldsIndex.get(e));const a=s||l;let n=null;return a&&(n=s&&s.label||l&&l.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName),n}_isUnclassedRenderer(e){const t=e.visualVariables;let i=!1;return ee(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(i=e.field?t.some(r=>!(!r||e.field!==r.field||(e.normalizationField||r.normalizationField)&&e.normalizationField!==r.normalizationField)):!!t.length),i}};v([C()],x.prototype,"children",void 0),v([C({readOnly:!0})],x.prototype,"effectList",null),v([C()],x.prototype,"layerView",void 0),v([C()],x.prototype,"layer",void 0),v([C()],x.prototype,"legendElements",void 0),v([C({readOnly:!0})],x.prototype,"opacity",null),v([C()],x.prototype,"parent",void 0),v([C({readOnly:!0,dependsOn:[]})],x.prototype,"ready",null),v([C()],x.prototype,"hideLayersNotInCurrentView",void 0),v([C()],x.prototype,"keepCacheOnDestroy",void 0),v([C()],x.prototype,"respectLayerVisibility",void 0),v([C({readOnly:!0})],x.prototype,"scale",null),v([C()],x.prototype,"sublayerIds",void 0),v([C({readOnly:!0})],x.prototype,"isScaleDriven",null),v([C()],x.prototype,"title",void 0),v([C({readOnly:!0,dependsOn:["ready"],value:0})],x.prototype,"version",null),v([C()],x.prototype,"view",void 0),x=v([de("esri.widgets.Legend.support.ActiveLayerInfo")],x);const Rt=x,H={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},$t=Oe.ofType(Rt),Ls=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer"],Vt="view.basemapView.baseLayerViews",zt="view.groundView.layerViews",xt="view.basemapView.referenceLayerViews",ws=[Vt,zt,"view.layerViews",xt];let B=class extends ut{constructor(e){super(e),this._handles=new Le,this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Oe,this.activeLayerInfos=new $t,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this._handles.add($(()=>this.view,()=>this._viewHandles(),se),H.view),this._handles.add(mi(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}_viewHandles(){this._handles.remove(H.state),this.view&&this._handles.add($(()=>this.state,()=>this._stateHandles(),se),H.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this._handles.remove([H.allLayerViews,H.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this._handles.remove(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t&&t.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{allLayerViews:e}=this.view;e.length&&this._refresh(),this._handles.add(e.on("change",t=>this._allLayerViewsChangeHandle(t)),H.allLayerViews),this._handles.add($(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),H.legendProperties)}_allLayerViewsChangeHandle(e){e.removed.forEach(t=>this._destroyViewActiveLayerInfo(t.uid)),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){if(e.length<2)return;const t=[];e.forEach(r=>{if(!r.parent){const s=r.layer.parent,l=s&&"uid"in s&&this._layerViewByLayerId[s.uid],a=l&&this._activeLayerInfosByLayerViewId[l.uid];a&&e.includes(a)&&(t.push(r),r.parent=a,a.children.add(r),this._sortActiveLayerInfos(a.children))}}),e.removeMany(t);const i={};this.view.allLayerViews.forEach((r,s)=>i[r.layer.uid]=s),e.sort((r,s)=>{const l=i[r.layer.uid]||0;return(i[s.layer.uid]||0)-l})}_generateLayerViews(){const e=[];return ws.filter(this._filterLayerViews,this).map(this.get,this).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===Vt||e===xt),i=!this.groundLegendVisible&&e===zt;return!t&&!i}_collectLayerViews(e,t){const i=r=>(r&&r.forEach(s=>{t.push(s),i(s[e])}),t);return i}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(i=>this._hasLayerInfo(i,e))}_hasLayerInfo(e,t){const i=this._isLayerUIDMatching(e.layer,t.layer.uid);return i&&(this._layerInfosByLayerViewId[t.uid]=e),i}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(i=>this._isLayerUIDMatching(i,t))}_isLayerViewSupported(e){return!!Ls.includes(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),this._handles.add($(()=>{var t;return[e.legendEnabled,(t=e.layer)==null?void 0:t.legendEnabled]},()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.get("layer.legendEnabled")}_buildActiveLayerInfo(e){var a;const t=e.layer,i=e.uid,r=this._layerInfosByLayerViewId[i];let s=this._activeLayerInfosByLayerViewId[i];if(!s){const n=r&&r.title!==void 0&&r.layer.uid===t.uid;s=new Rt({layer:t,layerView:e,title:n?r.title:t.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:r&&r.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[i]=s}const l=t.parent&&"uid"in t.parent&&this._layerViewByLayerId[(a=t.parent)==null?void 0:a.uid];if(s.parent=this._activeLayerInfosByLayerViewId[l==null?void 0:l.uid],!this._handles.has(i)){const n=[$(()=>t.title,o=>this._titleHandle(o,s)),$(()=>[t.opacity,"renderer"in t&&t.renderer,"pointSymbol"in t&&t.pointSymbol,"lineSymbol"in t&&t.lineSymbol,"polygonSymbol"in t&&t.polygonSymbol],()=>this._constructLegendElements(s)),fi(()=>{var o;return((o=this.view)==null?void 0:o.stationary)===!0},()=>this._scaleHandle(s),se),$(()=>e._effectiveRenderer,()=>this._constructLegendElements(s)),$(()=>"effect"in t&&t.effect,()=>this._constructLegendElements(s))];if(this.respectLayerVisibility){const o=$(()=>e.legendEnabled,y=>this._legendEnabledHandle(y,s)),d=$(()=>t.legendEnabled,y=>this._legendEnabledHandle(y,s));n.push(o,d)}this._handles.add(n,i)}s.isScaleDriven||this._constructLegendElements(s),this._addActiveLayerInfo(s)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){var r;const{layerView:t,layer:i}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){const s=e.parent;if(s)s.children.includes(e)||s.children.push(e),this._sortActiveLayerInfos(s.children);else{const l=(r=this.layerInfos)==null?void 0:r.some(a=>a.layer.uid===i.uid);i.parent&&"uid"in i.parent&&!l?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const l=[];this._activeLayerInfosWithNoParent.forEach(a=>{const n=a.layer.parent,o=n&&"uid"in n&&this._layerViewByLayerId[n==null?void 0:n.uid],d=this._activeLayerInfosByLayerViewId[o==null?void 0:o.uid];d&&(l.push(a),a.parent=d)}),l.length&&(this._activeLayerInfosWithNoParent.removeMany(l),l.forEach(a=>this._addActiveLayerInfo(a)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){var i;const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"featureReduction"in t&&((i=t.featureReduction)==null?void 0:i.type)==="binning"&&"renderer"in t.featureReduction?e.buildLegendElementsForRenderer(t.featureReduction.renderer):"renderer"in t&&t.renderer?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url?e.buildLegendElementsForTools():e.children.forEach(r=>this._constructLegendElements(r))}};v([C({type:$t})],B.prototype,"activeLayerInfos",void 0),v([C()],B.prototype,"basemapLegendVisible",void 0),v([C()],B.prototype,"groundLegendVisible",void 0),v([C()],B.prototype,"hideLayersNotInCurrentView",void 0),v([C()],B.prototype,"keepCacheOnDestroy",void 0),v([C()],B.prototype,"respectLayerVisibility",void 0),v([C()],B.prototype,"layerInfos",void 0),v([C({readOnly:!0})],B.prototype,"state",null),v([C()],B.prototype,"view",void 0),B=v([de("esri.widgets.Legend.LegendViewModel")],B);const Ss=B,Is="http://www.w3.org/2000/svg",R={diamondContainer:"esri-relationship-ramp--diamond__container",diamondLeftCol:"esri-relationship-ramp--diamond__left-column",diamondRightCol:"esri-relationship-ramp--diamond__right-column",diamondMidCol:"esri-relationship-ramp--diamond__middle-column",diamondMidColLabel:"esri-relationship-ramp--diamond__middle-column--label",diamondMidColRamp:"esri-relationship-ramp--diamond__middle-column--ramp",squareTable:"esri-relationship-ramp--square__table",squareTableRow:"esri-relationship-ramp--square__table-row",squareTableCell:"esri-relationship-ramp--square__table-cell",squareTableLabel:"esri-relationship-ramp--square__table-label",squareTableLabelLeftBottom:"esri-relationship-ramp--square__table-label--left-bottom",squareTableLabelRightBottom:"esri-relationship-ramp--square__table-label--right-bottom",squareTableLabelLeftTop:"esri-relationship-ramp--square__table-label--left-top",squareTableLabelRightTop:"esri-relationship-ramp--square__table-label--right-top"};function Tt(e,t,i,r){const{focus:s,labels:l}=e,a=!!s,n=Cs(e,t,i,r),o={justifyContent:"center"},d=xe();return a?c("div",{class:R.diamondContainer,styles:o},c("div",{class:R.diamondLeftCol},d?l.right:l.left),c("div",{class:R.diamondMidCol},c("div",{class:R.diamondMidColLabel},l.top),n,c("div",{class:R.diamondMidColLabel},l.bottom)),c("div",{class:R.diamondRightCol},d?l.left:l.right)):c("div",{class:R.squareTable},c("div",{class:R.squareTableRow},c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelRightBottom)},d?l.top:l.left),c("div",{class:R.squareTableCell}),c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelLeftBottom)},d?l.left:l.top)),c("div",{class:R.squareTableRow},c("div",{class:R.squareTableCell}),n,c("div",{class:R.squareTableCell})),c("div",{class:R.squareTableRow},c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelRightTop)},d?l.right:l.bottom),c("div",{class:R.squareTableCell}),c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelLeftTop)},d?l.bottom:l.right)))}function at(e,t,i){const r=`${i}_arrowStart`,s=`${i}_arrowEnd`,l=e==="left",a={markerStart:null,markerEnd:null};switch(t){case"HL":l?a.markerStart=`url(#${s})`:a.markerEnd=`url(#${r})`;break;case"LL":a.markerStart=`url(#${s})`;break;case"LH":l?a.markerEnd=`url(#${r})`:a.markerStart=`url(#${s})`;break;default:a.markerEnd=`url(#${r})`}return a}function Cs(e,t,i,r,s=60){const{focus:l,numClasses:a,colors:n,rotation:o}=e,d=!!l,y=Math.sqrt(s**2+s**2)+(d?0:5),p=[],h=[],m=[],f=(s||75)/a;for(let F=0;F<a;F++){const ye=F*f;for(let j=0;j<a;j++){const Se=j*f,G=gi(n[F][j]),Dt=bi(null),Qe={type:"rect",x:Se,y:ye,width:f,height:f};p.push(vi(G)),h.push(_i(Qe,G.fill,Dt,null)),m.push(Li(Qe))}}const _=10,g=15,u=15,w=10;let S=null;d||(S="margin: -15px -15px -18px -15px");const I=at("left",l,t),E=at("right",l,t),z=wi(m),k=tt(z,y,y,0,!1,o,!1),V=tt(z,y,y,0,!1,d?-45:null,!1),M={filter:Te(r),opacity:i==null?null:`${i}`};return c("div",{styles:M,class:d?R.diamondMidColRamp:R.squareTableCell},c("svg",{xmlns:Is,width:y,height:y,style:S},c("defs",null,c("marker",{id:`${t}_arrowStart`,markerWidth:"10",markerHeight:"10",refX:"5",refY:"5",markerUnits:"strokeWidth",orient:"auto"},c("polyline",{points:"0,0 5,5 0,10",fill:"none",stroke:"#555555","stroke-width":"1"})),c("marker",{id:`${t}_arrowEnd`,markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",markerUnits:"strokeWidth",orient:"auto"},c("polyline",{points:"5,0 0,5 5,10",fill:"none",stroke:"#555555","stroke-width":"1"})),p),c("g",{transform:k},h),c("g",{transform:V},c("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":I.markerStart,"marker-end":I.markerEnd,x1:-_,y1:s-g,x2:-_,y2:g}),c("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":E.markerStart,"marker-end":E.markerEnd,x1:u,y1:s+w,x2:s-u,y2:s+w}))))}const Es=Si(),At=10,je=20,we=10,Ge=20,Je={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Rs(e="vertical"){const t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?c("svg",{height:"4",width:"10"},c("line",{x1:"0",y1:"2",x2:"10",y2:"2",style:t})):c("svg",{height:"10",width:"10"},c("line",{x1:"5",y1:"0",x2:"5",y2:"10",style:t}))}function $s(e,t="vertical"){const i=document.createElement("div");return i.style.height=`${je}px`,i.className=Je.univariateAboveAndBelowSymbol,e!=null&&(i.style.opacity=e.toString()),Es.append(i,Rs.bind(null,t)),i}function kt(e,t,i="vertical",r){e.infos.forEach((s,l)=>{if(r&&l===2)s.preview=$s(t,i);else{const a=O(s.size)+(i==="horizontal"?Ge:we),n=s.preview.tagName.toLowerCase()==="div",o=n?s.preview:document.createElement("div");o.className=Je.univariateAboveAndBelowSymbol,i==="horizontal"?o.style.width=`${a}px`:o.style.height=`${a}px`,n||o.appendChild(s.preview),s.preview=o}})}function _e(e,t="classic"){const i=e.infos;return t==="classic"?(O(i[0].size)+we)/2:(O(i[0].size)-O(i[i.length-1].size))/2}function re(e,t){if(!e)return null;const i=e.infos.map(s=>s.color),r=U(t.type==="full"?i:t.type==="above"?i.slice(0,3):i.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList});return r.className=Je.colorRamp,t.opacity!=null&&(r.style.opacity=t.opacity.toString()),r}function Ne(e,t,i,r="vertical"){let s=0;const l=e.infos,a=Math.floor(l.length/2),n=t==="full"||t==="above"?0:a,o=t==="full"||t==="below"?l.length-1:a;for(let d=n;d<=o;d++)i&&d===a?s+=r==="horizontal"?At:je:s+=O(l[d].size)+(r==="horizontal"?Ge:we);return Math.round(s)}function le(e,t,i,r="vertical"){const s=Ne(e,t,i,r),l=e.infos,a=Math.floor(l.length/2),n=t==="full"||t==="above"?0:a,o=t==="full"||t==="below"?l.length-1:a,d=t==="full"?l[n].size+l[o].size:t==="above"?l[n].size:l[o].size,y=i?r==="vertical"?je:At:0,p=r==="vertical"?we*(t==="full"?2:1):Ge*(t==="full"?2:1);return Math.round(s-(O(d)/2+y/2+p/2))}function Ft(e,t,i="vertical"){const r=e.infos;let s=r.find(({type:a})=>a==="size-ramp"),l=r.find(({type:a})=>a==="color-ramp");return s&&(s={...s},s.infos=[...s.infos],kt(s,t,i,!0)),l&&(l={...l},l.infos=[...l.infos]),i==="horizontal"&&(s==null||s.infos.reverse(),l==null||l.infos.reverse()),{sizeRampElement:s,colorRampElement:l}}function Mt(e,t="vertical"){const i=e.infos;let r=i.find(({type:l})=>l==="size-ramp"),s=i.find(({type:l})=>l==="color-ramp");return r&&(r={...r},r.infos=[...r.infos],kt(r,null,t,!1)),s&&(s={...s},s.infos=[...s.infos]),t==="horizontal"&&(r==null||r.infos.reverse(),s==null||s.infos.reverse()),{sizeRampElement:r,colorRampElement:s}}function Vs(e,t){return t}function T(e){const t=this;e.appendChild(t)}function ae(e,t,i){if(!t)return;if(typeof t=="string"||typeof t=="number")return t;if("value"in t||"unit"in t)return Ae(e.dotValue,t);if("colorName"in t||"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:null;let r=null;return Vs(t,i)?r=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:Bt(t,i)&&(r=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),r?Ae(r==="showField"?"{field}":e[r],{field:t.field,normField:t.normField}):null}function Bt(e,t){return!t}function Nt(e,t){return!!(t&&t==="Stretched"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}const b={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",pieChartRampPreview:"esri-legend--card__pie-chart-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},zs=25,xs=25,Ts=768,As=100;var ce;(function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"})(ce||(ce={}));const ks="#ddd",Q=window.devicePixelRatio;function Fs(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const i=e.symbolLayers.getItemAt(t-1),r=i.resource&&i.resource.primitive;return r==="circle"||r==="cross"||r==="kite"||r==="sphere"||r==="cube"||r==="diamond"}{const t=e.style;return t==="circle"||t==="diamond"||t==="cross"}}}function Ms(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const i=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return i==="triangle"||i==="cone"||i==="tetrahedron"}return e.style==="triangle"}}let N=class extends qe{constructor(e,t){super(e,t),this._handles=new Le,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=ce.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own($(()=>this.activeLayerInfos,e=>{this._handles.removeAll(),this._watchForSectionChanges(e)}))}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators=this.layout===ce.Auto&&this.view.container.clientWidth<=Ts||this.layout===ce.Stack;const e=this.activeLayerInfos,t=e&&e.toArray().map(n=>this._renderLegendForLayer(n)).filter(n=>!!n);this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const i=this._sectionNames.length,r=this._sectionNames.map((n,o)=>{const d=Ae(this.messagesCommon.pagination.pageText,{index:o+1,total:i});return c("div",{key:n,role:"tab",id:n,"aria-label":d,"aria-controls":`${n}-panel`,"aria-selected":(this._selectedSectionName===n).toString(),tabIndex:this._selectedSectionName===n?0:-1,title:d,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(b.indicator,{[b.activated]:this._selectedSectionName===n}),"data-section-name":n})}),s=this._hasIndicators&&i>1?c("div",{class:b.indicatorContainer,key:"carousel-navigation",role:"tablist"},r):null,l=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,a={[b.stacked]:this._hasIndicators};return c("div",{class:this.classes(b.base,a)},l||c("div",{class:b.message},this.messages.noLegend),s)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,i=t==="ArrowLeft"?-1:1,r=e.target.getAttribute("data-section-name"),s=this._sectionNames.indexOf(r),l=this._sectionNames;let a=null;s!==-1&&(l[s+i]?a=document.getElementById(l[s+i]):t==="ArrowLeft"?a=document.getElementById(l[l.length-1]):t==="ArrowRight"&&(a=document.getElementById(l[0])),a&&a.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach(i=>{const r=`activeLayerInfo-${i.layer.uid}-version-change`;this._handles.remove(r),this._watchForSectionChanges(i.children),this._handles.add($(()=>i.version,()=>this._generateSectionNames()),r)});const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",()=>this._watchForSectionChanges(e)),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,i){return`${this.id}${e.uid}-type-${t.type}-${i}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((t,i)=>{this._sectionNames.push(this._getSectionName(e.layer,t,i))})}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map(i=>this._renderLegendForLayer(i)).toArray();return c("div",{key:e.layer.uid,class:this.classes(b.service,b.groupLayer)},c("div",{class:b.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const i=t.some(l=>l.type==="relationship-ramp"),r=t.map((l,a)=>this._renderLegendForElement(l,e,a,i)).filter(l=>!!l);if(!r.length)return null;const s={[b.groupLayerChild]:!!e.parent};return c("div",{key:e.layer.uid,class:this.classes(b.service,s)},c("div",{class:b.serviceCaptionContainer},c("div",{class:b.serviceCaptionText},e.title)),c("div",{class:b.serviceContent},r))}}_renderLegendForElement(e,t,i,r=!1){const s=e.type==="color-ramp",l=e.type==="opacity-ramp",a=e.type==="size-ramp",n=t.layer;let o=null;if(typeof e.title=="string")o=e.title;else if(e.title){const f=e.title,_=ae(this.messages,f,s||l);o=f.title?`${f.title} (${_})`:_}const d=this._getSectionName(n,e,i),y=this._hasIndicators?c("div",null,c(ge,{level:this.headingLevel,class:b.carouselTitle},t.title),c(ge,{level:Ci(this.headingLevel),class:b.layerCaption},o)):o?c(ge,{level:this.headingLevel,class:b.layerCaption},o):null,p=t.effectList;let h=null;if(e.type==="symbol-table"){const f=e.infos.map((_,g)=>this._renderLegendForElementInfo(_,t,e.legendType,g)).filter(_=>!!_);if(f.length){const _=f[0].properties.classes&&f[0].properties.classes[b.symbolRow],g={[b.labelContainer]:!_&&!r,[b.relationshipLabelContainer]:r};h=c("div",{class:this.classes(g)},f)}}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"?h=this._renderLegendForRamp(e,n.opacity,p):a?h=this._renderSizeRamp(e,n.opacity):e.type==="pie-chart-ramp"?h=this._renderPieChartRamp(e):e.type==="relationship-ramp"?h=Tt(e,this.id,n.opacity,p):e.type==="univariate-above-and-below-ramp"?h=this._renderUnivariateAboveAndBelowRamp(e,n.opacity,p):e.type==="univariate-color-size-ramp"&&(h=this._renderUnivariateColorSizeRamp(e,n.opacity,p));if(!h)return null;const m=c("div",{key:d,class:b.section,id:`${d}-panel`,role:"tabpanel","aria-labelledby":d,tabIndex:0},[y,h]);return this._sectionMap.set(d,m),m}_renderPieChartRamp(e){return c("div",{class:b.pieChartRampPreview,bind:e.preview,afterCreate:T})}_renderUnivariateAboveAndBelowRamp(e,t,i){const{sizeRampElement:r,colorRampElement:s}=Ft(e,t,"horizontal");if(!r)return null;const l=Ne(r,"full",!0,"horizontal"),a=le(r,"above",!0,"horizontal"),n=le(r,"below",!0,"horizontal"),o=12,d=re(s,{width:a,height:o,rampAlignment:"horizontal",opacity:t,type:"above",effectList:i}),y=re(s,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"below",effectList:i}),p=_e(r,"card"),h=r.infos.map(S=>S.label),m=h.length-1,f=h.map((S,I)=>I===0||I===m?c("div",{key:I},S):null),_={display:"flex",flexDirection:"column"},g={display:"flex",flexDirection:"row"},u={marginTop:"3px",display:"flex"};xe(this.container)?u.marginRight=`${p}px`:u.marginLeft=`${p}px`;const w={width:`${l}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return c("div",{class:b.layerRow,key:"size-ramp-preview",styles:_},c("div",{class:this.classes(b.symbolContainer,b.sizeRampHorizontal),styles:g},r.infos.map((S,I)=>c("div",{key:I,class:b.symbol,bind:S.preview,afterCreate:T}))),d?c("div",{class:b.univariateAboveAndBelowColorRamp,styles:u,key:"color-ramp-preview"},c("div",{bind:d,afterCreate:T}),c("div",{bind:y,afterCreate:T})):null,c("div",{class:b.layerInfo},c("div",{class:b.rampLabelsContainer,styles:w},f)))}_renderUnivariateColorSizeRamp(e,t,i){const{sizeRampElement:r,colorRampElement:s}=Mt(e,"horizontal");if(!r)return null;const l=Ne(r,"full",!1,"horizontal"),a=le(r,"full",!1,"horizontal"),n=re(s,{width:a,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:i}),o=_e(r,"card"),d=r.infos.length-1,y=r.infos.map((_,g)=>g===0||g===d?c("div",{key:g},_.label):null),p={display:"flex",flexDirection:"column"},h={display:"flex",flexDirection:"row"},m={marginTop:"3px",display:"flex"};xe(this.container)?m.marginRight=`${o}px`:m.marginLeft=`${o}px`;const f={width:`${l}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return c("div",{class:b.layerRow,key:"size-ramp-preview",styles:p},c("div",{class:this.classes(b.symbolContainer,b.sizeRampHorizontal),styles:h},r.infos.map((_,g)=>c("div",{key:g,class:b.symbol,bind:_.preview,afterCreate:T}))),c("div",{class:b.univariateAboveAndBelowColorRamp,styles:m,key:"color-ramp-preview"},c("div",{bind:n,afterCreate:T})),c("div",{class:b.layerInfo},c("div",{class:b.rampLabelsContainer,styles:f},y)))}_renderLegendForElementInfo(e,t,i,r){var a,n;const s=t.layer;if(e.type)return this._renderLegendForElement(e,t,r);const l=Nt(s,i);if(e.preview){if(!e.symbol||!e.symbol.type.includes("simple-fill")){if(!e.label)return c("div",{key:r,bind:e.preview,afterCreate:T});const E={[b.symbolCell]:this._hasIndicators};return c("div",{key:r,class:this.classes(b.layerRow,{[b.symbolRow]:this._hasIndicators})},c("div",{class:this.classes(E),bind:e.preview,afterCreate:T}),c("div",{class:this.classes(b.imageLabel,{[b.labelCell]:this._hasIndicators})},ae(this.messages,e.label,!1)||""))}let o=255,d=255,y=255,p=0,h=255,m=255,f=255,_=0;const g=e.symbol.color&&e.symbol.color.a,u=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;g&&(o=e.symbol.color.r,d=e.symbol.color.g,y=e.symbol.color.b,p=e.symbol.color.a*s.opacity),u&&(h=e.symbol.outline.color.r,m=e.symbol.outline.color.g,f=e.symbol.outline.color.b,_=e.symbol.outline.color.a*s.opacity);const w=(n=(a=e.symbol.color)==null?void 0:a.isBright)!=null?n:!0,S=w?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",I={background:g?`rgba(${o}, ${d}, ${y}, ${p})`:"none",color:w?"black":"white",textShadow:`-1px -1px 0 ${S},
                                              1px -1px 0 ${S},
                                              -1px 1px 0 ${S},
                                              1px 1px 0 ${S}`,border:u?`1px solid rgba(${h}, ${m}, ${f}, ${_})`:"none",filter:Te(t.effectList)};return c("div",{key:r,class:b.layerRow},c("div",{class:b.labelElement,styles:I}," ",e.label," "))}if(e.src){const o=this._renderImage(e,s,l);return c("div",{key:r,class:b.layerRow},o,c("div",{class:b.imageLabel},e.label||""))}}_renderImage(e,t,i){const{label:r,src:s,opacity:l}=e,a={[b.imageryLayerStretchedImage]:i,[b.symbol]:!i},n={opacity:`${l!=null?l:t.opacity}`};return c("img",{alt:ae(this.messages,r,!1),src:s,border:0,width:e.width,height:e.height,class:this.classes(a),styles:n})}_renderSizeRampLines(e){const t=e.infos,i=t[0],r=t[t.length-1],s=i.symbol,l=this._hasIndicators,a=O(i.size+i.outlineSize)*Q,n=O(r.size+r.outlineSize)*Q,o=l?a:a+50*Q,d=l?a/2+50*Q:a,y=Ms(s),p=Fs(s),h=document.createElement("canvas");h.width=o,h.height=d,h.style.width=h.width/Q+"px",h.style.height=h.height/Q+"px";const m=h.getContext("2d");if(l){m.beginPath();const f=0,_=0,g=o/2-n/2,u=d;m.moveTo(f,_),m.lineTo(g,u);const w=o,S=0,I=o/2+n/2,E=d;m.moveTo(w,S),m.lineTo(I,E)}else{m.beginPath();const f=0,_=d/2-n/2,g=o,u=0;m.moveTo(f,_),m.lineTo(g,u);const w=0,S=d/2+n/2,I=o,E=d;m.moveTo(w,S),m.lineTo(I,E)}return m.strokeStyle=ks,m.stroke(),c("div",{bind:h,afterCreate:T,styles:l?{display:"flex",marginTop:`-${y?0:p?a/2:0}px`,marginBottom:`-${y?n:p?n/2:0}px`}:{display:"flex",marginRight:`-${y?0:p?a/2:0}px`,marginLeft:`-${y?0:p?n/2:0}px`}})}_renderSizeRamp(e,t){const i=e.infos,r=i[0].label,s=i[i.length-1].label;let l=i[0].preview,a=i[i.length-1].preview;const n=this._hasIndicators,o={"flex-direction":n?"column":"row-reverse"};l&&(l=l.cloneNode(!0),l.style.display="flex"),a&&(a=a.cloneNode(!0),a.style.display="flex");const d={opacity:t!=null?`${t}`:""};return c("div",{class:this.classes(b.layerRow,{[b.sizeRampRow]:n})},c("div",{class:b.rampLabel},n?r:s),c("div",{class:b.sizeRampContainer,styles:o},c("div",{bind:l,afterCreate:T,class:b.sizeRampPreview,styles:d}),this._renderSizeRampLines(e),c("div",{bind:a,afterCreate:T,class:b.sizeRampContainer,styles:d})),c("div",{class:b.rampLabel},n?s:r))}_renderLegendForRamp(e,t,i){const r=e.infos,s=e.type==="heatmap-ramp",l=r.length-1,a=xs,n=l>2&&!s?zs*l:As,o=n+20,d=10,y=r.slice(0).reverse();y.forEach((E,z)=>{E.offset=s?E.ratio:z/l});const p=y.length-1,h=y.length%2!=0&&y[y.length/2|0],m=h&&c("div",{class:b.intervalSeparatorsContainer},c("div",{class:b.intervalSeparator},"|"),c("div",{class:b.rampLabel},h.label)),f=r[r.length-1].label,_=r[0].label,g=[[{shape:{type:"path",path:`M0 ${a/2} L${d} 0 L${d} ${a} Z`},fill:y[0].color,stroke:{width:0}},{shape:{type:"rect",x:d,y:0,width:n,height:a},fill:{type:"linear",x1:d,y1:0,x2:n+d,y2:0,colors:y},stroke:{width:0}},{shape:{type:"path",path:`M${n+d} 0 L${o} ${a/2} L${n+d} ${a} Z`},fill:y[p].color,stroke:{width:0}}]],u=Ei(g,o,a),{messages:w}=this,S={filter:Te(i),opacity:t==null?null:`${t}`},I={justifyContent:"center"};return c("div",{class:b.layerRow,styles:I},c("div",{class:b.rampLabel},s?w[f]:f),c("div",{class:b.symbolContainer},c("div",{styles:S},u),m),c("div",{class:b.rampLabel},s?w[_]:_))}};v([C()],N.prototype,"activeLayerInfos",void 0),v([C()],N.prototype,"headingLevel",void 0),v([C()],N.prototype,"layout",void 0),v([C(),ve("esri/widgets/Legend/t9n/Legend")],N.prototype,"messages",void 0),v([C(),ve("esri/t9n/common")],N.prototype,"messagesCommon",void 0),v([C({readOnly:!0})],N.prototype,"type",void 0),v([C()],N.prototype,"view",void 0),v([Ii()],N.prototype,"_selectSection",null),N=v([de("esri.widgets.Legend.styles.Card")],N);const $e=N,L={service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label",message:"esri-legend__message",header:"esri-widget__heading",hidden:"esri-hidden"},Bs="esri-legend__",Ns=24,nt={display:"flex",alignItems:"flex-start"},Ve={marginLeft:"3px"},X={display:"table-cell",verticalAlign:"middle"};let W=class extends qe{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const e=this.activeLayerInfos,t=e&&e.toArray().map(i=>this._renderLegendForLayer(i)).filter(i=>!!i);return c("div",null,t&&t.length?t:c("div",{class:L.message},this.messages.noLegend))}_renderLegendForLayer(e){if(!e.ready)return null;const t=!!e.children.length,i=`${Bs}${e.layer.uid}-version-${e.version}`,r=e.title?ge({level:this.headingLevel,class:this.classes(L.header,L.label)},e.title):null;if(t){const s=e.children.map(l=>this._renderLegendForLayer(l)).toArray();return c("div",{key:i,class:this.classes(L.service,L.groupLayer)},r,s)}{const s=e.legendElements;if(s&&!s.length)return null;const l=s.map(n=>this._renderLegendForElement(n,e.layer,e.effectList)).filter(n=>!!n);if(!l.length)return null;const a={[L.groupLayerChild]:!!e.parent};return c("div",{key:i,class:this.classes(L.service,a),tabIndex:0},r,c("div",{class:L.layer},l))}}_renderLegendForElement(e,t,i,r){const s=e.type==="color-ramp",l=e.type==="opacity-ramp",a=e.type==="size-ramp";let n=null;if(e.type==="symbol-table"||a){const m=e.infos.map(f=>this._renderLegendForElementInfo(f,t,i,a,e.legendType)).filter(f=>!!f);m.length&&(n=c("div",{class:L.layerBody},m))}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"||e.type==="stretch-ramp"?n=this._renderLegendForRamp(e,t.opacity):e.type==="relationship-ramp"?n=Tt(e,this.id,t.opacity,i):e.type==="pie-chart-ramp"?n=this._renderPieChartRamp(e):e.type==="univariate-above-and-below-ramp"?n=this._renderUnivariateAboveAndBelowRamp(e,t.opacity,i):e.type==="univariate-color-size-ramp"&&(n=this._renderUnivariateColorSizeRamp(e,t.opacity,i));if(!n)return null;const o=e.title;let d=null;if(typeof o=="string")d=o;else if(o){const m=ae(this.messages,o,s||l);d=Bt(o,s||l)&&o.title?`${o.title} (${m})`:m}const y=r?L.layerChildTable:L.layerTable,p=d?c("div",{class:L.layerCaption},d):null,h={[L.layerTableSizeRamp]:a||!r};return c("div",{class:this.classes(y,h)},p,n)}_renderPieChartRamp(e){return c("div",{bind:e.preview,afterCreate:T})}_renderUnivariateAboveAndBelowRamp(e,t,i){const{sizeRampElement:r,colorRampElement:s}=Ft(e,t);if(!r)return null;const l=le(r,"above",!0),a=le(r,"below",!0),n=12,o=re(s,{width:n,height:l,rampAlignment:"vertical",opacity:t,type:"above",effectList:i}),d=re(s,{width:n,height:a,rampAlignment:"vertical",opacity:t,type:"below",effectList:i}),y=_e(r),p=r.infos.map(I=>I.label),h=p.map((I,E)=>E===0?c("div",{key:E,class:I?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},I):E===2?c("div",null):null),m=p.length-1,f=Math.floor(p.length/2),_=p.map((I,E)=>E===f||E===m?c("div",{key:E,class:I?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},I):null),g={display:"table-cell",verticalAlign:"middle"},u={marginTop:`${y}px`},w={height:`${l}px`},S={height:`${a}px`};return c("div",{key:"univariate-above-and-below-ramp-preview",styles:nt},c("div",{class:L.layerBody},r.infos.map((I,E)=>c("div",{class:this.classes(L.layerRow,L.sizeRamp)},c("div",{class:L.symbol,styles:g,bind:I.preview,afterCreate:T}),o||E%2!=0?null:c("div",{class:L.layerInfo},p[E])))),o?c("div",{styles:u,key:"color-ramp-preview"},c("div",{styles:Ve},c("div",{styles:X},c("div",{class:L.rampContainer,bind:o,afterCreate:T})),c("div",{styles:X},c("div",{class:L.rampLabelsContainer,styles:w},h))),c("div",{styles:Ve},c("div",{styles:X},c("div",{class:L.rampContainer,bind:d,afterCreate:T})),c("div",{styles:X},c("div",{class:L.rampLabelsContainer,styles:S},_)))):null)}_renderUnivariateColorSizeRamp(e,t,i){const{sizeRampElement:r,colorRampElement:s}=Mt(e);if(!r)return null;const l=_e(r),a=12,n=le(r,"full",!1),o=re(s,{width:a,height:n,rampAlignment:"vertical",opacity:t,type:"full",effectList:i}),d=r.infos.length-1,y=r.infos.map((f,_)=>_===0||_===d?c("div",{key:_,class:f.label?s?L.univariateAboveAndBelowLabel:L.rampLabel:null},f.label):null),p={display:"table-cell",verticalAlign:"middle"},h={marginTop:`${l}px`},m={height:`${n}px`};return c("div",{key:"univariate-above-and-below-ramp-preview",styles:nt},c("div",{class:L.layerBody},r.infos.map(f=>c("div",{class:this.classes(L.layerRow,L.sizeRamp)},c("div",{class:L.symbol,styles:p,bind:f.preview,afterCreate:T})))),c("div",{styles:h,key:"color-ramp-preview"},c("div",{styles:Ve},c("div",{styles:X},c("div",{class:L.rampContainer,bind:o,afterCreate:T})),c("div",{styles:X},c("div",{class:L.rampLabelsContainer,styles:m},y)))))}_renderLegendForRamp(e,t){const i=e.infos,r=e.type==="opacity-ramp",s=e.type==="heatmap-ramp",l=e.type==="stretch-ramp",a=e.preview,n=r?L.opacityRamp:"";a.className=`${L.colorRamp} ${n}`,t!=null&&(a.style.opacity=t.toString());const o=i.map(p=>c("div",{class:p.label?L.rampLabel:null},s?this.messages[p.label]||p.label:l?this._getStretchStopLabel(p):p.label)),d={width:`${Ns}px`},y={height:a.style.height};return c("div",{class:L.layerRow},c("div",{class:L.symbolContainer,styles:d},c("div",{class:L.rampContainer,bind:a,afterCreate:T})),c("div",{class:L.layerInfo},c("div",{class:L.rampLabelsContainer,styles:y},o)))}_getStretchStopLabel(e){return e.label?this.messages[e.label]+": "+(typeof e.value=="string"?e.value:yt(e.value,{style:"decimal",notation:e.value.toString().includes("e")?"scientific":"standard"})):""}_renderLegendForElementInfo(e,t,i,r,s){if(e.type)return this._renderLegendForElement(e,t,i,!0);let l=null;const a=Nt(t,s);if(e.preview?l=c("div",{class:L.symbol,bind:e.preview,afterCreate:T}):e.src&&(l=this._renderImage(e,t,a)),!l)return null;const n={[L.imageryLayerInfoStretched]:a},o={[L.imageryLayerInfoStretched]:a,[L.sizeRamp]:!a&&r};return c("div",{class:L.layerRow},c("div",{class:this.classes(L.symbolContainer,o)},l),c("div",{class:this.classes(L.layerInfo,n)},ae(this.messages,e.label,!1)||""))}_renderImage(e,t,i){const{label:r,src:s,opacity:l}=e,a={[L.imageryLayerStretchedImage]:i,[L.symbol]:!i},n={opacity:`${l!=null?l:t.opacity}`};return c("img",{alt:ae(this.messages,r,!1),src:s,border:0,width:e.width,height:e.height,class:this.classes(a),styles:n})}};v([C()],W.prototype,"activeLayerInfos",void 0),v([C()],W.prototype,"headingLevel",void 0),v([C(),ve("esri/widgets/Legend/t9n/Legend")],W.prototype,"messages",void 0),v([C({readOnly:!0})],W.prototype,"type",void 0),W=v([de("esri.widgets.Legend.styles.Classic")],W);const Y=W,me={base:"esri-legend",widget:"esri-widget",panel:"esri-widget--panel",widgetIcon:"esri-icon-layer-list"};let A=class extends qe{constructor(e,t){super(e,t),this._handles=new Le,this.activeLayerInfos=null,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.headingLevel=3,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.iconClass=me.widgetIcon,this.label=void 0,this.layerInfos=null,this.messages=null,this.style=new Y,this.view=null,this.viewModel=new Ss}initialize(){this.own([fe(()=>this.view,"resize",()=>this.scheduleRender()),fe(()=>this.activeLayerInfos,"change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),$(()=>this.headingLevel,e=>{const{style:t}=this;t&&(t.headingLevel=e)}),$(()=>this.style,(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)},se)])}destroy(){this._handles=$i(this._handles)}castStyle(e){if(e instanceof $e||e instanceof Y)return e;if(typeof e=="string")return e==="card"?new $e:new Y;if(e&&typeof e.type=="string"){const t={...e};return delete t.type,new(e.type==="card"?$e:Y)(t)}return new Y}render(){return c("div",{class:this.classes(me.base,me.widget,this.style instanceof Y?me.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){this._handles.removeAll(),e.forEach(t=>this._renderOnActiveLayerInfoChange(t)),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){const t=$(()=>e.version,()=>this.scheduleRender());this._handles.add(t,`version_${e.layer.uid}`);const i=fe(()=>e.children,"change",()=>e.children.forEach(r=>this._renderOnActiveLayerInfoChange(r)),se);this._handles.add(i,`children_${e.layer.uid}`),e.children.forEach(r=>this._renderOnActiveLayerInfoChange(r))}};v([D("viewModel.activeLayerInfos")],A.prototype,"activeLayerInfos",void 0),v([D("viewModel.basemapLegendVisible")],A.prototype,"basemapLegendVisible",void 0),v([D("viewModel.groundLegendVisible")],A.prototype,"groundLegendVisible",void 0),v([C()],A.prototype,"headingLevel",void 0),v([D("viewModel.hideLayersNotInCurrentView")],A.prototype,"hideLayersNotInCurrentView",void 0),v([D("viewModel.keepCacheOnDestroy")],A.prototype,"keepCacheOnDestroy",void 0),v([D("viewModel.respectLayerVisibility")],A.prototype,"respectLayerVisibility",void 0),v([C()],A.prototype,"iconClass",void 0),v([C({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],A.prototype,"label",void 0),v([D("viewModel.layerInfos")],A.prototype,"layerInfos",void 0),v([C(),ve("esri/widgets/Legend/t9n/Legend")],A.prototype,"messages",void 0),v([C()],A.prototype,"style",void 0),v([Ri("style")],A.prototype,"castStyle",null),v([D("viewModel.view")],A.prototype,"view",void 0),v([C()],A.prototype,"viewModel",void 0),A=v([de("esri.widgets.Legend")],A);const Js=A;export{Js as default};
