import{$ as c,a0 as p,a1 as H,a2 as Z,t as v,dk as U,h as j,ex as K,ar as X,r as T,R as W,S as D,a9 as ee,Q as te,s as F,f as se,g as $,a4 as re,B as ie,aH as ae,aZ as oe,a_ as ne,M as le,a$ as he,E as de,F as ce,ap as ue,ec as me,cq as pe,dz as ye,ds as fe,dt as _e,ey as ve,p as ge,cE as we,ez as Re,aq as Me}from"./index.52935b46.js";import{p as xe}from"./normalizeUtilsSync.ca14d31b.js";import{a as Ce}from"./utils.88e80f44.js";import{c as B,f as Ee}from"./VertexArrayObject.b7add78f.js";import{P as $e,G as Te,L as qe,D as Se,F as Q}from"./enums.de935fa5.js";import{n as G,u as Ve}from"./Texture.7634927e.js";import{r as be}from"./vec3f32.0772c8d8.js";import{b as Ae,W as De}from"./WGLContainer.3dee497f.js";import{I as Ie}from"./Utils.e2c1ea7d.js";import{f as Oe}from"./LayerView2D.9ada509f.js";import{u as Pe}from"./LayerView.5d769fe2.js";import"./EffectView.d573d8e0.js";import"./MaterialKey.60b69a2c.js";import"./alignmentUtils.63b4d661.js";import"./definitions.6dca4f7b.js";import"./pixelUtils.2d74e066.js";import"./VertexElementDescriptor.d386088d.js";import"./vec4f32.8f10672a.js";import"./ProgramTemplate.a2b1ea90.js";import"./number.08b65821.js";import"./StyleDefinition.5774ff26.js";import"./enums.05a6ea95.js";import"./config.40d47db8.js";import"./GeometryUtils.8166011b.js";import"./earcut.d30cbec0.js";let m=class extends Z{constructor(r){super(r)}get bounds(){const r=this.coords;return v(r)?null:U(r.extent)}get coords(){var e;const r=(e=j(this.element.georeference))==null?void 0:e.coords;return K(r,this.spatialReference).geometry}get normalizedCoords(){return X.fromJSON(xe(this.coords))}get normalizedBounds(){return T(this.normalizedCoords)?U(this.normalizedCoords.extent):null}};c([p()],m.prototype,"spatialReference",void 0),c([p()],m.prototype,"element",void 0),c([p()],m.prototype,"bounds",null),c([p()],m.prototype,"coords",null),c([p()],m.prototype,"normalizedCoords",null),c([p()],m.prototype,"normalizedBounds",null),m=c([H("esri.layers.support.media.MediaElementView")],m);class ze extends Ce{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(W(()=>this.elementView.element.opacity,t=>this.opacity=t,D),W(()=>[this.elementView.coords],()=>{this.requestRender()},D),ee(()=>this.elementView.element.loaded,()=>{const t=this.elementView.element;this.ready(),t.type==="video"&&T(t.content)&&this._handles.push(te(t.content,"play",()=>this.requestRender()))},D)),e.element.load().catch(t=>{F.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new se("element-load-error","Element cannot be displayed",{element:e,error:t}))})}destroy(){var e;this._handles.forEach(t=>t.remove()),(e=this.texture)==null||e.dispose(),this.texture=null}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,s=this.elementView.element.content;if(T(s)){const i=s instanceof HTMLImageElement,a=s instanceof HTMLVideoElement,o=i?s.naturalWidth:a?s.videoWidth:s.width,h=i?s.naturalHeight:a?s.videoHeight:s.height;this.texture?a&&!s.paused&&(this.texture.setData(s),this.requestRender(),(G(t.gl)||$(o)&&$(h))&&this.texture.generateMipmap()):(this.texture=new Ve(t,{pixelFormat:$e.RGBA,dataType:Te.UNSIGNED_BYTE,samplingMode:qe.LINEAR,wrapMode:Se.CLAMP_TO_EDGE,width:o,height:h},s),(G(t.gl)||$(o)&&$(h))&&this.texture.generateMipmap(),a&&!s.paused&&this.requestRender())}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const s=this.elementView.coords;if(v(s))return;const[i,a,o,h]=s.rings[0],f=this._vertices,{x:n,y:l}=e,u=t!==0;u?f.set([a[0]-n,a[1]-l,i[0]-n,i[1]-l,o[0]-n,o[1]-l,h[0]-n,h[1]-l,h[0]-n,h[1]-l,a[0]+t-n,a[1]-l,a[0]+t-n,a[1]-l,i[0]+t-n,i[1]-l,o[0]+t-n,o[1]-l,h[0]+t-n,h[1]-l]):f.set([a[0]-n,a[1]-l,i[0]-n,i[1]-l,o[0]-n,o[1]-l,h[0]-n,h[1]-l]),this.isWrapAround=u}getVAO(e,t,s){if(v(this.elementView.coords))return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=B.createVertex(e,Q.DYNAMIC_DRAW,i);const a=B.createVertex(e,Q.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Ee(e,s,t,{geometry:this._geometryVbo,tex:a})}return this._vao}}class Le extends Ae{constructor(){super(...arguments),this._localOrigin=re(0,0),this._viewStateId=-1,this._dvsMat3=ie(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const t of this.children)t.beforeRender(e)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"overlay",brushes:[De.overlay],target:()=>this.children,drawPhase:Ie.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){const{state:t}=e,{id:s,size:i,pixelRatio:a,resolution:o,rotation:h,viewpoint:f,displayMat3:n}=t;if(this._viewStateId===s)return;const l=Math.PI/180*h,u=a*i[0],g=a*i[1],{x:M,y:q}=f.targetGeometry,S=ae(M,t.spatialReference);this._localOrigin.x=S,this._localOrigin.y=q;const x=o*u,w=o*g,d=oe(this._dvsMat3);ne(d,d,n),le(d,d,he(u/2,g/2)),de(d,d,be(u/x,-g/w,1)),ce(d,d,-l),this._viewStateId=s}_updateOverlays(e,t){const{state:s}=e,{rotation:i,spatialReference:a,worldScreenWidth:o,size:h,viewpoint:f}=s,n=this._localOrigin;let l=0;if(a.isWrappable){const u=h[0],g=h[1],M=180/Math.PI*i,q=Math.abs(Math.cos(M)),S=Math.abs(Math.sin(M)),x=Math.round(u*q+g*S),[w,d]=ue(a).valid,y=me(a),{x:I,y:N}=f.targetGeometry,k=[I,N],V=[0,0];s.toScreen(V,k);const C=[0,0];let b;b=x>o?.5*o:.5*x;const O=Math.floor((I+.5*y)/y),Y=w+O*y,J=d+O*y,A=[V[0]+b,0];s.toMap(C,A),C[0]>J&&(l=y),A[0]=V[0]-b,s.toMap(C,A),C[0]<Y&&(l=-y);for(const E of t){const P=E.elementView.bounds;if(v(P))continue;const[z,,L]=P;z<w&&L>w?E.updateDrawCoords(n,y):L>d&&z<d?E.updateDrawCoords(n,-y):E.updateDrawCoords(n,l)}}else for(const u of t)u.updateDrawCoords(n,l)}}let _=class extends Oe(Pe){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new pe}attach(){this.handles.add(ye(()=>this.layer.source,"refresh",()=>{for(const r of this._tileStrategy.tiles)this._updateTile(r);this.requestUpdate()})),this._overlayContainer=new Le,this.container.addChild(this._overlayContainer),this._fetchQueue=new fe({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(r,e)=>this._queryElements(r,e)}),this._tileStrategy=new _e({cachePolicy:"purge",resampling:!0,acquireTile:r=>this._acquireTile(r),releaseTile:r=>this._releaseTile(r),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear()}supportsSpatialReference(r){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(r){this._tileStrategy.update(r)}async hitTest(r,e){var i;const t=[],s=[r.x,r.y];for(const a of this.elements){const o=(i=j(a.georeference))==null?void 0:i.coords;T(o)&&ve(o.rings,s)&&t.push({type:"media",element:a,layer:this.layer,mapPoint:r})}return t.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){}_acquireTile(r){const e=new Ue(r.clone());return this._updateTile(e),e}_updateTile(r){this.updatingHandles.addPromise(this._fetchQueue.push(r.key).then(e=>{const[t,s]=r.setElements(e);this._acquireElements(r,t),this._releaseElements(r,s),this.requestUpdate()},e=>{ge(e)||F.getLogger(this.declaredClass).error(e)}))}_releaseTile(r){this._fetchQueue.abort(r.key.id),r.elements&&this._releaseElements(r,r.elements),this.requestUpdate()}async _queryElements(r,e){const t=this.layer.source;if(v(t))return[];this.view.featuresTilingScheme.getTileBounds(R,r,!0);const s=new we({xmin:R[0],ymin:R[1],xmax:R[2],ymax:R[3],spatialReference:this.view.spatialReference});return t.queryElements(s,e)}_acquireElements(r,e){const t=this.layer.source,s=this.view.spatialReference;if(!v(t))for(const i of e)Re(this._elementReferences,i.uid,()=>{const a=new m({element:i,spatialReference:s}),o=new ze(a);return this._overlayContainer.addChild(o),this.elements.add(i),{tiles:new Set,projectedElement:a,overlay:o}}).tiles.add(r)}_releaseElements(r,e){for(const t of e){const s=this._elementReferences.get(t.uid);s.tiles.delete(r),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t))}}};c([p()],_.prototype,"_fetchQueue",void 0),c([p()],_.prototype,"layer",void 0),c([p({readOnly:!0})],_.prototype,"elements",void 0),_=c([H("esri.views.2d.layers.MediaLayerView2D")],_);const R=Me();class Ue{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const i of e)s.has(i)?s.delete(i):t.push(i);return this.isReady=!0,[t,Array.from(s)]}}const ct=_;export{ct as default};
