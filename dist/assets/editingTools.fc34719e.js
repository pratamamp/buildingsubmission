import{e as h,g as p,n as C,y as ei,dD as rs,mb as ls,ae as hs,I as D,l as c,aH as ps,R as jt,w as v,mv as cs,rO as ds,jt as us,tC as Da,mc as gs,cS as X,me as fi,mQ as Mi,mg as ms,du as He,ey as Fe,dw as be,dp as ii,tD as _s,at as V,m as ut,hB as $a,m0 as k,r9 as vs,ln as ys,m3 as bi,W as fs,D as Ms,F as bs,gf as Vi,au as Ia,gF as Re,a6 as Tt,fk as Ni,m1 as Se,hX as Ze,nq as Ss,aU as ht,gb as di,b5 as T,tE as ws,aW as Ot,aX as At,np as ki,tF as xs,tG as Ce,gj as Os,tH as Hi,ao as Pa,gC as Ui,hk as Es,bg as As,tI as Ts,hU as ai,oD as Ca,l$ as Gs,tJ as Rs,tK as Fi,hH as xe,g9 as Z,tA as si,tB as mt,tL as Jt,gz as B,tM as Zi,h as Et,z as I,oz as et,nG as N,k7 as Vt,lK as ni,tN as za,hY as La,aV as Yi,tO as Ds,jD as $s,tP as Va,u as de,kD as Xi,mV as b,p3 as J,tQ as x,tR as Is,h8 as Ue,p2 as Na,dq as Y,pf as Ye,o7 as Gi,gM as oi,nF as Ps,oA as xt,os as Cs,i6 as z,lA as Xe,i4 as Be,lB as kt,nT as zs,tS as Ls,o8 as ka,tT as Vs,de as Si,ag as Ns,aG as he,dh as Ha,j as ks,tU as Hs,tV as Ua,tW as wi,oE as Us,Q as Ri,mw as De,mo as Fa,kw as Di,mm as Za,tX as Fs,mf as Bi,i5 as Zs,C as $i,tY as ve,aK as Ft,sm as ji,qk as Ys,hC as pe,mi as Yt,tZ as Ya,oB as Wi,t_ as Xs,ft as xi,oy as St,fN as Bs,t$ as js,u0 as Ws,J as je,da as qs,an as ot,qe as qi,mW as Xa,p1 as Ba,u1 as Ks,ob as Oe,i2 as Js,n_ as Ki,u2 as Ji,ox as Qs,bE as Oi,aY as tn,u3 as ja,u4 as Qi,nj as ta,mz as ea,oL as ae,nC as ie,ms as ia,u5 as en,u6 as an,md as Wa,u7 as sn,nh as Bt,oQ as nn,u8 as on,u9 as rn,oS as ln,oR as hn,ua as pn,ub as cn,nl as dn,oW as It,nE as aa,aq as ui,uc as sa,o$ as un,p0 as gn,no as mn,nA as _n,nD as vn,pa as yn,pc as fn,pe as Mn,ud as bn}from"./index.f5fb6b4d.js";import{x as Sn}from"./quantityFormatUtils.7fbf45d7.js";import{a as wn}from"./TextOverlayItem.d5360776.js";import{a as xn,_ as On,F as En,G as An,n as Tn,r as Gn,e as Gt,d as Ee,m as $e,b as Rn,f as Dn,l as $n,g as ze}from"./drawSurfaces.8e182b62.js";import{V as qa,g as Ae,G as Ka}from"./SnappingVisualizer3D.675e6b7d.js";import{u as In,_ as We,S as Pn}from"./PointVisualElement.aae50e18.js";import{t as Wt}from"./manipulatorUtils.58384725.js";import{N as Ii,G as Ja,h as Cn,T as zn,F as Ln,P as Vn,C as Ei}from"./dragEventPipeline3D.9e7bf15b.js";import{x as Nn,w as kn,p as pt,C as we,d as Hn,b as ue,G as Qa,D as se,c as ri,R as Un,M as Fn}from"./InteractiveToolBase.677ebdaf.js";import{C as Zn}from"./GraphicManipulator.332b58c5.js";import{S as li,T as na,X as Yn,E as wt,t as Xn,a as Bn,s as jn,c as Wn,e as oa}from"./EditGeometryOperations.50d7ddd5.js";import{e as qe}from"./SnappingContext.c3f58a7b.js";import{d as Ke,b as Je,v as qn,g as Kn}from"./euclideanLengthMeasurementUtils.d5b79ce8.js";import{y as Ht,o as Te,f as gi,s as ra}from"./quantityUtils.25484caf.js";import{l as Jn,v as Qn}from"./axisAngleDegrees.fd4b564b.js";import{o as to}from"./Factory.e783bc92.js";import"./geometryEngine.ec44d84f.js";import"./geometryEngineBase.cf4f989f.js";import"./hydrated.2bb80d4d.js";import"./dehydratedFeatureComparison.4428d1dd.js";import"./euclideanAreaMeasurementUtils.f54e9b68.js";import"./measurementUtils.86c15981.js";import"./RightAngleQuadVisualElement.73eb43f3.js";import"./drawUtils.f056f9c9.js";import"./PointSnappingHint.a7474f2b.js";const eo=3025,io={default:15,far:25};let dt=class extends ei{constructor(e){super(e),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const e=rs(async i=>{const a=await ls("esri/core/t9n/Units");hs(i),this._messagesUnits=a}),t=()=>Fe(this.context,i=>i.editGeometryOperations);this.own([D(()=>[c(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>ps(t,i,()=>this._update())),jt(()=>e.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return v(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(e=>e.label.text)}}get _edgeDistancePixels(){return io[this.edgeDistance]}_update(){this._nextLabelIndex=0;const e=this.context;if(v(e))return void this._destroyUnusedLabels();const{components:t,geometry:i,coordinateHelper:a}=e.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const s=t.length;for(let n=0;n<s;++n){const o=[];if(t[n].iterateVertices(u=>{o.push(a.toXYZ(u.pos))}),n===0&&c(this.stagedVertex)&&o.push(a.toXYZ(this.stagedVertex)),o.length<2)continue;const r=o[0],l=o[o.length-1];i.type==="polygon"&&o.length>2&&!cs(r,l)&&o.push(r);const d=s===1&&!ds(o,!1,!1);let g=ao,m=so;this.toScreenPointArray(e,r,g);for(let u=1;u<o.length;++u){const f=o[u-1],y=o[u];this.toScreenPointArray(e,y,m),this._addLabel(e,f,g,y,m,d),[g,m]=[m,g]}}this._destroyUnusedLabels()}_addLabel(e,t,i,a,s,n){const{label:o}=this._getOrCreateLabel(e);if(!this.visible||us(i,s)<eo)return void(o.visible=!1);const r=c(e.graphicState)?e.graphicState.isDraped?"on-the-ground":"absolute-height":Da(e.editGeometryOperations.data.geometry,e.elevationInfo),{spatialReference:l}=e.editGeometryOperations.data,d=xn(t,a,l,r),g=this._messagesUnits,m=gs(e.view);o.text=c(g)&&c(d)?Sn(g,d,m):"",o.visible=!0;const u=s[0]-i[0],f=s[1]-i[1];n?X(at,-f,u):X(at,f,-u),fi(at,at),Mi(at,at,this._edgeDistancePixels),ms(ye,i,s,.5),He(ye,ye,at),o.position=[ye[0],ye[1]],Math.abs(at[0])>Math.abs(at[1])?o.anchor=at[0]>0?"left":"right":o.anchor=-at[1]<0?"top":"bottom"}_getOrCreateLabel(e){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const t=new wn({fontSize:10,anchor:"center"});e.view.overlay.items.add(t);const i={label:t};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:e}){Fe(this.context,t=>t.view.overlay.items.remove(e)),e.destroy()}};h([p()],dt.prototype,"context",void 0),h([p()],dt.prototype,"stagedVertex",void 0),h([p()],dt.prototype,"visible",void 0),h([p()],dt.prototype,"edgeDistance",void 0),h([p()],dt.prototype,"updating",null),h([p()],dt.prototype,"_messagesUnits",void 0),h([p()],dt.prototype,"_edgeDistancePixels",null),dt=h([C("esri.views.interactive")],dt);const at=be(),ye=be(),ao=ii(),so=ii();let Qe=class extends dt{getCameraOrExtent({view:e}){return e.state.camera}toScreenPointArray({view:e,elevationInfo:t,editGeometryOperations:i},a,s=ii()){const{spatialReference:n}=i.data.coordinateHelper;return _s(a,n,t,e,la),e.state.camera.projectToScreen(la,s),s}};Qe=h([C("esri.views.3d.interactive.SegmentLabels3D")],Qe);const la=V(),M={main:new ut([255,127,0]),selected:new ut([255,255,255]),staged:new ut([12,207,255]),outline:new ut([0,0,0,.5]),selectedOutline:new ut([255,255,255])},le=.3;function Ge(e,t){const i=e.clone();return i.a*=t,i}function no(e,t){const i=e.clone(),a=vs(i);a.s*=t;const s=ys(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function it(e,t){if(t)for(const i in t)e[i]=t[i]}class oo{constructor(t){this.color=M.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=k.Opaque,it(this,t)}}class mi{constructor(t){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=M.main,this.outlineColor=M.outline,this.renderOccluded=k.Opaque,this.hoverOutlineColor=M.selectedOutline,it(this,t)}apply(t,i){const a=this[t];i.setParameters({color:Nt(a),transparent:t!=="color"||a.a<1,renderOccluded:this.renderOccluded})}}class ro{constructor(t){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=Ge(M.main,.5),this.hoverColor=M.main,this.renderOccluded=k.Transparent,this.minSquaredEdgeLength=900,it(this,t)}apply(t,i){const a=this[t];i.setParameters({color:Nt(a),transparent:a.a<1,renderOccluded:this.renderOccluded})}}class lo{constructor(t){this.vertex=new mi({color:M.main,outlineColor:M.outline}),this.edge=new mi({color:no(Ge(M.main,2/3),.5),outlineColor:Ge(M.outline,.5),size:8,collisionPadding:8}),this.selected=new mi({color:M.selected,outlineColor:M.outline}),this.edgeOffset=new ro,it(this,t)}}class Ai{constructor(t){this.color=M.selected,this.width=1.5,this.stipplePattern=bi(5),this.stippleOffColor=M.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=M.selected,this.renderOccluded=k.OccludeAndTransparent,it(this,t)}apply(t){t.color=Nt(this.color),t.width=this.width,t.stipplePattern=this.stipplePattern,t.stippleOffColor=Nt(this.stippleOffColor),t.falloff=this.falloff,t.innerWidth=this.innerWidth,t.innerColor=Nt(this.innerColor),t.renderOccluded=this.renderOccluded}}class ho{constructor(t){this.color=M.selected,this.size=4,this.outlineSize=1,this.outlineColor=M.outline,this.shape="square",it(this,t)}apply(t){t.color=Nt(this.color),t.size=this.size,t.outlineSize=this.outlineSize,t.outlineColor=Nt(this.outlineColor),t.primitive=this.shape}}class ti{constructor(t){this.innerColor=M.selected,this.innerWidth=1,this.glowColor=M.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=le,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=M.main,it(this,t)}apply(t,i=1){const a={glowColor:ut.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:ut.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=a:t.laserlineStyle=a}}class po{constructor(t){this.outline=new Ai({color:M.outline,renderOccluded:k.OccludeAndTransparentStencil,stippleOffColor:M.selected,stipplePattern:bi(5),width:1.5,innerWidth:0}),this.staged=new Ai({color:M.selected,renderOccluded:k.OccludeAndTransparentStencil,innerColor:M.staged,stippleOffColor:M.outline,stipplePattern:bi(5),width:1.5}),this.shadowStyle=new ti({globalAlpha:le,glowColor:M.main,glowFalloff:8,glowWidth:8,innerColor:M.selected,innerWidth:1}),it(this,t)}}class co{constructor(t){this.outline=new ho({color:M.selected,outlineColor:M.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new ti({globalAlpha:le,glowColor:M.main,glowFalloff:1.5,glowWidth:6,innerColor:M.selected,innerWidth:1,radius:2}),it(this,t)}}class uo extends Ai{constructor(t){super(),this.extensionType=qa.GROUND_RAY,it(this,t)}}class go{constructor(t){this.lineGraphics=new po,this.pointGraphics=new co,this.heightPlane=new ti({globalAlpha:le,glowColor:M.main,glowFalloff:8,glowWidth:8,innerColor:M.selected,innerWidth:1}),this.heightBox=new ti({globalAlpha:le,glowColor:M.main,glowFalloff:8,glowWidth:8,innerColor:M.selected,innerWidth:0,heightFillColor:M.main}),this.zVerticalLine=new uo({color:Ge(M.main,5*le/3),falloff:2,innerColor:Ge(M.selected,0),renderOccluded:k.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:qa.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,it(this,t)}}class mo{constructor(t){this.visualElements=new go,this.reshapeManipulators=new lo,this.zManipulator=new oo,it(this,t)}colorToVec4(t){return Nt(t)}}function Nt(e){return $a(ut.toUnitRGBA(e))}const _=new mo;class _o{constructor(t){this.resourceFactory=t,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return c(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(t){t!==this._attached&&(this._attached=t,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?v(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?v(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var s;this._destroyResources();const t=this.resourceFactory.createResources(),i=new ne({view:this.resourceFactory.view}),a=(s=this.resourceFactory.view.basemapTerrain)==null?void 0:s.overlayManager;this._resources={layerView:new ne({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},a&&(this._resources.drapeSourceRenderer=a.registerGeometryDrapeSource(i)),this._syncGeometriesToRenderer()}_destroyResources(){var i;if(v(this._resources))return;this._ensureRenderGeometriesRemoved();const t=(i=this.resourceFactory.view.basemapTerrain)==null?void 0:i.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){v(this._resources)||v(this._resources.drapeSourceRenderer)||!this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,Vi.Geometry.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){v(this._resources)||v(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,Vi.Geometry.UPDATE),this._resources.geometriesAdded=!0)}}let ne=class extends fs(ei){constructor(e){super(e),this.drapeSourceType=Ms.Features,this.updatePolicy=bs.SYNC}};h([p({constructOnly:!0})],ne.prototype,"view",void 0),h([p({readOnly:!0})],ne.prototype,"drapeSourceType",void 0),ne=h([C("DrapedVisualElementLayerView")],ne);class Kt{constructor(t){this.view=null,this._attachmentOrigin=Re(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new Tt,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Ni(1,0,1,1),this._innerWidth=0,this._innerColor=Ni(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=k.OccludeAndTransparentStencil,this.resources=new In({view:t.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometries.length=0,this._recreateGeometry(s,a.material,a.geometries),a.geometries)}),this._attachmentOrigin.spatialReference=t.view.spatialReference,this.drapedResources=new _o({view:t.view,createResources:()=>this._createDrapedResources(),recreateGeometry:a=>{a.geometries=this._createRenderGeometriesDraped(a.material),this._attachmentOriginChanged()}});let i=!0;this._laserline=new We({view:t.view});for(const a in t)a in this?a==="attached"?i=t[a]:this[a]=t[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(t){t!==this._isDraped&&(this._isDraped=t,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&c(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(t){this.resources.visible=t,this.drapedResources.visible=t,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(t){this._updateAttached(t)}_updateAttached(t){this.resources.attached=!this.isDraped&&t,this.drapedResources.attached=this.isDraped&&t,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get color(){return this._color}set color(t){Se(t,this._color)||(Ze(this._color,t),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){Se(t,this._innerColor)||(Ze(this._innerColor,t),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=c(t)!==c(this._stipplePattern);this._stipplePattern=t,i?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&Se(t,this._stippleOffColor)||(this._stippleOffColor=t?Ss(t):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this.laserlineAttached,c(t)&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=c(this.resources.resources)?this.resources.resources.geometries:null;if(!t||t.length===0)return null;ht(Qt,0,0,0);let i=0;for(const a of t){const s=a.vertexAttributes.get(di.POSITION),n=a.indices.get(di.POSITION),o=T(this.resources.resources).material.isClosed(s.data,n);ws(s,n,o,ha)&&(Ot(Qt,Qt,ha),i++)}return i===0?null:(At(Qt,Qt,1/i),this.view.renderCoordsHelper.fromRenderCoords(Qt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){c(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),c(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return c(this.geometry)&&this.geometry.type==="polygon"}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===k.OccludeAndTransparentStencil?k.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(t,i,a){const s=this._createRenderGeometries();for(const n of s)t.addGeometry(n,i),a.push(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(t){const i=new ki(this.materialParameters),a=[];return this._recreateGeometry(t,i,a),{material:i,geometries:a,forEach:s=>{s(i),a.forEach(s)}}}_createDrapedResources(){const t=new ki(this.materialParameters);return{material:t,geometries:this._createRenderGeometriesDraped(t)}}_createRenderGeometriesDraped(t){const i=this.geometry;if(v(i))return[];const a=xs(i,this.view.basemapTerrain.spatialReference),s=[];for(const{position:n}of a.lines){const o={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:n},removeDuplicateStartEnd:this.isClosed?Ce.REMOVE:Ce.KEEP},r=new Os(Hi(o),t),l=Pa(vo);Ui(l,n),Es(r.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),s.push(r)}return s}calculateMapBounds(t){if(v(this.resources.resources))return!1;const i=this.view.renderCoordsHelper;for(const a of this.resources.resources.geometries){const s=a.vertexAttributes.get(di.POSITION),n=new Float64Array(s.data.length);As(s.data,i.spatialReference,0,n,this.view.spatialReference,0,s.data.length/3),Ui(t,n)}return!0}_createRenderGeometries(){var n;const t=this.geometry;if(v(t))return[];const i=Ts(t,this.view.elevationProvider,this.view.renderCoordsHelper,ai.fromElevationInfo((n=this.elevationInfo)!=null?n:new Ca({mode:Da(t,null)}))),a=[],s=[];for(const{position:o,mapPosition:r}of i.lines){const l={overlayInfo:null,attributeData:{position:o,mapPosition:r},removeDuplicateStartEnd:this.isClosed?Ce.REMOVE:Ce.KEEP};a.push(Hi(l)),s.push(o)}return this._laserline.pathVerticalPlane=s,a}}const vo=Ia(),ha=V(),Qt=V();class pa extends Gs{constructor(t){super(t),this.view=null,this._renderOccluded=k.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=_.colorToVec4(_.reshapeManipulators.vertex.color),this._size=_.reshapeManipulators.vertex.size,this._outlineColor=_.colorToVec4(_.reshapeManipulators.vertex.outlineColor),this._outlineSize=_.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(t){this._vertices=t,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(t){this._spatialReference=t,this.recreateGeometry()}get color(){return this._color}set color(t){Se(t,this._color)||(Ze(this._color,t),this._updateMaterial())}get size(){return this._size}set size(t){t!==this._size&&(this._size=t,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(t){Se(t,this._outlineColor)||(Ze(this._outlineColor,t),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(t){t!==this._outlineSize&&(this._outlineSize=t,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const t=this.vertices;if(v(t)||t.length===0)return[];const i=.5,a=.5,s=Rs(t,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,ai.fromElevationInfo(this.elevationInfo)),n=[],o=s.numVertices,r=s.position;for(let l=0;l<o;++l){const d=ht(yo,r[3*l+0],r[3*l+1],r[3*l+2]),g=ca(i,d),m=ca(a,d);n.push({vertexGeometry:g,vertexOutlineGeometry:m})}return n}createGeometries(t){const i=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:s}of i)t.addGeometry(a,this.vertexMaterial),t.addGeometry(s,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new Fi({...this.vertexMaterialParameters,writeDepth:!0,cullFace:xe.Back,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new Fi({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:xe.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(t){t(this.vertexMaterial),t(this.vertexOutlineMaterial)}}const yo=V();function ca(e,t){return Z.createSphereGeometry(e,16,16,{offset:t})}let Pt=class extends On{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.labelOptions=new si,this.tooltipOptions=new mt,this.type="draw-3d"}initialize(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Ca({mode:e,offset:t})}normalizeCtorArgs(e){var t;if(!e.elevationInfo){const i=(t=e.hasZ)!=null?t:!0;return{...e,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return e}initializeGraphic(e){const t=this._createGraphicState=new Jt({graphic:e});return B([this.view.maskOccludee(e),this.view.trackGraphicState(t),D(()=>({element:this._outlineVisualElement,isDraped:t.isDraped}),({element:i,isDraped:a})=>{Fe(i,s=>s.isDraped=a)},Et)])}makeDrawOperation(){const{geometryType:e}=this,t=e!=="circle"&&e!=="rectangle";return new En({view:this.view,manipulators:this.manipulators,geometryType:An(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Tn(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Gn(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Ae,segmentLabels:t?new Qe:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Zi(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(e){return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[e],null):(this._activeVertexVisualElement=new pa({view:this.view,spatialReference:this.view.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:_.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=_.colorToVec4(_.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,jt(()=>{this._activeVertexVisualElement=I(this._activeVertexVisualElement)}))}onOutlineChanged(e){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Kt({view:this.view,geometry:e,elevationInfo:t,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Zi(this.hasZ,t)==="on-the-ground",attached:!1}),_.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),_.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,jt(()=>{this._outlineVisualElement=I(this._outlineVisualElement)})}onRegularVerticesChanged(e){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=e,null):(this._verticesVisualElement=new pa({view:this.view,spatialReference:this.view.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:_.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,jt(()=>{this._verticesVisualElement=I(this._verticesVisualElement)}))}};h([p({constructOnly:!0})],Pt.prototype,"elevationInfo",void 0),h([p({constructOnly:!0})],Pt.prototype,"geometryType",void 0),h([p({constructOnly:!0,type:si})],Pt.prototype,"labelOptions",void 0),h([p({constructOnly:!0,type:mt})],Pt.prototype,"tooltipOptions",void 0),h([p()],Pt.prototype,"type",void 0),h([p({constructOnly:!0})],Pt.prototype,"view",void 0),Pt=h([C("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Pt);var O;(function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"})(O||(O={}));var rt;(function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"})(rt||(rt={}));class ts{constructor(){this.grabbingState=rt.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=rt.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((i,a)=>{if(a===O.TRANSLATE_Z&&(this.zManipulator=i),i instanceof et&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),v(this.firstGrabbedXY)&&i.grabbing&&a===O.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=rt.ANY,a){case O.TRANSLATE_Z:this.grabbingState|=rt.Z;break;case O.TRANSLATE_XY:this.grabbingState|=rt.XY}})}}function fo(e){const{view:t,graphic:i}=e,a=new Jt({graphic:i}),s=Mo(e,a),n=[s,bo(e,s.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:s.visualElement,remove:()=>B(n).remove()}}function Mo(e,t){const{view:i,graphic:a}=e,s=new Kt({view:i,geometry:Ti(a)?a.geometry:null,elevationInfo:N(a),attached:!1});_.visualElements.lineGraphics.shadowStyle.apply(s);const n=()=>{s.attached=t.displaying};_.visualElements.lineGraphics.outline.apply(s);const o=[D(()=>t.displaying,n),D(()=>t.isDraped,r=>{s.isDraped=r}),t.on("changed",()=>s.geometry=Ti(a)?a.geometry:null),Vt(s)];return n(),{visualElement:s,remove:()=>B(o).remove()}}function bo(e,t,i){const{graphic:a,view:s}=e,n=[],o=N(a),r=o.mode==="on-the-ground"||!o.offset&&o.mode!=="absolute-height",l=new ts,d=new Ka({view:s,extensionType:_.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:k.OccludeAndTransparent});_.visualElements.pointGraphics.shadowStyle.apply(d);const g=ni(_.visualElements.heightPlaneAngleCutoff),m=new We({view:s,attached:!1,angleCutoff:g});_.visualElements.heightPlane.apply(m);let u=1,f=1;const y=()=>{if(l.update(e),!i.displaying||r&&(i.isDraped||!Ti(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,d.attached=!1,void(m.attached=!1);t.laserlineEnabled=!0;{const w=l.grabbingState&rt.XY?_.visualElements.laserlineAlphaMultiplier:1;w!==u&&(u=w,_.visualElements.lineGraphics.shadowStyle.apply(t,w),_.visualElements.pointGraphics.shadowStyle.apply(d,w))}{const w=l.grabbingState&rt.Z?_.visualElements.laserlineAlphaMultiplier:1;w!==f&&(f=w,_.visualElements.heightPlane.apply(m,w))}So(d,l),wo(e,t,m,l)};_.visualElements.zVerticalLine.apply(d),n.push(i.on("changed",y),D(()=>i.displaying,y),t.events.on("attachment-origin-changed",y),Vt(d),Vt(m));const S=[],A=()=>{B(S).remove(),S.length=0,e.forEachManipulator(w=>S.push(w.events.on("grab-changed",y))),e.forEachManipulator(w=>S.push(w.events.on("select-changed",y))),y()};return A(),n.push(e.onManipulatorsChanged(A),za(()=>B(S))),B(n)}function So(e,t){const i=t.numSelected===1?t.firstSelected:t.numSelected>1&&c(t.firstGrabbedXY)?t.firstGrabbedXY:null;c(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}function wo(e,t,i,a){if(a.numSelected>0){ht(Zt,0,0,0);let s=0;e.forEachManipulator((n,o)=>{o===O.TRANSLATE_XY&&n.selected&&n instanceof et&&(Ot(Zt,Zt,n.renderLocation),s++)}),s>0?(i.heightManifoldTarget=At(Zt,Zt,1/s),i.attached=!0):i.attached=!1}else{const s=t.attachmentOrigin;c(s)&&e.view.renderCoordsHelper.toRenderCoords(s,Zt)?(i.heightManifoldTarget=Zt,i.attached=!0):i.attached=!1}}function Ti(e){return c(e.geometry)&&(e.geometry.type==="polygon"||e.geometry.type==="polyline")}const Zt=V();function xo(e){const{view:t,graphic:i}=e,a=new Jt({graphic:i}),s=[],n=Eo(e,a,s);return Oo(e,a,s,n),s.push(t.trackGraphicState(a)),{visualElement:n,remove(){B(s).remove()}}}function Oo(e,t,i,a){const{view:s,graphic:n}=e,o=new Ka({view:s,extensionType:_.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:k.OccludeAndTransparent});_.visualElements.zVerticalLine.apply(o);const r=new We({view:s,intersectsLineInfinite:!0,attached:!1});_.visualElements.pointGraphics.shadowStyle.apply(r);const l=ni(_.visualElements.heightPlaneAngleCutoff),d=new We({view:s,attached:!1,angleCutoff:l});_.visualElements.heightPlane.apply(d);const g=N(e.graphic),m=ai.fromElevationInfo(g),u=g.mode==="on-the-ground"||!g.offset&&g.mode!=="absolute-height",f=new ts;let y=1,S=1;const A=()=>{f.update(e);const w=Pi(n),G=u&&(t.isDraped||v(w)||!w.hasZ);let j=!0;if(!G&&c(w)){const P=La(w,s.elevationProvider,m,s.renderCoordsHelper);ht(nt,w.x,w.y,P),Yi(nt,w.spatialReference,nt,s.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(nt),r.intersectsWorldUpAtLocation=nt}else j=!1;const ge=f.grabbingState&rt.Z?_.visualElements.laserlineAlphaMultiplier:1;ge!==y&&(y=ge,_.visualElements.heightPlane.apply(d,ge));const me=Pa(Ro);!G&&t.displaying&&a.calculateMapBounds(me)&&Yi(Ds(me,nt),s.spatialReference,nt,s.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=nt,d.attached=!0):d.attached=!1;const _t=f.grabbingState&rt.XY?_.visualElements.laserlineAlphaMultiplier:1;_t!==S&&(S=_t,_.visualElements.pointGraphics.shadowStyle.apply(r,_t));const Pe=j&&t.displaying&&!G;r.attached=Pe,o.attached=Pe};i.push(D(()=>[t.displaying,t.isDraped],A),t.on("changed",A)),e.forEachManipulator(w=>{i.push(w.events.on("grab-changed",A))}),i.push(Vt(r)),i.push(Vt(o)),i.push(Vt(d)),A()}function Eo(e,t,i){const{view:a,graphic:s}=e,n=new Pn({view:a,geometry:Pi(s),elevationInfo:N(s),attached:!1});return Ao(e,n,t,i),i.push(Vt(n)),n}function Pi(e){const t=e.geometry;return v(t)?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function Ao(e,t,i,a){const s=()=>t.attached=i.displaying;To(e,t,i,a),_.visualElements.pointGraphics.outline.apply(t),a.push(D(()=>i.displaying,s,Et))}function To(e,t,i,a){const{view:s,graphic:n}=e;let o=null;const r=d=>{c(o)&&(o.remove(),o=null),i.isDraped&&c(d)&&(o=Go(s,d,()=>{t.geometry=d}))},l=()=>{const d=Pi(n);r(d),t.geometry=d};a.push(i.on("changed",l),za(()=>o)),l()}function Go(e,t,i){const a=e.elevationProvider.spatialReference;$s(t,nt,a);const s=nt[0],n=nt[1];return e.elevationProvider.on("elevation-change",o=>{Va(o.extent,s,n)&&i()})}const nt=V(),Ro=Ia();function hi(e){switch(T(e.graphic.geometry).type){case"point":case"mesh":return xo(e);case"polygon":case"polyline":return fo(e);default:return null}}const Do=[1,.5,0],es=128,gt=70,$o=80,is=.02,Io=54,Po=100,as=Math.ceil(gt/3*2),Xt=160,_i=.5,vi=24,te=9,Co=Xt+30,da=Xt+53,zo=60,Lo=23,Vo=5*Math.PI/12,No=1*Math.PI/3,ua=10,ga=.2,ma=30,_a=53,va=.2,ya=.3,ko=200,Ho=3,Uo=1e6;class Ie{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(i=>i.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(i=>i.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(i=>i.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(i=>{t||(t=i.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(i=>i.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(i=>i===t)}someManipulator(t){let i=!1;return this.forEachManipulator(a=>{!i&&t(a)&&(i=!0)}),i}_forEachManipulator3D(t){this.forEachManipulator((i,a)=>{i instanceof et&&t(i,a)})}}function pi(e,t,i,a){const s=e.graphic,n=(o,r)=>t({action:o,graphic:s,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY});return i((o,r,l)=>{const d=r.next(g=>(g.action==="start"&&n("start",g),g)).next(Nn(s,a)).next(g=>{switch(g.action){case"start":case"update":(g.translationX||g.translationY||g.translationZ)&&n("update",g);break;case"end":n("end",g)}return g});return l.next(kn(s)).next(()=>{n("end",{screenDeltaX:0,screenDeltaY:0})}),d})}function ss(e){if(v(e)||e.type!=="polyline"&&e.type!=="polygon")return 0;const t=(e.type==="polyline"?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class Fo extends Ie{constructor(t){super(),this._handles=new de,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=gt,this._updateAfterDrag=!1,this.events=new Tt,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(t){this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._handles=I(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:i}of this._arrowManipulatorInfos)t(i,O.TRANSLATE_XY)}createGraphicDragPipeline(t,i,a){const s=i.graphic,n=N(s),o=T(s.geometry).spatialReference;return pi(i,a,r=>this.createDragPipeline((l,d,g,m,u)=>r(l,t(l,d,g,m,u),g),n,o,s),this._view.state.viewingMode)}createDragPipeline(t,i,a,s){return B(this._arrowManipulatorInfos.map(({manipulator:n},o)=>pt(n,(r,l,d,g,m)=>{const u=l.next(f=>({...f,manipulatorType:O.TRANSLATE_XY})).next(we(this._view,r.elevationAlignedLocation)).next(Ii(this._view,r.elevationAlignedLocation,i,a,s)).next(Hn(r.location,this.angle+(o+1)*Math.PI*.5)).next(ue());t(r,u,d,g,m)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:i},a){const s=this._radius/gt,n=Io*s,o=n*Math.sqrt(3)/2,r=Z.createExtrudedTriangle(o,n/2,n/2,is);Z.transformInPlace(r,Xi(J.get(),ht(b.get(),0,-o/3,0))),t.renderObjects=[{geometry:r,material:this._opaqueMaterial,stateMask:x.Focused},{geometry:r,material:this._transparentMaterial,stateMask:x.Unfocused}],t.radius=o/3*2*1.2;const l=Is(J.get(),a*Math.PI/2),d=Xi(J.get(),ht(b.get(),0,Po*s,0));Ue(i,l,d)}_createManipulators(){for(let t=0;t<4;t++){const i=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,i=Na(J.get(),t,Y(0,0,1));if(v(i))return;const a=Ye(J.get(),ht(b.get(),this.displayScale,this.displayScale,this.displayScale)),s=Ue(J.get(),a,i);for(const n of this._arrowManipulatorInfos){const o=Ue(J.get(),s,n.transform);n.manipulator.modelTransform=o}}_createArrowManipulator(t){const i=new et({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Y(0,0,1)}}),a={manipulator:i,transform:oi()};return this._updateArrowManipulator(a,t),this._handles.add(i.events.on("drag",s=>{this._updateAfterDrag&&s.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(t=1){const i=ut.toUnitRGBA(M.main);return i[3]*=t,new Gi({color:i,transparent:t!==1,cullFace:xe.Back,renderOccluded:k.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}}class Zo{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Qa,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&c(this.lastDragEvent)){const i=this.lastDragEvent.mapEnd,a=this._snap(this.lastDragEvent.screenEnd);if(c(a)){const s={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:t===!0?a:i,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(s)}}this._enabled=t}_snap(t){const i=c(this.view)?this.view.toMap(t,{exclude:[]}):null;return c(i)&&c(this.view)&&(i.z=Ps(i,this.view,this.elevationInfo)),i}createDragEventPipelineStep(t,i){return this.view=t,this.elevationInfo=i,this.lastDragEvent=null,a=>{if(this.lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const s=this._snap(a.screenEnd);return c(s)?{action:a.action,mapStart:a.mapStart,mapEnd:s,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class Yo extends Ie{constructor(t){super(),this._snapToScene=new Zo,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=gt,this._view=t.view,this._tool=t.tool,t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,O.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,i,a){const s=i.graphic,n=N(s),o=T(s.geometry).spatialReference;return pi(i,a,r=>this.createDragPipeline((l,d,g,m,u)=>r(l,t(l,d,g,m,u),g),n,o,s),this._view.state.viewingMode)}createDragPipeline(t,i,a,s){const n=this._view;return pt(this._manipulator,(o,r,l,d,g)=>{const m=r.next(we(n,o.elevationAlignedLocation)).next(Ii(n,o.elevationAlignedLocation,i,a,s)).next(this._snapToScene.createDragEventPipelineStep(n,i),this._snapToScene.next).next(u=>({...u,manipulatorType:O.TRANSLATE_XY})).next(ue());t(o,m,l,d,g)})}_updateManipulatorTransform(){const t=Ye(J.get(),ht(b.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new et({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Y(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=Z.createCylinderGeometry(is,1,es,Y(0,0,1),Y(0,0,0)),i=Ye(oi(),Y(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:t,material:this._discMaterial,transform:i,stateMask:x.Focused},{geometry:t,material:this._discMaterialTransparent,transform:i,stateMask:x.Unfocused}],this._manipulator.radius=$o*(this._radius/gt)}_createMaterial(t=1){const i=ut.toUnitRGBA(M.main);return i[3]*=t,new Gi({color:i,transparent:t!==1,cullFace:xe.Back,renderOccluded:k.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Xo extends Ie{constructor(t){super(),this._radius=gt,this.events=new Tt,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,O.TRANSLATE_Z)}createGraphicDragPipeline(t,i,a){const s=T(i.graphic.geometry).spatialReference;return pi(i,a,n=>this.createDragPipeline((o,r,l,d,g)=>n(o,t(o,r,l,d,g),l),s),this._view.state.viewingMode)}createDragPipeline(t,i){const a=this._view;return pt(this._manipulator,(s,n,o,r,l)=>{const d=n.next(g=>({...g,manipulatorType:O.TRANSLATE_Z})).next(Ja(a,s.renderLocation,i)).next(ue());t(s,d,o,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._radius/gt,i=_.zManipulator.height*t,a=_.zManipulator.coneHeight*t,s=_.zManipulator.coneWidth*t,n=_.zManipulator.width*t,o=[Y(0,0,0),Y(0,0,i)],r=Z.createTubeGeometry(o,n/2,16,!1),l=Z.createConeGeometry(a,s/2,16,!1),d=[Y(0,0,0),Y(0,0,i+a)],g=w=>{const G=oi();if(zs(G,G,[0,0,i]),Ls(G,G,Math.PI/2),w){const j=1+2*w/s;ka(G,G,[j,j,j])}return G},m=g(0),u=(w,G)=>{const j=Vs(_.zManipulator.color,G);return[j.r/255,j.g/255,j.b/255,_.zManipulator.color.a*w]},f=xt(u(1,.25),k.Occlude),y=xt(u(1,0),k.Occlude),S=xt(u(.7,0),_.zManipulator.renderOccluded),A=xt(u(.85,0),_.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:m,material:f,stateMask:x.Unfocused},{geometry:r,material:f,stateMask:x.Unfocused},{geometry:l,transform:m,material:y,stateMask:x.Focused},{geometry:r,material:y,stateMask:x.Focused},{geometry:l,transform:m,material:S,stateMask:x.Unfocused},{geometry:r,material:S,stateMask:x.Unfocused},{geometry:l,transform:m,material:A,stateMask:x.Focused},{geometry:r,material:A,stateMask:x.Focused}],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[d]}}_createManipulator(){const t=new et({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=i=>{const a=this._view.state.camera,s=fa;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const n=Cs(a.eye,s),o=a.computeRenderPixelSizeAtDist(n),r=z(ee,s,a.eye);Xe(r,r);const l=Bo;this._view.renderCoordsHelper.worldUpAtPosition(fa,l);const d=Math.abs(Be(r,l)),g=kt(ee,r,l),m=kt(ee,g,l),u=Si(d,.01,1),f=1-Math.sqrt(1-u*u)/u/a.fullWidth,y=this._radius/gt,S=_.zManipulator.width*y;At(m,Xe(m,m),(1/f-1)*n+o*S),i[12]-=ee[0],i[13]-=ee[1],i[14]-=ee[2]},this._manipulator=t,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const fa=V(),ee=V(),Bo=V();class qt extends Ie{constructor(t){super(),this._handles=new de,this._angleDeferred=null,this._interactive=!0;const{tool:i,view:a,snapToScene:s,radius:n}=t;this._view=a,this.xyManipulation=new Yo({tool:i,view:a,snapToScene:s,radius:n}),this.xyAxisManipulation=new Fo({tool:i,view:a,radius:n}),this.zManipulation=new Xo({tool:i,view:a,radius:n}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(o=>{this._handles.add(o.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,i,a){return B([this.xyManipulation.createGraphicDragPipeline((s,n,o,r,l)=>t(R.XY,s,n,o,r,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((s,n,o,r,l)=>t(R.XY_AXIS,s,n,o,r,l),i,a),this.zManipulation.createGraphicDragPipeline((s,n,o,r,l)=>t(R.Z,s,n,o,r,l),i,a)])}createDragPipeline(t,i,a,s){return B([this.xyManipulation.createDragPipeline((n,o,r,l,d)=>t(R.XY,n,o,r,l,d),i,a,s),this.xyAxisManipulation.createDragPipeline((n,o,r,l,d)=>t(R.XY_AXIS,n,o,r,l,d),i,a,s),this.zManipulation.createDragPipeline((n,o,r,l,d)=>t(R.Z,n,o,r,l,d),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this._angleDeferred=null,this.xyAxisManipulation.angle=t}set angleDeferred(t){this.xyAxisVisible?this.angle=t():this._angleDeferred=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(i=>t(i,O.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>t(i,O.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>t(i,O.TRANSLATE_Z))}get xyAxisVisible(){const t=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,i=this.xyManipulation;if(Ns("esri-mobile"))return;const a=[];i.forEachManipulator(n=>a.push(n)),t.forEachManipulator(n=>a.push(n));const s=()=>{const n=[];this.xyAxisVisible?c(this._angleDeferred)&&(this.angle=this._angleDeferred()):t.forEachManipulator(o=>n.push(o.disableDisplay())),this._handles.remove(Ma),this._handles.add(n,Ma)};for(const n of a)this._handles.add(n.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(he(()=>{var n;return(n=this._view.inputManager)==null?void 0:n.latestPointerType},s)),s()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(i=>{i.interactive=!t&&this._interactive||i.grabbing})}static radiusForSymbol(t){const i=c(t)&&t.type==="point-3d"&&t.symbolLayers;return!!i&&i.length>0&&i.some(a=>a.type==="icon")?as:gt}}const Ma="disable-xy-axis-display";var R;(function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"})(R||(R={}));class Ci extends Ie{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,O.TRANSLATE_XY)}createGraphicDragPipeline(t){return pi(this._graphicState,t,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(t){const i=this._view,a=this._graphicState.graphic,s=c(a.geometry)?a.geometry.spatialReference:null;return pt(this._manipulator,(n,o,r,l,d)=>{const g=o.next(Cn(d,i,a,s)).next(se()).next(ue());t(n,g,r,l,d)})}_createManipulator(){const t=this._view,i=this._graphicState.graphic;this._manipulator=new Zn({graphic:i,view:t,selectable:!0,cursor:"move"})}}let tt=class extends Gt{constructor(e){super(e),this.type="translate-graphic",this.distance=Ht}};h([p()],tt.prototype,"type",void 0),h([p()],tt.prototype,"distance",void 0),tt=h([C("esri.views.interactive.tooltip.TranslateGraphicTooltipInfo")],tt);let lt=class extends Gt{constructor(e){super(e),this.type="translate-z",this.distance=Ht}};h([p()],lt.prototype,"type",void 0),h([p()],lt.prototype,"distance",void 0),lt=h([C("esri.views.interactive.tooltip.TranslateZTooltipInfo")],lt);let Ct=class extends Gt{constructor(e){super(e),this.type="translate-vertex",this.distance=Ht,this.elevation=null,this.area=null,this.totalLength=null}};h([p()],Ct.prototype,"type",void 0),h([p()],Ct.prototype,"distance",void 0),h([p()],Ct.prototype,"elevation",void 0),h([p()],Ct.prototype,"area",void 0),h([p()],Ct.prototype,"totalLength",void 0),Ct=h([C("esri.views.interactive.tooltip.TranslateVertexTooltipInfo")],Ct);class jo{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class Wo{constructor(t,i,a){this.dx=t,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class ba{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}let vt=class extends Ha(Tt.EventedMixin(ri)){constructor(e){super(e),this.graphics=new ks,this.enableZ=!0,this.tooltipOptions=new mt,this.type="move-3d",this._snappingPipeline=new Ke,this._tooltip=null}initialize(){const{graphics:e,view:t}=this;this.own([e.on("change",()=>this._refreshManipulators()),D(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new $e({view:t}):I(this._tooltip)},Ri)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=I(this._tooltip),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter(t=>Hs(t)===Ua.SUPPORTED).map(t=>new qo(t));e.length&&(this._createManipulators(e),this._createVisualElements(e),this.handles.add(e.map(t=>this.view.trackGraphicState(t.state))),this._updateMoveManipulation(e))}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ci({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator(a=>this.handles.add([a.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:i.graphic}),s.stopPropagation()}),a.events.on("grab-changed",({action:s})=>{const{tooltipOptions:n,_tooltip:o}=this;v(o)||(s==="focus"?o.info=new tt({tooltipOptions:n}):o.clear())})])),this.handles.add(t.manipulationXY.createDragPipeline((a,s,n,o)=>this._buildDragEventPipeline(e,R.XY,a,s,n,o)))}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new qt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:e.length===1?qt.radiusForSymbol(e[0].graphic.symbol):gt});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((s,n)=>{this.handles.add(s.events.on("immediate-click",o=>{t.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",{...o,graphic:this.graphics.getItemAt(0)}),o.stopPropagation()})),n===O.TRANSLATE_XY&&this.handles.add(s.events.on("focus-changed",({action:o})=>{const{tooltipOptions:r,_tooltip:l}=this;v(l)||(o==="focus"?l.info=new tt({tooltipOptions:r}):l.clear())})),n===O.TRANSLATE_Z&&this.handles.add(s.events.on("focus-changed",({action:o})=>{const{tooltipOptions:r,_tooltip:l}=this;v(l)||(o==="focus"?l.info=new lt({tooltipOptions:r}):l.clear())}))});const i=()=>this._updateMoveManipulation(e);for(const s of e)this.handles.add([s.state.on("changed",i),D(()=>s.state.displaying,i)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(t.createDragPipeline((s,n,o,r,l)=>this._buildDragEventPipeline(e,s,n,o,r,l),N(a.graphic),T(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(e){for(const t of e){const i=t.graphic,a=hi({view:this.view,graphic:i,forEachManipulator:s=>{t.manipulationXY.forEachManipulator(s),this._moveManipulation.forEachManipulator(s)},onManipulatorsChanged:()=>jt()});v(a)||(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Kt&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(e)}),D(()=>t.state.isDraped,()=>this._updateMoveManipulation(e))]),this.handles.add(a))}}_updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>ss(e.graphic.geometry)}_updateMoveManipulation(e){const t=Re(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const n of e){if(!n.state.displaying)continue;const o=n.state.graphic;this.enableZ&&Wt(o)&&(a=!0);const r=n.geometryRepresentation instanceof Kt&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:wi(this.view,o);c(r)&&(t.x+=r.x,t.y+=r.y,t.z+=r.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,s.location=t,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(e,t,i,a,s,n){const o=[],r=[];let l=null,d=null;const g=()=>{for(const u of o)u.dragging=!1;o.length=0,r.length=0,l=null,d=null,this._moveManipulation.interactive=!0};if(e.length===1&&t===R.XY){const u=e[0].graphic;a=this._buildSnappingPipelineSteps(u,N(u),a,s,n)}const m=a.next(u=>{if(u.action==="start"){o.length=0,r.length=0;for(const f of e)f.dragging||!f.manipulationXY.hasManipulator(i)&&f.manipulationXY.grabbing||(o.push(f),r.push(f.graphic),f.dragging=!0);if(r.length!==0&&(this._moveManipulation.interactive=!1,l=Un(r,this.view.state.viewingMode),d=Fn(r),this.emit("graphic-move-start",new jo(r)),this.destroyed))return null}return r.length!==0?u:null}).next(u=>l(u)).next(u=>this._updateMoveTooltip(u,t,e)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const f=this.view.toScreen(u.mapStart),y=this.view.toScreen(u.mapEnd),S=y.x-f.x,A=y.y-f.y;if(this.emit("graphic-move",new Wo(S,A,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new ba(r)),this.destroyed)return null;g()}});return s.next(u=>d(u)).next(()=>{if(this.emit("graphic-move-stop",new ba(r)),this.destroyed)return null;g()}),m}_updateMoveTooltip(e,t,i){const{tooltipOptions:a,_tooltip:s}=this;if(v(s))return e;if(s.clear(),t===R.XY||t===R.XY_AXIS)if(e.action==="end")s.info=new tt({tooltipOptions:a});else{const n=i.length===0?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height",o=Ee(e.mapStart,e.mapEnd,n);c(o)&&(s.info=new tt({tooltipOptions:a,distance:o}))}return t===R.Z&&(e.action==="end"?s.info=new lt({tooltipOptions:a}):Fe(Je(e.mapStart,e.mapEnd),n=>{s.info=new lt({tooltipOptions:a,distance:n})})),e}_buildSnappingPipelineSteps(e,t,i,a,s){const n=e.geometry;if(v(n)||n.type!=="point"&&n.type!=="mesh")return i;const o=(n.type==="point"?n:n.anchor).clone(),r=new qe({elevationInfo:t,pointer:s,editGeometryOperations:li.fromGeometry(o,this.view.state.viewingMode),visualizer:new Ae,excludeFeature:e}),l=this.snappingManager;return i.next(d=>(o.z=Us(this.view,o,N(e),{mode:"absolute-height",offset:0}),{...d,snapOrigin:r.coordinateHelper.pointToVector(o)})).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:r,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};h([p({constructOnly:!0,nonNullable:!0})],vt.prototype,"view",void 0),h([p()],vt.prototype,"graphics",void 0),h([p({constructOnly:!0,nonNullable:!0})],vt.prototype,"enableZ",void 0),h([p({constructOnly:!0,type:mt})],vt.prototype,"tooltipOptions",void 0),h([p({constructOnly:!0})],vt.prototype,"snappingManager",void 0),h([p()],vt.prototype,"type",void 0),h([p()],vt.prototype,"updating",null),vt=h([C("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],vt);class qo{constructor(t){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Jt({graphic:t})}get graphic(){return this.state.graphic}}function Sa(e,t,i){const a=i.mode==="on-the-ground"?na.XY:na.XYZ;return new Yn(e,a,t,0)}function wa(e,t,i){const a=V();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const s=xa(e,t,De(i.plane)),n=xa(e,t,i.edgeDirection);if(v(s)||v(n))return null;const o=kt(V(),s,n);return Fa(a,o,Di())}function xa(e,t,i){const a=Re(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),s=V(),n=V();return e.renderCoordsHelper.toRenderCoords(t,s)&&e.renderCoordsHelper.toRenderCoords(a,n)?Za(n,s,n):null}function Ko(e,t,i){const a=De(e),s=Za(V(),t,i),n=kt(V(),s,a),o=kt(V(),s,n);return Fs(s[0],s[1],s[2],0,n[0],n[1],n[2],0,o[0],o[1],o[2],0,0,0,0,1)}function Jo(e,t,i){const a=i.projectToRenderScreen(e,Bi()),s=i.projectToRenderScreen(t,Bi());return c(a)&&c(s)?Zs(z(a,a,s)):0}let oe=class extends Gt{constructor(e){super(e),this.type="reshape-edge-offset",this.distance=Ht}};h([p()],oe.prototype,"type",void 0),h([p()],oe.prototype,"distance",void 0),oe=h([C("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],oe);let L=class extends Tt.EventedMixin($i){constructor(e){super(e),this._vertexManipulatorMaterial=xt(_.colorToVec4(_.reshapeManipulators.vertex.color),_.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=ve(_.colorToVec4(_.reshapeManipulators.vertex.outlineColor),_.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=ve(_.colorToVec4(_.reshapeManipulators.vertex.hoverOutlineColor),_.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=xt(_.colorToVec4(_.reshapeManipulators.edge.color),_.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=ve(_.colorToVec4(_.reshapeManipulators.edge.outlineColor),_.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=xt(_.colorToVec4(_.reshapeManipulators.edgeOffset.color),_.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=xt(_.colorToVec4(_.reshapeManipulators.edgeOffset.hoverColor),_.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=xt(_.colorToVec4(_.reshapeManipulators.selected.color),_.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=ve(_.colorToVec4(_.reshapeManipulators.selected.outlineColor),_.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=ve(_.colorToVec4(_.reshapeManipulators.selected.hoverOutlineColor),_.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new de,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=$.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new Ke,this._snappingPipelineHandle=new Ke,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:e,view:t}=this,i=this._graphicState=new Jt({graphic:e});this._tooltip=new $e({view:t}),this.own([D(()=>i.displaying,a=>{for(const s of this._manipulatorInfos)s.manipulator.available=a}),D(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:s,edgeOffsetEnabled:n})=>{c(a)&&(a.visible=s,a.edgeDistance=n?"far":"default")},Et),he(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),Et),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=I(this._segmentLabels),this._tooltip=I(this._tooltip),this._editGeometryOperations=I(this._editGeometryOperations),this._moveManipulation=I(this._moveManipulation),this._graphicMoveManipulation=I(this._graphicMoveManipulation),this._manipulatorHandles=I(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const e=this._manipulatorInfos.filter(t=>t.manipulator.selected&&t.type==="vertex");this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=I(this._moveManipulation),this._graphicMoveManipulation=I(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(v(this._editGeometryOperations))return;const e=N(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulators(e)}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(v(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return c(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(v(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return c(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(e=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),v(e)||(I(this._editGeometryOperations),this._editGeometryOperations=li.fromGeometry(e,this.view.state.viewingMode),this._createManipulators(),I(this._segmentLabels),this._segmentLabels=new Qe({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:N(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(e,t){if(t.action==="end")return t;let i=0;const a=[],s=this._manipulatorInfos.some(o=>o.type==="vertex"&&o.manipulator.selected),n=e===re.SELECTED_OR_ALL&&s;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.grabbing||n&&!o.manipulator.selected||a.push(o),i++);if(a.length===0)return t;if(this._moveVertices(a,t),a.length===i){if(this._updateEventState($.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState($.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t}_isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)t.type==="vertex"&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState($.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const s=[];for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected&&!n.manipulator.grabbing||n===e.info)&&s.push(n);this._moveVertices(s,e,wt.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case $.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case $.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case $.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case $.MOVING:switch(this._reshapeEventState){case $.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case $.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case $.RESHAPING:switch(this._reshapeEventState){case $.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case $.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){const{graphic:t,handles:i,tool:a,view:s}=this,n=this._graphicState;if(this._graphicMoveManipulation=new Ci({tool:a,view:s,graphicState:n}),this.enableMoveGraphic){let l=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((d,g,m)=>{g.next(u=>this._trackNumDragging(u)).next(u=>(u.action==="start"&&(l=T(this._editGeometryOperations).createUndoGroup()),u)).next(u=>this._perGraphicManipulatorDragAction(re.ALL,u)).next(u=>(this._updateTranslateGraphicTooltip(R.XY,u),u)).next(u=>{u.action==="end"&&(this._tooltip.clear(),l=Ft(l))}),m.next(this._cancelDragOperation(()=>l=Ft(l)))}))}else this._graphicMoveManipulation.forEachManipulator(l=>{l.grabbable=!1,l.cursor=null});this._graphicMoveManipulation.forEachManipulator(l=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",d=>{this._manipulatorInfos.some(g=>g.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...d,graphic:this.graphic}),d.stopPropagation()})])),this._moveManipulation=new qt({tool:a,view:s,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Wt(t),snapToScene:!1,radius:qt.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((l,d)=>{i.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",g=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(m=>m.manipulator.selected)||this.emit("immediate-click",{...g,graphic:t}),g.stopPropagation()})]),i.add(l.events.on("focus-changed",({action:g})=>{g==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(d===O.TRANSLATE_Z?R.Z:R.XY):this._tooltip.clear()}))}),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const o=T(t.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,d,g,m,u)=>{const f=g.next(y=>this._trackNumDragging(y)).next(y=>{const S=this._manipulatorInfos.filter(A=>A.type==="vertex"&&A.manipulator.selected);return y.manipulatorType===O.TRANSLATE_XY&&S.length===1?{...y,info:S[0],snapOrigin:S[0].handle.pos}:{...y,info:null}}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:y=>!!y.info,cancel:m,snappingManager:a.snappingManager,snappingContext:new qe({editGeometryOperations:T(this._editGeometryOperations),elevationInfo:e,pointer:u,excludeFeature:t,visualizer:new Ae}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(se()).next(y=>this._perGraphicManipulatorDragAction(re.SELECTED_OR_ALL,y)).next(y=>(this._updateTranslateTooltip(l,y),y));return m.next(this._cancelDragOperation()),f},e,o,t),D(()=>n==null?void 0:n.displaying,()=>{this._updateMoveManipulationPosition()},Et),n.on("changed",()=>this._updateMoveManipulationPosition()),D(()=>n==null?void 0:n.isDraped,l=>{const d="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),d):i.remove(d)},Et)]),this._updateMoveManipulationPosition();const r=hi({view:s,graphic:t,forEachManipulator:l=>{if(!this.destroyed){c(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(l);for(const d of this._manipulatorInfos)l(d.manipulator,O.TRANSLATE_XY);this._moveManipulation.forEachManipulator(l)}},onManipulatorsChanged:l=>this.on("manipulators-changed",l)});c(r)&&(this._outlineVisualElement=r.visualElement instanceof Kt?r.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{n.isDraped||this._updateMoveManipulationPosition()}),D(()=>n.isDraped,()=>this._updateMoveManipulationPosition())]),this._manipulatorHandles.add(r)}_createEdgeOffsetManipulator(e,t=N(this.graphic)){const i=_.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if(v(this._edgeOffsetManipulatorGeometryInside)||v(this._edgeOffsetManipulatorGeometryOutside)){const u=a/s,f=u*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=Z.createExtrudedTriangle(f,u/2,u/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=Z.createExtrudedTriangle(-f,u/2,u/2,i.height,-i.offset)}const n=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:x.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:x.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:x.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:x.Focused}],o=new et({view:this.view,renderObjects:n,elevationInfo:t.mode!=="on-the-ground"||ji(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:Y(0,0,1)},collisionPriority:1}),r=new et({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:o,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:r,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const d=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)),g=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=B([d,g]),this._manipulatorHandles.add(l.locationUpdateHandle,o),this._manipulatorHandles.add([this._watchAndUpdateGrabState(o,!0),this._watchAndUpdateGrabState(r,!0)],o),this._manipulatorHandles.add(pt(o,this._createEdgeOffsetPipeline(l,t)),o),this._manipulatorHandles.add(pt(r,(u,f,y,S)=>{if(S==="touch")this._createEdgeOffsetPipeline(l,t)(u,f,y);else if(this.enableMoveGraphic){const A=this.graphic,w=c(A.geometry)?A.geometry.spatialReference:null;f.next(G=>this._trackNumDragging(G)).next(we(this.view,u.elevationAlignedLocation)).next(Ii(this.view,u.elevationAlignedLocation,t,w,A)).next(ue()).next(se()).next(G=>this._perGraphicManipulatorDragAction(re.ALL,G)).next(G=>(this._updateTranslateGraphicTooltip(R.XY,G),G)).next(G=>{G.action==="end"&&this._tooltip.clear()}),y.next(this._cancelDragOperation())}}),o);const m=u=>{this._manipulatorInfos.some(f=>f.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...u,graphic:this.graphic}),u.stopPropagation()};return this._manipulatorHandles.add([o.events.on("immediate-click",m),r.events.on("immediate-click",m),o.events.on("focus-changed",({action:u})=>{const f=this._tooltipOptions;u==="focus"&&f.enabled?this._tooltip.info=new oe({tooltipOptions:f}):this._tooltip.clear()})],o),this._manipulatorInfos.push(l),this.manipulators.add(o),this.manipulators.add(r),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(e,t){const i=e.manipulator,a=e.edgeManipulator,s=()=>{Ft(e.visibilityHandle);const n=Jo(this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!a.focused||n)&&(i.grabbable=!n,a.grabbable=!n,e.visibilityHandle=B([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",s),a.events.on("focus-changed",s),{remove:()=>{Ft(e.visibilityHandle),this.manipulators.remove(a)}}],i),s()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const t=T(this._editGeometryOperations).data.coordinateHelper,i=wa(this.view,e.manipulator.elevationAlignedLocation,Sa(t,e.handle,T(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,n=c(i)?Ko(i,a,s):Ys;e.manipulator.modelTransform=n,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=n;const o=pe(z(Le,a,s))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-o,0,0],[o,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,s)=>{this._clearSelection();const{step:n,cleanup:o}=this._initializeEdgeOffset(e,t);a.next(r=>this._trackNumDragging(r)).next(we(this.view,i.elevationAlignedLocation)).next(n).next(zn(this.view)).next(Ln(this.view,T(this._editGeometryOperations).data.spatialReference)).next(se()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&o()}),s.next(r=>(o(),r)).next(r=>(this._tooltip.clear(),r)).next(this._cancelDragOperation())}}_initializeEdgeOffset(e,t){const i=T(this._editGeometryOperations),a=Sa(i.data.coordinateHelper,e.handle,t),s=i.createUndoGroup(),n=wa(this.view,e.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge),0);const o=()=>new Bs({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:T(this._editGeometryOperations).data.spatialReference}),r=new Kt({view:this.view,isDraped:this._graphicState.isDraped,geometry:o(),elevationInfo:e.elevationInfo,width:_.visualElements.lineGraphics.outline.width,color:_.colorToVec4(M.main),attached:!0});let l;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(e),l=Ft(l)},g=this.on("undo",d);return l=B([Vt(r),D(()=>this._graphicState.isDraped,m=>r.isDraped=m),this._graphicState.on("changed",()=>r.geometry=o()),s,g]),{step:m=>v(a)||v(n)?(d(),null):{...m,operation:a,plane:n},cleanup:d}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||v(t.operation))return t;this._updateEventState($.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=t;return(i||a||s)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_applyComputeEdgeOffsetDistanceStep(){return e=>{const{operation:t,mapEnd:i}=e;if(v(t)||v(i))return e;const a=t.signedDistanceToPoint(i);return{...e,signedDistance:a}}}_showEdgeOffsetTooltip(){return e=>{const{mapEnd:t,signedDistance:i,operation:a}=e,s=this._tooltip,n=this._tooltipOptions;if(!n.enabled||v(i))return s.clear(),e;const o=Qo(this._graphicState.isDraped,-i,t,a.plane,T(this._editGeometryOperations).data.coordinateHelper);return v(s.info)||s.info.type!=="reshape-edge-offset"?s.info=new oe({tooltipOptions:n,distance:o}):s.info.distance=o,e}}_cleanEdgeOffsetCollapsedEdges(e){var l,d;const t=(l=e.handle.leftVertex.leftEdge)==null?void 0:l.leftVertex,i=e.handle.leftVertex,a=(d=e.handle.rightVertex.rightEdge)==null?void 0:d.rightVertex,s=e.handle.rightVertex,n=T(this._editGeometryOperations).data.coordinateHelper,o=1e-6,r=[];t&&n.distance(t.pos,i.pos)<o&&r.push(this._getManipulatorInfoFromHandle(i)),(n.distance(i.pos,s.pos)<o||a&&n.distance(a.pos,s.pos)<o)&&r.push(this._getManipulatorInfoFromHandle(s)),r.length&&this._removeVertices(r)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=N(this.graphic)){if(e.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(v(this._vertexManipulatorGeometry)||v(this._vertexManipulatorOutlineGeometry)){const{size:o,outlineSize:r}=this._computeVertexManipulatorSizeAndOutline(_.reshapeManipulators.vertex);this._vertexManipulatorGeometry=Z.createSphereGeometry(o,16,16),this._vertexManipulatorOutlineGeometry=Z.createSphereGeometry(r,16,16)}if(v(this._edgeManipulatorGeometry)||v(this._edgeManipulatorOutlineGeometry)){const{size:o,outlineSize:r}=this._computeVertexManipulatorSizeAndOutline(_.reshapeManipulators.edge);this._edgeManipulatorGeometry=Z.createSphereGeometry(o,16,16),this._edgeManipulatorOutlineGeometry=Z.createSphereGeometry(r,16,16)}const i=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:st.Vertex|x.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:st.Vertex|x.Unfocused|x.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:st.Vertex|x.Focused|x.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:x.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:x.Selected|x.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:x.Selected|x.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:st.Edge|x.Focused|x.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:st.Edge|x.Focused|x.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:st.Edge|x.Unfocused|x.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:st.Edge|x.Unfocused|x.Unselected});const a=new et({view:this.view,renderObjects:i,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const s=e.type==="edge"?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),s.type==="edge"){const o=this._getManipulatorInfoFromHandle(s.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s)),r=this._getManipulatorInfoFromHandle(s.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s));s.locationUpdateHandle=B([o,r]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const n=pt(a,(o,r,l,d)=>{let g=null;r.next(m=>this._trackNumDragging(m)).next(m=>{if(m.action==="start"&&(g=T(this._editGeometryOperations).createUndoGroup()),s.type==="edge"){const u=this._splitEdgeManipulator(s);return{...m,info:u,snapOrigin:u.handle.pos}}return{...m,info:s,snapOrigin:s.handle.pos}}).next(we(this.view,o.elevationAlignedLocation)).next(Vn(this.view,this.graphic,o.elevationAlignedLocation,o.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new qe({editGeometryOperations:T(this._editGeometryOperations),elevationInfo:t,pointer:d,excludeFeature:this.graphic,visualizer:new Ae}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(se()).next(m=>{this._perVertexManipulatorDragAction(m),m.action==="end"&&(g=Ft(g)),this._updateTranslateVertexTooltip(o,R.XY,m)}),l.next(this._cancelDragOperation(()=>g=Ft(g)))});return this._manipulatorHandles.add([n,a.events.on("immediate-click",o=>this._manipulatorClickCallback(o,s)),a.events.on("select-changed",()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:o})=>{o==="focus"&&s.type!=="edge"?this._updateTranslateVertexTooltip(a,R.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),s}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case $.NONE:break;case $.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case $.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState($.NONE)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=st.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=_.reshapeManipulators.vertex.size/2+_.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":e.state=st.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=_.reshapeManipulators.edge.size/2+_.reshapeManipulators.edge.collisionPadding,e.elevationInfo=i.mode!=="on-the-ground"||ji(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",i=>this._onGrabStateChanged(e,t,i.action,i.pointerType))}_onGrabStateChanged(e,t,i,a="mouse"){if(i==="start")t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState($.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(s=>{s.manipulator.interactive=!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in s&&(s.edgeManipulator.interactive=!this._numGrabbing)}),T(this._graphicMoveManipulation).forEachManipulator(s=>s.interactive=!this._numGrabbing))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(e.manipulator.grabbing&&this._onGrabStateChanged(e.manipulator,!1,"end"),this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e){for(const t of this._manipulatorInfos)if(e===t.handle)return t}return null}_updateManipulatorPosition(e){if(!e)return;const t=T(this._editGeometryOperations);if(e.type==="vertex")e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,fe),e.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if(e.type==="edge"){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator;if(c(e.manipulator.elevationInfo)&&e.manipulator.elevationInfo.mode==="on-the-ground"){const s=i.location,n=a.location,o=.5,r=s.x+o*(n.x-s.x),l=s.y+o*(n.y-s.y),d=s.hasZ&&n.hasZ?0:void 0;e.manipulator.location=Re(r,l,d,t.data.spatialReference)}else Yt(Le,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=Le}}_splitEdgeManipulator(e,t=.5){const i=T(this._editGeometryOperations),a=T(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const s=N(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(e),n=this._createVertexOrEdgeManipulator(a)):(n=e,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this.enableEdgeOffset||this._updateTranslateVertexTooltip(n.manipulator,R.XY),this._updateSelection(e.manipulator);const o=this._updateEventState($.RESHAPING),r=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:T(a.index)}],added:r}),o&&this._updateEventState($.NONE),n}_updateMoveManipulationPosition(){const e=ht(Le,0,0,0);let t=0,i=!1,a=null,s=null;for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected?(t++,Ot(e,e,n.manipulator.renderLocation),v(a)||n.selectedIndex>a.selectedIndex?(s=a,a=n):(v(s)||n.selectedIndex>s.selectedIndex)&&(s=n)):i=!0);if(t!==0){const n=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.zManipulation.available=n&&this.enableZVertex&&Wt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n&&t!==1}else{const n=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n,this._moveManipulation.zManipulation.available=n&&this.enableZShape&&Wt(this.graphic)}if(t!==0){let n=0;if(c(a)){const o=a.handle.pos,r=c(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=v(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;r&&l?this._moveManipulation.xyAxisManipulation.available=!1:r?n=Oa(r,o):l&&(n=Oa(o,l))}this._moveManipulation.angle=n,this._moveManipulation.radius=as}else this._moveManipulation.angleDeferred=()=>ss(T(this.graphic.geometry)),this._moveManipulation.radius=qt.radiusForSymbol(this.graphic.symbol);t!==0&&i?(At(e,e,1/t),fe.spatialReference=T(this._editGeometryOperations).data.spatialReference,fe.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,fe),this._moveManipulation.elevationAlignedLocation=fe):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Ya(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=T(this._editGeometryOperations);for(const a of e)if(a.type==="vertex"&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const s=T(i.removeVertices([a.handle]).removedVertices[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(t.length>0){const a=t.map(n=>{const o=i.data.components.indexOf(n.component);return{coordinates:i.data.coordinateHelper.vectorToArray(n.pos),componentIndex:o,vertexIndex:T(n.index)}});this.outputGeometry=i.data.geometry;const s=this._updateEventState($.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(n=>n.coordinates),vertices:a}),this.destroyed)||s&&(this._updateEventState($.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=t.action==="start"?wt.NEW_STEP:wt.ACCUMULATE_STEPS){const a=T(this._editGeometryOperations);a.moveVertices(e.map(s=>s.handle),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const s of e)this._updateManipulatorPosition(s)}_offsetEdge(e,t){if(v(t.operation)||v(t.signedDistance))return;const i=T(this._editGeometryOperations),a=t.operation.clone();a.distance=t.signedDistance,i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),t.type==="vertex"&&(t.manipulator.selected=!t.manipulator.selected,e.button===Wi.Right&&this._removeVertices([t])),t.type==="edge"&&e.button===Wi.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}_updateTranslateTooltip(e,t){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)}_updateTranslateGraphicTooltip(e,t){const i=this._tooltipOptions;if(!i.enabled)return;const a=e===R.Z,s=a?new lt({tooltipOptions:i}):new tt({tooltipOptions:i});if(c(t)&&t.action!=="end"){const{mapStart:n,mapEnd:o}=t,r=a?Je(n,o):Ee(n,o,this._graphicState.isDraped?"on-the-ground":"absolute-height");s.distance=c(r)?r:Ht}this._tooltip.info=s}_updateTranslateVertexTooltip(e,t,i){const a=this._tooltipOptions;if(!a.enabled)return;const s=t===R.Z,n=new Ct({tooltipOptions:a});if(c(i)&&i.action!=="end"){const{mapStart:l,mapEnd:d}=i,g=s?Je(l,d):Ee(l,d,this._graphicState.isDraped?"on-the-ground":"absolute-height");n.distance=c(g)?g:Ht}const o=qn(e.elevationAlignedLocation);c(o)&&(n.elevation={mode:"absolute-height",...o});const{geometry:r}=this.graphic;c(r)&&!s&&(n.area=r.type==="polygon"?Rn(r,this._graphicState.isDraped):null,n.totalLength=r.type==="polyline"?Dn(r,this._graphicState.isDraped?"on-the-ground":"absolute-height"):null),this._tooltip.info=n}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function Oa(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Qo(e,t,i,a,s){if(e){const n=s.toXYZ(s.pointToVector(i)),o=Xs(a,n,b.get()),r=$n(o,n,s.spatialReference);if(c(r))return Te(r.value*Math.sign(t),r.unit)}return Te(t*xi(i.spatialReference),"meters")}h([p()],L.prototype,"_segmentLabels",void 0),h([p({constructOnly:!0})],L.prototype,"tool",void 0),h([p()],L.prototype,"_tooltip",void 0),h([p()],L.prototype,"inputGeometry",null),h([p()],L.prototype,"outputGeometry",void 0),h([p({readOnly:!0})],L.prototype,"updating",null),h([p()],L.prototype,"manipulators",null),h([p()],L.prototype,"view",null),h([p()],L.prototype,"graphic",null),h([p()],L.prototype,"enableZShape",null),h([p()],L.prototype,"enableZVertex",null),h([p()],L.prototype,"enableMoveGraphic",null),h([p()],L.prototype,"enableMidpoints",null),h([p()],L.prototype,"enableEdgeOffset",null),h([p()],L.prototype,"_labelOptions",null),h([p()],L.prototype,"_tooltipOptions",null),L=h([C("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],L);const fe=Re(0,0,null,null),Le=V();var st,$,re;(function(e){e.Vertex=St.Custom1,e.Edge=St.Custom2})(st||(st={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}($||($={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(re||(re={}));let U=class extends Tt.EventedMixin(ri){constructor(e){super(e),this._handles=new de,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new si,this.tooltipOptions=new mt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const e=this._reshapeOperation=new L({tool:this});this.own([e.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),e.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),e.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),e.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),e.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>{t.stopPropagation()}),D(()=>this.graphic,()=>this._updateGraphic(),Ri)]),this.finishToolCreation()}destroy(){this._handles=I(this._handles),this._reshapeOperation=I(this._reshapeOperation)}get updating(){var e,t;return(t=(e=this._reshapeOperation)==null?void 0:e.updating)!=null?t:!1}_updateGeometry(){const e=js(this.graphic);this._reshapeOperation.inputGeometry=c(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),Ws(this.graphic)!==Ua.SUPPORTED)return;const e=D(()=>{var t;return(t=this.graphic)==null?void 0:t.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},je);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){v(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){var e;return(e=this._reshapeOperation.canUndo)!=null?e:!1}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var e;return(e=this._reshapeOperation.canRedo)!=null?e:!1}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(e){e.type!=="key-down"||e.key!=="Delete"&&e.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([p()],U.prototype,"_reshapeOperation",void 0),h([p({constructOnly:!0,nonNullable:!0})],U.prototype,"view",void 0),h([p({constructOnly:!0})],U.prototype,"graphic",void 0),h([p({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZShape",void 0),h([p({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZVertex",void 0),h([p({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMoveGraphic",void 0),h([p({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMidpoints",void 0),h([p({constructOnly:!0,nonNullable:!0})],U.prototype,"enableEdgeOffset",void 0),h([p()],U.prototype,"type",void 0),h([p({constructOnly:!0,type:si})],U.prototype,"labelOptions",void 0),h([p({constructOnly:!0,type:mt})],U.prototype,"tooltipOptions",void 0),h([p({constructOnly:!0})],U.prototype,"snappingManager",void 0),h([p()],U.prototype,"updating",null),h([p()],U.prototype,"automaticManipulatorSelection",void 0),U=h([C("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],U);let yt=class extends Gt{constructor(e){super(e),this.type="transform-rotate",this.rotationType="geographic"}};h([p()],yt.prototype,"type",void 0),h([p()],yt.prototype,"rotation",void 0),h([p()],yt.prototype,"rotationPrecision",void 0),h([p()],yt.prototype,"orientation",void 0),h([p()],yt.prototype,"orientationPrecision",void 0),h([p()],yt.prototype,"rotationType",void 0),yt=h([C("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],yt);let zt=class extends Gt{constructor(e){super(e),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};h([p()],zt.prototype,"type",void 0),h([p()],zt.prototype,"scale",void 0),h([p()],zt.prototype,"size",void 0),h([p()],zt.prototype,"sizeUnit",void 0),h([p()],zt.prototype,"sizePrecision",void 0),zt=h([C("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],zt);let Q=class extends Gt{constructor(e){super(e),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};h([p()],Q.prototype,"type",void 0),h([p()],Q.prototype,"orientation",void 0),h([p()],Q.prototype,"orientationEnabled",void 0),h([p()],Q.prototype,"orientationPrecision",void 0),h([p()],Q.prototype,"rotationType",void 0),h([p()],Q.prototype,"size",void 0),h([p()],Q.prototype,"sizeUnit",void 0),h([p()],Q.prototype,"sizeEnabled",void 0),h([p()],Q.prototype,"sizePrecision",void 0),Q=h([C("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Q);var E,ce;(function(e){e.ScaleIn=St.Custom2,e.ScaleOut=St.Custom3,e.RotateLeft=St.Custom4,e.RotateRight=St.Custom5,e.Unlocked=St.Custom7,e.DelayedFocused=St.Custom8,e.TouchInput=St.Custom12})(E||(E={}));class tr{constructor({adapter:t,tooltipOptions:i,mode:a,tool:s}){this.mode=null,this._handles=new de,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new Tt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this.adapter.scale:1,this.tool=s,this.mode=a,this.adapter=t,this._tooltipOptions=i,this._tooltip=new $e({view:s.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(he(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),Et))}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=I(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=I(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const i=qs({update:({deltaTime:a})=>{t.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:i}}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=I(this._activeAnimation))}forEachManipulator(t){t(this._ringManipulator,O.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const i=this.tool.graphicState.graphic,a=pt(t,(s,n,o)=>{this._scaleRotateDragData=null;const r=this.adapter.startInteraction(),l={mode:"none",origin:Xa(s.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const d=b.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(s.renderLocation,d),n.next(Ei(this.tool.view,Fa(s.renderLocation,d,Di()))).next(g=>{const m=De(g.plane),u=Ba(g.renderStart,g.renderEnd,l.origin,m),f=Ks.shortestSignedDiff(l.angle,u);l.angleDir=Si(l.angleDir+f,-ya,ya),l.angle=u;const y=er(l,g),S=y-this.adapter.scale;if(l.scaleDir=Si(l.scaleDir+S,-va,va),this._onScaleChanged(),l.mode==="none"){const A=this.mode||ir(g,g.plane,l.origin,this.tool.view.state.camera);if(c(A)){switch(A){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}l.mode=A}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+u;break;case"scale":r.state.scale=y,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),g.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:Oe(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:y,yScale:y})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:Oe(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:y,yScale:y})}}return g.action==="end"&&(this.startAnimation(Ea(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),r.done()),g}).next(this._updateTooltipPipelineStep(l)),o.next(()=>{if(r.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(Ea(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,t.events.on("focus-changed",s=>{s.action==="focus"?this.startAnimation(ar(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),t.events.on("immediate-click",s=>{s.stopPropagation()}),D(()=>{var s;return(s=this.tool.graphicState)==null?void 0:s.displaying},s=>this._ringManipulator.available=s,Et)])}_updateTooltipPipelineStep(t){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const s=this._tooltip,n=this._tooltipOptions.visualVariables,o=c(n)?n.size:null,r=c(n)?n.rotation:null;switch(t.mode){case"scale":s.info=new zt({tooltipOptions:a,scale:{value:this.adapter.scale},size:Te(ot(this.adapter.size,-1),"meters"),sizeUnit:c(o)?o.unit:null,sizePrecision:c(o)?Ne(o.valueType):null});break;case"rotate":{const l=c(r)?Ne(r.valueType):null,d=c(r)?r.rotationType:"geographic";s.info=new yt({tooltipOptions:a,rotation:gi(ot(-this.adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:gi(-this.adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:d})}}return i}}_updateFocusTooltip(){if(!!this._tooltipOptions.enabled)if(this.getFocused()){const t=this._tooltipOptions.visualVariables,i=c(t)?t.rotation:null,a=c(t)?t.size:null;this._tooltip.info=new Q({tooltipOptions:this._tooltipOptions,orientation:gi(-this.adapter.angle,"radians","geographic"),orientationEnabled:this.mode==null||this.mode==="rotate",orientationPrecision:c(i)?Ne(i.valueType):null,rotationType:c(i)?i.rotationType:"geographic",size:Te(ot(this.adapter.size,-1),"meters"),sizeUnit:c(a)?a.unit:null,sizeEnabled:this.mode==null||this.mode==="scale",sizePrecision:c(a)?Ne(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(E.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(E.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut,!1),this._ringManipulator.updateStateEnabled(E.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(E.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(E.RotateLeft|E.RotateRight,!1),this._ringManipulator.updateStateEnabled(E.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(E.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut|E.RotateLeft|E.RotateRight,!1)}_updateManipulatorTransform(){const t=Na(J.get(),this.adapter.angle,Y(0,0,1));if(v(t))return;const i=this.getScale(),a=Ye(J.get(),ht(b.get(),i,i,i));this._ringManipulator.modelTransform=Ue(J.get(),a,t)}_createRingManipulator(){const t=(P,ct,Rt)=>{const Dt=[],$t=Math.ceil(es*(ct-P)/(2*Math.PI));for(let H=0;H<$t+1;H++){const _e=P+H*(ct-P)/$t;Dt.push(Y(Rt*Math.cos(_e),Rt*Math.sin(_e),0))}return Dt},i=P=>t(0,2*Math.PI,P),a=P=>[[-P/2,0],[P/2,0],[P/2,_i/2],[-P/2,_i/2]],s=(P,ct)=>Z.createPathExtrusionGeometry(a(ct),P,[],[],!1),n=i(Xt),o=s(n,vi),r={left:[],right:[]},l=[];for(let P=0;P<2;P++){const ct=P*Math.PI-Math.PI/4,Rt=Math.PI/2-Vo,Dt=ct+Rt,$t=ct+Math.PI/2-Rt,H=t(Dt,$t,Co),_e=s(H,te);l.push(H),l.push(t(Dt,$t,da-vi/2)),r.left.push(_e),r.right.push(_e);for(let ci=0;ci<2;ci++){const zi=ci===0,W=oi();if(zi){ka(W,W,[1,-1,1]),qi(W,W,-Dt,[0,0,1]);const Ut=Math.round(ga*(H.length-1));W[12]=H[Ut][0],W[13]=H[Ut][1],W[14]=H[Ut][2]}else{qi(W,W,$t,[0,0,1]);const Ut=Math.round((1-ga)*(H.length-1));W[12]=H[Ut][0],W[13]=H[Ut][1],W[14]=H[Ut][2]}const Li=Z.createExtrudedTriangle(zo,0,Lo,_i);Z.transformInPlace(Li,W),(zi?r.left:r.right).push(Li)}}const d=[];for(let P=0;P<2;P++){const ct=P*Math.PI-Math.PI/4,Rt=Math.PI/2-No,Dt=ct+Rt,$t=ct+Math.PI/2-Rt,H=t(Dt,$t,da);d.push(s(H,te))}const g=i(Xt+ma),m=i(Xt+_a),u=s(g,te),f=s(m,te),y=i(Xt-ma),S=i(Xt-_a),A=s(y,te),w=s(S,te),G=this._createMaterial(),j=this._createMaterial(.66),ge=this._createMaterial(.5),me=this._createMaterial(.33);let _t=[{geometry:o,material:G,stateMask:E.DelayedFocused},{geometry:o,material:ge,stateMask:x.None}];this.mode&&this.mode!=="scale"||(_t=_t.concat([{geometry:d,material:G,stateMask:E.DelayedFocused|E.Unlocked},{geometry:u,material:j,stateMask:E.DelayedFocused|E.ScaleIn},{geometry:f,material:me,stateMask:E.DelayedFocused|E.ScaleIn},{geometry:A,material:j,stateMask:E.DelayedFocused|E.ScaleOut},{geometry:w,material:me,stateMask:E.DelayedFocused|E.ScaleOut}])),this.mode&&this.mode!=="rotate"||(_t=_t.concat([{geometry:r.right,material:G,stateMask:E.DelayedFocused|E.Unlocked},{geometry:r.left,material:G,stateMask:E.DelayedFocused|E.RotateLeft},{geometry:r.right,material:G,stateMask:E.DelayedFocused|E.RotateRight}]));const Pe=[n,...l];return new et({view:this.tool.view,renderObjects:_t,autoScaleRenderObjects:!1,worldOriented:!0,radius:vi,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:N(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:Pe,direction:Y(0,0,1)}})}_createMaterial(t=1){const i=$a([...Do,t]);return new Gi({color:i,transparent:t!==1,cullFace:xe.Back,renderOccluded:k.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function er(e,t){const i=z(b.get(),t.renderStart,e.origin),a=z(b.get(),t.renderEnd,e.origin),s=pe(i),n=pe(a);return s===0?0:n/s}function ir(e,t,i,a){const{renderStart:s,renderEnd:n}=e,o=Ve(s,a,b.get()),r=Ve(n,a,b.get());if(Js(o,r)<ua*ua)return null;const l=z(b.get(),s,i),d=kt(b.get(),l,De(t)),g=s,m=Ot(b.get(),g,d),u=Ve(i,a,b.get()),f=o,y=Ve(m,a,b.get()),S=z(b.get(),y,f),A=z(b.get(),o,u),w=Ki(f,S),G=Ki(u,A);return Ji(w,r)<Ji(G,r)?"rotate":"scale"}function Ve(e,t,i){return t.projectToScreen(e,yi),ht(i,yi[0],yi[1],0)}function Ea(e,t){let i=null,a=1;const s=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=s,t()},update:n=>(a+=((a+1)/2-a)*Math.min(n*Ho,1),t(),Math.abs(a-1)<.01?ce.STOP:ce.CONTINUE),destroy:()=>{e.getScale=i,t()}}}function ar(e,t){let i=0,a=null;const s=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=s,i=0,t()},update:n=>(i+=n,!a()||i>ko?ce.STOP:ce.CONTINUE),destroy:()=>{e.getFocused=a,t()}}}function Ne(e){switch(e){case"integer":case"long":return 0;default:return null}}(function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"})(ce||(ce={}));const yi=ii();function ns(e){return c(e.geometry)&&e.geometry.type==="mesh"?sr(e.geometry):nr(e)}function sr(e){return c(e.transform)?or(e,e.transform):rr(e)}function nr(e){let t=e.geometry,i=Qs;return{undo(a){i=a.geometry,a.geometry=t},redo(a){t=a.geometry,a.geometry=i}}}function or(e,t){let i=t.clone(),a=null;return{undo:s=>{a=c(e.transform)?e.transform.clone():null,e.transform=i,s.notifyGeometryChanged()},redo:s=>{i=c(e.transform)?e.transform.clone():null,e.transform=a,s.notifyGeometryChanged()}}}function rr(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}let ft=class extends $i{constructor(e){super(e),this.interactionState=null}initialize(){this.own([he(()=>c(this.interactionState)&&this.interactionState.angle!==this.interactionState.previousAngle?{interactionState:this.interactionState,angle:this.interactionState.state.angle}:null,({interactionState:e})=>{this._updateMeshRotation(e)},je),he(()=>c(this.interactionState)&&this.interactionState.scale!==this.interactionState.previousScale?{interactionState:this.interactionState,scale:this.interactionState.state.scale}:null,({interactionState:e})=>{this._updateMeshSize(e)},je)])}get angle(){const e=this.geometry.transform;if(v(e))return 0;const t=Jn(e.rotation)[2];return Math.abs(t)>.999999?ni(Qn(e.rotation))*Math.sign(t):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}startInteraction(){const e=new Mt({angle:this.angle});this.interactionState=e;const t=()=>this.interactionState=null;return{state:e,done:t,cancel:()=>{e.cancel(),t()}}}createUndoRecord(){return ns(this.graphic)}_updateMeshRotation(e){const t=this.geometry.anchor,i=this.viewingMode===Oi.Global,{angle:a,previousAngle:s}=e;this.geometry.rotate(0,0,Oe(a-s),{origin:t,geographic:i}),e.previousAngle=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(e){const t=this.geometry.anchor,i=this.viewingMode===Oi.Global,{scale:a,previousScale:s}=e;this.geometry.scale(a/s,{origin:t,geographic:i}),e.previousScale=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};h([p({constructOnly:!0})],ft.prototype,"graphic",void 0),h([p({constructOnly:!0})],ft.prototype,"geometry",void 0),h([p({constructOnly:!0})],ft.prototype,"viewingMode",void 0),h([p()],ft.prototype,"angle",null),h([p()],ft.prototype,"scale",null),h([p()],ft.prototype,"interactionState",void 0),ft=h([C("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],ft);let Mt=class extends ei{constructor(e){super(e),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=e.angle,this.previousAngle=e.angle}get state(){const{angle:e,scale:t}=this;return{angle:e,scale:t}}cancel(){this.angle=this.initialAngle,this.scale=1}};h([p()],Mt.prototype,"angle",void 0),h([p()],Mt.prototype,"initialAngle",void 0),h([p()],Mt.prototype,"previousAngle",void 0),h([p()],Mt.prototype,"previousScale",void 0),h([p()],Mt.prototype,"scale",void 0),h([p()],Mt.prototype,"state",null),Mt=h([C("InteractionState")],Mt);let F=class extends $i{constructor(e){super(e),this.sizeAxis=null,this.interactionState=null}initialize(){this.own(he(()=>c(this.interactionState)?this.interactionState.state:null,e=>{this._updateSymbol(e)},je))}get angle(){return c(this.interactionState)?this.interactionState.angle:c(this._orientationReferenceSymbolLayer)?lr(this._orientationReferenceSymbolLayer.heading):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return c(this.interactionState)?this.interactionState.initialAngle:0}get size(){const e=this._sizeReferenceSymbolLayer;if(v(e))return null;const t=this.findLayerView(),i=this._graphicSymbol;if(v(t)||v(i)||i.type!=="point-3d")return null;const a=t.getSymbolLayerSize(i,e);if("size"in a&&c(a.size))return a.size;const s=this.sizeAxis;return"width"in a&&c(a.width)&&(v(s)||s==="width"||s==="all"||s==="width-and-depth")?a.width:"depth"in a&&c(e.depth)&&(v(s)||s==="depth"||s==="all"||s==="width-and-depth")?a.depth:"height"in a&&c(e.height)&&(v(s)||s==="height"||s==="all")?a.height:null}get _sizeReferenceSymbolLayer(){const e=this._graphicSymbol;return v(e)||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const e=this._graphicSymbol;return v(e)||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object"&&c(t.heading))}get _graphicSymbol(){return c(this.graphic)&&c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(e){this.graphic.symbol=e}startInteraction(){const e=this._graphicSymbol,t=this.findLayerView();if(c(this.interactionState)||v(e)||v(t))return hr;const i=e.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(e,r):null).toArray(),a=e.clone(),s=this.angle,n=new bt({originalSymbol:a,angle:s,initialSizes:i});this.interactionState=n;const o=()=>this.interactionState=null;return{state:n,done:o,cancel:()=>{this._graphicSymbol=a,o()}}}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e},redo:i=>{e=i.symbol,i.symbol=t}}}_updateSymbol({scale:e,angle:t,originalSymbol:i,initialSizes:a}){const s=this._graphicSymbol;if(v(s)||s.type!=="point-3d")return;const n=s.clone(),o=-Oe(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,n,(l,d,g)=>{const m=ot(l.heading,0)+o;d.heading!==m&&(d.heading=m,r=!0);const u=a[g];if(c(u)&&"width"in u){u.width=this.sizeFilter(u.width),u.height=this.sizeFilter(u.height),u.depth=this.sizeFilter(u.depth);const f=u.width*e;d.width!==f&&(d.width=f,r=!0);const y=u.depth*e;d.depth!==y&&(d.depth=y,r=!0);const S=u.height*e;d.height!==S&&(d.height=S,r=!0)}}),r&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach((a,s)=>{const n=t.symbolLayers.getItemAt(s);a.type==="object"&&n.type==="object"&&i(a,n,s)})}};function lr(e){return-ni(e)}h([p()],F.prototype,"angle",null),h([p()],F.prototype,"scale",null),h([p()],F.prototype,"relativeAngle",null),h([p()],F.prototype,"initialAngle",null),h([p()],F.prototype,"size",null),h([p()],F.prototype,"sizeAxis",void 0),h([p({constructOnly:!0})],F.prototype,"graphic",void 0),h([p()],F.prototype,"interactionState",void 0),h([p({constructOnly:!0})],F.prototype,"findLayerView",void 0),h([p({constructOnly:!0})],F.prototype,"sizeFilter",void 0),h([p()],F.prototype,"_sizeReferenceSymbolLayer",null),h([p()],F.prototype,"_orientationReferenceSymbolLayer",null),h([p()],F.prototype,"_graphicSymbol",null),F=h([C("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],F);const hr={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let bt=class extends ei{constructor(e){super(e),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=e.angle}get state(){const{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:s}=this;return{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:s}}};h([p()],bt.prototype,"originalSymbol",void 0),h([p()],bt.prototype,"angle",void 0),h([p()],bt.prototype,"initialAngle",void 0),h([p()],bt.prototype,"initialSizes",void 0),h([p()],bt.prototype,"scale",void 0),h([p()],bt.prototype,"state",null),bt=h([C("InteractionState")],bt);let q=class extends Ha(Tt.EventedMixin(ri)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new mt,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new Ke,this._tooltip=null}initialize(){const{graphic:e,view:t}=this;this.graphicState=new Jt({graphic:e}),this.own(D(()=>this.tooltipOptions.enabled,a=>{this._tooltip=a?new $e({view:t}):I(this._tooltip)},Ri)),this._moveManipulation=new qt({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Wt(e),radius:qt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((a,s)=>this.handles.add([a.events.on("immediate-click",n=>{this.emit("immediate-click",{...n,graphic:e}),n.stopPropagation()}),a.events.on("focus-changed",({action:n})=>{const{tooltipOptions:o,_tooltip:r}=this;if(!v(r)&&(r.clear(),n==="focus")){const l=s===O.TRANSLATE_Z?lt:tt;r.info=new l({tooltipOptions:o})}})])),this._moveManipulation.elevationInfo=N(e);const i=e.geometry;if(this._moveManipulation.createGraphicDragPipeline((a,s,n,o,r)=>(c(i)&&a===R.XY&&(n=n.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new qe({elevationInfo:N(e),pointer:r,editGeometryOperations:li.fromGeometry(new tn({spatialReference:i.spatialReference}),t.state.viewingMode),visualizer:new Ae,excludeFeature:e}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:o}),this._snappingPipeline.next)),n=n.next(l=>{const{tooltipOptions:d,_tooltip:g}=this;if(v(g))return l;const{mapStart:m,mapEnd:u}=l;g.clear();const f=a===R.Z?lt:tt;if(l.action==="end")g.info=new f({tooltipOptions:d});else{const y=a===R.Z?Je(m,u):Ee(m,u,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(y)&&(g.info=new f({tooltipOptions:d,distance:y}))}return l})),this.graphicState,a=>{const{action:s,graphic:n,dxScreen:o,dyScreen:r}=a,l={graphic:n,dxScreen:o,dyScreen:r};switch(s){case"start":this.emit("graphic-translate-start",l),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",l);break;case"end":this.emit("graphic-translate-stop",l)}}),this._moveManipulation.angle=c(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(D(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const a=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new tr({tool:this,mode:a,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([hi({view:this.view,graphic:this.graphic,forEachManipulator:a=>this._forEachManipulator(a),onManipulatorsChanged:()=>jt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),D(()=>t.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(a=>{a instanceof et&&this.handles.add(a.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=I(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=I(this._scaleRotate),this._scaleRotateAdapter=I(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){v(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new ft({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new F({graphic:this.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find(e=>e.layer===this.graphic.layer),sizeAxis:c(this.tooltipOptions.visualVariables)&&c(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(e){this._moveManipulation.forEachManipulator(e),c(this._scaleRotate)&&this._scaleRotate.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return D(()=>this.graphicState.displaying,e=>{this._forEachManipulator(t=>t.available=e),this._moveManipulation.zManipulation.available=e&&this.enableZ&&Wt(this.graphic)})}_createGeometryUndoRecord(){return ns(this.graphic)}set snapToScene(e){this._moveManipulation&&(this._moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this._moveManipulation.location=e,c(this._scaleRotate)&&(this._scaleRotate.location=e)}set elevationAlignedLocation(e){this._moveManipulation.elevationAlignedLocation=e,c(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){c(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(v(this._scaleRotate))return;const e=this._scaleRotate.getScale();this._moveManipulation.displayScale=e}_updateMoveAngle(){this.view.state.viewingMode===Oi.Local||this.view.scale<Uo?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){Ya(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([p({constructOnly:!0,nonNullable:!0})],q.prototype,"view",void 0),h([p({constructOnly:!0,nonNullable:!0})],q.prototype,"graphic",void 0),h([p({constructOnly:!0,nonNullable:!0})],q.prototype,"enableZ",void 0),h([p()],q.prototype,"enableRotation",void 0),h([p()],q.prototype,"enableScaling",void 0),h([p({constructOnly:!0,type:mt})],q.prototype,"tooltipOptions",void 0),h([p()],q.prototype,"graphicState",void 0),h([p({value:!1})],q.prototype,"snapToScene",null),h([p({constructOnly:!0})],q.prototype,"snappingManager",void 0),h([p({readOnly:!0})],q.prototype,"type",void 0),h([p({readOnly:!0})],q.prototype,"updating",null),q=h([C("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],q);class pr{constructor(){this.lastDragEvent=null,this.next=new Qa,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&c(this.lastDragEvent)){const i={...this.lastDragEvent,action:"update"};t&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=t}createDragEventPipelineStep(){return this.lastDragEvent=null,t=>(this.lastDragEvent=t.action!=="end"?{...t}:null,this._enabled&&this._adjustScaleFactors(t),t)}_adjustScaleFactors(t){const i=ja(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-i:i,t.factor2=t.factor2<0?-i:i}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}function ke(e,t){return os(e,t,!1)}function Aa(e,t){return os(e,t,!0)}function os(e,t,i){if(e instanceof Xn){if(e.operation instanceof Bn)return cr(e.operation,t,i),!0;if(e.operation instanceof jn)return dr(e.operation,t,i),!0;if(e.operation instanceof Wn)return ur(e.operation,t,i),!0}return!1}function cr(e,t,i=!1){const a=i?-1:1,s=Y(a*e.dx,a*e.dy,a*e.dz);Ot(t.origin,t.origin,s)}function dr(e,t,i=!1){const a=i?-e.angle:e.angle;Qi(t.basis1,t.basis1,ta,a),Qi(t.basis2,t.basis2,ta,a)}function ur(e,t,i=!1){const a=i?1/e.factor1:e.factor1,s=i?1/e.factor2:e.factor2;At(t.basis1,t.basis1,a),At(t.basis2,t.basis2,s),ea(t.origin,t.origin,e.origin,e.axis1,a),ea(t.origin,t.origin,e.origin,e.axis2,s)}function gr(e,t,i,a){a||(a=ae());const s=X(ie.get(),e[1],-e[0]),n=X(ie.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=X(ie.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),r=ie.get();t.components.forEach(g=>g.vertices.forEach(m=>{const u=m.pos;X(r,ia(e,u),ia(s,u)),en(n,n,r),an(o,o,r)}));const l=1e-6,d=X(ie.get(),o[0]-n[0]<l?i/2:0,o[1]-n[1]<l?i/2:0);return Wa(n,n,d),He(o,o,d),Mi(a.basis1,e,(o[0]-n[0])/2),Mi(a.basis2,s,(o[1]-n[1])/2),X(a.origin,n[0]*e[0]+n[1]*s[0],n[0]*e[1]+n[1]*s[1]),He(a.origin,a.origin,a.basis1),He(a.origin,a.origin,a.basis2),a}function mr(e,t,i,a=0,s){s||(s=ae()),t.toRenderCoords(e.origin,i,s.origin);const n=b.get();Ot(n,e.origin,e.basis1),Ot(n,n,e.basis2),t.toRenderCoords(n,i,n);const o=b.get();Ot(o,e.origin,e.basis1),z(o,o,e.basis2),t.toRenderCoords(o,i,o);const r=b.get();z(r,e.origin,e.basis1),z(r,r,e.basis2),t.toRenderCoords(r,i,r);const l=b.get();z(l,e.origin,e.basis1),Ot(l,l,e.basis2),t.toRenderCoords(l,i,l);const d=Yt(b.get(),n,o,.5);z(d,d,s.origin);const g=Yt(b.get(),r,l,.5);z(g,s.origin,g),Yt(s.basis1,d,g,.5);const m=Yt(b.get(),l,n,.5);z(m,m,s.origin);const u=Yt(b.get(),o,r,.5);z(u,s.origin,u),Yt(s.basis2,m,u,.5);const f=kt(b.get(),s.basis1,s.basis2),y=kt(f,f,s.basis1);return Xe(y,y),At(s.basis2,y,Be(s.basis2,y)),At(s.basis1,s.basis1,1+a/pe(s.basis1)),At(s.basis2,s.basis2,1+a/pe(s.basis2)),sn(s),s}function Ta(e,t,i,a){const s=b.get();z(s,z(s,e.origin,e.basis1),e.basis2);const n=b.get();Bt(n,s,e.basis1,2);const o=b.get();Bt(o,n,e.basis2,2);const r=b.get();Bt(r,s,e.basis2,2),s[2]=n[2]=o[2]=r[2]=t;const l=a?"on-the-ground":"absolute-height",d=ra(ze(s,n,i,l),ze(r,o,i,l)),g=ra(ze(n,o,i,l),ze(s,r,i,l));return v(g)||v(d)?null:[d,g]}let Me=class extends Gt{constructor(e){super(e),this.type="extent-rotate",this.angle=0}};h([p()],Me.prototype,"type",void 0),h([p()],Me.prototype,"angle",void 0),Me=h([C("esri.views.interactive.tooltip.ExtentRotateTooltipInfo")],Me);let Lt=class extends Gt{constructor(e){super(e),this.type="extent-scale",this.xScale=0,this.yScale=0,this.xSize=Ht,this.ySize=Ht}};h([p()],Lt.prototype,"type",void 0),h([p()],Lt.prototype,"xScale",void 0),h([p()],Lt.prototype,"yScale",void 0),h([p()],Lt.prototype,"xSize",void 0),h([p()],Lt.prototype,"ySize",void 0),Lt=h([C("esri.views.interactive.tooltip.ExtentScaleTooltipInfo")],Lt);let K=class extends Tt.EventedMixin(ri){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new mt,this._preserveAspectRatio=new pr,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new de,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=ae(),this.mapBoundsStart=ae(),this.zmax=0,this.sizeStart=null,this.displayBounds=ae(),this.displayBoundsStart=ae(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=be(),this._endScale=be()}initialize(){const{view:e,graphic:t,manipulators:i,handles:a}=this,s=this.graphicState=new Jt({graphic:t}),n=t.geometry;this.editGeometryOperations=li.fromGeometry(n,e.state.viewingMode),this.graphicMoveManipulation=new Ci({tool:this,view:e,graphicState:s}),this.moveZManipulator=nn(e,on.CENTER_ON_CALLOUT),this.moveZManipulator.state|=rn,a.add([this._createMoveXYGraphicDragPipeline(),D(()=>this.enableZ,()=>this._updateManipulatorAvailability(this.moveZManipulator,O.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map(g=>{const m=ln(e,g);return a.add([D(()=>this.enableScaling,()=>this._updateManipulatorAvailability(m,O.SCALE)),m.events.on("grab-changed",u=>this._onResizeGrab(u)),this._createResizeDragPipeline(m,g)]),m}),i.addMany(this.resizeManipulators),this.rotateManipulatorTexture=to(e.toolViewManager.textures),this.rotateManipulator=hn(e,this.rotateManipulatorTexture.texture),a.add([D(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this.rotateManipulator,O.ROTATE)),this.rotateManipulator.events.on("grab-changed",g=>{this._onRotateGrab(g)}),this._createRotateDragPipeline(this.rotateManipulator)]),i.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const o=hi({view:e,graphic:t,forEachManipulator:g=>this._forEachManipulator(g),onManipulatorsChanged:()=>jt()});c(o)&&(this.outlineVisualElement=o.visualElement instanceof Kt?o.visualElement:null),c(this.outlineVisualElement)&&a.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(o),a.add([s.on("changed",()=>this._onGeometryChanged()),D(()=>s.displaying,()=>this._updateAllManipulatorAvailability()),D(()=>s.isDraped,()=>this._graphicDrapedChanged(),Et),e.trackGraphicState(s)]);const r=e.pointsOfInterest;r&&a.add(D(()=>r.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=g=>{a.add(g.events.on("grab-changed",()=>{this.grabbing=g.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const d=(g,m)=>{a.add(g.events.on("immediate-click",u=>{m===O.TRANSLATE_XY&&this.emit("immediate-click",{...u,graphic:t}),u.stopPropagation()}))};this._forEachManipulator(d),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{handles:e,view:t}=this,i=this._tooltip=new $e({view:t}),a=()=>{i.info=this._getUpdatedTooltipInfo()};e.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",s=>{this._startAngle=s.angle,a()}),this.on("graphic-rotate",s=>{this._endAngle=s.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",s=>{X(this._startScale,s.xScale,s.yScale),X(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale",s=>{X(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale-stop",()=>{X(this._startScale,0,0),X(this._endScale,0,0),a()})]),this._forEachManipulator(s=>{e.add([s.events.on("focus-changed",a),s.events.on("grab-changed",a),s.events.on("drag",n=>{n.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this.graphicMoveManipulation.grabbing||this.graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():this.rotateManipulator.focused?this._computeRotateTooltipInfo():this.resizeManipulators.some(e=>e.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=ot(this._moveXYTooltipInfo,()=>new tt({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const e=this._moveZTooltipInfo=ot(this._moveZTooltipInfo,()=>new lt({tooltipOptions:this.tooltipOptions})),t=this._moveUnit;if(this.moveZManipulator.dragging){const i=this.mapBoundsStart.origin,a=this.mapBounds.origin,s=Kn(i,a,this.view.spatialReference);if(v(s))return null;e.distance=s}else e.distance=Te(0,t);return e}_computeRotateTooltipInfo(){const e=this._rotateTooltipInfo=ot(this._rotateTooltipInfo,()=>new Me({tooltipOptions:this.tooltipOptions}));return e.angle=this._startAngle-this._endAngle,e}_computeScaleTooltipInfo(){const e=this.graphic.geometry;if(v(e))return null;const t=this._scaleTooltipInfo=ot(this._scaleTooltipInfo,()=>new Lt({tooltipOptions:this.tooltipOptions})),i=Ta(this.mapBounds,this.zmax,e.spatialReference,this.graphicState.isDraped);return v(i)?null:(t.xSize=i[0],t.ySize=i[1],c(this.sizeStart)&&this.resizeManipulators.some(a=>a.dragging)?(t.xScale=i[0].value/this.sizeStart[0].value,t.yScale=i[1].value/this.sizeStart[1].value):(t.xScale=1,t.yScale=1),t)}_graphicDrapedChanged(){this.handles.remove(Ga),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",e=>{c(this.attachmentOrigin)&&Va(e.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()}),Ga)}_updateAllManipulatorAvailability(){this._forEachManipulator((e,t)=>this._updateManipulatorAvailability(e,t))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof et){const a=this.graphicState.displaying,s=this.enableZ&&Wt(this.graphic);switch(t){case O.ROTATE:e.available=a&&this.enableRotation;break;case O.SCALE:e.available=a&&(this.enableScaling||this.enableRotation||s),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?pn:cn;break;case O.TRANSLATE_Z:e.available=a&&s;break;default:e.available=a}}}_forEachManipulator(e){this.graphicMoveManipulation.forEachManipulator(e),this.resizeManipulators.forEach(t=>e(t,O.SCALE)),e(this.rotateManipulator,O.ROTATE),e(this.moveZManipulator,O.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}get _moveUnit(){return ot(dn(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const e=this.graphic.geometry,t=this.editGeometryOperations.data,i=t.components[0].edges[0],a=Wa(ie.get(),i.leftVertex.pos,i.rightVertex.pos);fi(a,a);const s=ot(wi(this.view,this.graphic),()=>e.extent.center);let n=vr*this.view.pixelSizeAt(s);const o=this.view.spatialReference,r=e.spatialReference;o.equals(r)||(n*=xi(o)/xi(r)),gr(a,t,n,this.mapBounds),this._calculateZMax()}_calculateZMax(){const e=this.editGeometryOperations.data;if(!e.geometry.hasZ)return void(this.zmax=0);const t=e.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of e.components)for(const s of a.vertices){const n=t.getZ(s.pos);i=Math.max(n,i)}this.zmax=i}_updateDisplayBounds(){const e=this.graphic.geometry;if(v(e))return;const t=c(this.outlineVisualElement)&&!this.graphicState.isDraped&&c(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:wi(this.view,this.graphic);this.attachmentOrigin=ot(t,e.extent.center);const i=c(t)?t.z:La(this.mapBounds.origin,this.view.elevationProvider,ai.fromElevationInfo(N(this.graphic)),this.view.renderCoordsHelper),a=It(this.mapBounds);a.origin[2]=i,mr(a,this.view.renderCoordsHelper,e.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return _r*this.view.pixelSizeAt(t)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline((e,t,i)=>this._applyGraphicMoveSteps(t,i,R.XY))}_createMoveZDragPipeline(){const e=this.view,t=this.editGeometryOperations.data.spatialReference;return pt(this.moveZManipulator,(i,a,s)=>{const n=Xa(i.renderLocation),o=a.next(Ja(e,n,t)).next(ue());this._applyGraphicMoveSteps(o,s,R.Z)})}_applyGraphicMoveSteps(e,t,i){const a=e.next(s=>(s.action==="start"&&(this.inputState={type:"move"},It(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})),s)).next(se()).next(this._moveDragUpdateGeometry()).next(s=>{const n={graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY};switch(s.action){case"start":case"update":(s.mapEnd.x-s.mapStart.x||s.mapEnd.y-s.mapStart.y||s.mapEnd.z-s.mapStart.z)&&this.emit("graphic-translate",n);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",n)}return s}).next(s=>this._updateMoveTooltip(s,i));return t.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_calculateSizeStart(){v(this.graphic.geometry)?this.sizeStart=null:this.sizeStart=Ta(this.mapBoundsStart,this.zmax,this.graphic.geometry.spatialReference,this.graphicState.isDraped)}_moveDragUpdateGeometry(){return e=>{if(v(this.inputState)||this.inputState.type!=="move")return e;const t=[];for(const s of this.editGeometryOperations.data.components)t.push(...s.vertices);const i=e.action==="start"?wt.NEW_STEP:wt.ACCUMULATE_STEPS,a=this.editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);return ke(a,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_updateMoveTooltip(e,t){if(t===R.XY||t===R.XY_AXIS){const i=Ee(e.mapStart,e.mapEnd,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(i)&&c(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return e}_onResizeGrab(e){if(e.action!=="start")return;const t=this._calculatePickRay(e.screenPoint);aa(this.displayBounds.plane,t,b.get())&&(It(this.displayBounds,this.displayBoundsStart),It(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return pt(e,(i,a,s)=>{v(this.inputState)||(a.next(n=>(n.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),n)).next(Ei(this.view,this.displayBoundsStart.plane)).next(n=>({...n,handle:t})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(n=>{const o={graphic:this.graphic,xScale:n.factor1,yScale:n.factor2};switch(n.action){case"start":case"update":this.emit("graphic-scale",o);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",o)}return n}),s.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return e=>{const t=this.displayBoundsStart,i=e.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,n=ui(b.get(),t.origin);Bt(n,n,t.basis1,-i[0]),Bt(n,n,t.basis2,-i[1]);const o=z(b.get(),e.renderEnd,n),r=z(b.get(),e.renderStart,n),l=ja(e.handle),d=sa(t),g=sa(this.displayBounds)/d,m=(u,f)=>{if(u===0)return 1;let y=pe(f),S=.5*u*Be(f,o)/y;const A=S<0?-1:1;l&&(S+=(y-.5*u*Be(f,r)/y)*A*g);const w=y<1.5*s?1:Ra;return y=Math.max(y-s,Ra),A>0&&(S-=a),A*Math.max(A*(S/y),w)};return{...e,factor1:m(i[0],t.basis1),factor2:m(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=ui(V(),this.mapBoundsStart.origin);Bt(t,t,this.mapBoundsStart.basis1,-e.handle.direction[0]),Bt(t,t,this.mapBoundsStart.basis2,-e.handle.direction[1]);const i=X(be(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);fi(i,i);const a=[];for(const o of this.editGeometryOperations.data.components)a.push(...o.vertices);const s=e.action==="start"?wt.NEW_STEP:wt.ACCUMULATE_STEPS,n=this.editGeometryOperations.scaleVertices(a,t,i,e.factor1,e.factor2,s,oa.REPLACE);return It(this.mapBoundsStart,this.mapBounds),ke(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_onRotateGrab(e){if(e.action!=="start")return;const t=un(this.displayBounds,this.view.renderCoordsHelper,gn.HEADING,Di()),i=this._calculatePickRay(e.screenPoint);aa(t,i,b.get())&&(It(this.displayBounds,this.displayBoundsStart),It(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.inputState={type:"rotate",rotatePlane:t})}_createRotateDragPipeline(e){return pt(e,(t,i,a)=>{const s=this.inputState;v(s)||(i.next(n=>(n.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),n)).next(Ei(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdateGeometry()).next(n=>{const o={graphic:this.graphic,angle:Oe(n.rotateAngle)};switch(n.action){case"start":case"update":this.emit("graphic-rotate",o);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",o)}return n}),a.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(e){return t=>{const i=De(e.rotatePlane),a=Ba(t.renderStart,t.renderEnd,this.displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return e=>{const t=ui(V(),this.mapBoundsStart.origin),i=[];for(const n of this.editGeometryOperations.data.components)i.push(...n.vertices);const a=e.action==="start"?wt.NEW_STEP:wt.ACCUMULATE_STEPS,s=this.editGeometryOperations.rotateVertices(i,t,e.rotateAngle,a,oa.REPLACE);return It(this.mapBoundsStart,this.mapBounds),ke(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_calculatePickRay(e){const t=mn(),i=_n(e);return vn(this.view.state.camera,i,t),Xe(t.direction,t.direction),t}_updateManipulators(){if(!this.visible)return;const e=yn(this.displayBounds,J.get());fn(this.rotateManipulator,e,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,e),this.resizeManipulators.forEach((t,i)=>{Mn(t,this.resizeHandles[i],e,this.displayBounds)})}_updateZMoveHandle(e,t){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:z(b.get(),i.origin,i.basis1),edge:2},s=J.get();bn(s,t,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}_cancel(){const e=this.editGeometryOperations.lastOperation;v(e)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,Aa(e,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,Aa(T(e),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,ke(T(e),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator,tooltip:this._tooltip}}};h([p({constructOnly:!0,nonNullable:!0})],K.prototype,"view",void 0),h([p({constructOnly:!0,nonNullable:!0})],K.prototype,"graphic",void 0),h([p({constructOnly:!0,nonNullable:!0})],K.prototype,"enableZ",void 0),h([p()],K.prototype,"enableRotation",void 0),h([p()],K.prototype,"enableScaling",void 0),h([p({constructOnly:!0,type:mt})],K.prototype,"tooltipOptions",void 0),h([p()],K.prototype,"preserveAspectRatio",null),h([p()],K.prototype,"grabbing",void 0),h([p()],K.prototype,"inputState",void 0),h([p({readOnly:!0})],K.prototype,"type",void 0),h([p()],K.prototype,"_moveUnit",null),K=h([C("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],K);const Ga="draped-elevation-changes",_r=10,vr=80,Ra=1e-6;export{Pt as DrawGraphicTool3D,K as ExtentTransformTool,vt as GraphicMoveTool,U as GraphicReshapeTool,q as GraphicTransformTool};
