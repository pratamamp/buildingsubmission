import{ai as $,e as o,g as l,jI as N,gx as G,jJ as C,n as Q,I as M,Q as S,aH as b,gt as v,gu as I,jK as R,l as f,P as B,b9 as L,E as q,jL as P,jM as T,jN as _,jO as V,jP as z,jQ as j,jR as m,w as F,s as g,jS as D}from"./index.46140dee.js";import{o as O}from"./floorFilterUtils.69500d62.js";import{s as w,d as U}from"./popupUtils.69afd071.js";const y=$.getLogger("esri.views.layers.FeatureLayerView"),K=A=>{let n=class extends A{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([M(()=>{var t;const e=this.layer;return[(t=e==null?void 0:e.elevationInfo)==null?void 0:t.featureExpressionInfo,e==null?void 0:e.displayField,e==null?void 0:e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),S),b(()=>{var e;return(e=this.view)==null?void 0:e.floors},"change",()=>this._handleRequiredFieldsChange()),b(()=>{const e=this.layer;return e&&"sublayers"in e&&e.sublayers},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?v(t,[...I(t,e.outFields),...r]):v(t,r)}set effect(e){R(y,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=e}get effect(){return R(y,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){e!==void 0?this._override("featureEffect",e):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){y.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=f(this.filter)?this.filter.createQuery(e):new B(e);if(this.layer.type==="feature"){const r=O(this);f(r)&&(t.where=t.where?`(${t.where}) AND (${r})`:r)}return f(this.timeExtent)&&(t.timeExtent=f(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeatures(e,t){const r=this.validateFetchPopupFeatures(t);if(r)throw r;return this.fetchClientPopupFeatures(t)}_loadArcadeModules(e){if(e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some(t=>t.type==="expression"))return L()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then(()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e=this.view.type==="3d",{layer:t,layer:{fieldsIndex:r,objectIdField:u}}=this,p="renderer"in t&&t.renderer,s="orderBy"in t&&t.orderBy,a=t.featureReduction,i=new Set,h=await q([p?p.collectRequiredFields(i,r):null,P(i,t),e?T(i,t):null,f(this.filter)?_(i,t,this.filter):null,f(this.featureEffect)?_(i,t,this.featureEffect.filter):null,a?V(i,t,a):null,s?z(i,t,s):null]);if(t.timeInfo&&this.timeExtent&&j(i,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),t.type==="feature"&&t.floorInfo&&j(i,t.fieldsIndex,[t.floorInfo.floorField]),t.type==="subtype-group"){m(i,r,t.subtypeField);const d=t.sublayers.map(E=>{var x;return Promise.all([(x=E.renderer)==null?void 0:x.collectRequiredFields(i,r),P(i,E)])});await q(d)}for(const d of h)d.error&&y.error(d.error);m(i,r,u),e&&"displayField"in t&&t.displayField&&m(i,r,t.displayField);const c=Array.from(i).sort();this._set("requiredFields",c)}validateFetchPopupFeatures(e){if(F(e))return null;for(const t of e.clientGraphics){const r=t.layer;if("popupEnabled"in r&&!r.popupEnabled)return new g("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r});if(t.isAggregate){if(!(r.featureReduction&&"popupTemplate"in r.featureReduction&&r.featureReduction.popupEnabled&&r.featureReduction.popupTemplate))return new g("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r})}else if("popupTemplate"in r&&!w(r,e))return new g("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:r})}}async fetchClientPopupFeatures(e){const t=f(e)?e.clientGraphics:null;if(!t||t.length===0)return[];const r=new Array(t.length),u=new Map,p=await this.createPopupQuery(e);for(let s=0;s<t.length;s++){const a=t[s];if(a.isAggregate){r[s]=a;continue}const{layer:i}=a;if(!("popupEnabled"in i))continue;const h=I(this.layer.fieldsIndex,p.outFields),c=w(i,e);if(F(c))continue;const d=await this._loadArcadeModules(c);d&&d.arcadeUtils.hasGeometryOperations(c)||!D(h,a)?u.set(a.getObjectId(),s):r[s]=a}if(this.layer.type==="stream"||u.size===0)return r.filter(Boolean);p.objectIds=Array.from(u.keys());try{const s=await this.layer.queryFeatures(p);for(const a of s.features)r[u.get(a.getObjectId())]=a}catch{}return r.filter(Boolean)}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let u=!1;const p=f(e)&&e.clientGraphics?e.clientGraphics.map(s=>s.layer):[this.layer];for(const s of p){if(!("popupEnabled"in s))continue;const a=w(s,e);if(F(a))continue;const i=await this._loadArcadeModules(a),h=i&&i.arcadeUtils.hasGeometryOperations(a);u=!(this.layer.geometryType!=="point"&&!h);const c=await U(this.layer,a);for(const d of c)r.add(d)}if(t.returnGeometry=u,t.returnZ=u,t.returnM=u,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){const s=O(this);f(s)&&(t.where=t.where?`(${t.where}) AND (${s})`:s)}return t}canResume(){return!!super.canResume()&&(!f(this.timeExtent)||!this.timeExtent.isEmpty)}};return o([l()],n.prototype,"_updatingRequiredFieldsPromise",void 0),o([l({readOnly:!0})],n.prototype,"availableFields",null),o([l()],n.prototype,"effect",null),o([l({type:N})],n.prototype,"featureEffect",null),o([l({type:G})],n.prototype,"filter",void 0),o([l(C)],n.prototype,"timeExtent",void 0),o([l()],n.prototype,"layer",void 0),o([l({type:Number})],n.prototype,"maximumNumberOfFeatures",null),o([l({readOnly:!0,type:Boolean})],n.prototype,"maximumNumberOfFeaturesExceeded",null),o([l({readOnly:!0})],n.prototype,"requiredFields",void 0),o([l()],n.prototype,"suspended",void 0),o([l()],n.prototype,"view",void 0),n=o([Q("esri.views.layers.FeatureLayerView")],n),n};export{K as A};
