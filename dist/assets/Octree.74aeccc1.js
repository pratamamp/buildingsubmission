import{g0 as q,a6 as k,gk as Ot,gg as mt,hJ as Rt,C as At,hG as g,A as p,ba as Et,fa as z,r as J,hE as tt,g4 as et,hK as pt,J as f}from"./index.52935b46.js";import{s as lt,f as Nt,r as Ft}from"./vectorStacks.a7af424f.js";import{d as nt,l as bt,q as C,j as ot,k as U,E as H,X as rt,_ as j}from"./sphere.fe54e1ae.js";import{p as A,A as gt,j as x,H as Mt}from"./plane.1ed71234.js";import{c as st}from"./Util.221caaac.js";function dt(o){return o?{ray:nt(o.ray),c0:o.c0,c1:o.c1}:{ray:nt(),c0:0,c1:Number.MAX_VALUE}}function wt(o,t=dt()){return bt(o,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function qt(o,t){return ct(o,o.c0,t)}function kt(o,t){return ct(o,o.c1,t)}function ct(o,t,e){return q(e,o.ray.origin,k(e,o.ray.direction,t))}new lt(()=>({c0:0,c1:0,ray:null}));function Ct(o){return o?[A(o[0]),A(o[1]),A(o[2]),A(o[3]),A(o[4]),A(o[5])]:[A(),A(),A(),A(),A(),A()]}function Bt(){return[p(),p(),p(),p(),p(),p(),p(),p()]}function Ut(o,t){for(let e=0;e<D.NUM;e++)gt(o[e],t[e])}function Kt(o,t,e,n=xt){const r=Ot(Nt.get(),t,o);mt(r,r);for(let s=0;s<Q.NUM;++s){const i=Rt(Ft.get(),St[s],r);At(n[s],i[0]/i[3],i[1]/i[3],i[2]/i[3])}It(e,n)}function It(o,t){x(t[h.FAR_BOTTOM_LEFT],t[h.NEAR_BOTTOM_LEFT],t[h.NEAR_TOP_LEFT],o[M.LEFT]),x(t[h.NEAR_BOTTOM_RIGHT],t[h.FAR_BOTTOM_RIGHT],t[h.FAR_TOP_RIGHT],o[M.RIGHT]),x(t[h.FAR_BOTTOM_LEFT],t[h.FAR_BOTTOM_RIGHT],t[h.NEAR_BOTTOM_RIGHT],o[M.BOTTOM]),x(t[h.NEAR_TOP_LEFT],t[h.NEAR_TOP_RIGHT],t[h.FAR_TOP_RIGHT],o[M.TOP]),x(t[h.NEAR_BOTTOM_LEFT],t[h.NEAR_BOTTOM_RIGHT],t[h.NEAR_TOP_RIGHT],o[M.NEAR]),x(t[h.FAR_BOTTOM_RIGHT],t[h.FAR_BOTTOM_LEFT],t[h.FAR_TOP_LEFT],o[M.FAR])}function v(o,t){for(let e=0;e<D.NUM;e++){const n=o[e];if(n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]>=t[3])return!1}return!0}function Wt(o,t){for(let e=0;e<D.NUM;e++){const n=o[e];if(!Mt(n,t))return!1}return!0}var M,h;(function(o){o[o.LEFT=0]="LEFT",o[o.RIGHT=1]="RIGHT",o[o.BOTTOM=2]="BOTTOM",o[o.TOP=3]="TOP",o[o.NEAR=4]="NEAR",o[o.FAR=5]="FAR"})(M||(M={})),function(o){o[o.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",o[o.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",o[o.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",o[o.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",o[o.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",o[o.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",o[o.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",o[o.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(h||(h={}));h.FAR_BOTTOM_RIGHT,h.NEAR_BOTTOM_RIGHT,h.NEAR_BOTTOM_LEFT,h.FAR_BOTTOM_LEFT,h.NEAR_BOTTOM_LEFT,h.NEAR_BOTTOM_RIGHT,h.NEAR_TOP_RIGHT,h.NEAR_TOP_LEFT,h.FAR_BOTTOM_RIGHT,h.FAR_BOTTOM_LEFT,h.FAR_TOP_LEFT,h.FAR_TOP_RIGHT,h.NEAR_BOTTOM_RIGHT,h.FAR_BOTTOM_RIGHT,h.FAR_TOP_RIGHT,h.NEAR_TOP_RIGHT,h.FAR_BOTTOM_LEFT,h.NEAR_BOTTOM_LEFT,h.NEAR_TOP_LEFT,h.FAR_TOP_LEFT,h.FAR_TOP_LEFT,h.NEAR_TOP_LEFT,h.NEAR_TOP_RIGHT,h.FAR_TOP_RIGHT;var D,Q;(function(o){o[o.NUM=6]="NUM"})(D||(D={})),function(o){o[o.NUM=8]="NUM"}(Q||(Q={}));const St=[g(-1,-1,-1,1),g(1,-1,-1,1),g(1,1,-1,1),g(-1,1,-1,1),g(-1,-1,1,1),g(1,-1,1,1),g(1,1,1,1),g(-1,1,1,1)];new lt(dt);const xt=Bt();class L{constructor(t,e){this._objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new d,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),d.clearPool(),Y[0]=null,I.prune(),S.prune()}add(t,e=t.length){this._objectCount+=e,this._grow(t,e);const n=d.acquire();for(let r=0;r<e;r++){const s=t[r];this._isDegenerate(s)?this._degenerateObjects.add(s):(n.init(this._root),this._add(s,n))}d.release(n)}remove(t,e=null){this._objectCount-=t.length;const n=d.acquire();for(const r of t){const s=J(e)?e:C(this._objectToBoundingSphere(r),Ht);$(s[3])?(n.init(this._root),this._remove(r,s,n)):this._degenerateObjects.delete(r)}d.release(n),this._shrink()}update(t,e){if(!$(e[3])&&this._isDegenerate(t))return;const n=Gt(t);this.remove(n,e),this.add(n)}forEachAlongRay(t,e,n){const r=ot(t,e);this._forEachNode(this._root,s=>{if(!this._intersectsNode(r,s))return!1;const i=s.node;return i.terminals.forAll(a=>{this._intersectsObject(r,a)&&n(a)}),i.residents!==null&&i.residents.forAll(a=>{this._intersectsObject(r,a)&&n(a)}),!0})}forEachAlongRayWithVerticalOffset(t,e,n,r){const s=ot(t,e);this._forEachNode(this._root,i=>{if(!this._intersectsNodeWithOffset(s,i,r))return!1;const a=i.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(s,l,r)&&n(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(s,l,r)&&n(l)}),!0})}forEach(t){this._forEachNode(this._root,e=>{const n=e.node;return n.terminals.forAll(t),n.residents!==null&&n.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,n,r=()=>!0,s=1/0){let i=1/0,a=1/0,l=null;const c=K(t,e),T=u=>{if(--s,!r(u))return;const R=this._objectToBoundingSphere(u);if(!v(n,R))return;const F=B(t,e,H(R)),P=F-R[3],_=F+R[3];P<i&&(i=P,a=_,l=u)};return this._forEachNodeDepthOrdered(this._root,u=>{if(s<=0||!v(n,u.bounds)||(k(E,c,u.halfSize),q(E,E,u.bounds),B(t,e,E)>a))return!1;const R=u.node;return R.terminals.forAll(F=>T(F)),R.residents!==null&&R.residents.forAll(F=>T(F)),!0},t,e),l}forEachInDepthRange(t,e,n,r,s,i,a){let l=-1/0,c=1/0;const T={setRange:_=>{n===L.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,_.near),c=Math.min(c,_.far)):(l=Math.max(l,-_.far),c=Math.min(c,-_.near))}};T.setRange(r);const u=B(e,n,t),R=K(e,n),F=K(e,-n),P=_=>{if(!a(_))return;const b=this._objectToBoundingSphere(_),G=H(b),Z=B(e,n,G)-u,ft=Z-b[3],Tt=Z+b[3];ft>c||Tt<l||!v(i,b)||s(_,T)};this._forEachNodeDepthOrdered(this._root,_=>{if(!v(i,_.bounds)||(k(E,R,_.halfSize),q(E,E,_.bounds),B(e,n,E)-u>c)||(k(E,F,_.halfSize),q(E,E,_.bounds),B(e,n,E)-u<l))return!1;const b=_.node;return b.terminals.forAll(G=>P(G)),b.residents!==null&&b.residents.forAll(G=>P(G)),!0},e,n)}forEachNode(t){this._forEachNode(this._root,e=>t(e.node,e.bounds,e.halfSize))}forEachNeighbor(t,e){const n=U(e),r=H(e),s=i=>{const a=this._objectToBoundingSphere(i),l=U(a),c=n+l;tt(H(a),r)-c*c<=0&&t(i)};this._forEachNode(this._root,i=>{const a=U(i.bounds),l=n+a;if(tt(H(i.bounds),r)-l*l>0)return!1;const c=i.node;return c.terminals.forAll(T=>s(T)),c.residents!==null&&c.residents.forAll(T=>s(T)),!0}),this.forEachDegenerateObject(s)}_intersectsNode(t,e){return y(e.bounds,2*-e.halfSize,O),y(e.bounds,2*e.halfSize,m),st(t.origin,t.direction,O,m)}_intersectsNodeWithOffset(t,e,n){return y(e.bounds,2*-e.halfSize,O),y(e.bounds,2*e.halfSize,m),n.applyToMinMax(O,m),st(t.origin,t.direction,O,m)}_intersectsObject(t,e){const n=this._objectToBoundingSphere(e);return!(n[3]>0)||rt(n,t)}_intersectsObjectWithOffset(t,e,n){const r=this._objectToBoundingSphere(e);return!(r[3]>0)||rt(n.applyToBoundingSphere(r),t)}_forEachNode(t,e){let n=d.acquire().init(t);const r=[n];for(;r.length!==0;){if(n=r.pop(),e(n)&&!n.isLeaf())for(let s=0;s<n.node.children.length;s++)n.node.children[s]&&r.push(d.acquire().init(n).advance(s));d.release(n)}}_forEachNodeDepthOrdered(t,e,n,r=L.DepthOrder.FRONT_TO_BACK){let s=d.acquire().init(t);const i=[s];for(Pt(n,r,at);i.length!==0;){if(s=i.pop(),e(s)&&!s.isLeaf())for(let a=7;a>=0;--a){const l=at[a];s.node.children[l]&&i.push(d.acquire().init(s).advance(l))}d.release(s)}}_remove(t,e,n){I.clear();const r=n.advanceTo(e,(s,i)=>{I.push(s.node),I.push(i)})?n.node.terminals:n.node.residents;if(r.removeUnordered(t),r.length===0)for(let s=I.length-2;s>=0;s-=2){const i=I.data[s],a=I.data[s+1];if(!this._purge(i,a))break}}_nodeIsEmpty(t){if(t.terminals.length!==0)return!1;if(t.residents!==null)return t.residents.length===0;for(let e=0;e<t.children.length;e++)if(t.children[e])return!1;return!0}_purge(t,e){return e>=0&&(t.children[e]=null),!!this._nodeIsEmpty(t)&&(t.residents===null&&(t.residents=new z({shrink:!0})),!0)}_add(t,e){e.advanceTo(this._objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let n=0;n<e.length;n++){const r=d.acquire().init(t);this._add(e.getItemAt(n),r),d.release(r)}}_grow(t,e){if(e!==0&&(it(t,e,n=>this._objectToBoundingSphere(n),N),$(N[3])&&!this._fitsInsideTree(N)))if(this._nodeIsEmpty(this._root.node))C(N,this._root.bounds),this._root.halfSize=1.25*N[3];else{const n=this._rootBoundsForRootAsSubNode(N);this._placingRootViolatesMaxDepth(n)?this._rebuildTree(N,n):this._growRootAsSubNode(n),d.release(n)}}_rebuildTree(t,e){et(V,e.bounds),V[3]=e.halfSize,it([t,V],2,r=>r,X);const n=d.acquire().init(this._root);this._root.initFrom(null,X,1.25*X[3]),this._forEachNode(n,r=>(this.add(r.node.terminals.data,r.node.terminals.length),r.node.residents!==null&&this.add(r.node.residents.data,r.node.residents.length),!0)),d.release(n)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return this._forEachNode(this._root,r=>(n=Math.max(n,r.depth),n+e<=this._maximumDepth)),n+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],n=t;let r=-1/0;const s=this._root.bounds,i=this._root.halfSize;for(let a=0;a<3;a++){const l=s[a]-i-(n[a]-e),c=n[a]+e-(s[a]+i),T=Math.max(0,Math.ceil(l/(2*i))),u=Math.max(0,Math.ceil(c/(2*i)))+1,R=2**Math.ceil(Math.log(T+u)*Math.LOG2E);r=Math.max(r,R),w[a].min=T,w[a].max=u}for(let a=0;a<3;a++){let l=w[a].min,c=w[a].max;const T=(r-(l+c))/2;l+=Math.ceil(T),c+=Math.floor(T);const u=s[a]-i-l*i*2;W[a]=u+(c+l)*i}return W[3]=r*i*_t,d.acquire().initFrom(null,W,r*i,0)}_growRootAsSubNode(t){const e=this._root.node;et(N,this._root.bounds),N[3]=this._root.halfSize,this._root.init(t),t.advanceTo(N,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let n=0,r=0;for(;r<e.length&&t==null;)n=r++,t=e[n];for(;r<e.length;)if(e[r++])return-1;return n}_isDegenerate(t){return!$(this._objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,n=this._root.halfSize;return t[3]<=n&&t[0]>=e[0]-n&&t[0]<=e[0]+n&&t[1]>=e[1]-n&&t[1]<=e[1]+n&&t[2]>=e[2]-n&&t[2]<=e[2]+n}}class d{constructor(){this.bounds=j(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,n,r=this.depth){return this.node=J(t)?t:d.createEmptyNode(),J(e)&&C(e,this.bounds),this.halfSize=n,this.depth=r,this}advance(t){let e=this.node.children[t];e||(e=d.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const n=ut[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.bounds[3]=this.halfSize*_t,this}advanceTo(t,e,n=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!n)return e&&e(this,-1),!1;this.node.residents=null}const r=this._childIndex(t);e&&e(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new z({shrink:!0}),residents:new z({shrink:!0})}}static acquire(){return d._pool.acquire()}static release(t){d._pool.release(t)}static clearPool(){d._pool.prune()}}function Lt(o,t){o[0]=Math.min(o[0],t[0]-t[3]),o[1]=Math.min(o[1],t[1]-t[3]),o[2]=Math.min(o[2],t[2]-t[3])}function jt(o,t){o[0]=Math.max(o[0],t[0]+t[3]),o[1]=Math.max(o[1],t[1]+t[3]),o[2]=Math.max(o[2],t[2]+t[3])}function y(o,t,e){e[0]=o[0]+t,e[1]=o[1]+t,e[2]=o[2]+t}function it(o,t,e,n){if(t===1){const r=e(o[0]);C(r,n)}else{O[0]=1/0,O[1]=1/0,O[2]=1/0,m[0]=-1/0,m[1]=-1/0,m[2]=-1/0;for(let r=0;r<t;r++){const s=e(o[r]);$(s[3])&&(Lt(O,s),jt(m,s))}pt(n,O,m,.5),n[3]=Math.max(m[0]-O[0],m[1]-O[1],m[2]-O[2])/2}}function Pt(o,t,e){if(!S.length)for(let n=0;n<8;++n)S.push({index:0,distance:0});for(let n=0;n<8;++n){const r=ut[n];S.data[n].index=n,S.data[n].distance=B(o,t,r)}S.sort((n,r)=>n.distance-r.distance);for(let n=0;n<8;++n)e[n]=S.data[n].index}function K(o,t){let e=1/0,n=null;for(let r=0;r<8;++r){const s=B(o,t,ht[r]);s<e&&(e=s,n=ht[r])}return n}function B(o,t,e){return t*(o[0]*e[0]+o[1]*e[1]+o[2]*e[2])}function $(o){return!isNaN(o)&&o!==-1/0&&o!==1/0&&o>0}d._pool=new Et(d),function(o){var t;(t=o.DepthOrder||(o.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(L||(L={}));const ut=[f(-1,-1,-1),f(1,-1,-1),f(-1,1,-1),f(1,1,-1),f(-1,-1,1),f(1,-1,1),f(-1,1,1),f(1,1,1)],ht=[f(-1,-1,-1),f(-1,-1,1),f(-1,1,-1),f(-1,1,1),f(1,-1,-1),f(1,-1,1),f(1,1,-1),f(1,1,1)],_t=Math.sqrt(3),Y=[null];function Gt(o){return Y[0]=o,Y}const W=j(),E=p(),O=p(),m=p(),I=new z,Ht=j(),N=j(),V=j(),X=j(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],S=new z,at=[0,0,0,0,0,0,0,0],Vt=L;export{Vt as G,Ct as H,Kt as a,Ut as i,M as k,qt as l,Wt as m,wt as p,dt as s,kt as v};
