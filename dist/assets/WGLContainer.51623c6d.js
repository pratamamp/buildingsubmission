import{ai as R,fF as L,a9 as w,cD as u,s as _,fG as S,cS as G,l,ct as I,cF as A,d2 as y,fH as C,dw as v,dC as P,I as b,w as B,cz as M,cV as T}from"./index.f5fb6b4d.js";import{W as U}from"./brushes.e5622ff7.js";import{s as $}from"./Container.42f5d0eb.js";import{w as o}from"./number.08b65821.js";import{I as d}from"./Utils.cfa3e151.js";const D=R.getLogger("esri.views.2d.engine.webgl.Mesh2D"),H=f=>{switch(f.BYTES_PER_ELEMENT){case 1:return y.UNSIGNED_BYTE;case 2:return y.UNSIGNED_SHORT;case 4:return y.UNSIGNED_INT;default:throw new _("Cannot get DataType of array")}},N=(f,t,e,s)=>{let r=0;for(let i=1;i<e;i++){const n=f[2*(t+i-1)],a=f[2*(t+i-1)+1];r+=(f[2*(t+i)]-n)*(f[2*(t+i)+1]+a)}return s?r>0:r<0},E=({coords:f,lengths:t},e)=>{const s=[];for(let r=0,i=0;r<t.length;i+=t[r],r+=1){const n=i,a=[];for(;r<t.length-1&&N(f,i+t[r],t[r+1],e);r+=1,i+=t[r])a.push(i+t[r]-n);const c=f.slice(2*n,2*(i+t[r])),p=C(c,a,2);for(const m of p)s.push(m+n)}return s};class h{constructor(t,e,s,r=!1){this._cache={},this.vertices=t,this.indices=e,this.primitiveType=s,this.isMapSpace=r}static fromRect({x:t,y:e,width:s,height:r}){const i=t,n=e,a=i+s,c=n+r;return h.fromScreenExtent({xmin:i,ymin:n,xmax:a,ymax:c})}static fromPath(t){const e=L(new w,t.path,!1,!1),s=e.coords,r=new Uint32Array(E(e,!0)),i=new Uint32Array(s.length/2);for(let n=0;n<i.length;n++)i[n]=o(Math.floor(s[2*n]),Math.floor(s[2*n+1]));return new h({geometry:i},r,u.TRIANGLES)}static fromGeometry(t,e){const s=e.geometry.type;switch(s){case"polygon":return h.fromPolygon(t,e.geometry);case"extent":return h.fromMapExtent(t,e.geometry);default:return D.error(new _("mapview-bad-type",`Unable to create a mesh from type ${s}`,e)),h.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(t,e){const s=S(new w,e,!1,!1),r=s.coords,i=new Uint32Array(E(s,!1)),n=new Uint32Array(r.length/2),a=v(),c=v();for(let p=0;p<n.length;p++)G(a,r[2*p],r[2*p+1]),t.toScreen(c,a),n[p]=o(Math.floor(c[0]),Math.floor(c[1]));return new h({geometry:n},i,u.TRIANGLES,!0)}static fromScreenExtent({xmin:t,xmax:e,ymin:s,ymax:r}){const i={geometry:new Uint32Array([o(t,s),o(e,s),o(t,r),o(t,r),o(e,s),o(e,r)])},n=new Uint32Array([0,1,2,3,4,5]);return new h(i,n,u.TRIANGLES)}static fromMapExtent(t,e){const[s,r]=t.toScreen([0,0],[e.xmin,e.ymin]),[i,n]=t.toScreen([0,0],[e.xmax,e.ymax]),a={geometry:new Uint32Array([o(s,r),o(i,r),o(s,n),o(s,n),o(i,r),o(i,n)])},c=new Uint32Array([0,1,2,3,4,5]);return new h(a,c,u.TRIANGLES)}destroy(){l(this._cache.indexBuffer)&&this._cache.indexBuffer.dispose();for(const t in this._cache.vertexBuffers)l(this._cache.vertexBuffers[t])&&this._cache.vertexBuffers[t].dispose()}get elementType(){return H(this.indices)}getIndexBuffer(t,e=A.STATIC_DRAW){return this._cache.indexBuffer||(this._cache.indexBuffer=I.createIndex(t,e,this.indices)),this._cache.indexBuffer}getVertexBuffers(t,e=A.STATIC_DRAW){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce((s,r)=>({...s,[r]:I.createVertex(t,e,this.vertices[r])}),{})),this._cache.vertexBuffers}}const O=R.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),g=f=>parseFloat(f)/100;class x extends P{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=b(()=>e.version,()=>this._invalidate()),this.ready()}static fromClipArea(t,e){return new x(t,e)}_destroyGL(){l(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),l(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null)}destroy(){this._destroyGL(),this._handle.remove()}getVAO(t,e,s,r){const[i,n]=e.size;if(this._clip.type!=="geometry"&&this._lastWidth===i&&this._lastHeight===n||(this._lastWidth=i,this._lastHeight=n,this._destroyGL()),B(this._cache.vao)){const a=this._createMesh(e,this._clip),c=a.getIndexBuffer(t),p=a.getVertexBuffers(t);this._cache.mesh=a,this._cache.vao=new M(t,s,r,p,c)}return this._cache.vao}_createTransforms(){return{dvs:T()}}_invalidate(){this._destroyGL(),this.requestRender()}_createScreenRect(t,e){const[s,r]=t.size,i=typeof e.left=="string"?g(e.left)*s:e.left,n=typeof e.right=="string"?g(e.right)*s:e.right,a=typeof e.top=="string"?g(e.top)*r:e.top,c=typeof e.bottom=="string"?g(e.bottom)*r:e.bottom,p=i,m=a;return{x:p,y:m,width:Math.max(s-n-p,0),height:Math.max(r-c-m,0)}}_createMesh(t,e){switch(e.type){case"rect":return h.fromRect(this._createScreenRect(t,e));case"path":return h.fromPath(e);case"geometry":return h.fromGeometry(t,e);default:return O.error(new _("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),h.fromRect({x:0,y:0,width:1,height:1})}}}class Y extends ${constructor(){super(...arguments),this.name=this.constructor.name}set clips(t){this._clips=t,this.children.forEach(e=>e.clips=t),this._updateClippingInfo()}_createTransforms(){return{dvs:T()}}doRender(t){const e=this.createRenderParams(t),{painter:s,globalOpacity:r,profiler:i,drawPhase:n}=e,a=n===d.LABEL||n===d.HIGHLIGHT?1:r*this.computedOpacity;i.recordContainerStart(this.name),s.beforeRenderLayer(e,this._clippingInfos?255:0,a),this.updateTransforms(t.state),this.renderChildren(e),s.compositeLayer(e,a),i.recordContainerEnd()}renderChildren(t){B(this._renderPasses)&&(this._renderPasses=this.prepareRenderPasses(t.painter));for(const e of this.children)e.beforeRender(t);for(const e of this._renderPasses)try{e.render(t)}catch{}for(const e of this.children)e.afterRender(t)}createRenderParams(t){return t.requireFBO=this.requiresDedicatedFBO,t}prepareRenderPasses(t){return[t.registerRenderPass({name:"clip",brushes:[U.clip],target:()=>this._clippingInfos,drawPhase:d.MAP|d.LABEL|d.LABEL_ALPHA|d.DEBUG|d.HIGHLIGHT})]}updateTransforms(t){for(const e of this.children)e.setTransform(t)}onAttach(){super.onAttach(),this._updateClippingInfo()}onDetach(){super.onDetach(),this._updateClippingInfo()}_updateClippingInfo(){if(l(this._clippingInfos)&&(this._clippingInfos.forEach(e=>e.destroy()),this._clippingInfos=null),!this.stage)return;const t=this._clips;l(t)&&t.length&&(this._clippingInfos=t.items.map(e=>x.fromClipArea(this.stage,e))),this.requestRender()}}export{Y as a};
