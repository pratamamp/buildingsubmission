import{$ as h,a0 as _,a1 as B,a2 as Ii,an as xo,kb as Eo,q as Oo,R as L,r as c,dz as Ao,eQ as Gt,t as m,k4 as To,ir as Po,kc as mr,kd as fr,jv as Ro,x as ne,k2 as ca,ke as ei,jW as Do,ad as Mt,K as da,af as Vt,ab as be,kf as $o,A as b,gf as pa,al as Gi,C as Z,g9 as P,e2 as nt,hF as Ss,g4 as j,c as Hs,f3 as js,gh as xe,ga as Ka,g1 as re,g8 as Me,g0 as z,hJ as vr,gp as ua,kg as yr,am as ot,J as N,h as R,gn as ga,gM as Ve,gE as Ne,L as W,j$ as Co,j1 as ws,S as je,hG as rt,W as _a,gb as Lo,jB as ma,kh as es,ki as ts,gr as Vi,kj as ye,bg as he,j0 as ee,kk as pi,hK as yt,kl as Io,km as Ua,j_ as xt,hB as Go,eI as Vo,aL as zo,ej as br,I as Xe,a6 as Q,hb as Mr,gc as No,gl as Fo,kn as Sr,ko,kp as Uo,jM as Pa,jN as Qe,kq as jt,jV as ge,kr as Bs,fE as k,ks as is,aj as qs,a8 as ti,kt as ae,ku as as,kv as Ho,kw as fa,cu as jo,gu as Ys,gw as Ws,kx as Zs,ky as ss,hE as wr,e5 as Bo,kz as ns,kA as qo,kB as E,kC as Yo,gk as Ye,kD as Wo,kE as Zo,kF as Xo,kG as rs,gg as Qo,kH as X,kI as xr,kJ as Jo,kK as Ko,di as Er,kL as Xs,jQ as Or,a5 as Te,g5 as Ei,kM as xs,hH as Ar,gd as va,kN as el,kO as Tr,kP as tl,e as Pr,a9 as si,Z as Rr,cq as il,kQ as al,kR as Dr,jO as sl,dy as Es,g7 as $r,hD as nl,e0 as Os,fD as At,kS as Qs,kT as Js,c6 as os,dn as rl,kU as ol,kV as ll,d$ as ya,P as hl,ge as Ks,kW as cl,gC as Oi,kX as dl,jd as ls,eC as pl,jP as ul,co as en,kY as tn,kZ as an,cp as gl,k_ as _l,s as ml,k$ as sn,l0 as nn,k6 as rn,k3 as on,l1 as fl,l2 as vl,hC as Ct,jH as yl,l3 as bl}from"./index.52935b46.js";import{a as Ml,x as Sl,_ as wl,F as xl,G as El,n as Ol,r as Al,b as As,d as Tl,w as Pl,p as ze,C as Si,e as Rl,f as li,D as Zt,g as lt,y as wt,h as Ra,i as ba,R as Dl,M as $l,j as Ai,k as Ma,m as zi,v as Cl,l as Ll,o as Il,q as Gl,s as Ti,t as Ha,u as ln,z as Xi,A as Vl}from"./drawSurfaces.7da3d09c.js";import{r as Ft,t as Cr}from"./vec4f32.8f10672a.js";import{s as Lr,p as Ir,m as Gr,l as Vr,v as zr}from"./Octree.74aeccc1.js";import{v as Pi,h as Sa,j as Dt,m as zl,l as wi,b as Nl,B as Fl}from"./lineSegment.42c0099b.js";import{_ as kl,j as hs,d as Ni,p as ja,e as Ul,h as hn,i as Hl}from"./sphere.fe54e1ae.js";import{p as hi,_ as kt,q as ni,Z as Fi,J as jl}from"./plane.1ed71234.js";import{o as Bl}from"./glUtil.345a77b1.js";import{T as Nr}from"./InterleavedLayout.b5350ce1.js";import{O as A}from"./VertexAttribute.5551e0d8.js";import{a as ql,o as Ee,e as cs,c as Fr,b as Lt,n as $,i as ki,d as ds,f as Ui,g as Hi,t as ji,h as U,j as Yl,k as Wl,E as Ts,S as Zl,l as Oe,B as Xl,u as Ql,m as D,p as Jl,L as kr,q as Ur,r as Kl,s as q,v as Hr,w as jr,x as Br,y as Ps,z as wa,A as qr,C as eh,D as Yr,F as Wr,G as ps,H as th,I as Zr,J as ih,K as ah,M as cn,N as sh,O as nh,P as rh,Q as oh}from"./Matrix4Uniform.9e24b035.js";import{e as _e,t as lh,o as hh}from"./mat4f64.84d5c445.js";import{n as ch,s as dh,o as ph,a as Ba,r as dn,l as Rs,O as Ds,H as ri,T as V,b as uh,J as gh,m as $s,h as Bi,c as _h,d as Be,e as us,f as mh,E as pn,g as fh,P as Qi,i as vh,j as un,R as yh,k as Xr,p as bh,K as Mh,Z as gn,q as qa,w as Sh,t as wh,u as xh,v as Eh,W as Cs}from"./NativeLineMaterial.b0f0cd6a.js";import{R as qe,E as Qr,F as Oh,I as la}from"./enums.de935fa5.js";import{W as qi,s as Ls,c as Yi,o as Da,O as Ze,n as K,b as Ah,E as Jr,h as Kr,d as eo,S as to,f as Th,l as Ph,e as Rh,i as Dh,_ as $h}from"./requestImageUtils.16628477.js";import{f as Ch,c as Lh}from"./VertexArrayObject.b7add78f.js";import{c as M,f as se,t as bt,o as _n}from"./vectorStacks.a7af424f.js";import{r as Ih,e as xa,S as $a,T as mn,X as Gh,E as at,t as Vh,a as zh,s as Nh,c as Fh,b as fn}from"./SnappingContext.6035d506.js";import{v as Wi}from"./dehydratedFeatures.5573332f.js";import{h as kh}from"./geometryDataUtils.8151b70d.js";import{i as Uh}from"./BufferView.43fc091d.js";import{e as Hh}from"./Util.221caaac.js";import{e as jh}from"./quatf64.b60d4974.js";import{G as Xt,H as Bh,X as ut}from"./boundedPlane.d7d86859.js";import{C as qh}from"./GraphicManipulator.6d798ed3.js";import{l as Yh,v as Wh}from"./axisAngleDegrees.b0e51c69.js";import{w as ui}from"./persistable.eb01740e.js";import{Q as vn}from"./quat.122fba57.js";let Zh=t=>({vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}),io=(t,e,i)=>{for(let a=0,s=e.length;a<s;a++){let n=e[a];Array.isArray(n)?io(t,n,i):n!=null&&n!==!1&&(typeof n=="string"&&(n=Zh(n)),i.push(n))}};function Xh(t,e,i){if(Array.isArray(e))i=e,e=void 0;else if(e&&(typeof e=="string"||e.hasOwnProperty("vnodeSelector"))||i&&(typeof i=="string"||i.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let a,s;return i&&i.length===1&&typeof i[0]=="string"?a=i[0]:i&&(s=[],io(t,i,s),s.length===0&&(s=void 0)),{vnodeSelector:t,properties:e,children:s,text:a===""?void 0:a,domNode:null}}const yn={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let te=class extends Ii{constructor(t){super(t),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this._backgroundColor="rgba(0, 0, 0, 0.6)",this._textColor="white",this._textShadowColor=[0,0,0],this._textShadowSize=1}get position(){return[this.x,this.y]}set position(t){this._set("x",t[0]),this._set("y",t[1])}get _textShadow(){const[t,e,i]=this._textColor;return`0 0 ${this._textShadowSize}px rgb(${t}, ${e}, ${i})`}get _padding(){return .5*this.fontSize}get _borderRadius(){return this._padding}render(){return Xh("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",lineHeight:this.fontSize+"px",backgroundColor:this._backgroundColor,color:this._textColor,padding:this._padding+"px",borderRadius:this._borderRadius+"px",textShadow:this._textShadow}},[this.text])}renderCanvas(t){if(!this.visible)return;const e=t.font.replace(/^(.*?)px/,"");t.font=`${this.fontSize}px ${e}`;const i=this._padding,a=this._borderRadius,s=t.measureText(this.text).width,n=this.fontSize,r=Qh[this.anchor];t.textAlign="center",t.textBaseline="middle";const o=s+2*i,l=n+2*i,d=this.x+r.x*o,p=this.y+r.y*l;this._roundedRect(t,d,p,o,l,a),t.fillStyle=this._backgroundColor,t.fill();const u=this.x+(r.x+.5)*o,g=this.y+(r.y+.5)*l;this._renderTextShadow(t,this.text,u,g),t.fillStyle=this._textColor,t.fillText(this.text,u,g)}_renderTextShadow(t,e,i,a){t.lineJoin="miter",t.fillStyle=`rgba(${this._textShadowColor[0]}, ${this._textShadowColor[1]}, ${this._textShadowColor[2]}, ${1/gs.length})`;const s=this._textShadowSize;for(const[n,r]of gs)t.fillText(e,i+s*n,a+s*r)}_roundedRect(t,e,i,a,s,n){t.beginPath(),t.moveTo(e,i+n),t.arcTo(e,i,e+n,i,n),t.lineTo(e+a-n,i),t.arcTo(e+a,i,e+a,i+n,n),t.lineTo(e+a,i+s-n),t.arcTo(e+a,i+s,e+a-n,i+s,n),t.lineTo(e+n,i+s),t.arcTo(e,i+s,e,i+s-n,n),t.closePath()}_cssClasses(){const t={"esri-text-overlay-item":!0};for(const e in yn)t[yn[e]]=this.anchor===e;return t}};h([_()],te.prototype,"x",void 0),h([_()],te.prototype,"y",void 0),h([_()],te.prototype,"position",null),h([_()],te.prototype,"text",void 0),h([_()],te.prototype,"fontSize",void 0),h([_()],te.prototype,"anchor",void 0),h([_()],te.prototype,"visible",void 0),h([_()],te.prototype,"_backgroundColor",void 0),h([_()],te.prototype,"_textColor",void 0),h([_()],te.prototype,"_textShadowColor",void 0),h([_()],te.prototype,"_textShadowSize",void 0),h([_()],te.prototype,"_textShadow",null),h([_()],te.prototype,"_padding",null),h([_()],te.prototype,"_borderRadius",null),te=h([B("esri.views.overlay.TextOverlayItem")],te);const Qh={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},gs=[];for(let e=0;e<360;e+=360/16)gs.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);const Jh=te,Kh=3025,ec={default:15,far:25};let Ue=class extends Ii{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=xo(async i=>{const a=await Eo("esri/core/t9n/Units");Oo(i),this._messagesUnits=a}),e=()=>da(this.context,i=>i.editGeometryOperations);this.own([L(()=>[c(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>Ao(e,i,()=>this._update())),Gt(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return m(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return ec[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(m(t))return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const s=e.length;for(let n=0;n<s;++n){const r=[];if(e[n].iterateVertices(g=>{r.push(a.toXYZ(g.pos))}),n===0&&c(this.stagedVertex)&&r.push(a.toXYZ(this.stagedVertex)),r.length<2)continue;const o=r[0],l=r[r.length-1];i.type==="polygon"&&r.length>2&&!To(o,l)&&r.push(o);const d=s===1&&!Po(r,!1,!1);let p=tc,u=ic;this.toScreenPointArray(t,o,p);for(let g=1;g<r.length;++g){const v=r[g-1],f=r[g];this.toScreenPointArray(t,f,u),this._addLabel(t,v,p,f,u,d),[p,u]=[u,p]}}this._destroyUnusedLabels()}_addLabel(t,e,i,a,s,n){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||mr(i,s)<Kh)return void(r.visible=!1);const o=c(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":fr(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,d=Ml(e,a,l,o),p=this._messagesUnits,u=Ro(t.view);r.text=c(p)&&c(d)?Sl(p,d,u):"",r.visible=!0;const g=s[0]-i[0],v=s[1]-i[1];n?ne(Re,-v,g):ne(Re,v,-g),ca(Re,Re),ei(Re,Re,this._edgeDistancePixels),Do(gi,i,s,.5),Mt(gi,gi,Re),r.position=[gi[0],gi[1]],Math.abs(Re[0])>Math.abs(Re[1])?r.anchor=Re[0]>0?"left":"right":r.anchor=-Re[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new Jh({fontSize:10,anchor:"center"});t.view.overlay.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){da(this.context,e=>e.view.overlay.items.remove(t)),t.destroy()}};h([_()],Ue.prototype,"context",void 0),h([_()],Ue.prototype,"stagedVertex",void 0),h([_()],Ue.prototype,"visible",void 0),h([_()],Ue.prototype,"edgeDistance",void 0),h([_()],Ue.prototype,"updating",null),h([_()],Ue.prototype,"_messagesUnits",void 0),h([_()],Ue.prototype,"_edgeDistancePixels",null),Ue=h([B("esri.views.interactive")],Ue);const Re=Vt(),gi=Vt(),tc=be(),ic=be();let Ea=class extends Ue{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,s=be()){const{spatialReference:n}=i.data.coordinateHelper;return $o(a,n,e,t,bn),t.state.camera.projectToScreen(bn,s),s}};Ea=h([B("esri.views.3d.interactive.SegmentLabels3D")],Ea);const bn=b();class ao{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this._handle=L(()=>this.view.ready,i=>{this._resourcesCreated&&(i?this._createResources():this._destroyResources())})}applyProps(e){let i=!1;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.attached=!1,this._handle.remove()}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}function so(t,e){t.extensions.add("GL_OES_standard_derivatives");const i=t.fragment;i.include(ql),t.include(ch),i.uniforms.add([new Ee("globalAlpha",a=>a.globalAlpha),new cs("glowColor",a=>a.glowColor),new Ee("glowWidth",(a,s)=>a.glowWidth*s.camera.pixelRatio),new Ee("glowFalloff",a=>a.glowFalloff),new cs("innerColor",a=>a.innerColor),new Ee("innerWidth",(a,s)=>a.innerWidth*s.camera.pixelRatio),new Fr("depthMap",(a,s)=>s.linearDepthTexture),new Lt("nearFar",(a,s)=>s.camera.nearFar),new dh("frameColor")]),i.code.add($`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),i.code.add($`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),i.code.add($`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),i.code.add($`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),e.contrastControlEnabled?(i.uniforms.add(new Ee("globalAlphaContrastBoost",a=>c(a.globalAlphaContrastBoost)?a.globalAlphaContrastBoost:1)),i.code.add($`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`)):i.code.add($`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}function ac(t){const e=new ki;e.include(so,t);const{vertex:i,fragment:a}=e;return i.uniforms.add([new ds("modelView",(s,n)=>pa(nc,n.camera.viewMatrix,s.origin)),new ds("proj",(s,n)=>n.camera.projectionMatrix),new Ee("glowWidth",(s,n)=>s.glowWidth*n.camera.pixelRatio),new Lt("pixelToNDC",(s,n)=>ne(sc,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3]))]),e.attributes.add(A.START,"vec3"),e.attributes.add(A.END,"vec3"),e.attributes.add(A.UP,"vec3"),e.attributes.add(A.EXTRUDE,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vViewStart","vec3"),e.varyings.add("vViewEnd","vec3"),e.varyings.add("vViewPlane","vec4"),i.code.add($`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),a.uniforms.add(new Ee("perScreenPixelRatio",(s,n)=>n.camera.perScreenPixelRatio)),a.code.add($`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),e}const sc=Vt(),nc=_e(),rc=Object.freeze(Object.defineProperty({__proto__:null,build:ac},Symbol.toStringTag,{value:"Module"}));class Ut extends Ui{initializeProgram(e){const i=Ut.shader.get().build(this.configuration);return new Hi(e.rctx,i,Ut.attributeLocations)}initializePipeline(){return qi({blending:Ls(qe.ONE,qe.ONE_MINUS_SRC_ALPHA),colorWrite:Yi})}}Ut.shader=new ji(rc,()=>Gi(()=>import("./LaserlinePath.glsl.e734963c.js"),["assets/LaserlinePath.glsl.e734963c.js","assets/index.52935b46.js","assets/index.be38f7b7.css","assets/mat4f64.84d5c445.js","assets/Matrix4Uniform.9e24b035.js","assets/enums.de935fa5.js","assets/Texture.7634927e.js","assets/requestImageUtils.16628477.js","assets/Util.221caaac.js","assets/geometryDataUtils.8151b70d.js","assets/triangle.4a12653d.js","assets/vectorStacks.a7af424f.js","assets/quatf64.b60d4974.js","assets/lineSegment.42c0099b.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.b7add78f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.43fc091d.js","assets/quat.122fba57.js","assets/vec3f32.0772c8d8.js","assets/sphere.fe54e1ae.js","assets/drawSurfaces.7da3d09c.js","assets/geometryEngine.938806be.js","assets/geometryEngineBase.cf4f989f.js","assets/hydrated.54675f53.js","assets/SnappingContext.6035d506.js","assets/PointSnappingHint.735dac09.js","assets/plane.1ed71234.js","assets/drawUtils.b3864c8e.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.5573332f.js","assets/vec4f32.8f10672a.js","assets/Octree.74aeccc1.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.b5350ce1.js","assets/types.25c129c5.js","assets/NativeLineMaterial.b0f0cd6a.js","assets/floatRGBA.5328f61e.js","assets/triangulationUtils.b0bb3487.js","assets/deduplicate.ee0b1de6.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.d7d86859.js","assets/GraphicManipulator.6d798ed3.js","assets/axisAngleDegrees.b0e51c69.js","assets/persistable.eb01740e.js","assets/multiOriginJSONSupportUtils.8128aa52.js"])),Ut.attributeLocations=new Map([[A.START,0],[A.END,1],[A.UP,2],[A.EXTRUDE,3]]);class Mn{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=b(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const i=new Float64Array(3*e.length);let a=0;for(const s of e)i[a++]=s[0],i[a++]=s[1],i[a++]=s[2];this.buffers=[i]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const i=this._buffers[0],a=3*Math.floor(i.length/3/2);Z(this._origin,i[a+0],i[a+1],i[a+2])}else Z(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const i=this._ensureVAO(e);c(i)&&(e.bindVAO(i),e.drawArrays(Qr.TRIANGLES,0,this._count))}dispose(){c(this._vao)&&this._vao.dispose()}_ensureVAO(e){return m(this._buffers)?null:(m(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,i){const a=this._createDataBuffer(i);return this._dirty=!1,new Ch(e,Ut.attributeLocations,{data:Bl(wn)},{data:Lh.createVertex(e,Oh.STATIC_DRAW,a)})}_ensureVertexData(e,i){if(!this._dirty)return;const a=this._createDataBuffer(i);e.vertexBuffers.data.setData(a),this._dirty=!1}_numberOfRenderVertices(e){return 3*(2*(e.length/3-1))}_createDataBuffer(e){const i=e.reduce((o,l)=>o+this._numberOfRenderVertices(l),0);this._count=i;const a=wn.createBuffer(i),s=this._origin;let n=0,r=0;for(const o of e){for(let l=0;l<o.length;l+=3){const d=Z(Sn,o[l+0],o[l+1],o[l+2]);l===0?r=this._renderCoordsHelper.getAltitude(d):this._renderCoordsHelper.setAltitude(d,r);const p=this._renderCoordsHelper.worldUpAtPosition(d,oc),u=n+2*l,g=P(Sn,d,s);if(l<o.length-3){a.up.setVec(u,p),a.up.setVec(u+3,p),a.up.setVec(u+5,p);for(let v=0;v<6;v++)a.start.setVec(u+v,g);a.extrude.setValues(u+0,0,-1),a.extrude.setValues(u+1,1,-1),a.extrude.setValues(u+2,1,1),a.extrude.setValues(u+3,0,-1),a.extrude.setValues(u+4,1,1),a.extrude.setValues(u+5,0,1)}if(l>0){a.up.setVec(u-2,p),a.up.setVec(u-4,p),a.up.setVec(u-5,p);for(let v=-6;v<0;v++)a.end.setVec(u+v,g)}}n+=this._numberOfRenderVertices(o)}return a.buffer}}const oc=b(),Sn=b(),wn=Nr().vec3f(A.START).vec3f(A.END).vec3f(A.UP).vec2f(A.EXTRUDE);class Is extends Yl{constructor(){super(...arguments),this.contrastControlEnabled=!1}}h([U()],Is.prototype,"contrastControlEnabled",void 0);class _i extends Wl{constructor(e){super(e,"vec3")}}const Gs=nt(6);function lc(t){const e=new ki;e.extensions.add("GL_OES_standard_derivatives"),e.include(ph),e.include(so,t);const i=e.fragment;return t.heightManifoldEnabled&&i.uniforms.add(new Ba("heightPlane")),t.pointDistanceEnabled&&i.uniforms.add(new Ba("pointDistanceSphere")),t.lineVerticalPlaneEnabled&&(i.uniforms.add(new Ba("lineVerticalPlane")),i.uniforms.add(new _i("lineVerticalStart")),i.uniforms.add(new _i("lineVerticalEnd"))),(t.heightManifoldEnabled||t.pointDistanceEnabled||t.lineVerticalPlaneEnabled)&&i.uniforms.add(new dn("maxPixelDistance")),(t.lineVerticalPlaneEnabled||t.heightManifoldEnabled)&&i.code.add($`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.pointDistanceEnabled&&i.code.add($`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.intersectsLineEnabled&&(i.uniforms.add(new _i("intersectsLineStart")),i.uniforms.add(new _i("intersectsLineEnd")),i.uniforms.add(new _i("intersectsLineDirection")),i.uniforms.add(new dn("intersectsLineRadius")),i.uniforms.add(new Ee("perScreenPixelRatio",(a,s)=>s.camera.perScreenPixelRatio)),i.code.add($`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`)),(t.lineVerticalPlaneEnabled||t.intersectsLineEnabled)&&i.code.add($`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),i.code.add($`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),t.heightManifoldEnabled&&(i.uniforms.add(new Lt("angleCutoff",a=>Ji(a))),i.code.add($`{
float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
color = max(color, heightManifoldColor * heightManifoldAlpha);
}`)),t.pointDistanceEnabled&&(i.uniforms.add(new Lt("angleCutoff",a=>Ji(a))),i.code.add($`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`)),t.lineVerticalPlaneEnabled&&(i.uniforms.add(new Lt("angleCutoff",a=>Ji(a))),i.code.add($`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`)),t.intersectsLineEnabled&&(i.uniforms.add(new Lt("angleCutoff",a=>Ji(a))),i.code.add($`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`)),i.code.add($`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),e}function Ji(t){const e=c(t.angleCutoff)?t.angleCutoff:Gs;return ne(hc,Math.cos(e),Math.cos(Math.max(0,e-nt(2))))}const hc=Vt(),cc=Object.freeze(Object.defineProperty({__proto__:null,defaultAngleCutoff:Gs,build:lc},Symbol.toStringTag,{value:"Module"}));class Ca extends Ui{initializeProgram(e){const i=Ca.shader.get().build(this.configuration);return new Hi(e.rctx,i,Ts)}initializePipeline(){return qi({blending:Ls(qe.ONE,qe.ONE_MINUS_SRC_ALPHA),colorWrite:Yi})}}Ca.shader=new ji(cc,()=>Gi(()=>import("./Laserlines.glsl.4d76c7cc.js"),["assets/Laserlines.glsl.4d76c7cc.js","assets/index.52935b46.js","assets/index.be38f7b7.css","assets/Matrix4Uniform.9e24b035.js","assets/enums.de935fa5.js","assets/Texture.7634927e.js","assets/requestImageUtils.16628477.js","assets/Util.221caaac.js","assets/geometryDataUtils.8151b70d.js","assets/triangle.4a12653d.js","assets/vectorStacks.a7af424f.js","assets/quatf64.b60d4974.js","assets/mat4f64.84d5c445.js","assets/lineSegment.42c0099b.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.b7add78f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.43fc091d.js","assets/quat.122fba57.js","assets/vec3f32.0772c8d8.js","assets/sphere.fe54e1ae.js","assets/drawSurfaces.7da3d09c.js","assets/geometryEngine.938806be.js","assets/geometryEngineBase.cf4f989f.js","assets/hydrated.54675f53.js","assets/SnappingContext.6035d506.js","assets/PointSnappingHint.735dac09.js","assets/plane.1ed71234.js","assets/drawUtils.b3864c8e.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.5573332f.js","assets/vec4f32.8f10672a.js","assets/Octree.74aeccc1.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.b5350ce1.js","assets/types.25c129c5.js","assets/NativeLineMaterial.b0f0cd6a.js","assets/floatRGBA.5328f61e.js","assets/triangulationUtils.b0bb3487.js","assets/deduplicate.ee0b1de6.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.d7d86859.js","assets/GraphicManipulator.6d798ed3.js","assets/axisAngleDegrees.b0e51c69.js","assets/persistable.eb01740e.js","assets/multiOriginJSONSupportUtils.8128aa52.js"]));class yi extends Is{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1}}h([U()],yi.prototype,"heightManifoldEnabled",void 0),h([U()],yi.prototype,"pointDistanceEnabled",void 0),h([U()],yi.prototype,"lineVerticalPlaneEnabled",void 0),h([U()],yi.prototype,"intersectsLineEnabled",void 0);const dc=b(),pc=Ss(),uc={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:nt(6),globalAlphaContrastBoost:2,__tagStrict:"NoParameters"};function xn(t,e,i,a){const s=dc,n=pc;xe(s,e,a),j(n,i),n[3]=0,vr(n,n,a),kt(s,n,t)}class gc{constructor(e,i={},a={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=a,this._technique=null,this._heightManifoldEnabled=!1,this._heightManifoldTarget=b(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=b(),this._pointDistanceTarget=b(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=Pi(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=Pi(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=b(),this._tempDir=b(),this._tempUp=b(),this._tempVec3A=b(),this._tempVec3B=b(),this._tempVec4=Ss(),this._tempPlane=hi(),this._tempSphere=kl(),this._parameters=Zl(i,uc)}get renderSlots(){return[this._config.contrastControlEnabled?Oe.LASERLINES_CONTRAST_CONTROL:Oe.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){j(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){j(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){j(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){Sa(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){Sa(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,c(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){m(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Mn(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){m(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Mn(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){Xl(this._parameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const i=e.renderContext.rctx;this._quadVAO=Ql(i),this._techniqueRepository=e.shaderTechniqueRepository,this._techniqueConfig=new yi;const a=new Is;a.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(Ut,a)}uninitializeRenderContext(){this._quadVAO=Hs(this._quadVAO),this._technique=js(this._technique),this._pathVerticalPlaneData=Hs(this._pathVerticalPlaneData),this._pathTechnique=js(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(Ca,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,i){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,i),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,i){const a=e.rctx,s=a.bindTechnique(i,this._parameters,e.bindParameters);this._bindGlobalUniforms(e,s),this._bindHeightManifoldUniforms(e,s),this._bindPointDistanceUniforms(e,s),this._bindLineVerticalPlaneUniforms(e,s),this._bindIntersectsLineUniforms(e,s),a.bindVAO(this._quadVAO),a.drawArrays(Qr.TRIANGLE_STRIP,0,4)}_renderPath(e){if(m(this._pathVerticalPlaneData)||m(this._pathTechnique))return;const i=e.rctx,a=this._pathTechnique,s=i.bindTechnique(a,{...this._parameters,origin:this._pathVerticalPlaneData.origin},e.bindParameters);this._bindGlobalUniforms(e,s),this._pathVerticalPlaneData.draw(e.rctx)}_bindHeightManifoldUniforms(e,i){if(!this.heightManifoldEnabled)return;const a=this._tempVec3A,s=this._tempPlane,n=e.bindParameters.camera;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,a),xn(s,this._heightManifoldTarget,a,n.viewMatrix),i.setUniform4fv("heightPlane",s)}_bindPointDistanceUniforms(e,i){if(!this._pointDistanceEnabled)return;const a=e.bindParameters.camera,s=this._tempSphere;j(s,this._pointDistanceOrigin),xe(s,s,a.viewMatrix),s[3]=Ka(this._pointDistanceOrigin,this._pointDistanceTarget),i.setUniform4f("pointDistanceSphere",s[0],s[1],s[2],s[3])}_bindLineVerticalPlaneUniforms(e,i){if(!this._lineVerticalPlaneEnabled)return;const a=this._renderCoordsHelper,s=e.bindParameters.camera,n=this._tempPlane,r=this._tempVec3A,o=this._tempUp,l=this._tempDir,d=this._tempNormal;Dt(this._lineVerticalPlaneSegment,.5,r),a.worldUpAtPosition(r,o),re(l,this._lineVerticalPlaneSegment.vector),Me(d,o,l),re(d,d),xn(n,this._lineVerticalPlaneSegment.origin,d,s.viewMatrix),i.setUniform4fv("lineVerticalPlane",n);const p=this._tempVec3A;j(p,this._lineVerticalPlaneSegment.origin),a.setAltitude(p,0),xe(p,p,s.viewMatrix),i.setUniform3fv("lineVerticalStart",p);const u=this._tempVec3B;z(u,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),a.setAltitude(u,0),xe(u,u,s.viewMatrix),i.setUniform3fv("lineVerticalEnd",u)}_bindIntersectsLineUniforms(e,i){if(!this._intersectsLineEnabled)return;const a=_c,s=mc,n=e.bindParameters.camera;if(this._intersectsLineInfinite){if(Ir(hs(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),mi),mi.c0=-Number.MAX_VALUE,!Gr(n.frustum,mi))return;Vr(mi,a),zr(mi,s)}else j(a,this._intersectsLineSegment.origin),z(s,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const r=this._tempVec3A;xe(r,a,n.viewMatrix),i.setUniform3fv("intersectsLineStart",r);const o=this._tempVec4;j(o,this._intersectsLineSegment.vector),this._tempVec4[3]=0,vr(this._tempVec4,this._tempVec4,n.viewMatrix),xe(s,s,n.viewMatrix),i.setUniform3fv("intersectsLineEnd",s),re(o,o),i.setUniform3f("intersectsLineDirection",o[0],o[1],o[2]),i.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(e,i){const a=e.bindParameters.camera;this._heightManifoldEnabled?i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),i.bindTexture("frameColor",e.offscreenRenderingHelper.mainColorTexture)}_requestRender(){this._context&&this._context.requestRender()}}const mi=Lr(),_c=b(),mc=b();class Ri extends ao{constructor(e){super(e.view),this._angleCutoff=Gs,this._style={},this._heightManifoldTarget=b(),this._heightManifoldEnabled=!1,this._intersectsLine=Pi(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this.renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){c(e)?(j(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(m(e))return void(this.intersectsLine=null);const i=this.view.renderCoordsHelper.worldUpAtPosition(e,fc);this.intersectsLine=zl(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){c(e)?(Sa(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=c(e)?Sa(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=c(e)?{origin:ua(e.origin),target:ua(e.target)}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||c(this._pointDistanceLine)||c(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){c(this.renderer)||(this.renderer=new gc(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}_syncStyle(){m(this.renderer)||(this.renderer.setParameters(this._style),this._style.intersectsLineRadius!=null&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){m(this.renderer)||this.renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){m(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){m(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){m(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){m(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=c(this._pathVerticalPlaneBuffers)&&this.visible,c(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){m(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=c(this._lineVerticalPlaneSegment)&&this.visible,c(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){m(this.renderer)||(this.renderer.pointDistanceEnabled=c(this._pointDistanceLine)&&this.visible,c(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}_disposeRenderer(){c(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const fc=b();class La extends ao{constructor(e){super(e.view),this._resources=null,this._transform=_e()}get object(){return c(this._resources)?this._resources.object:null}get transform(){return this._transform}set transform(e){yr(this._transform,e),c(this._resources)&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(m(this._resources))return;const e=this._resources.object,i=this.view._stage;i.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),i.addMany(e.geometries)}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const i=new Rs({isPickable:!1,updatePolicy:Da.SYNC});e.add(i);const a=new Ds({castShadow:!1});a.transformation=this._transform,this.createExternalResources(),this.createGeometries(a),e.addMany(a.geometries),this.forEachExternalMaterial(s=>e.add(s)),e.add(a),i.add(a),this.visible||a.setVisible(!1),this._resources={layer:i,object:a}}destroyResources(){const e=this.view._stage;!m(this._resources)&&e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this.forEachExternalMaterial(i=>{e.remove(i),i.dispose()}),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){m(this._resources)||this._resources.object.setVisible(e)}}class Vs extends La{constructor(e){super(e),this._ray=Ni(),this._externalResources=null,this._handles=new ot,this._isWorldDown=!1,this._start=b(),this._end=N(1,0,0),this._width=1,this._color=Ft(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ft(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=ve.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=D.OccludeAndTransparent,this._fadedExtensions=An,this.applyProps(e)}createExternalResources(){const e=new ri(this.materialParameters);this._handles.add(L(()=>this.view.state.camera,()=>{this._updateGeometry()}));const i=new Ri({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:i}}destroyExternalResources(){c(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){c(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const i=[b(),b()],a=this.extensionType===ve.FADED;a&&i.push(b(),b());const s=a?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,n=V.createPolylineGeometry(i,null,s);e.addGeometry(n,R(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),c(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,j(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),P(this._end,e,this._end),ja(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,ga(this._start,e)||(j(this._start,e),ja(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,ga(this._end,e)||(j(this._end,e),ja(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Ve(e,this._color)||(Ne(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Ve(e,this._innerColor)||(Ne(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=c(e)!==c(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(m(e)||m(this._stippleOffColor)||!Ve(e,this._stippleOffColor))&&(this._stippleOffColor=c(e)?Cr(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&c(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,c(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,c(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,c(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=W(e,An),this.recreateGeometry()}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){c(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const i=this._extensionType===ve.FADED?this._updateLineSegmentFinite(En):this._updateLineSegmentInfinite(this._extensionType,En);this._updateVertexAttributes(e,i),c(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}_updateLineSegmentFinite(e){return wi(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const a=this.view.state.camera;switch(Ir(this._ray,gt),e){case ve.LINE:gt.c0=-Number.MAX_VALUE;break;case ve.RAY:case ve.GROUND_RAY:{const r=this._ray.origin,o=W(this.view.elevationProvider.getElevation(r[0],r[1],r[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),l=this.view.renderCoordsHelper.getAltitude(r);this._isWorldDown&&l<o&&Co(gt.ray.direction,gt.ray.direction),this._extensionType===ve.GROUND_RAY&&o!=null&&(gt.c1=Math.abs(l-o));break}}if(!Gr(a.frustum,gt))return wi(this._start,this._end,i);const s=Vr(gt,Tt),n=zr(gt,vc);return wi(s,n,i)}_updateVertexAttributes(e,i){const a=e.geometries[0].getMutableAttribute(A.POSITION).data;if(this.extensionType===ve.FADED){const s=Dt(i,-this.fadedExtensions.start,Tt);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=Dt(i,0,Tt);a[3]=n[0],a[4]=n[1],a[5]=n[2];const r=Dt(i,1,Tt);a[6]=r[0],a[7]=r[1],a[8]=r[2];const o=Dt(i,1+this.fadedExtensions.end,Tt);a[9]=o[0],a[10]=o[1],a[11]=o[2]}else{const s=Dt(i,0,Tt);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=Dt(i,1,Tt);a[3]=n[0],a[4]=n[1],a[5]=n[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const gt=Lr(),Tt=b(),vc=b(),En=Pi();var ve;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(ve||(ve={}));const On=1/3,An={start:On,end:On};class yc extends La{constructor(e){super(e),this._handles=new ot,this._location=b(),this._direction=N(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ft(1,0,1,1),this._renderOccluded=D.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){ga(this._location,e)||(j(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){ga(this._direction,e)||(j(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){re(this._direction,P(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Ve(e,this._color)||(Ne(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new ri(this.materialParameters);this._handles.add(L(()=>this.view.state.camera,()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const i=V.createPolylineGeometry([b(),b()]),a=V.createPolylineGeometry([b(),b()]),s=R(this._externalResources).material;e.addGeometry(i,s),e.addGeometry(a,s),this._updateVertices(e)}forEachExternalMaterial(e){c(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;m(e)||this._updateVertices(e)}_updateVertices(e){const i=this.view.state.camera;i.projectToScreen(this.location,Ki),z(ke,this.location,this.direction),i.projectToScreen(ke,Bt),ca(Bt,ws(Bt,Bt,Ki)),this._updateVertexAttributes(i,e,0,Ki,Bt,1),this._updateVertexAttributes(i,e,1,Ki,Bt,-1)}_updateVertexAttributes(e,i,a,s,n,r){const o=i.geometryRecords[a],l=o.geometry.getMutableAttribute(A.POSITION).data,d=ei(Tn,ne(Tn,n[1]*r,n[0]*-r),this.offset+this.width/2),p=Mt(ea,Mt(ea,Mt(ea,s,ei(ea,n,this.length/2)),d),d),u=Mt(Pn,p,ei(Pn,n,-this.length));e.unprojectFromScreen(p,ke),l[0]=ke[0],l[1]=ke[1],l[2]=ke[2],e.unprojectFromScreen(u,ke),l[3]=ke[0],l[4]=ke[1],l[5]=ke[2],i.geometryVertexAttrsUpdated(o)}}const ke=b(),Ki=be(),Bt=be(),Tn=be(),ea=be(),Pn=be();class no{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return c(this._resources)?this._resources.object:null}get resources(){return c(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(m(this._resources)||!e)return;const i=this._resources.object;this._resources.external.forEach(s=>{s.type===Jl.Geometry&&e.remove(s)}),i.removeAllGeometries();const a=this.resourceFactory.recreateGeometry(this._resources.external,i,this._resources.layer);e.addMany(a)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory,i=e.view,a=i._stage;if(!a)return;const s=new Rs({isPickable:!1,updatePolicy:Da.SYNC});a.add(s);const n=new Ds({castShadow:!1}),r=e.createResources(n,s);r.forEach(l=>{a.add(l),l instanceof kr&&a.loadImmediate(l)}),a.add(n),s.add(n);const o=e.cameraChanged?L(()=>i.state.camera,l=>e.cameraChanged(l),je):null;this._resources={layer:s,object:n,external:r,cameraHandle:o},this._syncVisible()}_destroyResources(){if(m(this._resources))return;const e=this.resourceFactory.view._stage;e==null||e.remove(this._resources.object),e==null||e.remove(this._resources.layer),this._resources.external.forEach(i=>{e==null||e.remove(i),"dispose"in i&&i.dispose()}),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){m(this._resources)||this._resources.object.setVisible(this._visible)}}class _s{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=rt(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=rt(1,1,1,1),this._elevationInfo=null,this.resources=new no({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometry=this._recreateGeometry(s,a.material),c(a.geometry)?[a.geometry]:[])});let i=!0;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const i=this.preferredTextureSize;this._size=e,i<this.preferredTextureSize?c(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){Ve(e,this._color)||(Ne(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,c(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Ve(e,this._outlineColor)||(Ne(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const e=this.resources.resources;m(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this.resources.resources,i=this.resources.object;if(m(e)||m(i))return;const a=e.geometry;if(m(a))return;const s=a.getMutableAttribute(A.SIZE).data,n=this.geometrySize;s[0]=n,s[1]=n,i.geometryVertexAttrsUpdated(i.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:bc,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/bi}_recreateGeometry(e,i){const a=this._createRenderGeometry();return c(a)&&e.addGeometry(a,i),a}_createResources(e){const i=uh(this._primitive,this.preferredTextureSize),a=new gh(this._materialParameters(i.id)),s=this._recreateGeometry(e,a);return{material:a,texture:i,geometry:s,forEach(n){n(i),n(a),c(this.geometry)&&n(this.geometry)}}}get preferredTextureSize(){return _a(Lo(2*this.geometrySize),16,128)}calculateMapBounds(e){if(m(this.resources.resources)||m(this.resources.resources.geometry))return!1;const i=this.resources.resources.geometry.vertexAttributes.get(A.POSITION);return ma(i.data,this.view.renderCoordsHelper.spatialReference,Rn,this.view.spatialReference),es(e,Rn),!0}_createRenderGeometry(){const e=this.geometry;if(m(e))return null;const{renderCoordsHelper:i,elevationProvider:a}=this.view,s=$s(e,a,Bi.fromElevationInfo(this.elevationInfo),i),n=Z(M.get(),e.x,e.y,s),r=M.get();ma(n,e.spatialReference,r,i.spatialReference);const o=this.geometrySize;return V.createPointGeometry(null,r,null,[o,o],[0,0,0,1])}}const bi=_h,bc=[bi/2,bi/2,1-bi/2,1-bi/2],Rn=b();class Mc extends La{constructor(e){super(e),this._handles=new ot,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=b(),this._up=b(),this._right=b(),this._renderOccluded=D.OccludeAndTransparent,this._color=Ft(1,0,0,1),this._outlineColor=Ft(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=D.Opaque,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){Ne(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){Ne(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const i=this._outlineSize===0!=(e===0);this._outlineSize=e,i?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:i,next:a}){this._maxSize=Math.min(Ka(i,e),Ka(i,a))/3,re(this._up,P(this._up,e,i)),re(this._right,P(this._right,a,i)),j(this._position,i),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new Be(this.quadMaterialParameters),this._outlineMaterial=new ri(this.outlineMaterialParameters),this._handles.add(L(()=>this.view.state.camera,()=>this._updateTransform()))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const i=this._quadGeometryData(this._up,this._right);e.addGeometry(i,this._quadMaterial)}_createOutlineGeometry(e){if(this._outlineSize===0)return;const i=z(M.get(),this._up,this._right),a=V.createPolylineGeometry([this._up,i,this._right]);e.addGeometry(a,this._outlineMaterial)}_updateTransform(e=this.object){const i=this.view.state.camera,a=this._size*i.computeScreenPixelSizeAt(this._position),s=Math.min(this._maxSize,a);ts(ta,this._position),Vi(ta,ta,[s,s,s]),c(e)&&(e.transformation=ta)}_quadGeometryData(e,i){const a=z(M.get(),e,i);return new Ur([[A.POSITION,{size:3,data:[0,0,0,...i,...e,...a],exclusive:!0}]],[[A.POSITION,new Uint16Array([0,1,2,1,2,3])]])}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameters(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameters(this.outlineMaterialParameters)}}const ta=_e();class Di extends Ih{visualizeIntersectionPoint(e,i){const{coordinateHelper:a,view:s}=i;return ye(new _s({view:s,primitive:"circle",geometry:a.vectorToPoint(e.intersectionPoint),elevationInfo:W(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:he.toUnitRGBA(ee.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:a,view:s}=i;return ye(new _s({view:s,primitive:"circle",geometry:a.vectorToPoint(e.point),elevationInfo:W(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:he.toUnitRGBA(ee.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:a,view:s}=i;return ye(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,a,W(e.elevationInfo,i.elevationInfo),s,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:a,view:s}=i,n=W(e.elevationInfo,i.elevationInfo),r=pi(e.lineStart,a,n,i.view),o=pi(e.lineEnd,a,n,i.view),l=yt(o,r,o,.5),d=new yc({view:s,attached:!1,offset:ee.parallelLineHintOffset,length:ee.parallelLineHintLength,width:ee.parallelLineHintWidth,color:he.toUnitRGBA(ee.orange),location:l,renderOccluded:D.Opaque});return d.setDirectionFromPoints(r,l),d.attached=!0,ye(d)}visualizeRightAngleQuad(e,i){const{coordinateHelper:a,view:s}=i,n=W(e.elevationInfo,i.elevationInfo);return ye(new Mc({view:s,attached:!0,color:he.toUnitRGBA(ee.orange),renderOccluded:D.Transparent,outlineRenderOccluded:D.Opaque,outlineColor:he.toUnitRGBA(ee.orange),outlineSize:ee.rightAngleHintOutlineSize,size:ee.rightAngleHintSize,geometry:{previous:pi(e.previousVertex,a,n,s),center:pi(e.centerVertex,a,n,s),next:pi(e.nextVertex,a,n,s)}}))}_createLineSegmentHintFromMap(e,i,a,s,n,r,o=!0,l=!0){const d=b(),p=b();return Io(i,a,s,n,r,d,p),this._createLineSegmentHint(e,r,d,p,o,l)}_createLineSegmentHint(e,i,a,s,n=!0,r=!0){const o=new Vs({view:i,extensionType:ve.FADED,start:a,end:s,color:he.toUnitRGBA(ee.orange),renderOccluded:D.Opaque});switch(e){case Ua.TARGET:o.width=ee.lineHintWidthTarget,o.fadedExtensions={start:0,end:ee.lineHintFadedExtensions};break;case Ua.REFERENCE_EXTENSION:o.width=ee.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case Ua.REFERENCE:o.width=ee.lineHintWidthReference,o.fadedExtensions={start:n?ee.lineHintFadedExtensions:0,end:r?ee.lineHintFadedExtensions:0}}return o.attached=!0,o}}const T={main:new he([255,127,0]),selected:new he([255,255,255]),staged:new he([12,207,255]),outline:new he([0,0,0,.5]),selectedOutline:new he([255,255,255])},ii=.3;function $i(t,e){const i=t.clone();return i.a*=e,i}function Sc(t,e){const i=t.clone(),a=Go(i);a.s*=e;const s=Vo(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function Pe(t,e){if(e)for(const i in e)t[i]=e[i]}class wc{constructor(e){this.color=T.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=D.Opaque,Pe(this,e)}}class Ya{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=T.main,this.outlineColor=T.outline,this.renderOccluded=D.Opaque,this.hoverOutlineColor=T.selectedOutline,Pe(this,e)}apply(e,i){const a=this[e];i.setParameters({color:St(a),transparent:e!=="color"||a.a<1,renderOccluded:this.renderOccluded})}}class xc{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=$i(T.main,.5),this.hoverColor=T.main,this.renderOccluded=D.Transparent,this.minSquaredEdgeLength=900,Pe(this,e)}apply(e,i){const a=this[e];i.setParameters({color:St(a),transparent:a.a<1,renderOccluded:this.renderOccluded})}}class Ec{constructor(e){this.vertex=new Ya({color:T.main,outlineColor:T.outline}),this.edge=new Ya({color:Sc($i(T.main,2/3),.5),outlineColor:$i(T.outline,.5),size:8,collisionPadding:8}),this.selected=new Ya({color:T.selected,outlineColor:T.outline}),this.edgeOffset=new xc,Pe(this,e)}}class ms{constructor(e){this.color=T.selected,this.width=1.5,this.stipplePattern=us(5),this.stippleOffColor=T.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=T.selected,this.renderOccluded=D.OccludeAndTransparent,Pe(this,e)}apply(e){e.color=St(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=St(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=St(this.innerColor),e.renderOccluded=this.renderOccluded}}class Oc{constructor(e){this.color=T.selected,this.size=4,this.outlineSize=1,this.outlineColor=T.outline,this.shape="square",Pe(this,e)}apply(e){e.color=St(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=St(this.outlineColor),e.primitive=this.shape}}class Oa{constructor(e){this.innerColor=T.selected,this.innerWidth=1,this.glowColor=T.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ii,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=T.main,Pe(this,e)}apply(e,i=1){const a={glowColor:he.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:he.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=a:e.laserlineStyle=a}}class Ac{constructor(e){this.outline=new ms({color:T.outline,renderOccluded:D.OccludeAndTransparentStencil,stippleOffColor:T.selected,stipplePattern:us(5),width:1.5,innerWidth:0}),this.staged=new ms({color:T.selected,renderOccluded:D.OccludeAndTransparentStencil,innerColor:T.staged,stippleOffColor:T.outline,stipplePattern:us(5),width:1.5}),this.shadowStyle=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:1}),Pe(this,e)}}class Tc{constructor(e){this.outline=new Oc({color:T.selected,outlineColor:T.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:1.5,glowWidth:6,innerColor:T.selected,innerWidth:1,radius:2}),Pe(this,e)}}class Pc extends ms{constructor(e){super(),this.extensionType=ve.GROUND_RAY,Pe(this,e)}}class Rc{constructor(e){this.lineGraphics=new Ac,this.pointGraphics=new Tc,this.heightPlane=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:1}),this.heightBox=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:0,heightFillColor:T.main}),this.zVerticalLine=new Pc({color:$i(T.main,5*ii/3),falloff:2,innerColor:$i(T.selected,0),renderOccluded:D.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:ve.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,Pe(this,e)}}class Dc{constructor(e){this.visualElements=new Rc,this.reshapeManipulators=new Ec,this.zManipulator=new wc,Pe(this,e)}colorToVec4(e){return St(e)}}function St(t){return xt(he.toUnitRGBA(t))}const y=new Dc;class $c{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return c(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?m(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?m(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var s;this._destroyResources();const e=this.resourceFactory.createResources(),i=new Qt({view:this.resourceFactory.view}),a=(s=this.resourceFactory.view.basemapTerrain)==null?void 0:s.overlayManager;this._resources={layerView:new Qt({view:this.resourceFactory.view}),external:e,geometriesAdded:!1},a&&(this._resources.drapeSourceRenderer=a.registerGeometryDrapeSource(i)),this._syncGeometriesToRenderer()}_destroyResources(){var i;if(m(this._resources))return;this._ensureRenderGeometriesRemoved();const e=(i=this.resourceFactory.view.basemapTerrain)==null?void 0:i.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){m(this._resources)||m(this._resources.drapeSourceRenderer)||!this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,pn.Geometry.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){m(this._resources)||m(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,pn.Geometry.UPDATE),this._resources.geometriesAdded=!0)}}let Qt=class extends zo(Ii){constructor(t){super(t),this.drapeSourceType=mh.Features,this.updatePolicy=Da.SYNC}};h([_({constructOnly:!0})],Qt.prototype,"view",void 0),h([_({readOnly:!0})],Qt.prototype,"drapeSourceType",void 0),Qt=h([B("DrapedVisualElementLayerView")],Qt);class Ht{constructor(e){this.view=null,this._attachmentOrigin=Wi(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new Xe,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Ft(1,0,1,1),this._innerWidth=0,this._innerColor=Ft(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=D.OccludeAndTransparentStencil,this.resources=new no({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometries.length=0,this._recreateGeometry(s,a.material,a.geometries),a.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new $c({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:a=>{a.geometries=this._createRenderGeometriesDraped(a.material),this._attachmentOriginChanged()}});let i=!0;this._laserline=new Ri({view:e.view});for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&c(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Ve(e,this._color)||(Ne(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Ve(e,this._innerColor)||(Ne(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=c(e)!==c(this._stipplePattern);this._stipplePattern=e,i?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&Ve(e,this._stippleOffColor)||(this._stippleOffColor=e?Cr(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,c(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=c(this.resources.resources)?this.resources.resources.geometries:null;if(!e||e.length===0)return null;Z(qt,0,0,0);let i=0;for(const a of e){const s=a.vertexAttributes.get(A.POSITION),n=a.indices.get(A.POSITION),r=R(this.resources.resources).material.isClosed(s.data,n);kh(s,n,r,Dn)&&(z(qt,qt,Dn),i++)}return i===0?null:(Q(qt,qt,1/i),this.view.renderCoordsHelper.fromRenderCoords(qt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){c(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),c(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return c(this.geometry)&&this.geometry.type==="polygon"}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===D.OccludeAndTransparentStencil?D.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,i,a){const s=this._createRenderGeometries();for(const n of s)e.addGeometry(n,i),a.push(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const i=new ri(this.materialParameters),a=[];return this._recreateGeometry(e,i,a),{material:i,geometries:a,forEach:s=>{s(i),a.forEach(s)}}}_createDrapedResources(){const e=new ri(this.materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const i=this.geometry;if(m(i))return[];const a=fh(i,this.view.basemapTerrain.spatialReference),s=[];for(const{position:n}of a.lines){const r={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:n},removeDuplicateStartEnd:this.isClosed?Qi.REMOVE:Qi.KEEP},o=new vh(un(r),e),l=Mr(Cc);es(l,n),No(o.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),s.push(o)}return s}calculateMapBounds(e){if(m(this.resources.resources))return!1;const i=this.view.renderCoordsHelper;for(const a of this.resources.resources.geometries){const s=a.vertexAttributes.get(A.POSITION),n=new Float64Array(s.data.length);Fo(s.data,i.spatialReference,0,n,this.view.spatialReference,0,s.data.length/3),es(e,n)}return!0}_createRenderGeometries(){var n;const e=this.geometry;if(m(e))return[];const i=yh(e,this.view.elevationProvider,this.view.renderCoordsHelper,Bi.fromElevationInfo((n=this.elevationInfo)!=null?n:new Sr({mode:fr(e,null)}))),a=[],s=[];for(const{position:r,mapPosition:o}of i.lines){const l={overlayInfo:null,attributeData:{position:r,mapPosition:o},removeDuplicateStartEnd:this.isClosed?Qi.REMOVE:Qi.KEEP};a.push(un(l)),s.push(r)}return this._laserline.pathVerticalPlane=s,a}}const Cc=br(),Dn=b(),qt=b();function Lc(t,e){if(!e.screenSizeEnabled)return;const i=t.vertex;Kl(i,e),i.uniforms.add(new Ee("perScreenPixelRatio",(a,s)=>s.camera.perScreenPixelRatio)),i.uniforms.add(new Ee("screenSizeScale",a=>a.screenSizeScale)),i.code.add($`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function Ic(t){const e=new ki,i=t.hasMultipassTerrain&&(t.output===q.Color||t.output===q.Alpha);e.include(Hr),e.include(Lc,t),e.include(jr,t);const{vertex:a,fragment:s}=e;return s.include(Br),Ps(e,t),s.uniforms.add(new wa("uColor",n=>n.color)),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vWorldPosition","vec3"),i&&e.varyings.add("depth","float"),t.screenSizeEnabled&&e.attributes.add(A.OFFSET,"vec3"),t.shadingEnabled&&(a.uniforms.add(new ds("viewNormal",(n,r)=>r.camera.viewInverseTransposeMatrix)),e.attributes.add(A.NORMAL,"vec3"),e.varyings.add("vViewNormal","vec3")),a.code.add($`
    void main(void) {
      vWorldPosition = ${t.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),t.shadingEnabled&&a.code.add($`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),a.code.add($`
    ${i?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),i&&e.include(qr,t),s.code.add($`
    void main() {
      discardBySlice(vWorldPosition);
      ${i?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),t.shadingEnabled?(s.uniforms.add(new cs("shadingDirection",n=>n.shadingDirection)),s.uniforms.add(new wa("shadedColor",n=>Gc(n.shadingTint,n.color))),s.code.add($`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`)):s.code.add($`vec4 finalColor = uColor;`),s.code.add($`
      if (finalColor.a < ${$.float(eh)}) {
        discard;
      }
      ${t.output===q.Alpha?$`gl_FragColor = vec4(finalColor.a);`:""}

      ${t.output===q.Color?$`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${t.transparencyPassType===Ze.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),e}function Gc(t,e){const i=1-t[3],a=t[3]+e[3]*i;return a===0?(Pt[3]=a,Pt):(Pt[0]=(t[0]*t[3]+e[0]*e[3]*i)/a,Pt[1]=(t[1]*t[3]+e[1]*e[3]*i)/a,Pt[2]=(t[2]*t[3]+e[2]*e[3]*i)/a,Pt[3]=e[3],Pt)}const Pt=Ss(),Vc=Object.freeze(Object.defineProperty({__proto__:null,build:Ic},Symbol.toStringTag,{value:"Module"}));class Ia extends Ui{initializeProgram(e){const i=Ia.shader.get().build(this.configuration);return new Hi(e.rctx,i,ro)}_setPipelineState(e){const i=this.configuration,a=e===Ze.NONE,s=e===Ze.FrontFace;return qi({blending:i.output!==q.Color&&i.output!==q.Alpha||!i.transparent?null:a?Ah:Jr(e),culling:Kr(i.cullFace),depthTest:{func:s?la.LESS:i.shadingEnabled?la.LEQUAL:la.LESS},depthWrite:a?i.writeDepth&&eo:to(e),colorWrite:Yi,polygonOffset:a||s?null:Th})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Ia.shader=new ji(Vc,()=>Gi(()=>import("./ShadedColorMaterial.glsl.120887ca.js"),["assets/ShadedColorMaterial.glsl.120887ca.js","assets/index.52935b46.js","assets/index.be38f7b7.css","assets/Matrix4Uniform.9e24b035.js","assets/enums.de935fa5.js","assets/Texture.7634927e.js","assets/requestImageUtils.16628477.js","assets/Util.221caaac.js","assets/geometryDataUtils.8151b70d.js","assets/triangle.4a12653d.js","assets/vectorStacks.a7af424f.js","assets/quatf64.b60d4974.js","assets/mat4f64.84d5c445.js","assets/lineSegment.42c0099b.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.b7add78f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.43fc091d.js","assets/quat.122fba57.js","assets/vec3f32.0772c8d8.js","assets/sphere.fe54e1ae.js","assets/drawSurfaces.7da3d09c.js","assets/geometryEngine.938806be.js","assets/geometryEngineBase.cf4f989f.js","assets/hydrated.54675f53.js","assets/SnappingContext.6035d506.js","assets/PointSnappingHint.735dac09.js","assets/plane.1ed71234.js","assets/drawUtils.b3864c8e.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.5573332f.js","assets/vec4f32.8f10672a.js","assets/Octree.74aeccc1.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.b5350ce1.js","assets/types.25c129c5.js","assets/NativeLineMaterial.b0f0cd6a.js","assets/floatRGBA.5328f61e.js","assets/triangulationUtils.b0bb3487.js","assets/deduplicate.ee0b1de6.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.d7d86859.js","assets/GraphicManipulator.6d798ed3.js","assets/axisAngleDegrees.b0e51c69.js","assets/persistable.eb01740e.js","assets/multiOriginJSONSupportUtils.8128aa52.js"]));class De extends Yr{constructor(){super(...arguments),this.output=q.Color,this.cullFace=K.None,this.transparencyPassType=Ze.NONE,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}h([U({count:q.COUNT})],De.prototype,"output",void 0),h([U({count:K.COUNT})],De.prototype,"cullFace",void 0),h([U({count:Ze.COUNT})],De.prototype,"transparencyPassType",void 0),h([U()],De.prototype,"hasSlicePlane",void 0),h([U()],De.prototype,"transparent",void 0),h([U()],De.prototype,"writeDepth",void 0),h([U()],De.prototype,"screenSizeEnabled",void 0),h([U()],De.prototype,"shadingEnabled",void 0),h([U()],De.prototype,"hasMultipassTerrain",void 0),h([U()],De.prototype,"cullAboveGround",void 0);const ro=new Map([[A.POSITION,0],[A.NORMAL,1],[A.OFFSET,2]]);class fs extends Wr{constructor(e){super(e,new Nc),this.supportsEdges=!0,this.techniqueConfig=new De,this._vertexAttributeLocations=ro}getConfiguration(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.screenSizeEnabled=this.parameters.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.parameters.shadingEnabled,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(e,i,a,s,n,r,o){if(this.parameters.screenSizeEnabled){const l=e.vertexAttributes.get(A.OFFSET);ps(e,i,s,n,r,{applyToVertex:(p,u,g,v)=>{const f=Z($n,l.data[3*v+0],l.data[3*v+1],l.data[3*v+2]),S=Z(kc,p,u,g);return Q(f,f,this.parameters.screenSizeScale*s.camera.computeRenderPixelSizeAt(f)),z(S,S,f),[S[0],S[1],S[2]]},applyToAabb:p=>{const u=ko(p,$n);return Uo(p,this.parameters.screenSizeScale*s.camera.computeRenderPixelSizeAt(u))}},o)}else ps(e,i,s,n,r,void 0,o)}requiresSlot(e,i){if(Xr(i)===q.Highlight)return e===Oe.OPAQUE_MATERIAL;let a=Oe.OPAQUE_MATERIAL;return this.parameters.transparent&&(a=this.parameters.writeDepth?Oe.TRANSPARENT_MATERIAL:Oe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===a||e===Oe.DRAPED_MATERIAL}createGLMaterial(e){return e.output===q.Color||e.output===q.Alpha||e.output===q.Highlight?new zc(e):null}createBufferWriter(){return new Fc(this.parameters.screenSizeEnabled)}}class zc extends th{beginSlot(e){return this.ensureTechnique(Ia,e)}}class Nc extends Zr{constructor(){super(...arguments),this.color=rt(1,1,1,1),this.shadingTint=rt(0,0,0,.25),this.shadingDirection=re(b(),[.5,-.5,-.5]),this.screenSizeScale=14,this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=K.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}}class Fc{constructor(e){this.screenSizeEnabled=e;const i=Nr().vec3f(A.POSITION).vec3f(A.NORMAL);this.screenSizeEnabled&&i.vec3f(A.OFFSET),this.vertexBufferLayout=i}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(A.POSITION).length}write(e,i,a,s){if(ih(i,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,a,s),this.screenSizeEnabled){if(!i.vertexAttributes.has(A.OFFSET))throw new Error(`${A.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const n=i.vertexAttributes.get(A.OFFSET),r=i.indices.get(A.OFFSET);Hh(n.size===3);const o=a.getField(A.OFFSET,Uh);if(!o)throw new Error("unable to acquire view for "+A.OFFSET);ah(r,n.data,e.invTranspTransformation,o,s)}}}}const $n=b(),kc=b();class Cn extends La{constructor(e){super(e),this.view=null,this._renderOccluded=D.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=y.colorToVec4(y.reshapeManipulators.vertex.color),this._size=y.reshapeManipulators.vertex.size,this._outlineColor=y.colorToVec4(y.reshapeManipulators.vertex.outlineColor),this._outlineSize=y.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){Ve(e,this._color)||(Ne(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Ve(e,this._outlineColor)||(Ne(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(m(e)||e.length===0)return[];const i=.5,a=.5,s=bh(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Bi.fromElevationInfo(this.elevationInfo)),n=[],r=s.numVertices,o=s.position;for(let l=0;l<r;++l){const d=Z(Uc,o[3*l+0],o[3*l+1],o[3*l+2]),p=Ln(i,d),u=Ln(a,d);n.push({vertexGeometry:p,vertexOutlineGeometry:u})}return n}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:s}of i)e.addGeometry(a,this.vertexMaterial),e.addGeometry(s,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new fs({...this.vertexMaterialParameters,writeDepth:!0,cullFace:K.Back,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new fs({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:K.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const Uc=b();function Ln(t,e){return V.createSphereGeometry(t,16,16,{offset:e})}let Je=class extends wl{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.labelOptions=new Pa,this.tooltipOptions=new Qe,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Sr({mode:t,offset:e})}normalizeCtorArgs(t){var e;if(!t.elevationInfo){const i=(e=t.hasZ)!=null?e:!0;return{...t,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return t}initializeGraphic(t){const e=this._createGraphicState=new jt({graphic:t});return ge([this.view.maskOccludee(t),this.view.trackGraphicState(e),L(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:i,isDraped:a})=>{da(i,s=>s.isDraped=a)},je)])}makeDrawOperation(){const{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new xl({view:this.view,manipulators:this.manipulators,geometryType:El(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ol(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Al(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Di,segmentLabels:e?new Ea:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Bs(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new Cn({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:y.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=y.colorToVec4(y.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,Gt(()=>{this._activeVertexVisualElement=k(this._activeVertexVisualElement)}))}onOutlineChanged(t){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ht({view:this.view,geometry:t,elevationInfo:e,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Bs(this.hasZ,e)==="on-the-ground",attached:!1}),y.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),y.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Gt(()=>{this._outlineVisualElement=k(this._outlineVisualElement)})}onRegularVerticesChanged(t){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Cn({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:y.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Gt(()=>{this._verticesVisualElement=k(this._verticesVisualElement)}))}};h([_({constructOnly:!0})],Je.prototype,"elevationInfo",void 0),h([_({constructOnly:!0})],Je.prototype,"geometryType",void 0),h([_({constructOnly:!0,type:Pa})],Je.prototype,"labelOptions",void 0),h([_({constructOnly:!0,type:Qe})],Je.prototype,"tooltipOptions",void 0),h([_()],Je.prototype,"type",void 0),h([_({constructOnly:!0})],Je.prototype,"view",void 0),Je=h([B("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Je);function ai(t,e,i){return Hc(t,t.screenToRender(e,is(M.get())),i)}function Hc(t,e,i){const a=is(qs(M.get(),e));if(a[2]=0,!t.unprojectFromRenderScreen(a,i.origin))return null;const s=is(qs(M.get(),e));s[2]=1;const n=t.unprojectFromRenderScreen(s,M.get());return m(n)?null:(P(i.direction,n,i.origin),i)}class ce{constructor(e){this.camera=new Mh,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=_e(),this._worldFrame=null,this._renderLocation=b(),this._renderLocationDirty=!0,this._location=new ti({x:0,y:0,z:0}),this._elevationAlignedLocation=new ti,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=ae.None,this._focused=!1,this.events=new Xe.EventEmitter,this._screenLocation={screenPointArray:be(),renderScreenPointArray:as(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayer=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const i in e)this[i]=e[i];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),{remove:Ho(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){In(e)&&(this._screenLocationDirty=!0),yr(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=_e()),jc(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){gn(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){gn(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=c(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,i){i?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(In(this._modelTransform)){const i=this._calculateModelTransformOffset(Yc);e=z(i,i,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(e,i){var r;if(!this.available)return null;const a=fa(e,Bc),s=this._getCollisionRadius(i),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(mr(this.screenLocation.screenPointArray,a)<s*s)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":{const o=this.collisionType.paths,l=this._getWorldToScreenObjectScale(),d=this._calculateObjectTransform(l,ia),p=s*this.screenLocation.pixelSize,u=ai(this.camera,a,Wa);if(m(u))return null;for(const g of o){if(g.length===0)continue;const v=xe(xi,g[0],d);for(let f=1;f<g.length;f++){const S=xe(zn,g[f],d),w=Fl(wi(v,S,Gn),u);if(w!=null&&w<p*p){const x=z(M.get(),v,S);Q(x,x,.5);const O=Zs(M.get());return this.camera.projectToRenderScreen(x,O),O[2]+n}j(v,S)}}break}case"disc":{const o=this.collisionType.direction,l=(r=this.collisionType.offset)!=null?r:ss,d=this._getWorldToScreenObjectScale(),p=this._calculateObjectTransform(d,ia),u=s*this.screenLocation.pixelSize,g=ai(this.camera,a,Wa);if(m(g))return null;const v=Ys(Vn,p),f=Ws(Fn,o,v),S=xe(kn,l,p);kt(S,f,aa);const w=Nn;if(ni(aa,g,w)&&wr(w,S)<u*u)return this.screenLocation.renderScreenPointArray[2]+n;break}case"ribbon":{const{paths:o,direction:l}=this.collisionType,d=this._getWorldToScreenObjectScale(),p=this._calculateObjectTransform(d,ia),u=s*this.camera.computeScreenPixelSizeAt(this.renderLocation),g=ai(this.camera,a,Wa);if(m(g))return null;const v=Ys(Vn,p),f=Ws(Fn,l,v),S=this._calculateModelTransformPosition(kn);kt(S,f,aa);const w=Nn;if(!ni(aa,g,w))break;for(const x of o){if(x.length===0)continue;const O=xe(xi,x[0],p);for(let H=1;H<x.length;H++){const de=xe(zn,x[H],p),ht=Nl(wi(O,de,Gn),w);if(ht!=null&&ht<u*u){const me=z(M.get(),O,de);Q(me,me,.5);const Et=Zs(M.get());return this.camera.projectToRenderScreen(me,Et),Et[2]+n}j(O,de)}}break}default:jo(this.collisionType)}return null}attach(e={manipulator3D:{}}){var a;if(!this.view._stage)return;const i=e.manipulator3D;if(m(i.engineLayerId)){const s=new Rs({isPickable:!1,updatePolicy:Da.SYNC});this.view._stage.add(s),i.engineLayerId=s.id,this._engineLayer=s}else(a=this.view._stage)!=null&&a.getObject&&(this._engineLayer=this.view._stage.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,m(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Bo(this._location.spatialReference,this.view.spatialReference)||(this.location=new ti({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const i=e.manipulator3D;i.engineLayerReferences--;const a=i.engineLayerReferences===0;a&&(i.engineLayerId=null),this._removeResourcesFromStage(a),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){ns(this.location,Un,e.spatialReference),qo(e.extent,Un)&&(this.location=this._location)}_evaluateElevationAlignment(e=this.location){if(m(this.elevationInfo))return!1;let i=null,a=0;const s=W(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":i=W(qa(this.view.elevationProvider,e,"ground"),0);break;case"relative-to-ground":a=W(qa(this.view.elevationProvider,e,"ground"),0)+s;break;case"relative-to-scene":a=W(qa(this.view.elevationProvider,e,"scene"),0)+s;break;case"absolute-height":a=s}return(a!==this._elevation.offset||i!==this._elevation.override)&&(this._elevation.offset=a,this._elevation.override=i,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),i=ia;if(this.autoScaleRenderObjects===!0){const r=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(r,i)}else this._calculateObjectTransform(e,i);const{objectsByState:a}=this._ensureEngineResources(),s=(this.focused?E.Focused:E.Unfocused)|(this.selected?E.Selected:E.Unselected),n=this._noDisplayCount>0;for(const{stateMask:r,objects:o}of a){if(n){for(const g of o)g.setVisible(!1);continue}const l=(r&E.All)!==E.None,d=(r&ae.All)!==ae.None,p=!l||(s&r)==(r&E.All),u=!d||(this.state&r)==(r&ae.All);if(p&&u)for(const g of o)g.setVisible(!0),g.transformation=i;else for(const g of o)g.setVisible(!1)}}_ensureEngineResources(){if(m(this._engineResources)){const e=R(this._engineLayer),i=[],a=new Set;this.renderObjects.forEach(({material:o})=>{a.has(o)||(i.push(o),a.add(o))});const s=(o,l)=>{const{geometry:d,material:p,transform:u}=l;Array.isArray(d)?d.forEach(g=>o.addGeometry(g,p,u)):o.addGeometry(d,p,u)},n=new Map;this._renderObjects.forEach(o=>{const l=new Ds({castShadow:!1});s(l,o);const d=o.stateMask||0,p=n.get(d)||[];p.push(l),n.set(d,p)});const r=[];n.forEach((o,l)=>r.push({stateMask:l,objects:o})),this._engineResources={objectsByState:r,layer:e,materials:i}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||m(this._engineResources))return;const{objectsByState:e,layer:i,materials:a}=this._engineResources;a.forEach(s=>{const n=R(this._materialIdReferences),r=n.get(s.id)||0;r===0&&this.view._stage.add(s),n.set(s.id,r+1)}),e.forEach(({objects:s})=>{i.addMany(s),this.view._stage.addMany(s)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){if(!this._engineResourcesAddedToStage||m(this._engineResources)||!this.view._stage)return;const{objectsByState:i,layer:a,materials:s}=this._engineResources;i.forEach(({objects:n})=>{a.removeMany(n),this.view._stage.removeMany(n)}),s.forEach(n=>{const r=R(this._materialIdReferences),o=r.get(n.id);o===1?(this.view._stage.remove(n),r.delete(n.id)):r.set(n.id,o-1)}),e&&this.view._stage.remove(a),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,i){return e*(i?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const i=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(i,qc);return Z(e,a[12],a[13],a[14])}_calculateModelTransformOffset(e){const i=this._calculateModelTransformPosition(e);return P(e,i,this.renderLocation)}_calculateObjectTransform(e,i){return Yo(i,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Ye(i,i,this._worldFrame),Ye(i,i,this._modelTransform),i[12]+=this.renderLocation[0],i[13]+=this.renderLocation[1],i[14]+=this.renderLocation[2],i[15]=1,c(this._applyObjectTransform)&&this._applyObjectTransform(i),i}get test(){let e=!1;if(c(this._engineResources))for(const i in this._engineResources.objectsByState){const a=this._engineResources.objectsByState[i];for(const s of a.objects)if(s.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function In(t){return t[12]!==0||t[13]!==0||t[14]!==0}function jc(t,e,i){switch(t.viewingMode){case"local":return rs(i),!0;case"global":{const a=Wo(t.renderCoordsHelper.spatialReference);return Zo(e,0,xi,0,a.radius),Xo(nt(xi[0]),nt(xi[1]),i),!0}}}const Bc=be(),Gn=Pi(),Wa=Ni(),Vn=jh(),qc=_e(),ia=_e(),aa=hi(),xi=b(),zn=b(),Nn=b(),Fn=b(),kn=b(),Yc=b(),Un=new ti({x:0,y:0,z:0,spatialReference:null});function st(t,e=D.OccludeAndTransparent,i=!0){const a=rt(t[0],t[1],t[2],t.length>3?t[3]:1),s=t[3]<1;return i?new fs({color:a,transparent:s,writeDepth:!0,cullFace:K.Back,renderOccluded:e}):new Be({color:a,transparent:s,writeDepth:!0,cullFace:K.Back,renderOccluded:e})}function fi(t,e=D.OccludeAndTransparent){const i=rt(t[0],t[1],t[2],t.length===4?t[3]:1);return new Be({color:i,transparent:!0,writeDepth:!0,cullFace:K.Front,renderOccluded:e})}function oo(t,e,i,a){const s=P(M.get(),t,i),n=lo(s,Me(M.get(),a,s),i,se.get());Qo(n,n);const r=xe(M.get(),e,n);return Math.atan2(r[1],r[0])}function lo(t,e,i,a){const s=re(M.get(),t),n=re(M.get(),e),r=Me(M.get(),s,n);return a[0]=s[0],a[1]=s[1],a[2]=s[2],a[3]=0,a[4]=n[0],a[5]=n[1],a[6]=n[2],a[7]=0,a[8]=r[0],a[9]=r[1],a[10]=r[2],a[11]=0,a[12]=i[0],a[13]=i[1],a[14]=i[2],a[15]=1,a}function Aa(t,e){const i=t.getViewForGraphic(e);return c(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(e,t.spatialReference):null}function ho(t,e,i){const a=Aa(t,i);c(a)?e.elevationAlignedLocation=a:Wc(e,i.geometry)}function Wc(t,e){if(m(e))return;const i=e.type==="mesh"?e.anchor:Sh(e);m(i)||(t.location=wh(i))}var C;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(C||(C={}));function zt(t,e=X(t)){return e.mode!=="on-the-ground"&&!(m(t.geometry)||!t.geometry.hasZ)}var Ie;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(Ie||(Ie={}));class co{constructor(){this.grabbingState=Ie.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=Ie.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,a)=>{if(a===C.TRANSLATE_Z&&(this.zManipulator=i),i instanceof ce&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),m(this.firstGrabbedXY)&&i.grabbing&&a===C.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=Ie.ANY,a){case C.TRANSLATE_Z:this.grabbingState|=Ie.Z;break;case C.TRANSLATE_XY:this.grabbingState|=Ie.XY}})}}function Zc(t){const{view:e,graphic:i}=t,a=new jt({graphic:i}),s=Xc(t,a),n=[s,Qc(t,s.visualElement,a),e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:s.visualElement,remove:()=>ge(n).remove()}}function Xc(t,e){const{view:i,graphic:a}=t,s=new Ht({view:i,geometry:vs(a)?a.geometry:null,elevationInfo:X(a),attached:!1});y.visualElements.lineGraphics.shadowStyle.apply(s);const n=()=>{s.attached=e.displaying};y.visualElements.lineGraphics.outline.apply(s);const r=[L(()=>e.displaying,n),L(()=>e.isDraped,o=>{s.isDraped=o}),e.on("changed",()=>s.geometry=vs(a)?a.geometry:null),ye(s)];return n(),{visualElement:s,remove:()=>ge(r).remove()}}function Qc(t,e,i){const{graphic:a,view:s}=t,n=[],r=X(a),o=r.mode==="on-the-ground"||!r.offset&&r.mode!=="absolute-height",l=new co,d=new Vs({view:s,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent});y.visualElements.pointGraphics.shadowStyle.apply(d);const p=nt(y.visualElements.heightPlaneAngleCutoff),u=new Ri({view:s,attached:!1,angleCutoff:p});y.visualElements.heightPlane.apply(u);let g=1,v=1;const f=()=>{if(l.update(t),!i.displaying||o&&(i.isDraped||!vs(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,d.attached=!1,void(u.attached=!1);e.laserlineEnabled=!0;{const x=l.grabbingState&Ie.XY?y.visualElements.laserlineAlphaMultiplier:1;x!==g&&(g=x,y.visualElements.lineGraphics.shadowStyle.apply(e,x),y.visualElements.pointGraphics.shadowStyle.apply(d,x))}{const x=l.grabbingState&Ie.Z?y.visualElements.laserlineAlphaMultiplier:1;x!==v&&(v=x,y.visualElements.heightPlane.apply(u,x))}Jc(d,l),Kc(t,e,u,l)};y.visualElements.zVerticalLine.apply(d),n.push(i.on("changed",f),L(()=>i.displaying,f),e.events.on("attachment-origin-changed",f),ye(d),ye(u));const S=[],w=()=>{ge(S).remove(),S.length=0,t.forEachManipulator(x=>S.push(x.events.on("grab-changed",f))),t.forEachManipulator(x=>S.push(x.events.on("select-changed",f))),f()};return w(),n.push(t.onManipulatorsChanged(w),xr(()=>ge(S))),ge(n)}function Jc(t,e){const i=e.numSelected===1?e.firstSelected:e.numSelected>1&&c(e.firstGrabbedXY)?e.firstGrabbedXY:null;c(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function Kc(t,e,i,a){if(a.numSelected>0){Z(Rt,0,0,0);let s=0;t.forEachManipulator((n,r)=>{r===C.TRANSLATE_XY&&n.selected&&n instanceof ce&&(z(Rt,Rt,n.renderLocation),s++)}),s>0?(i.heightManifoldTarget=Q(Rt,Rt,1/s),i.attached=!0):i.attached=!1}else{const s=e.attachmentOrigin;c(s)&&t.view.renderCoordsHelper.toRenderCoords(s,Rt)?(i.heightManifoldTarget=Rt,i.attached=!0):i.attached=!1}}function vs(t){return c(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const Rt=b();function ed(t){const{view:e,graphic:i}=t,a=new jt({graphic:i}),s=[],n=id(t,a,s);return td(t,a,s,n),s.push(e.trackGraphicState(a)),{visualElement:n,remove(){ge(s).remove()}}}function td(t,e,i,a){const{view:s,graphic:n}=t,r=new Vs({view:s,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent});y.visualElements.zVerticalLine.apply(r);const o=new Ri({view:s,intersectsLineInfinite:!0,attached:!1});y.visualElements.pointGraphics.shadowStyle.apply(o);const l=nt(y.visualElements.heightPlaneAngleCutoff),d=new Ri({view:s,attached:!1,angleCutoff:l});y.visualElements.heightPlane.apply(d);const p=X(t.graphic),u=Bi.fromElevationInfo(p),g=p.mode==="on-the-ground"||!p.offset&&p.mode!=="absolute-height",v=new co;let f=1,S=1;const w=()=>{v.update(t);const x=zs(n),O=g&&(e.isDraped||m(x)||!x.hasZ);let H=!0;if(!O&&c(x)){const Y=$s(x,s.elevationProvider,u,s.renderCoordsHelper);Z(Le,x.x,x.y,Y),ma(Le,x.spatialReference,Le,s.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(Le),o.intersectsWorldUpAtLocation=Le}else H=!1;const de=v.grabbingState&Ie.Z?y.visualElements.laserlineAlphaMultiplier:1;de!==f&&(f=de,y.visualElements.heightPlane.apply(d,de));const ht=Mr(rd);!O&&e.displaying&&a.calculateMapBounds(ht)&&ma(Jo(ht,Le),s.spatialReference,Le,s.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=Le,d.attached=!0):d.attached=!1;const me=v.grabbingState&Ie.XY?y.visualElements.laserlineAlphaMultiplier:1;me!==S&&(S=me,y.visualElements.pointGraphics.shadowStyle.apply(o,me));const Et=H&&e.displaying&&!O;o.attached=Et,r.attached=Et};i.push(L(()=>[e.displaying,e.isDraped],w),e.on("changed",w)),t.forEachManipulator(x=>{i.push(x.events.on("grab-changed",w))}),i.push(ye(o)),i.push(ye(r)),i.push(ye(d)),w()}function id(t,e,i){const{view:a,graphic:s}=t,n=new _s({view:a,geometry:zs(s),elevationInfo:X(s),attached:!1});return ad(t,n,e,i),i.push(ye(n)),n}function zs(t){const e=t.geometry;return m(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function ad(t,e,i,a){const s=()=>e.attached=i.displaying;sd(t,e,i,a),y.visualElements.pointGraphics.outline.apply(e),a.push(L(()=>i.displaying,s,je))}function sd(t,e,i,a){const{view:s,graphic:n}=t;let r=null;const o=d=>{c(r)&&(r.remove(),r=null),i.isDraped&&c(d)&&(r=nd(s,d,()=>{e.geometry=d}))},l=()=>{const d=zs(n);o(d),e.geometry=d};a.push(i.on("changed",l),xr(()=>r)),l()}function nd(t,e,i){const a=t.elevationProvider.spatialReference;Ko(e,Le,a);const s=Le[0],n=Le[1];return t.elevationProvider.on("elevation-change",r=>{Er(r.extent,s,n)&&i()})}const Le=b(),rd=br();function Ga(t){switch(R(t.graphic.geometry).type){case"point":case"mesh":return ed(t);case"polygon":case"polyline":return Zc(t);default:return null}}const od=[1,.5,0],po=128,We=70,ld=80,uo=.02,hd=54,cd=100,go=Math.ceil(We/3*2),$t=160,Za=.5,Xa=24,Yt=9,dd=$t+30,Hn=$t+53,pd=60,ud=23,gd=5*Math.PI/12,_d=1*Math.PI/3,jn=10,Bn=.2,qn=30,Yn=53,Wn=.2,Zn=.3,md=200,fd=3,vd=1e6;class Zi{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(a=>{!i&&e(a)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,a)=>{i instanceof ce&&e(i,a)})}}function Ta(t,e){return _o(t,()=>e)}function yd(t){return _o(t,e=>e.plane)}function _o(t,e){const i=b(),a=b();let s=!1;return n=>{const r=e(n);if(n.action==="start"){const d=fa(n.screenStart,Xs(bt.get())),p=ai(t.state.camera,d,Qn);c(p)&&(s=ni(r,p,i))}if(!s)return null;const o=fa(n.screenEnd,Xs(bt.get())),l=ai(t.state.camera,o,Qn);return m(l)?null:ni(r,l,a)?{...n,renderStart:i,renderEnd:a,plane:r,ray:l}:null}}function bd(t,e,i,a=null,s=null){let n=null;return r=>{if(r.action==="start"&&(n=t.sceneIntersectionHelper.intersectElevationFromScreen(be(r.screenStart.x,r.screenStart.y),e,i,s),c(n)&&c(a)&&!ns(n,n,a))||m(n))return null;const o=t.sceneIntersectionHelper.intersectElevationFromScreen(be(r.screenEnd.x,r.screenEnd.y),e,i,s);return c(o)?c(a)&&!ns(o,o,a)?null:{...r,mapStart:n,mapEnd:o}:null}}function Va(t,e,i,a=null,s=null){return bd(t,i,Or(e,t,i),a,s)}function mo(t,e,i,a=null,s=null){return Va(t,i,X(e),a,s)}function Md(t,e,i,a){const s=e.toMap(t.screenStart,{include:[i]});return c(s)?mo(e,i,s,a):null}function Sd(t,e){const i=xd,a=Ed,s=hi();t.renderCoordsHelper.worldUpAtPosition(e,i);const n=Me(s,i,P(a,e,t.state.camera.eye));return Me(n,n,i),kt(e,n,s)}function fo(t,e,i){let a=null;const s=new As;return s.next(Ta(t,Sd(t,e))).next(wd(t,e)).next(vo(t,i)).next(n=>{n.mapEnd.x=n.mapStart.x,n.mapEnd.y=n.mapStart.y,a=n}),n=>(a=null,s.execute(n),a)}function wd(t,e){const i=b(),a=Te(e);t.renderCoordsHelper.worldUpAtPosition(e,i);const s=b(),n=b(),r=o=>(P(o,o,e),Ul(i,o,o),t.viewingMode==="global"&&Te(o)*Math.sign(Ei(i,o))<.001-a&&P(o,Q(o,i,.001),e),z(o,o,e),o);return o=>(o.renderStart=r(j(s,o.renderStart)),o.renderEnd=r(j(n,o.renderEnd)),o)}function vo(t,e){const i=t.renderCoordsHelper;return a=>{const s=i.fromRenderCoords(a.renderStart,e),n=i.fromRenderCoords(a.renderEnd,e);return c(s)&&c(n)?{...a,mapStart:s,mapEnd:n}:null}}var Xn;(function(t){t[t.GROUND=0]="GROUND",t[t.OTHER=1]="OTHER"})(Xn||(Xn={}));const xd=b(),Ed=b(),Qn=Ni();function za(t,e,i,a){const s=t.graphic,n=(r,o)=>e({action:r,graphic:s,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY});return i((r,o,l)=>{const d=o.next(p=>(p.action==="start"&&n("start",p),p)).next(Tl(s,a)).next(p=>{switch(p.action){case"start":case"update":(p.translationX||p.translationY||p.translationZ)&&n("update",p);break;case"end":n("end",p)}return p});return l.next(Pl(s)).next(()=>{n("end",{screenDeltaX:0,screenDeltaY:0})}),d})}function yo(t){if(m(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class Od extends Zi{constructor(e){super(),this._handles=new ot,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=We,this._updateAfterDrag=!1,this.events=new Xe,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._handles=k(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:i}of this._arrowManipulatorInfos)e(i,C.TRANSLATE_XY)}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=X(s),r=R(s.geometry).spatialReference;return za(i,a,o=>this.createDragPipeline((l,d,p,u,g)=>o(l,e(l,d,p,u,g),p),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){return ge(this._arrowManipulatorInfos.map(({manipulator:n},r)=>ze(n,(o,l,d,p,u)=>{const g=l.next(v=>({...v,manipulatorType:C.TRANSLATE_XY})).next(Si(this._view,o.elevationAlignedLocation)).next(Va(this._view,o.elevationAlignedLocation,i,a,s)).next(Rl(o.location,this.angle+(r+1)*Math.PI*.5)).next(li());e(o,g,d,p,u)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},a){const s=this._radius/We,n=hd*s,r=n*Math.sqrt(3)/2,o=V.createExtrudedTriangle(r,n/2,n/2,uo);V.transformInPlace(o,ts(se.get(),Z(M.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:E.Focused},{geometry:o,material:this._transparentMaterial,stateMask:E.Unfocused}],e.radius=r/3*2*1.2;const l=xs(se.get(),a*Math.PI/2),d=ts(se.get(),Z(M.get(),0,cd*s,0));Ye(i,l,d)}_createManipulators(){for(let e=0;e<4;e++){const i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,i=Ar(se.get(),e,N(0,0,1));if(m(i))return;const a=va(se.get(),Z(M.get(),this.displayScale,this.displayScale,this.displayScale)),s=Ye(se.get(),a,i);for(const n of this._arrowManipulatorInfos){const r=Ye(se.get(),s,n.transform);n.manipulator.modelTransform=r}}_createArrowManipulator(e){const i=new ce({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)}}),a={manipulator:i,transform:_e()};return this._updateArrowManipulator(a,e),this._handles.add(i.events.on("drag",s=>{this._updateAfterDrag&&s.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){const i=he.toUnitRGBA(T.main);return i[3]*=e,new Be({color:i,transparent:e!==1,cullFace:K.Back,renderOccluded:D.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class Ad{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new As,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const i=this.lastDragEvent.mapEnd,a=this._snap(this.lastDragEvent.screenEnd);if(c(a)){const s={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:e===!0?a:i,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(s)}}this._enabled=e}_snap(e){const i=c(this.view)?this.view.toMap(e,{exclude:[]}):null;return c(i)&&c(this.view)&&(i.z=Or(i,this.view,this.elevationInfo)),i}createDragEventPipelineStep(e,i){return this.view=e,this.elevationInfo=i,this.lastDragEvent=null,a=>{if(this.lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const s=this._snap(a.screenEnd);return c(s)?{action:a.action,mapStart:a.mapStart,mapEnd:s,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class Td extends Zi{constructor(e){super(),this._snapToScene=new Ad,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=We,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,C.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=X(s),r=R(s.geometry).spatialReference;return za(i,a,o=>this.createDragPipeline((l,d,p,u,g)=>o(l,e(l,d,p,u,g),p),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){const n=this._view;return ze(this._manipulator,(r,o,l,d,p)=>{const u=o.next(Si(n,r.elevationAlignedLocation)).next(Va(n,r.elevationAlignedLocation,i,a,s)).next(this._snapToScene.createDragEventPipelineStep(n,i),this._snapToScene.next).next(g=>({...g,manipulatorType:C.TRANSLATE_XY})).next(li());e(r,u,l,d,p)})}_updateManipulatorTransform(){const e=va(se.get(),Z(M.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new ce({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=V.createCylinderGeometry(uo,1,po,N(0,0,1),N(0,0,0)),i=va(_e(),N(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:i,stateMask:E.Focused},{geometry:e,material:this._discMaterialTransparent,transform:i,stateMask:E.Unfocused}],this._manipulator.radius=ld*(this._radius/We)}_createMaterial(e=1){const i=he.toUnitRGBA(T.main);return i[3]*=e,new Be({color:i,transparent:e!==1,cullFace:K.Back,renderOccluded:D.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Pd extends Zi{constructor(e){super(),this._radius=We,this.events=new Xe,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,C.TRANSLATE_Z)}createGraphicDragPipeline(e,i,a){const s=R(i.graphic.geometry).spatialReference;return za(i,a,n=>this.createDragPipeline((r,o,l,d,p)=>n(r,e(r,o,l,d,p),l),s),this._view.state.viewingMode)}createDragPipeline(e,i){const a=this._view;return ze(this._manipulator,(s,n,r,o,l)=>{const d=n.next(p=>({...p,manipulatorType:C.TRANSLATE_Z})).next(fo(a,s.renderLocation,i)).next(li());e(s,d,r,o,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/We,i=y.zManipulator.height*e,a=y.zManipulator.coneHeight*e,s=y.zManipulator.coneWidth*e,n=y.zManipulator.width*e,r=[N(0,0,0),N(0,0,i)],o=V.createTubeGeometry(r,n/2,16,!1),l=V.createConeGeometry(a,s/2,16,!1),d=[N(0,0,0),N(0,0,i+a)],p=x=>{const O=_e();if(pa(O,O,[0,0,i]),Tr(O,O,Math.PI/2),x){const H=1+2*x/s;Vi(O,O,[H,H,H])}return O},u=p(0),g=(x,O)=>{const H=tl(y.zManipulator.color,O);return[H.r/255,H.g/255,H.b/255,y.zManipulator.color.a*x]},v=st(g(1,.25),D.Occlude),f=st(g(1,0),D.Occlude),S=st(g(.7,0),y.zManipulator.renderOccluded),w=st(g(.85,0),y.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:u,material:v,stateMask:E.Unfocused},{geometry:o,material:v,stateMask:E.Unfocused},{geometry:l,transform:u,material:f,stateMask:E.Focused},{geometry:o,material:f,stateMask:E.Focused},{geometry:l,transform:u,material:S,stateMask:E.Unfocused},{geometry:o,material:S,stateMask:E.Unfocused},{geometry:l,transform:u,material:w,stateMask:E.Focused},{geometry:o,material:w,stateMask:E.Focused}],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[d]}}_createManipulator(){const e=new ce({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=i=>{const a=this._view.state.camera,s=Jn;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const n=el(a.eye,s),r=a.computeRenderPixelSizeAtDist(n),o=P(Wt,s,a.eye);re(o,o);const l=Rd;this._view.renderCoordsHelper.worldUpAtPosition(Jn,l);const d=Math.abs(Ei(o,l)),p=Me(Wt,o,l),u=Me(Wt,p,l),g=_a(d,.01,1),v=1-Math.sqrt(1-g*g)/g/a.fullWidth,f=this._radius/We,S=y.zManipulator.width*f;Q(u,re(u,u),(1/v-1)*n+r*S),i[12]-=Wt[0],i[13]-=Wt[1],i[14]-=Wt[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Jn=b(),Wt=b(),Rd=b();class Nt extends Zi{constructor(e){super(),this._handles=new ot,this._angleDeferred=null,this._interactive=!0;const{tool:i,view:a,snapToScene:s,radius:n}=e;this._view=a,this.xyManipulation=new Td({tool:i,view:a,snapToScene:s,radius:n}),this.xyAxisManipulation=new Od({tool:i,view:a,radius:n}),this.zManipulation=new Pd({tool:i,view:a,radius:n}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(r=>{this._handles.add(r.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,i,a){return ge([this.xyManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(G.XY,s,n,r,o,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(G.XY_AXIS,s,n,r,o,l),i,a),this.zManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(G.Z,s,n,r,o,l),i,a)])}createDragPipeline(e,i,a,s){return ge([this.xyManipulation.createDragPipeline((n,r,o,l,d)=>e(G.XY,n,r,o,l,d),i,a,s),this.xyAxisManipulation.createDragPipeline((n,r,o,l,d)=>e(G.XY_AXIS,n,r,o,l,d),i,a,s),this.zManipulation.createDragPipeline((n,r,o,l,d)=>e(G.Z,n,r,o,l,d),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,C.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,C.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,C.TRANSLATE_Z))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(Pr("esri-mobile"))return;const a=[];i.forEachManipulator(n=>a.push(n)),e.forEachManipulator(n=>a.push(n));const s=()=>{const n=[];this.xyAxisVisible?c(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator(r=>n.push(r.disableDisplay())),this._handles.remove(Kn),this._handles.add(n,Kn)};for(const n of a)this._handles.add(n.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(si(()=>{var n;return(n=this._view.inputManager)==null?void 0:n.latestPointerType},s)),s()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this._interactive||i.grabbing})}static radiusForSymbol(e){const i=c(e)&&e.type==="point-3d"&&e.symbolLayers;return!!i&&i.length>0&&i.some(a=>a.type==="icon")?go:We}}const Kn="disable-xy-axis-display";var G;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(G||(G={}));class Ns extends Zi{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,C.TRANSLATE_XY)}createGraphicDragPipeline(e){return za(this._graphicState,e,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(e){const i=this._view,a=this._graphicState.graphic,s=c(a.geometry)?a.geometry.spatialReference:null;return ze(this._manipulator,(n,r,o,l,d)=>{const p=r.next(Md(d,i,a,s)).next(Zt()).next(li());e(n,p,o,l,d)})}_createManipulator(){const e=this._view,i=this._graphicState.graphic;this._manipulator=new qh({graphic:i,view:e,selectable:!0,cursor:"move"})}}let Ae=class extends lt{constructor(t){super(t),this.type="translate-graphic",this.distance=wt}};h([_()],Ae.prototype,"type",void 0),h([_()],Ae.prototype,"distance",void 0),Ae=h([B("esri.views.interactive.tooltip.TranslateGraphicTooltipInfo")],Ae);let Ge=class extends lt{constructor(t){super(t),this.type="translate-z",this.distance=wt}};h([_()],Ge.prototype,"type",void 0),h([_()],Ge.prototype,"distance",void 0),Ge=h([B("esri.views.interactive.tooltip.TranslateZTooltipInfo")],Ge);let mt=class extends lt{constructor(t){super(t),this.type="translate-vertex",this.distance=wt,this.elevation=null,this.area=null,this.totalLength=null}};h([_()],mt.prototype,"type",void 0),h([_()],mt.prototype,"distance",void 0),h([_()],mt.prototype,"elevation",void 0),h([_()],mt.prototype,"area",void 0),h([_()],mt.prototype,"totalLength",void 0),mt=h([B("esri.views.interactive.tooltip.TranslateVertexTooltipInfo")],mt);class Dd{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class $d{constructor(e,i,a){this.dx=e,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class er{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let He=class extends Rr(Xe.EventedMixin(Ra)){constructor(t){super(t),this.graphics=new il,this.enableZ=!0,this.tooltipOptions=new Qe,this.type="move-3d",this._snappingPipeline=new ba,this._tooltip=null}initialize(){const{graphics:t,view:e}=this;this.own([t.on("change",()=>this._refreshManipulators()),L(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new zi({view:e}):k(this._tooltip)},Es)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=k(this._tooltip),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(e=>al(e)===Dr.SUPPORTED).map(e=>new Cd(e));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(e=>this.view.trackGraphicState(e.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new Ns({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator(a=>this.handles.add([a.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:i.graphic}),s.stopPropagation()}),a.events.on("grab-changed",({action:s})=>{const{tooltipOptions:n,_tooltip:r}=this;m(r)||(s==="focus"?r.info=new Ae({tooltipOptions:n}):r.clear())})])),this.handles.add(e.manipulationXY.createDragPipeline((a,s,n,r)=>this._buildDragEventPipeline(t,G.XY,a,s,n,r)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new Nt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?Nt.radiusForSymbol(t[0].graphic.symbol):We});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((s,n)=>{this.handles.add(s.events.on("immediate-click",r=>{e.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",{...r,graphic:this.graphics.getItemAt(0)}),r.stopPropagation()})),n===C.TRANSLATE_XY&&this.handles.add(s.events.on("focus-changed",({action:r})=>{const{tooltipOptions:o,_tooltip:l}=this;m(l)||(r==="focus"?l.info=new Ae({tooltipOptions:o}):l.clear())})),n===C.TRANSLATE_Z&&this.handles.add(s.events.on("focus-changed",({action:r})=>{const{tooltipOptions:o,_tooltip:l}=this;m(l)||(r==="focus"?l.info=new Ge({tooltipOptions:o}):l.clear())}))});const i=()=>this._updateMoveManipulation(t);for(const s of t)this.handles.add([s.state.on("changed",i),L(()=>s.state.displaying,i)]);const a=t[t.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(e.createDragPipeline((s,n,r,o,l)=>this._buildDragEventPipeline(t,s,n,r,o,l),X(a.graphic),R(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=Ga({view:this.view,graphic:i,forEachManipulator:s=>{e.manipulationXY.forEachManipulator(s),this._moveManipulation.forEachManipulator(s)},onManipulatorsChanged:()=>Gt()});m(a)||(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof Ht&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),L(()=>e.state.isDraped,()=>this._updateMoveManipulation(t))]),this.handles.add(a))}}_updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>yo(t.graphic.geometry)}_updateMoveManipulation(t){const e=Wi(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const n of t){if(!n.state.displaying)continue;const r=n.state.graphic;this.enableZ&&zt(r)&&(a=!0);const o=n.geometryRepresentation instanceof Ht&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:Aa(this.view,r);c(o)&&(e.x+=o.x,e.y+=o.y,e.z+=o.z,i++)}i>0?(e.x/=i,e.y/=i,e.z/=i,s.location=e,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(t,e,i,a,s,n){const r=[],o=[];let l=null,d=null;const p=()=>{for(const g of r)g.dragging=!1;r.length=0,o.length=0,l=null,d=null,this._moveManipulation.interactive=!0};if(t.length===1&&e===G.XY){const g=t[0].graphic;a=this._buildSnappingPipelineSteps(g,X(g),a,s,n)}const u=a.next(g=>{if(g.action==="start"){r.length=0,o.length=0;for(const v of t)v.dragging||!v.manipulationXY.hasManipulator(i)&&v.manipulationXY.grabbing||(r.push(v),o.push(v.graphic),v.dragging=!0);if(o.length!==0&&(this._moveManipulation.interactive=!1,l=Dl(o,this.view.state.viewingMode),d=$l(o),this.emit("graphic-move-start",new Dd(o)),this.destroyed))return null}return o.length!==0?g:null}).next(g=>l(g)).next(g=>this._updateMoveTooltip(g,e,t)).next(g=>{switch(g.action){case"start":case"update":if(g.translationX||g.translationY||g.translationZ){const v=this.view.toScreen(g.mapStart),f=this.view.toScreen(g.mapEnd),S=f.x-v.x,w=f.y-v.y;if(this.emit("graphic-move",new $d(S,w,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new er(o)),this.destroyed)return null;p()}});return s.next(g=>d(g)).next(()=>{if(this.emit("graphic-move-stop",new er(o)),this.destroyed)return null;p()}),u}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:s}=this;if(m(s))return t;if(s.clear(),e===G.XY||e===G.XY_AXIS)if(t.action==="end")s.info=new Ae({tooltipOptions:a});else{const n=i.length===0?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height",r=Ai(t.mapStart,t.mapEnd,n);c(r)&&(s.info=new Ae({tooltipOptions:a,distance:r}))}return e===G.Z&&(t.action==="end"?s.info=new Ge({tooltipOptions:a}):da(Ma(t.mapStart,t.mapEnd),n=>{s.info=new Ge({tooltipOptions:a,distance:n})})),t}_buildSnappingPipelineSteps(t,e,i,a,s){const n=t.geometry;if(m(n)||n.type!=="point"&&n.type!=="mesh")return i;const r=(n.type==="point"?n:n.anchor).clone(),o=new xa({elevationInfo:e,pointer:s,editGeometryOperations:$a.fromGeometry(r,this.view.state.viewingMode),visualizer:new Di,excludeFeature:t}),l=this.snappingManager;return i.next(d=>(r.z=sl(this.view,r,X(t),{mode:"absolute-height",offset:0}),{...d,snapOrigin:o.coordinateHelper.pointToVector(r)})).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:o,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};h([_({constructOnly:!0,nonNullable:!0})],He.prototype,"view",void 0),h([_()],He.prototype,"graphics",void 0),h([_({constructOnly:!0,nonNullable:!0})],He.prototype,"enableZ",void 0),h([_({constructOnly:!0,type:Qe})],He.prototype,"tooltipOptions",void 0),h([_({constructOnly:!0})],He.prototype,"snappingManager",void 0),h([_()],He.prototype,"type",void 0),h([_()],He.prototype,"updating",null),He=h([B("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],He);class Cd{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new jt({graphic:e})}get graphic(){return this.state.graphic}}function tr(t,e,i){const a=i.mode==="on-the-ground"?mn.XY:mn.XYZ;return new Gh(t,a,e,0)}function ir(t,e,i){const a=b();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const s=ar(t,e,Fi(i.plane)),n=ar(t,e,i.edgeDirection);if(m(s)||m(n))return null;const r=Me(b(),s,n);return kt(a,r,hi())}function ar(t,e,i){const a=Wi(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),s=b(),n=b();return t.renderCoordsHelper.toRenderCoords(e,s)&&t.renderCoordsHelper.toRenderCoords(a,n)?$r(n,s,n):null}function Ld(t,e,i){const a=Fi(t),s=$r(b(),e,i),n=Me(b(),s,a),r=Me(b(),s,n);return lh(s[0],s[1],s[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1)}function Id(t,e,i){const a=i.projectToRenderScreen(t,as()),s=i.projectToRenderScreen(e,as());return c(a)&&c(s)?nl(P(a,a,s)):0}let Jt=class extends lt{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=wt}};h([_()],Jt.prototype,"type",void 0),h([_()],Jt.prototype,"distance",void 0),Jt=h([B("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Jt);let J=class extends Xe.EventedMixin(Os){constructor(t){super(t),this._vertexManipulatorMaterial=st(y.colorToVec4(y.reshapeManipulators.vertex.color),y.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.vertex.outlineColor),y.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.vertex.hoverOutlineColor),y.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=st(y.colorToVec4(y.reshapeManipulators.edge.color),y.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.edge.outlineColor),y.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=st(y.colorToVec4(y.reshapeManipulators.edgeOffset.color),y.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=st(y.colorToVec4(y.reshapeManipulators.edgeOffset.hoverColor),y.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=st(y.colorToVec4(y.reshapeManipulators.selected.color),y.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.selected.outlineColor),y.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.selected.hoverOutlineColor),y.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new ot,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=F.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new ba,this._snappingPipelineHandle=new ba,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new jt({graphic:t});this._tooltip=new zi({view:e}),this.own([L(()=>i.displaying,a=>{for(const s of this._manipulatorInfos)s.manipulator.available=a}),L(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:s,edgeOffsetEnabled:n})=>{c(a)&&(a.visible=s,a.edgeDistance=n?"far":"default")},je),si(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),je),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=k(this._segmentLabels),this._tooltip=k(this._tooltip),this._editGeometryOperations=k(this._editGeometryOperations),this._moveManipulation=k(this._moveManipulation),this._graphicMoveManipulation=k(this._graphicMoveManipulation),this._manipulatorHandles=k(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=k(this._moveManipulation),this._graphicMoveManipulation=k(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(m(this._editGeometryOperations))return;const t=X(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const i of e.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of e.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(m(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(m(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),m(t)||(k(this._editGeometryOperations),this._editGeometryOperations=$a.fromGeometry(t,this.view.state.viewingMode),this._createManipulators(),k(this._segmentLabels),this._segmentLabels=new Ea({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:X(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let i=0;const a=[],s=this._manipulatorInfos.some(r=>r.type==="vertex"&&r.manipulator.selected),n=t===Kt.SELECTED_OR_ALL&&s;for(const r of this._manipulatorInfos)r.type==="vertex"&&(r.manipulator.grabbing||n&&!r.manipulator.selected||a.push(r),i++);if(a.length===0)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(F.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(F.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)e.type==="vertex"&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(F.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const s=[];for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected&&!n.manipulator.grabbing||n===t.info)&&s.push(n);this._moveVertices(s,t,at.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case F.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case F.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case F.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case F.MOVING:switch(this._reshapeEventState){case F.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case F.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case F.RESHAPING:switch(this._reshapeEventState){case F.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case F.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulators(t){const{graphic:e,handles:i,tool:a,view:s}=this,n=this._graphicState;if(this._graphicMoveManipulation=new Ns({tool:a,view:s,graphicState:n}),this.enableMoveGraphic){let l=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((d,p,u)=>{p.next(g=>this._trackNumDragging(g)).next(g=>(g.action==="start"&&(l=R(this._editGeometryOperations).createUndoGroup()),g)).next(g=>this._perGraphicManipulatorDragAction(Kt.ALL,g)).next(g=>(this._updateTranslateGraphicTooltip(G.XY,g),g)).next(g=>{g.action==="end"&&(this._tooltip.clear(),l=At(l))}),u.next(this._cancelDragOperation(()=>l=At(l)))}))}else this._graphicMoveManipulation.forEachManipulator(l=>{l.grabbable=!1,l.cursor=null});this._graphicMoveManipulation.forEachManipulator(l=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",d=>{this._manipulatorInfos.some(p=>p.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...d,graphic:this.graphic}),d.stopPropagation()})])),this._moveManipulation=new Nt({tool:a,view:s,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&zt(e),snapToScene:!1,radius:Nt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((l,d)=>{i.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",p=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(u=>u.manipulator.selected)||this.emit("immediate-click",{...p,graphic:e}),p.stopPropagation()})]),i.add(l.events.on("focus-changed",({action:p})=>{p==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(d===C.TRANSLATE_Z?G.Z:G.XY):this._tooltip.clear()}))}),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=R(e.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,d,p,u,g)=>{const v=p.next(f=>this._trackNumDragging(f)).next(f=>{const S=this._manipulatorInfos.filter(w=>w.type==="vertex"&&w.manipulator.selected);return f.manipulatorType===C.TRANSLATE_XY&&S.length===1?{...f,info:S[0],snapOrigin:S[0].handle.pos}:{...f,info:null}}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:f=>!!f.info,cancel:u,snappingManager:a.snappingManager,snappingContext:new xa({editGeometryOperations:R(this._editGeometryOperations),elevationInfo:t,pointer:g,excludeFeature:e,visualizer:new Di}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(Zt()).next(f=>this._perGraphicManipulatorDragAction(Kt.SELECTED_OR_ALL,f)).next(f=>(this._updateTranslateTooltip(l,f),f));return u.next(this._cancelDragOperation()),v},t,r,e),L(()=>n==null?void 0:n.displaying,()=>{this._updateMoveManipulationPosition()},je),n.on("changed",()=>this._updateMoveManipulationPosition()),L(()=>n==null?void 0:n.isDraped,l=>{const d="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),d):i.remove(d)},je)]),this._updateMoveManipulationPosition();const o=Ga({view:s,graphic:e,forEachManipulator:l=>{if(!this.destroyed){c(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(l);for(const d of this._manipulatorInfos)l(d.manipulator,C.TRANSLATE_XY);this._moveManipulation.forEachManipulator(l)}},onManipulatorsChanged:l=>this.on("manipulators-changed",l)});c(o)&&(this._outlineVisualElement=o.visualElement instanceof Ht?o.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{n.isDraped||this._updateMoveManipulationPosition()}),L(()=>n.isDraped,()=>this._updateMoveManipulationPosition())]),this._manipulatorHandles.add(o)}_createEdgeOffsetManipulator(t,e=X(this.graphic)){const i=y.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if(m(this._edgeOffsetManipulatorGeometryInside)||m(this._edgeOffsetManipulatorGeometryOutside)){const g=a/s,v=g*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=V.createExtrudedTriangle(v,g/2,g/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=V.createExtrudedTriangle(-v,g/2,g/2,i.height,-i.offset)}const n=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:E.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:E.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:E.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:E.Focused}],r=new ce({view:this.view,renderObjects:n,elevationInfo:e.mode!=="on-the-ground"||Qs(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:N(0,0,1)},collisionPriority:1}),o=new ce({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:r,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:o,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const d=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)),p=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=ge([d,p]),this._manipulatorHandles.add(l.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(o,!0)],r),this._manipulatorHandles.add(ze(r,this._createEdgeOffsetPipeline(l,e)),r),this._manipulatorHandles.add(ze(o,(g,v,f,S)=>{if(S==="touch")this._createEdgeOffsetPipeline(l,e)(g,v,f);else if(this.enableMoveGraphic){const w=this.graphic,x=c(w.geometry)?w.geometry.spatialReference:null;v.next(O=>this._trackNumDragging(O)).next(Si(this.view,g.elevationAlignedLocation)).next(Va(this.view,g.elevationAlignedLocation,e,x,w)).next(li()).next(Zt()).next(O=>this._perGraphicManipulatorDragAction(Kt.ALL,O)).next(O=>(this._updateTranslateGraphicTooltip(G.XY,O),O)).next(O=>{O.action==="end"&&this._tooltip.clear()}),f.next(this._cancelDragOperation())}}),r);const u=g=>{this._manipulatorInfos.some(v=>v.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...g,graphic:this.graphic}),g.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",u),o.events.on("immediate-click",u),r.events.on("focus-changed",({action:g})=>{const v=this._tooltipOptions;g==="focus"&&v.enabled?this._tooltip.info=new Jt({tooltipOptions:v}):this._tooltip.clear()})],r),this._manipulatorInfos.push(l),this.manipulators.add(r),this.manipulators.add(o),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,s=()=>{At(t.visibilityHandle);const n=Id(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||n)&&(i.grabbable=!n,a.grabbable=!n,t.visibilityHandle=ge([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",s),a.events.on("focus-changed",s),{remove:()=>{At(t.visibilityHandle),this.manipulators.remove(a)}}],i),s()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const e=R(this._editGeometryOperations).data.coordinateHelper,i=ir(this.view,t.manipulator.elevationAlignedLocation,tr(e,t.handle,R(t.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,n=c(i)?Ld(i,a,s):hh;t.manipulator.modelTransform=n,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=n;const r=Te(P(sa,a,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-r,0,0],[r,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,s)=>{this._clearSelection();const{step:n,cleanup:r}=this._initializeEdgeOffset(t,e);a.next(o=>this._trackNumDragging(o)).next(Si(this.view,i.elevationAlignedLocation)).next(n).next(yd(this.view)).next(vo(this.view,R(this._editGeometryOperations).data.spatialReference)).next(Zt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(o=>{o.action==="end"&&r()}),s.next(o=>(r(),o)).next(o=>(this._tooltip.clear(),o)).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,e){const i=R(this._editGeometryOperations),a=tr(i.data.coordinateHelper,t.handle,e),s=i.createUndoGroup(),n=ir(this.view,t.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const r=()=>new rl({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:R(this._editGeometryOperations).data.spatialReference}),o=new Ht({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:t.elevationInfo,width:y.visualElements.lineGraphics.outline.width,color:y.colorToVec4(T.main),attached:!0});let l;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=At(l)},p=this.on("undo",d);return l=ge([ye(o),L(()=>this._graphicState.isDraped,u=>o.isDraped=u),this._graphicState.on("changed",()=>o.geometry=r()),s,p]),{step:u=>m(a)||m(n)?(d(),null):{...u,operation:a,plane:n},cleanup:d}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||m(e.operation))return e;this._updateEventState(F.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=e;return(i||a||s)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;if(m(e)||m(i))return t;const a=e.signedDistanceToPoint(i);return{...t,signedDistance:a}}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,s=this._tooltip,n=this._tooltipOptions;if(!n.enabled||m(i))return s.clear(),t;const r=Gd(this._graphicState.isDraped,-i,e,a.plane,R(this._editGeometryOperations).data.coordinateHelper);return m(s.info)||s.info.type!=="reshape-edge-offset"?s.info=new Jt({tooltipOptions:n,distance:r}):s.info.distance=r,t}}_cleanEdgeOffsetCollapsedEdges(t){var l,d;const e=(l=t.handle.leftVertex.leftEdge)==null?void 0:l.leftVertex,i=t.handle.leftVertex,a=(d=t.handle.rightVertex.rightEdge)==null?void 0:d.rightVertex,s=t.handle.rightVertex,n=R(this._editGeometryOperations).data.coordinateHelper,r=1e-6,o=[];e&&n.distance(e.pos,i.pos)<r&&o.push(this._getManipulatorInfoFromHandle(i)),(n.distance(i.pos,s.pos)<r||a&&n.distance(a.pos,s.pos)<r)&&o.push(this._getManipulatorInfoFromHandle(s)),o.length&&this._removeVertices(o)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=X(this.graphic)){if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(m(this._vertexManipulatorGeometry)||m(this._vertexManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(y.reshapeManipulators.vertex);this._vertexManipulatorGeometry=V.createSphereGeometry(r,16,16),this._vertexManipulatorOutlineGeometry=V.createSphereGeometry(o,16,16)}if(m(this._edgeManipulatorGeometry)||m(this._edgeManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(y.reshapeManipulators.edge);this._edgeManipulatorGeometry=V.createSphereGeometry(r,16,16),this._edgeManipulatorOutlineGeometry=V.createSphereGeometry(o,16,16)}const i=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Ce.Vertex|E.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:Ce.Vertex|E.Unfocused|E.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Ce.Vertex|E.Focused|E.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:E.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:E.Selected|E.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:E.Selected|E.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Ce.Edge|E.Focused|E.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Ce.Edge|E.Focused|E.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:Ce.Edge|E.Unfocused|E.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:Ce.Edge|E.Unfocused|E.Unselected});const a=new ce({view:this.view,renderObjects:i,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,t,e);const s=t.type==="edge"?{manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),s.type==="edge"){const r=this._getManipulatorInfoFromHandle(s.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s)),o=this._getManipulatorInfoFromHandle(s.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s));s.locationUpdateHandle=ge([r,o]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const n=ze(a,(r,o,l,d)=>{let p=null;o.next(u=>this._trackNumDragging(u)).next(u=>{if(u.action==="start"&&(p=R(this._editGeometryOperations).createUndoGroup()),s.type==="edge"){const g=this._splitEdgeManipulator(s);return{...u,info:g,snapOrigin:g.handle.pos}}return{...u,info:s,snapOrigin:s.handle.pos}}).next(Si(this.view,r.elevationAlignedLocation)).next(mo(this.view,this.graphic,r.elevationAlignedLocation,r.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new xa({editGeometryOperations:R(this._editGeometryOperations),elevationInfo:e,pointer:d,excludeFeature:this.graphic,visualizer:new Di}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(Zt()).next(u=>{this._perVertexManipulatorDragAction(u),u.action==="end"&&(p=At(p)),this._updateTranslateVertexTooltip(r,G.XY,u)}),l.next(this._cancelDragOperation(()=>p=At(p)))});return this._manipulatorHandles.add([n,a.events.on("immediate-click",r=>this._manipulatorClickCallback(r,s)),a.events.on("select-changed",()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:r})=>{r==="focus"&&s.type!=="edge"?this._updateTranslateVertexTooltip(a,G.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),s}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case F.NONE:break;case F.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case F.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(F.NONE)}}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=Ce.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=y.reshapeManipulators.vertex.size/2+y.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=Ce.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=y.reshapeManipulators.edge.size/2+y.reshapeManipulators.edge.collisionPadding,t.elevationInfo=i.mode!=="on-the-ground"||Qs(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>this._onGrabStateChanged(t,e,i.action,i.pointerType))}_onGrabStateChanged(t,e,i,a="mouse"){if(i==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(F.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(s=>{s.manipulator.interactive=!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in s&&(s.edgeManipulator.interactive=!this._numGrabbing)}),R(this._graphicMoveManipulation).forEachManipulator(s=>s.interactive=!this._numGrabbing))}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(t.manipulator.grabbing&&this._onGrabStateChanged(t.manipulator,!1,"end"),this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(!t)return;const e=R(this._editGeometryOperations);if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,vi),t.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(c(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const s=i.location,n=a.location,r=.5,o=s.x+r*(n.x-s.x),l=s.y+r*(n.y-s.y),d=s.hasZ&&n.hasZ?0:void 0;t.manipulator.location=Wi(o,l,d,e.data.spatialReference)}else yt(sa,i.renderLocation,a.renderLocation,.5),t.manipulator.renderLocation=sa}}_splitEdgeManipulator(t,e=.5){const i=R(this._editGeometryOperations),a=R(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const s=X(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(a)):(n=t,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this.enableEdgeOffset||this._updateTranslateVertexTooltip(n.manipulator,G.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(F.RESHAPING),o=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:R(a.index)}],added:o}),r&&this._updateEventState(F.NONE),n}_updateMoveManipulationPosition(){const t=Z(sa,0,0,0);let e=0,i=!1,a=null,s=null;for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected?(e++,z(t,t,n.manipulator.renderLocation),m(a)||n.selectedIndex>a.selectedIndex?(s=a,a=n):(m(s)||n.selectedIndex>s.selectedIndex)&&(s=n)):i=!0);if(e!==0){const n=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.zManipulation.available=n&&this.enableZVertex&&zt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n&&e!==1}else{const n=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n,this._moveManipulation.zManipulation.available=n&&this.enableZShape&&zt(this.graphic)}if(e!==0){let n=0;if(c(a)){const r=a.handle.pos,o=c(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=m(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;o&&l?this._moveManipulation.xyAxisManipulation.available=!1:o?n=sr(o,r):l&&(n=sr(r,l))}this._moveManipulation.angle=n,this._moveManipulation.radius=go}else this._moveManipulation.angleDeferred=()=>yo(R(this.graphic.geometry)),this._moveManipulation.radius=Nt.radiusForSymbol(this.graphic.symbol);e!==0&&i?(Q(t,t,1/e),vi.spatialReference=R(this._editGeometryOperations).data.spatialReference,vi.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,vi),this._moveManipulation.elevationAlignedLocation=vi):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:ho(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],i=R(this._editGeometryOperations);for(const a of t)if(a.type==="vertex"&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const s=R(i.removeVertices([a.handle]).removedVertices[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(e.length>0){const a=e.map(n=>{const r=i.data.components.indexOf(n.component);return{coordinates:i.data.coordinateHelper.vectorToArray(n.pos),componentIndex:r,vertexIndex:R(n.index)}});this.outputGeometry=i.data.geometry;const s=this._updateEventState(F.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(n=>n.coordinates),vertices:a}),this.destroyed)||s&&(this._updateEventState(F.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=e.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS){const a=R(this._editGeometryOperations);a.moveVertices(t.map(s=>s.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const s of t)this._updateManipulatorPosition(s)}_offsetEdge(t,e){if(m(e.operation)||m(e.signedDistance))return;const i=R(this._editGeometryOperations),a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Js.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Js.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const a=t===G.Z,s=a?new Ge({tooltipOptions:i}):new Ae({tooltipOptions:i});if(c(e)&&e.action!=="end"){const{mapStart:n,mapEnd:r}=e,o=a?Ma(n,r):Ai(n,r,this._graphicState.isDraped?"on-the-ground":"absolute-height");s.distance=c(o)?o:wt}this._tooltip.info=s}_updateTranslateVertexTooltip(t,e,i){const a=this._tooltipOptions;if(!a.enabled)return;const s=e===G.Z,n=new mt({tooltipOptions:a});if(c(i)&&i.action!=="end"){const{mapStart:l,mapEnd:d}=i,p=s?Ma(l,d):Ai(l,d,this._graphicState.isDraped?"on-the-ground":"absolute-height");n.distance=c(p)?p:wt}const r=Cl(t.elevationAlignedLocation);c(r)&&(n.elevation={mode:"absolute-height",...r});const{geometry:o}=this.graphic;c(o)&&!s&&(n.area=o.type==="polygon"?Ll(o,this._graphicState.isDraped):null,n.totalLength=o.type==="polyline"?Il(o,this._graphicState.isDraped?"on-the-ground":"absolute-height"):null),this._tooltip.info=n}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function sr(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function Gd(t,e,i,a,s){if(t){const n=s.toXYZ(s.pointToVector(i)),r=jl(a,n,M.get()),o=Gl(r,n,s.spatialReference);if(c(o))return Ti(o.value*Math.sign(e),o.unit)}return Ti(e*os(i.spatialReference),"meters")}h([_()],J.prototype,"_segmentLabels",void 0),h([_({constructOnly:!0})],J.prototype,"tool",void 0),h([_()],J.prototype,"_tooltip",void 0),h([_()],J.prototype,"inputGeometry",null),h([_()],J.prototype,"outputGeometry",void 0),h([_({readOnly:!0})],J.prototype,"updating",null),h([_()],J.prototype,"manipulators",null),h([_()],J.prototype,"view",null),h([_()],J.prototype,"graphic",null),h([_()],J.prototype,"enableZShape",null),h([_()],J.prototype,"enableZVertex",null),h([_()],J.prototype,"enableMoveGraphic",null),h([_()],J.prototype,"enableMidpoints",null),h([_()],J.prototype,"enableEdgeOffset",null),h([_()],J.prototype,"_labelOptions",null),h([_()],J.prototype,"_tooltipOptions",null),J=h([B("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],J);const vi=Wi(0,0,null,null),sa=b();var Ce,F,Kt;(function(t){t.Vertex=ae.Custom1,t.Edge=ae.Custom2})(Ce||(Ce={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(F||(F={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Kt||(Kt={}));let ie=class extends Xe.EventedMixin(Ra){constructor(t){super(t),this._handles=new ot,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Pa,this.tooltipOptions=new Qe,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new J({tool:this});this.own([t.on("reshape",e=>{e.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",e)}),t.on("move",e=>{e.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",e)}),t.on("vertex-add",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)}),t.on("vertex-remove",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)}),t.on("immediate-click",e=>this.emit("immediate-click",e)),this.view.on("pointer-down",["Shift"],e=>{e.stopPropagation()}),L(()=>this.graphic,()=>this._updateGraphic(),Es)]),this.finishToolCreation()}destroy(){this._handles=k(this._handles),this._reshapeOperation=k(this._reshapeOperation)}get updating(){var t,e;return(e=(t=this._reshapeOperation)==null?void 0:t.updating)!=null?e:!1}_updateGeometry(){const t=ol(this.graphic);this._reshapeOperation.inputGeometry=c(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),ll(this.graphic)!==Dr.SUPPORTED)return;const t=L(()=>{var e;return(e=this.graphic)==null?void 0:e.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},ya);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){m(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){var t;return(t=this._reshapeOperation.canUndo)!=null?t:!1}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t;return(t=this._reshapeOperation.canRedo)!=null?t:!1}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([_()],ie.prototype,"_reshapeOperation",void 0),h([_({constructOnly:!0,nonNullable:!0})],ie.prototype,"view",void 0),h([_({constructOnly:!0})],ie.prototype,"graphic",void 0),h([_({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableZShape",void 0),h([_({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableZVertex",void 0),h([_({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableMoveGraphic",void 0),h([_({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableMidpoints",void 0),h([_({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableEdgeOffset",void 0),h([_()],ie.prototype,"type",void 0),h([_({constructOnly:!0,type:Pa})],ie.prototype,"labelOptions",void 0),h([_({constructOnly:!0,type:Qe})],ie.prototype,"tooltipOptions",void 0),h([_({constructOnly:!0})],ie.prototype,"snappingManager",void 0),h([_()],ie.prototype,"updating",null),h([_()],ie.prototype,"automaticManipulatorSelection",void 0),ie=h([B("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],ie);let Ke=class extends lt{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};h([_()],Ke.prototype,"type",void 0),h([_()],Ke.prototype,"rotation",void 0),h([_()],Ke.prototype,"rotationPrecision",void 0),h([_()],Ke.prototype,"orientation",void 0),h([_()],Ke.prototype,"orientationPrecision",void 0),h([_()],Ke.prototype,"rotationType",void 0),Ke=h([B("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],Ke);let ft=class extends lt{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};h([_()],ft.prototype,"type",void 0),h([_()],ft.prototype,"scale",void 0),h([_()],ft.prototype,"size",void 0),h([_()],ft.prototype,"sizeUnit",void 0),h([_()],ft.prototype,"sizePrecision",void 0),ft=h([B("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],ft);let Se=class extends lt{constructor(t){super(t),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};h([_()],Se.prototype,"type",void 0),h([_()],Se.prototype,"orientation",void 0),h([_()],Se.prototype,"orientationEnabled",void 0),h([_()],Se.prototype,"orientationPrecision",void 0),h([_()],Se.prototype,"rotationType",void 0),h([_()],Se.prototype,"size",void 0),h([_()],Se.prototype,"sizeUnit",void 0),h([_()],Se.prototype,"sizeEnabled",void 0),h([_()],Se.prototype,"sizePrecision",void 0),Se=h([B("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Se);var I,oi;(function(t){t.ScaleIn=ae.Custom2,t.ScaleOut=ae.Custom3,t.RotateLeft=ae.Custom4,t.RotateRight=ae.Custom5,t.Unlocked=ae.Custom7,t.DelayedFocused=ae.Custom8,t.TouchInput=ae.Custom12})(I||(I={}));class Vd{constructor({adapter:e,tooltipOptions:i,mode:a,tool:s}){this.mode=null,this._handles=new ot,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new Xe,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this.adapter.scale:1,this.tool=s,this.mode=a,this.adapter=e,this._tooltipOptions=i,this._tooltip=new zi({view:s.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(si(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),je))}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this._ringManipulator.location=e}set elevationAlignedLocation(e){this._ringManipulator.elevationAlignedLocation=e}get grabbing(){return this._ringManipulator.grabbing}set interactive(e){this._ringManipulator.interactive=e}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=k(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=k(this._tooltip)}startAnimation(e){this.cancelActiveAnimation(),e.start();const i=hl({update:({deltaTime:a})=>{e.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:i}}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=k(this._activeAnimation))}forEachManipulator(e){e(this._ringManipulator,C.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const i=this.tool.graphicState.graphic,a=ze(e,(s,n,r)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),l={mode:"none",origin:ua(s.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const d=M.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(s.renderLocation,d),n.next(Ta(this.tool.view,kt(s.renderLocation,d,hi()))).next(p=>{const u=Fi(p.plane),g=oo(p.renderStart,p.renderEnd,l.origin,u),v=cl.shortestSignedDiff(l.angle,g);l.angleDir=_a(l.angleDir+v,-Zn,Zn),l.angle=g;const f=zd(l,p),S=f-this.adapter.scale;if(l.scaleDir=_a(l.scaleDir+S,-Wn,Wn),this._onScaleChanged(),l.mode==="none"){const w=this.mode||Nd(p,p.plane,l.origin,this.tool.view.state.camera);if(c(w)){switch(w){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}l.mode=w}}switch(l.mode){case"rotate":o.state.angle=l.initialAngle+g;break;case"scale":o.state.scale=f,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),p.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:Oi(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:f,yScale:f})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:Oi(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:f,yScale:f})}}return p.action==="end"&&(this.startAnimation(nr(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),o.done()),p}).next(this._updateTooltipPipelineStep(l)),r.next(()=>{if(o.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(nr(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,e.events.on("focus-changed",s=>{s.action==="focus"?this.startAnimation(Fd(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),e.events.on("immediate-click",s=>{s.stopPropagation()}),L(()=>{var s;return(s=this.tool.graphicState)==null?void 0:s.displaying},s=>this._ringManipulator.available=s,je)])}_updateTooltipPipelineStep(e){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const s=this._tooltip,n=this._tooltipOptions.visualVariables,r=c(n)?n.size:null,o=c(n)?n.rotation:null;switch(e.mode){case"scale":s.info=new ft({tooltipOptions:a,scale:{value:this.adapter.scale},size:Ti(W(this.adapter.size,-1),"meters"),sizeUnit:c(r)?r.unit:null,sizePrecision:c(r)?ra(r.valueType):null});break;case"rotate":{const l=c(o)?ra(o.valueType):null,d=c(o)?o.rotationType:"geographic";s.info=new Ke({tooltipOptions:a,rotation:Ha(W(-this.adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:Ha(-this.adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:d})}}return i}}_updateFocusTooltip(){if(!!this._tooltipOptions.enabled)if(this.getFocused()){const e=this._tooltipOptions.visualVariables,i=c(e)?e.rotation:null,a=c(e)?e.size:null;this._tooltip.info=new Se({tooltipOptions:this._tooltipOptions,orientation:Ha(-this.adapter.angle,"radians","geographic"),orientationEnabled:this.mode==null||this.mode==="rotate",orientationPrecision:c(i)?ra(i.valueType):null,rotationType:c(i)?i.rotationType:"geographic",size:Ti(W(this.adapter.size,-1),"meters"),sizeUnit:c(a)?a.unit:null,sizeEnabled:this.mode==null||this.mode==="scale",sizePrecision:c(a)?ra(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(I.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(I.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(I.ScaleIn|I.ScaleOut,!1),this._ringManipulator.updateStateEnabled(I.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(I.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(I.RotateLeft|I.RotateRight,!1),this._ringManipulator.updateStateEnabled(I.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(I.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(I.ScaleIn|I.ScaleOut|I.RotateLeft|I.RotateRight,!1)}_updateManipulatorTransform(){const e=Ar(se.get(),this.adapter.angle,N(0,0,1));if(m(e))return;const i=this.getScale(),a=va(se.get(),Z(M.get(),i,i,i));this._ringManipulator.modelTransform=Ye(se.get(),a,e)}_createRingManipulator(){const e=(Y,Fe,ct)=>{const dt=[],pt=Math.ceil(po*(Fe-Y)/(2*Math.PI));for(let oe=0;oe<pt+1;oe++){const di=Y+oe*(Fe-Y)/pt;dt.push(N(ct*Math.cos(di),ct*Math.sin(di),0))}return dt},i=Y=>e(0,2*Math.PI,Y),a=Y=>[[-Y/2,0],[Y/2,0],[Y/2,Za/2],[-Y/2,Za/2]],s=(Y,Fe)=>V.createPathExtrusionGeometry(a(Fe),Y,[],[],!1),n=i($t),r=s(n,Xa),o={left:[],right:[]},l=[];for(let Y=0;Y<2;Y++){const Fe=Y*Math.PI-Math.PI/4,ct=Math.PI/2-gd,dt=Fe+ct,pt=Fe+Math.PI/2-ct,oe=e(dt,pt,dd),di=s(oe,Yt);l.push(oe),l.push(e(dt,pt,Hn-Xa/2)),o.left.push(di),o.right.push(di);for(let ka=0;ka<2;ka++){const ks=ka===0,fe=_e();if(ks){Vi(fe,fe,[1,-1,1]),Ks(fe,fe,-dt,[0,0,1]);const Ot=Math.round(Bn*(oe.length-1));fe[12]=oe[Ot][0],fe[13]=oe[Ot][1],fe[14]=oe[Ot][2]}else{Ks(fe,fe,pt,[0,0,1]);const Ot=Math.round((1-Bn)*(oe.length-1));fe[12]=oe[Ot][0],fe[13]=oe[Ot][1],fe[14]=oe[Ot][2]}const Us=V.createExtrudedTriangle(pd,0,ud,Za);V.transformInPlace(Us,fe),(ks?o.left:o.right).push(Us)}}const d=[];for(let Y=0;Y<2;Y++){const Fe=Y*Math.PI-Math.PI/4,ct=Math.PI/2-_d,dt=Fe+ct,pt=Fe+Math.PI/2-ct,oe=e(dt,pt,Hn);d.push(s(oe,Yt))}const p=i($t+qn),u=i($t+Yn),g=s(p,Yt),v=s(u,Yt),f=i($t-qn),S=i($t-Yn),w=s(f,Yt),x=s(S,Yt),O=this._createMaterial(),H=this._createMaterial(.66),de=this._createMaterial(.5),ht=this._createMaterial(.33);let me=[{geometry:r,material:O,stateMask:I.DelayedFocused},{geometry:r,material:de,stateMask:E.None}];this.mode&&this.mode!=="scale"||(me=me.concat([{geometry:d,material:O,stateMask:I.DelayedFocused|I.Unlocked},{geometry:g,material:H,stateMask:I.DelayedFocused|I.ScaleIn},{geometry:v,material:ht,stateMask:I.DelayedFocused|I.ScaleIn},{geometry:w,material:H,stateMask:I.DelayedFocused|I.ScaleOut},{geometry:x,material:ht,stateMask:I.DelayedFocused|I.ScaleOut}])),this.mode&&this.mode!=="rotate"||(me=me.concat([{geometry:o.right,material:O,stateMask:I.DelayedFocused|I.Unlocked},{geometry:o.left,material:O,stateMask:I.DelayedFocused|I.RotateLeft},{geometry:o.right,material:O,stateMask:I.DelayedFocused|I.RotateRight}]));const Et=[n,...l];return new ce({view:this.tool.view,renderObjects:me,autoScaleRenderObjects:!1,worldOriented:!0,radius:Xa,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:X(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:Et,direction:N(0,0,1)}})}_createMaterial(e=1){const i=xt([...od,e]);return new Be({color:i,transparent:e!==1,cullFace:K.Back,renderOccluded:D.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function zd(t,e){const i=P(M.get(),e.renderStart,t.origin),a=P(M.get(),e.renderEnd,t.origin),s=Te(i),n=Te(a);return s===0?0:n/s}function Nd(t,e,i,a){const{renderStart:s,renderEnd:n}=t,r=na(s,a,M.get()),o=na(n,a,M.get());if(wr(r,o)<jn*jn)return null;const l=P(M.get(),s,i),d=Me(M.get(),l,Fi(e)),p=s,u=z(M.get(),p,d),g=na(i,a,M.get()),v=r,f=na(u,a,M.get()),S=P(M.get(),f,v),w=P(M.get(),r,g),x=hs(v,S),O=hs(g,w);return hn(x,o)<hn(O,o)?"rotate":"scale"}function na(t,e,i){return e.projectToScreen(t,Qa),Z(i,Qa[0],Qa[1],0)}function nr(t,e){let i=null,a=1;const s=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=s,e()},update:n=>(a+=((a+1)/2-a)*Math.min(n*fd,1),e(),Math.abs(a-1)<.01?oi.STOP:oi.CONTINUE),destroy:()=>{t.getScale=i,e()}}}function Fd(t,e){let i=0,a=null;const s=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=s,i=0,e()},update:n=>(i+=n,!a()||i>md?oi.STOP:oi.CONTINUE),destroy:()=>{t.getFocused=a,e()}}}function ra(t){switch(t){case"integer":case"long":return 0;default:return null}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(oi||(oi={}));const Qa=be();function bo(t){return c(t.geometry)&&t.geometry.type==="mesh"?kd(t.geometry):Ud(t)}function kd(t){return c(t.transform)?Hd(t,t.transform):jd(t)}function Ud(t){let e=t.geometry,i=dl;return{undo(a){i=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=i}}}function Hd(t,e){let i=e.clone(),a=null;return{undo:s=>{a=c(t.transform)?t.transform.clone():null,t.transform=i,s.notifyGeometryChanged()},redo:s=>{i=c(t.transform)?t.transform.clone():null,t.transform=a,s.notifyGeometryChanged()}}}function jd(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}let et=class extends Os{constructor(t){super(t),this.interactionState=null}initialize(){this.own([si(()=>c(this.interactionState)&&this.interactionState.angle!==this.interactionState.previousAngle?{interactionState:this.interactionState,angle:this.interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},ya),si(()=>c(this.interactionState)&&this.interactionState.scale!==this.interactionState.previousScale?{interactionState:this.interactionState,scale:this.interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},ya)])}get angle(){const t=this.geometry.transform;if(m(t))return 0;const e=Yh(t.rotation)[2];return Math.abs(e)>.999999?nt(Wh(t.rotation))*Math.sign(e):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}startInteraction(){const t=new tt({angle:this.angle});this.interactionState=t;const e=()=>this.interactionState=null;return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return bo(this.graphic)}_updateMeshRotation(t){const e=this.geometry.anchor,i=this.viewingMode===ls.Global,{angle:a,previousAngle:s}=t;this.geometry.rotate(0,0,Oi(a-s),{origin:e,geographic:i}),t.previousAngle=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const e=this.geometry.anchor,i=this.viewingMode===ls.Global,{scale:a,previousScale:s}=t;this.geometry.scale(a/s,{origin:e,geographic:i}),t.previousScale=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};h([_({constructOnly:!0})],et.prototype,"graphic",void 0),h([_({constructOnly:!0})],et.prototype,"geometry",void 0),h([_({constructOnly:!0})],et.prototype,"viewingMode",void 0),h([_()],et.prototype,"angle",null),h([_()],et.prototype,"scale",null),h([_()],et.prototype,"interactionState",void 0),et=h([B("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],et);let tt=class extends Ii{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}cancel(){this.angle=this.initialAngle,this.scale=1}};h([_()],tt.prototype,"angle",void 0),h([_()],tt.prototype,"initialAngle",void 0),h([_()],tt.prototype,"previousAngle",void 0),h([_()],tt.prototype,"previousScale",void 0),h([_()],tt.prototype,"scale",void 0),h([_()],tt.prototype,"state",null),tt=h([B("InteractionState")],tt);let le=class extends Os{constructor(t){super(t),this.sizeAxis=null,this.interactionState=null}initialize(){this.own(si(()=>c(this.interactionState)?this.interactionState.state:null,t=>{this._updateSymbol(t)},ya))}get angle(){return c(this.interactionState)?this.interactionState.angle:c(this._orientationReferenceSymbolLayer)?Bd(this._orientationReferenceSymbolLayer.heading):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return c(this.interactionState)?this.interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(m(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(m(e)||m(i)||i.type!=="point-3d")return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&c(a.size))return a.size;const s=this.sizeAxis;return"width"in a&&c(a.width)&&(m(s)||s==="width"||s==="all"||s==="width-and-depth")?a.width:"depth"in a&&c(t.depth)&&(m(s)||s==="depth"||s==="all"||s==="width-and-depth")?a.depth:"height"in a&&c(t.height)&&(m(s)||s==="height"||s==="all")?a.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return m(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return m(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&c(e.heading))}get _graphicSymbol(){return c(this.graphic)&&c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(c(this.interactionState)||m(t)||m(e))return qd;const i=t.symbolLayers.map(o=>o.type==="object"?e.getSymbolLayerSize(t,o):null).toArray(),a=t.clone(),s=this.angle,n=new it({originalSymbol:a,angle:s,initialSizes:i});this.interactionState=n;const r=()=>this.interactionState=null;return{state:n,done:r,cancel:()=>{this._graphicSymbol=a,r()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const s=this._graphicSymbol;if(m(s)||s.type!=="point-3d")return;const n=s.clone(),r=-Oi(e-this.initialAngle);let o=!1;this._forEachObjectSymbolLayerPair(i,n,(l,d,p)=>{const u=W(l.heading,0)+r;d.heading!==u&&(d.heading=u,o=!0);const g=a[p];if(c(g)&&"width"in g){g.width=this.sizeFilter(g.width),g.height=this.sizeFilter(g.height),g.depth=this.sizeFilter(g.depth);const v=g.width*t;d.width!==v&&(d.width=v,o=!0);const f=g.depth*t;d.depth!==f&&(d.depth=f,o=!0);const S=g.height*t;d.height!==S&&(d.height=S,o=!0)}}),o&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((a,s)=>{const n=e.symbolLayers.getItemAt(s);a.type==="object"&&n.type==="object"&&i(a,n,s)})}};function Bd(t){return-nt(t)}h([_()],le.prototype,"angle",null),h([_()],le.prototype,"scale",null),h([_()],le.prototype,"relativeAngle",null),h([_()],le.prototype,"initialAngle",null),h([_()],le.prototype,"size",null),h([_()],le.prototype,"sizeAxis",void 0),h([_({constructOnly:!0})],le.prototype,"graphic",void 0),h([_()],le.prototype,"interactionState",void 0),h([_({constructOnly:!0})],le.prototype,"findLayerView",void 0),h([_({constructOnly:!0})],le.prototype,"sizeFilter",void 0),h([_()],le.prototype,"_sizeReferenceSymbolLayer",null),h([_()],le.prototype,"_orientationReferenceSymbolLayer",null),h([_()],le.prototype,"_graphicSymbol",null),le=h([B("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],le);const qd={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let it=class extends Ii{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}}};h([_()],it.prototype,"originalSymbol",void 0),h([_()],it.prototype,"angle",void 0),h([_()],it.prototype,"initialAngle",void 0),h([_()],it.prototype,"initialSizes",void 0),h([_()],it.prototype,"scale",void 0),h([_()],it.prototype,"state",null),it=h([B("InteractionState")],it);let pe=class extends Rr(Xe.EventedMixin(Ra)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Qe,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new ba,this._tooltip=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new jt({graphic:t}),this.own(L(()=>this.tooltipOptions.enabled,a=>{this._tooltip=a?new zi({view:e}):k(this._tooltip)},Es)),this._moveManipulation=new Nt({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&zt(t),radius:Nt.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((a,s)=>this.handles.add([a.events.on("immediate-click",n=>{this.emit("immediate-click",{...n,graphic:t}),n.stopPropagation()}),a.events.on("focus-changed",({action:n})=>{const{tooltipOptions:r,_tooltip:o}=this;if(!m(o)&&(o.clear(),n==="focus")){const l=s===C.TRANSLATE_Z?Ge:Ae;o.info=new l({tooltipOptions:r})}})])),this._moveManipulation.elevationInfo=X(t);const i=t.geometry;if(this._moveManipulation.createGraphicDragPipeline((a,s,n,r,o)=>(c(i)&&a===G.XY&&(n=n.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new xa({elevationInfo:X(t),pointer:o,editGeometryOperations:$a.fromGeometry(new ti({spatialReference:i.spatialReference}),e.state.viewingMode),visualizer:new Di,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:r}),this._snappingPipeline.next)),n=n.next(l=>{const{tooltipOptions:d,_tooltip:p}=this;if(m(p))return l;const{mapStart:u,mapEnd:g}=l;p.clear();const v=a===G.Z?Ge:Ae;if(l.action==="end")p.info=new v({tooltipOptions:d});else{const f=a===G.Z?Ma(u,g):Ai(u,g,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(f)&&(p.info=new v({tooltipOptions:d,distance:f}))}return l})),this.graphicState,a=>{const{action:s,graphic:n,dxScreen:r,dyScreen:o}=a,l={graphic:n,dxScreen:r,dyScreen:o};switch(s){case"start":this.emit("graphic-translate-start",l),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",l);break;case"end":this.emit("graphic-translate-stop",l)}}),this._moveManipulation.angle=c(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(L(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const a=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Vd({tool:this,mode:a,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([Ga({view:this.view,graphic:this.graphic,forEachManipulator:a=>this._forEachManipulator(a),onManipulatorsChanged:()=>Gt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),L(()=>e.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(a=>{a instanceof ce&&this.handles.add(a.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=k(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=k(this._scaleRotate),this._scaleRotateAdapter=k(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){m(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new et({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new le({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer),sizeAxis:c(this.tooltipOptions.visualVariables)&&c(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),c(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return L(()=>this.graphicState.displaying,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&zt(this.graphic)})}_createGeometryUndoRecord(){return bo(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,c(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,c(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){c(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(m(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===ls.Local||this.view.scale<vd?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){ho(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([_({constructOnly:!0,nonNullable:!0})],pe.prototype,"view",void 0),h([_({constructOnly:!0,nonNullable:!0})],pe.prototype,"graphic",void 0),h([_({constructOnly:!0,nonNullable:!0})],pe.prototype,"enableZ",void 0),h([_()],pe.prototype,"enableRotation",void 0),h([_()],pe.prototype,"enableScaling",void 0),h([_({constructOnly:!0,type:Qe})],pe.prototype,"tooltipOptions",void 0),h([_()],pe.prototype,"graphicState",void 0),h([_({value:!1})],pe.prototype,"snapToScene",null),h([_({constructOnly:!0})],pe.prototype,"snappingManager",void 0),h([_({readOnly:!0})],pe.prototype,"type",void 0),h([_({readOnly:!0})],pe.prototype,"updating",null),pe=h([B("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],pe);let _t=class extends pl(gl){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&ul(this.position,t.position)&&this.width===t.width&&this.height===t.height}};h([_({readOnly:!0,json:{read:!1,write:!0}})],_t.prototype,"type",void 0),h([_({type:ti}),ui()],_t.prototype,"position",void 0),h([_({type:Number,nonNullable:!0,range:{min:0,max:360}}),ui(),en(t=>tn.normalize(an(t),0,!0))],_t.prototype,"heading",void 0),h([_({type:Number,nonNullable:!0,range:{min:0,max:360}}),ui(),en(t=>tn.normalize(an(t),0,!0))],_t.prototype,"tilt",void 0),h([_({type:Number,nonNullable:!0}),ui()],_t.prototype,"width",void 0),h([_({type:Number,nonNullable:!0}),ui()],_t.prototype,"height",void 0),_t=h([B("esri.analysis.SlicePlane")],_t);Pr("mac");const Yd=2,Wd=1.15,Zd=1.15,Xd=1.1,Qd=.7,ci=N(1,.5,0);xt([...ci,Qd]);xt([...ci,.5]);const Jd=xt([...ci,1]),Kd=rt(1,1,1,1),ep=rt(1,.8,.6,1),tp=rt(1,.93,.86,1),ip=xt([...ci,1]),ap=xt([...ci,1]),sp=3,rr=11,np=22.5,Ja=40,or=48,rp=2.25,op=xt([...ci,1]),lp=4,lr=1,hp=.3,cp=6,dp=4,hr=12,pp=40,up=27;function gp(t){const e=new ki;return e.extensions.add("GL_OES_standard_derivatives"),Ps(e,t),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add($`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add([new wa("backgroundColor",i=>i.backgroundColor),new wa("gridColor",i=>i.gridColor),new Ee("gridWidth",i=>i.gridWidth)]),e.fragment.code.add($`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}const _p=Object.freeze(Object.defineProperty({__proto__:null,build:gp},Symbol.toStringTag,{value:"Module"}));class Fs extends Ui{initializeProgram(e){const i=Fs.shader.get().build(this.configuration);return new Hi(e.rctx,i,Ts)}initializePipeline(){return qi({blending:Ph(qe.ONE,qe.ONE,qe.ONE_MINUS_SRC_ALPHA,qe.ONE_MINUS_SRC_ALPHA),depthTest:{func:la.LESS},colorWrite:Yi})}}Fs.shader=new ji(_p,()=>Gi(()=>import("./SlicePlaneMaterial.glsl.17ecbe56.js"),["assets/SlicePlaneMaterial.glsl.17ecbe56.js","assets/Matrix4Uniform.9e24b035.js","assets/index.52935b46.js","assets/index.be38f7b7.css","assets/enums.de935fa5.js","assets/Texture.7634927e.js","assets/requestImageUtils.16628477.js","assets/Util.221caaac.js","assets/geometryDataUtils.8151b70d.js","assets/triangle.4a12653d.js","assets/vectorStacks.a7af424f.js","assets/quatf64.b60d4974.js","assets/mat4f64.84d5c445.js","assets/lineSegment.42c0099b.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.b7add78f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.43fc091d.js","assets/quat.122fba57.js","assets/vec3f32.0772c8d8.js","assets/sphere.fe54e1ae.js","assets/drawSurfaces.7da3d09c.js","assets/geometryEngine.938806be.js","assets/geometryEngineBase.cf4f989f.js","assets/hydrated.54675f53.js","assets/SnappingContext.6035d506.js","assets/PointSnappingHint.735dac09.js","assets/plane.1ed71234.js","assets/drawUtils.b3864c8e.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.5573332f.js","assets/vec4f32.8f10672a.js","assets/Octree.74aeccc1.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.b5350ce1.js","assets/types.25c129c5.js","assets/NativeLineMaterial.b0f0cd6a.js","assets/floatRGBA.5328f61e.js","assets/triangulationUtils.b0bb3487.js","assets/deduplicate.ee0b1de6.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.d7d86859.js","assets/GraphicManipulator.6d798ed3.js","assets/axisAngleDegrees.b0e51c69.js","assets/persistable.eb01740e.js","assets/multiOriginJSONSupportUtils.8128aa52.js"]));function mp(t){const e=new ki;Ps(e,t),e.include(Hr),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2"),e.varyings.add("vpos","vec3"),t.hasMultipassTerrain&&e.varyings.add("depth","float");const{vertex:i,fragment:a}=e;return i.uniforms.add(new Lt("textureCoordinateScaleFactor",s=>c(s.texture)&&c(s.texture.descriptor.textureCoordinateScaleFactor)?s.texture.descriptor.textureCoordinateScaleFactor:_l)),i.code.add($`
    void main(void) {
      vpos = position;
      ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),e.include(jr,t),e.include(qr,t),a.uniforms.add([new Fr("tex",s=>s.texture),new Ee("opacity",s=>s.opacity)]),e.varyings.add("vTexCoord","vec2"),t.output===q.Alpha?a.code.add($`
    void main() {
      discardBySlice(vpos);
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${$.float(cn)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(a.include(Br),a.code.add($`
    void main() {
      discardBySlice(vpos);
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${$.float(cn)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${t.transparencyPassType===Ze.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),e}const fp=Object.freeze(Object.defineProperty({__proto__:null,build:mp},Symbol.toStringTag,{value:"Module"}));class Na extends Ui{initializeProgram(e){const i=Na.shader.get().build(this.configuration);return new Hi(e.rctx,i,Ts)}_setPipelineState(e,i){const a=this.configuration,s=e===Ze.NONE,n=e===Ze.FrontFace;return qi({blending:a.output!==q.Color&&a.output!==q.Alpha||!a.transparent?null:s?vp:Jr(e),culling:Kr(a.cullFace),depthTest:{func:Rh(e)},depthWrite:s?a.writeDepth&&eo:to(e),colorWrite:Yi,stencilWrite:a.hasOccludees?sh:null,stencilTest:a.hasOccludees?i?nh:rh:null,polygonOffset:s||n?null:Dh(a.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}Na.shader=new ji(fp,()=>Gi(()=>import("./ImageMaterial.glsl.dd4b00a3.js"),["assets/ImageMaterial.glsl.dd4b00a3.js","assets/index.52935b46.js","assets/index.be38f7b7.css","assets/Matrix4Uniform.9e24b035.js","assets/enums.de935fa5.js","assets/Texture.7634927e.js","assets/requestImageUtils.16628477.js","assets/Util.221caaac.js","assets/geometryDataUtils.8151b70d.js","assets/triangle.4a12653d.js","assets/vectorStacks.a7af424f.js","assets/quatf64.b60d4974.js","assets/mat4f64.84d5c445.js","assets/lineSegment.42c0099b.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.b7add78f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.43fc091d.js","assets/quat.122fba57.js","assets/vec3f32.0772c8d8.js","assets/sphere.fe54e1ae.js","assets/drawSurfaces.7da3d09c.js","assets/geometryEngine.938806be.js","assets/geometryEngineBase.cf4f989f.js","assets/hydrated.54675f53.js","assets/SnappingContext.6035d506.js","assets/PointSnappingHint.735dac09.js","assets/plane.1ed71234.js","assets/drawUtils.b3864c8e.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.5573332f.js","assets/vec4f32.8f10672a.js","assets/Octree.74aeccc1.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.b5350ce1.js","assets/types.25c129c5.js","assets/NativeLineMaterial.b0f0cd6a.js","assets/floatRGBA.5328f61e.js","assets/triangulationUtils.b0bb3487.js","assets/deduplicate.ee0b1de6.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.d7d86859.js","assets/GraphicManipulator.6d798ed3.js","assets/axisAngleDegrees.b0e51c69.js","assets/persistable.eb01740e.js","assets/multiOriginJSONSupportUtils.8128aa52.js"]));const vp=Ls(qe.ONE,qe.ONE_MINUS_SRC_ALPHA);class $e extends Yr{constructor(){super(...arguments),this.output=q.Color,this.cullFace=K.None,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=Ze.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}h([U({count:q.COUNT})],$e.prototype,"output",void 0),h([U({count:K.COUNT})],$e.prototype,"cullFace",void 0),h([U()],$e.prototype,"hasSlicePlane",void 0),h([U()],$e.prototype,"transparent",void 0),h([U()],$e.prototype,"enableOffset",void 0),h([U()],$e.prototype,"writeDepth",void 0),h([U()],$e.prototype,"hasOccludees",void 0),h([U({count:Ze.COUNT})],$e.prototype,"transparencyPassType",void 0),h([U()],$e.prototype,"hasMultipassTerrain",void 0),h([U()],$e.prototype,"cullAboveGround",void 0);class yp extends Wr{constructor(e){super(e,new Mp),this.supportsEdges=!0,this.techniqueConfig=new $e}getConfiguration(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<$h,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(e,i,a,s,n,r,o){ps(e,i,s,n,r,void 0,o)}requiresSlot(e,i){return e===Oe.DRAPED_MATERIAL?!0:Xr(i)===q.Highlight?e===Oe.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?Oe.TRANSPARENT_MATERIAL:Oe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Oe.OPAQUE_MATERIAL)}createGLMaterial(e){return e.output===q.Color||e.output===q.Alpha||e.output===q.Highlight?new bp(e):void 0}createBufferWriter(){return new xh(Eh)}}class bp extends oh{constructor(e){super({...e,...e.material.parameters})}_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(Na,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:e.hasOccludees}),this._updateParameters(e))}beginSlot(e){return this._output!==q.Color&&this._output!==q.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class Mp extends Zr{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=K.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0}}ml.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Sp(t,e){return lo(t.basis1,t.basis2,t.origin,e)}function wp(t,e,i,a){const s=e.worldUpAtPosition(t.origin,M.get()),n=M.get();switch(i){case Ci.HEADING:j(n,s);break;case Ci.TILT:j(n,t.basis1)}return kt(t.origin,n,a)}function xp(t,e,i,a){const s=Te(a.basis1),n=Te(a.basis2),r=Mo(a),o=ys(a),l=Z(M.get(),0,0,0);z(l,Q(M.get(),a.basis1,e.direction[0]),Q(M.get(),a.basis2,e.direction[1])),z(l,a.origin,l);let d=0,p=1;if(Fa(e))e.direction[0]===1&&e.direction[1]===-1?d=Ms:e.direction[0]===1&&e.direction[1]===1?d=Math.PI:e.direction[0]===-1&&e.direction[1]===1&&(d=3*Math.PI/2),p=o;else{const g=e.direction[0]!==0?1:2;d=g===1?Ms:0,p=(g===1?n:s)-r}const u=xs(se.get(),d);Vi(u,u,Z(M.get(),p,p,p)),Ye(u,i,u),u[12]=0,u[13]=0,u[14]=0,t.modelTransform=u,t.renderLocation=l}function Ep(t,e,i,a){const s=a.worldUpAtPosition(i.origin,M.get()),n=Op(i,It.POSITIVE_X),r=xs(se.get(),n.edge*Math.PI/2);Tr(r,r,-Cp(i,s)),Ye(r,e,r),r[12]=0,r[13]=0,r[14]=0,t.modelTransform=r,t.renderLocation=n.position}var It;function Op(t,e){switch(e){case It.POSITIVE_X:return{basis:t.basis1,direction:1,position:z(M.get(),t.origin,t.basis1),edge:e};case It.POSITIVE_Y:return{basis:t.basis2,direction:1,position:z(M.get(),t.origin,t.basis2),edge:e};case It.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:P(M.get(),t.origin,t.basis1),edge:e};case It.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:P(M.get(),t.origin,t.basis2),edge:e}}}function Mo(t){const e=Te(t.basis1),i=Te(t.basis2);return hp*Math.min(e,i)}function ys(t){return Mo(t)}function Fa(t){return t.direction[0]!==0&&t.direction[1]!==0}function Ap(t,e=Li.CENTER_ON_ARROW){const i=e===Li.CENTER_ON_CALLOUT?Ja:0,a=[N(i,0,-or/2),N(i,0,or/2)],s=$p(a,!0),n=(S,w)=>Rp(a,a,{tubeRadius:sp,tipRadius:rr,tipLength:np,tubeFocusMultiplier:Wd,tipFocusMultiplier:Zd,padding:S,bothEnds:!0,flat:null,focusTipLength:!0,addCap:w}),r=n(0,!1),o=n(rp,!0),l=new Be({color:Kd,cullFace:K.Back,renderOccluded:D.Opaque}),d=new Be({color:ep,cullFace:K.Back,renderOccluded:D.Opaque}),p=new Be({color:tp,cullFace:K.Back,renderOccluded:D.Opaque}),u=new Be({color:ap,transparent:!0,writeDepth:!1,cullFace:K.Front,renderOccluded:D.Transparent}),g=V.createPolylineGeometry([[i,0,0],[i-Ja,0,0]]),v=V.createPolylineGeometry([[i,0,0],[i-Ja,0,0]]),f=new Cs({color:ip,renderOccluded:D.OccludeAndTransparent});return new ce({view:t,renderObjects:[...r.normal.map(({part:S,geometry:w,transform:x})=>({geometry:w,material:S==="tip"?l:S==="cap"?d:p,transform:x,stateMask:E.Unfocused|we})),...o.normal.map(({geometry:S,transform:w})=>({geometry:S,material:u,transform:w,stateMask:E.Unfocused|we})),{geometry:g,material:f,stateMask:E.Unfocused|we|bs},...r.focused.map(({part:S,geometry:w,transform:x})=>({geometry:w,material:S==="tip"?l:S==="cap"?d:p,transform:x,stateMask:E.Focused|we})),...o.focused.map(({geometry:S,transform:w})=>({geometry:S,material:u,transform:w,stateMask:E.Focused|we})),{geometry:v,material:f,stateMask:E.Focused|we|bs}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:rr,state:we})}function Tp(t,e){const i=new yp({transparent:!0,writeDepth:!1,textureId:e.id,renderOccluded:D.Opaque}),a=pp,s=up,n=s*Xd,r=u=>{const g=new Uint32Array([0,1,2,2,3,0]);return new Ur([[A.POSITION,{size:3,data:[a-u,-u,0,a+u,-u,0,a+u,u,0,a-u,u,0],exclusive:!0}],[A.UV0,{size:2,data:[0,0,1,0,1,1,0,1]}]],[[A.POSITION,g],[A.UV0,g]])},o=V.createPolylineGeometry([[0,0,0],[a-s,0,0]]),l=V.createPolylineGeometry([[0,0,0],[a-n,0,0]]),d=new Cs({color:Jd,renderOccluded:D.OccludeAndTransparent}),p=[{geometry:r(s),material:i,stateMask:E.Unfocused|we},{geometry:o,material:d,stateMask:E.Unfocused|we},{geometry:r(n),material:i,stateMask:E.Focused|we},{geometry:l,material:d,stateMask:E.Focused|we}];return new ce({view:t,renderObjects:p,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},collisionPriority:1,radius:s/2,state:we})}function Pp(t,e){const i=Fa(e),a=i?[N(1,0,0),N(0,0,0),N(0,1,0)]:[N(1,0,0),N(-1,0,0)],s=V.createPolylineGeometry(a),n=op,r=f=>new ri({color:n,width:f,renderOccluded:D.OccludeAndTransparent}),o=()=>new Cs({color:n,renderOccluded:D.OccludeAndTransparent}),l=i?lp:lr,d=l*Yd,p=lr,u=f=>f>1?r(f):o(),g=[{geometry:s,material:u(l),stateMask:E.Unfocused|ha},{geometry:s,material:u(d),stateMask:E.Focused|ha},{geometry:s,material:u(p),stateMask:So}],v=new ce({view:t,renderObjects:g,collisionType:{type:"line",paths:[a]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?cp:dp});return v.state=ha,v}function Rp(t,e,i){const a=s=>{const n=(s?e:t).slice(0),r=P(M.get(),n[0],n[1]);re(r,r);const o=P(M.get(),n[n.length-1],n[n.length-2]);if(re(o,o),i.padding>0){const O=Q(b(),o,-i.padding);if(n[n.length-1]=z(O,O,n[n.length-1]),i.bothEnds){const H=Q(b(),r,-i.padding);n[0]=z(H,H,n[0])}}const l=s?i.tipFocusMultiplier:1,d=i.tipLength*(i.focusTipLength?l:1),p=i.tipRadius*l,u=rs(se.get());if(i.padding>0){const O=d/4,H=Z(M.get(),0,O,0),de=1+i.padding/O;pa(u,u,H),Vi(u,u,Z(M.get(),de,de,de)),pa(u,u,Q(H,H,-1/de))}const g=rs(_e()),v=N(0,1,0),f=sn(_e(),vn(_n.get(),v,o));f[12]=n[n.length-1][0],f[13]=n[n.length-1][1],f[14]=n[n.length-1][2],Ye(f,f,u);const S=[{part:"tube",geometry:Dp(i.tubeRadius*(s?i.tubeFocusMultiplier:1)+i.padding,i.flat,n),transform:g}];let w,x;if(c(i.flat)?w=V.createExtrudedTriangle(d,p,p,i.flat.thickness):(w=V.createConeGeometry(d,p,24,!1,!1,!0),x=V.createConeGeometry(d,p,24,!1,!0,!1)),S.push({part:"tip",geometry:w,transform:f}),x&&S.push({part:"cap",geometry:x,transform:f}),i.bothEnds){const O=sn(_e(),vn(_n.get(),v,r));O[12]=n[0][0],O[13]=n[0][1],O[14]=n[0][2],Ye(O,O,u),S.push({part:"tip",geometry:w,transform:O}),x&&S.push({part:"cap",geometry:x,transform:O})}return S};return{normal:a(!1),focused:a(!0)}}function Dp(t,e,i){const a=[];if(c(e))a.push([t,e.thickness/2],[-t,e.thickness/2],[-t,-e.thickness/2],[t,-e.thickness/2]);else for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*t,Math.sin(r)*t])}return V.createPathExtrusionGeometry(a,i,[],[],!1)}function $p(t,e){const i=P(b(),t[t.length-1],t[t.length-2]);if(re(i,i),Q(i,i,hr),z(i,i,t[t.length-1]),e){const a=P(b(),t[0],t[1]);return re(a,a),Q(a,a,hr),z(a,a,t[0]),[a,...t,i]}return[...t,i]}function Cp(t,e){return Hl(e,t.basis2,t.basis1)+Ms}(function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"})(It||(It={}));const we=ae.Custom1;var Ci,cr;(function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"})(Ci||(Ci={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(cr||(cr={}));const bs=ae.Custom2;Ni();const Ms=Math.PI/2,ha=ae.Custom1,So=ae.Custom2;var Li;(function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Li||(Li={}));const dr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAnFBMVEUAAAD/gAD/gAD/cAD/gAD/eAD/gAD/eQD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fAD/gAD/fAD/fQD/fQD/fQD/fQD/fQD/fgD/jR7/mjn/mjf/p1H/plH/smf/sWb/vHr/u3n/xYz/xIv/zZz/zJv/zJr/1Kv/1Kr/06r/06n/27n/27f/4cX/4cT/59D/7dr/8uX/9u7/+/f////u2EN0AAAAM3RSTlMACBAQICAoKDAwODhAQEhIUFBYYGhweICIkJCXmJ+gp6ivsLe4uL+/wMDHx8/P19/n7/cWvjXwAAACeUlEQVR42tWX3XqiMBCGY2pbtbrUnzhhdak/lHWliJD7v7fdJ+KG5AMhh30P8zCTmS+TycDaeBoHi5Wgf4jVYvbKmRfPgSAHMX9mPRnM1tSIGHM/c2QddLp4c8wxCvYIvqROBPfbHlm/sRYC6smMNTKn3sxZAyvyYNW1v38MM/IkcPQnZHPMLtciz9P9hhqwzoLD+cnfpTIUaYinyZlBkE2YKZcMXCyN/YhsPkuFlMfWJLiwo89VMxfpJDForMCwuG+Zx7ttGO2S/w4LJ42ZURDty5M0a4dqsZAQAihQfXqWdlhnpcmdEPAI0tv2EbnsbsKmdgi6/1GN7T1XJLx5sF0P9SWABMC+co5JBE4Ge/1NTM3EGIJgjFONXCdAbeQYwhN7pRrRV20LJNIhWOczdu+xPFzIBiQ62iIsyIOTvlZUY+HXySLQaMUEeSC1CPYxENIlwk+q8e0clFAIfiKG+qpaIvod4wfU8sqvkDLda+xCCqgDaAk7uyeNqD+feFlfGCcg3Hzsk+xS7Nz1Aq4CcauhhMc0uxaqIgcFsF0J+1WQyoCN7Y9ezeCVH5LhSxmyRvsihKbK1m7LafpSpkpj6yJgtsiVBh6AX5UyCVmMbrNpcwj5/h6DPN79JjAiQAhXVeN6SZI0q5bQnn4wBiHEqpUybp1ZJzWxStVCHhKhAhVLp/Emh6trHpGLaB6yZHk7wu3Z+ChOxhwUNEmYYjpUvqJDksSHraQmJm2DdqQK6sGUObybYtpSN+8Phm3pN2xjDH33R6b0CKxAZNLvl8foD3BBnSw5e8RI+G2P8GD9wHw6YN3wkfA0R4Zz8CGCIfOCv8zM738walXuLw6nXBvPr8wvAAAAAElFTkSuQmCC",Lp={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};function Ip(t){return t.fromData(dr,()=>new kr(dr,Lp))}class Gp{constructor(){this.lastDragEvent=null,this.next=new As,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const i={...this.lastDragEvent,action:"update"};e&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent=e.action!=="end"?{...e}:null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const i=Fa(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-i:i,e.factor2=e.factor2<0?-i:i}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function oa(t,e){return wo(t,e,!1)}function pr(t,e){return wo(t,e,!0)}function wo(t,e,i){if(t instanceof Vh){if(t.operation instanceof zh)return Vp(t.operation,e,i),!0;if(t.operation instanceof Nh)return zp(t.operation,e,i),!0;if(t.operation instanceof Fh)return Np(t.operation,e,i),!0}return!1}function Vp(t,e,i=!1){const a=i?-1:1,s=N(a*t.dx,a*t.dy,a*t.dz);z(e.origin,e.origin,s)}function zp(t,e,i=!1){const a=i?-t.angle:t.angle;nn(e.basis1,e.basis1,ss,a),nn(e.basis2,e.basis2,ss,a)}function Np(t,e,i=!1){const a=i?1/t.factor1:t.factor1,s=i?1/t.factor2:t.factor2;Q(e.basis1,e.basis1,a),Q(e.basis2,e.basis2,s),rn(e.origin,e.origin,t.origin,t.axis1,a),rn(e.origin,e.origin,t.origin,t.axis2,s)}function Fp(t,e,i,a){a||(a=Xt());const s=ne(bt.get(),t[1],-t[0]),n=ne(bt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=ne(bt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=bt.get();e.components.forEach(p=>p.vertices.forEach(u=>{const g=u.pos;ne(o,on(t,g),on(s,g)),fl(n,n,o),vl(r,r,o)}));const l=1e-6,d=ne(bt.get(),r[0]-n[0]<l?i/2:0,r[1]-n[1]<l?i/2:0);return ws(n,n,d),Mt(r,r,d),ei(a.basis1,t,(r[0]-n[0])/2),ei(a.basis2,s,(r[1]-n[1])/2),ne(a.origin,n[0]*t[0]+n[1]*s[0],n[0]*t[1]+n[1]*s[1]),Mt(a.origin,a.origin,a.basis1),Mt(a.origin,a.origin,a.basis2),a}function kp(t,e,i,a=0,s){s||(s=Xt()),e.toRenderCoords(t.origin,i,s.origin);const n=M.get();z(n,t.origin,t.basis1),z(n,n,t.basis2),e.toRenderCoords(n,i,n);const r=M.get();z(r,t.origin,t.basis1),P(r,r,t.basis2),e.toRenderCoords(r,i,r);const o=M.get();P(o,t.origin,t.basis1),P(o,o,t.basis2),e.toRenderCoords(o,i,o);const l=M.get();P(l,t.origin,t.basis1),z(l,l,t.basis2),e.toRenderCoords(l,i,l);const d=yt(M.get(),n,r,.5);P(d,d,s.origin);const p=yt(M.get(),o,l,.5);P(p,s.origin,p),yt(s.basis1,d,p,.5);const u=yt(M.get(),l,n,.5);P(u,u,s.origin);const g=yt(M.get(),r,o,.5);P(g,s.origin,g),yt(s.basis2,u,g,.5);const v=Me(M.get(),s.basis1,s.basis2),f=Me(v,v,s.basis1);return re(f,f),Q(s.basis2,f,Ei(s.basis2,f)),Q(s.basis1,s.basis1,1+a/Te(s.basis1)),Q(s.basis2,s.basis2,1+a/Te(s.basis2)),Bh(s),s}function ur(t,e,i,a){const s=M.get();P(s,P(s,t.origin,t.basis1),t.basis2);const n=M.get();Ct(n,s,t.basis1,2);const r=M.get();Ct(r,n,t.basis2,2);const o=M.get();Ct(o,s,t.basis2,2),s[2]=n[2]=r[2]=o[2]=e;const l=a?"on-the-ground":"absolute-height",d=ln(Xi(s,n,i,l),Xi(o,r,i,l)),p=ln(Xi(n,r,i,l),Xi(s,o,i,l));return m(p)||m(d)?null:[d,p]}let Mi=class extends lt{constructor(t){super(t),this.type="extent-rotate",this.angle=0}};h([_()],Mi.prototype,"type",void 0),h([_()],Mi.prototype,"angle",void 0),Mi=h([B("esri.views.interactive.tooltip.ExtentRotateTooltipInfo")],Mi);let vt=class extends lt{constructor(t){super(t),this.type="extent-scale",this.xScale=0,this.yScale=0,this.xSize=wt,this.ySize=wt}};h([_()],vt.prototype,"type",void 0),h([_()],vt.prototype,"xScale",void 0),h([_()],vt.prototype,"yScale",void 0),h([_()],vt.prototype,"xSize",void 0),h([_()],vt.prototype,"ySize",void 0),vt=h([B("esri.views.interactive.tooltip.ExtentScaleTooltipInfo")],vt);let ue=class extends Xe.EventedMixin(Ra){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Qe,this._preserveAspectRatio=new Gp,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new ot,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=Xt(),this.mapBoundsStart=Xt(),this.zmax=0,this.sizeStart=null,this.displayBounds=Xt(),this.displayBoundsStart=Xt(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=Vt(),this._endScale=Vt()}initialize(){const{view:t,graphic:e,manipulators:i,handles:a}=this,s=this.graphicState=new jt({graphic:e}),n=e.geometry;this.editGeometryOperations=$a.fromGeometry(n,t.state.viewingMode),this.graphicMoveManipulation=new Ns({tool:this,view:t,graphicState:s}),this.moveZManipulator=Ap(t,Li.CENTER_ON_CALLOUT),this.moveZManipulator.state|=bs,a.add([this._createMoveXYGraphicDragPipeline(),L(()=>this.enableZ,()=>this._updateManipulatorAvailability(this.moveZManipulator,C.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map(p=>{const u=Pp(t,p);return a.add([L(()=>this.enableScaling,()=>this._updateManipulatorAvailability(u,C.SCALE)),u.events.on("grab-changed",g=>this._onResizeGrab(g)),this._createResizeDragPipeline(u,p)]),u}),i.addMany(this.resizeManipulators),this.rotateManipulatorTexture=Ip(t.toolViewManager.textures),this.rotateManipulator=Tp(t,this.rotateManipulatorTexture.texture),a.add([L(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this.rotateManipulator,C.ROTATE)),this.rotateManipulator.events.on("grab-changed",p=>{this._onRotateGrab(p)}),this._createRotateDragPipeline(this.rotateManipulator)]),i.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const r=Ga({view:t,graphic:e,forEachManipulator:p=>this._forEachManipulator(p),onManipulatorsChanged:()=>Gt()});c(r)&&(this.outlineVisualElement=r.visualElement instanceof Ht?r.visualElement:null),c(this.outlineVisualElement)&&a.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(r),a.add([s.on("changed",()=>this._onGeometryChanged()),L(()=>s.displaying,()=>this._updateAllManipulatorAvailability()),L(()=>s.isDraped,()=>this._graphicDrapedChanged(),je),t.trackGraphicState(s)]);const o=t.pointsOfInterest;o&&a.add(L(()=>o.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=p=>{a.add(p.events.on("grab-changed",()=>{this.grabbing=p.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const d=(p,u)=>{a.add(p.events.on("immediate-click",g=>{u===C.TRANSLATE_XY&&this.emit("immediate-click",{...g,graphic:e}),g.stopPropagation()}))};this._forEachManipulator(d),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{handles:t,view:e}=this,i=this._tooltip=new zi({view:e}),a=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",s=>{this._startAngle=s.angle,a()}),this.on("graphic-rotate",s=>{this._endAngle=s.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",s=>{ne(this._startScale,s.xScale,s.yScale),ne(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale",s=>{ne(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale-stop",()=>{ne(this._startScale,0,0),ne(this._endScale,0,0),a()})]),this._forEachManipulator(s=>{t.add([s.events.on("focus-changed",a),s.events.on("grab-changed",a),s.events.on("drag",n=>{n.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this.graphicMoveManipulation.grabbing||this.graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():this.rotateManipulator.focused?this._computeRotateTooltipInfo():this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=W(this._moveXYTooltipInfo,()=>new Ae({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo=W(this._moveZTooltipInfo,()=>new Ge({tooltipOptions:this.tooltipOptions})),e=this._moveUnit;if(this.moveZManipulator.dragging){const i=this.mapBoundsStart.origin,a=this.mapBounds.origin,s=Vl(i,a,this.view.spatialReference);if(m(s))return null;t.distance=s}else t.distance=Ti(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo=W(this._rotateTooltipInfo,()=>new Mi({tooltipOptions:this.tooltipOptions}));return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(m(t))return null;const e=this._scaleTooltipInfo=W(this._scaleTooltipInfo,()=>new vt({tooltipOptions:this.tooltipOptions})),i=ur(this.mapBounds,this.zmax,t.spatialReference,this.graphicState.isDraped);return m(i)?null:(e.xSize=i[0],e.ySize=i[1],c(this.sizeStart)&&this.resizeManipulators.some(a=>a.dragging)?(e.xScale=i[0].value/this.sizeStart[0].value,e.yScale=i[1].value/this.sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this.handles.remove(gr),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",t=>{c(this.attachmentOrigin)&&Er(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()}),gr)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof ce){const a=this.graphicState.displaying,s=this.enableZ&&zt(this.graphic);switch(e){case C.ROTATE:t.available=a&&this.enableRotation;break;case C.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||s),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?ha:So;break;case C.TRANSLATE_Z:t.available=a&&s;break;default:t.available=a}}}_forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach(e=>t(e,C.SCALE)),t(this.rotateManipulator,C.ROTATE),t(this.moveZManipulator,C.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return W(yl(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,i=e.components[0].edges[0],a=ws(bt.get(),i.leftVertex.pos,i.rightVertex.pos);ca(a,a);const s=W(Aa(this.view,this.graphic),()=>t.extent.center);let n=Hp*this.view.pixelSizeAt(s);const r=this.view.spatialReference,o=t.spatialReference;r.equals(o)||(n*=os(r)/os(o)),Fp(a,e,n,this.mapBounds),this._calculateZMax()}_calculateZMax(){const t=this.editGeometryOperations.data;if(!t.geometry.hasZ)return void(this.zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const s of a.vertices){const n=e.getZ(s.pos);i=Math.max(n,i)}this.zmax=i}_updateDisplayBounds(){const t=this.graphic.geometry;if(m(t))return;const e=c(this.outlineVisualElement)&&!this.graphicState.isDraped&&c(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Aa(this.view,this.graphic);this.attachmentOrigin=W(e,t.extent.center);const i=c(e)?e.z:$s(this.mapBounds.origin,this.view.elevationProvider,Bi.fromElevationInfo(X(this.graphic)),this.view.renderCoordsHelper),a=ut(this.mapBounds);a.origin[2]=i,kp(a,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return Up*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline((t,e,i)=>this._applyGraphicMoveSteps(e,i,G.XY))}_createMoveZDragPipeline(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return ze(this.moveZManipulator,(i,a,s)=>{const n=ua(i.renderLocation),r=a.next(fo(t,n,e)).next(li());this._applyGraphicMoveSteps(r,s,G.Z)})}_applyGraphicMoveSteps(t,e,i){const a=t.next(s=>(s.action==="start"&&(this.inputState={type:"move"},ut(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})),s)).next(Zt()).next(this._moveDragUpdateGeometry()).next(s=>{const n={graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY};switch(s.action){case"start":case"update":(s.mapEnd.x-s.mapStart.x||s.mapEnd.y-s.mapStart.y||s.mapEnd.z-s.mapStart.z)&&this.emit("graphic-translate",n);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",n)}return s}).next(s=>this._updateMoveTooltip(s,i));return e.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_calculateSizeStart(){m(this.graphic.geometry)?this.sizeStart=null:this.sizeStart=ur(this.mapBoundsStart,this.zmax,this.graphic.geometry.spatialReference,this.graphicState.isDraped)}_moveDragUpdateGeometry(){return t=>{if(m(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const s of this.editGeometryOperations.data.components)e.push(...s.vertices);const i=t.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS,a=this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return oa(a,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===G.XY||e===G.XY_AXIS){const i=Ai(t.mapStart,t.mapEnd,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(i)&&c(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return t}_onResizeGrab(t){if(t.action!=="start")return;const e=this._calculatePickRay(t.screenPoint);ni(this.displayBounds.plane,e,M.get())&&(ut(this.displayBounds,this.displayBoundsStart),ut(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return ze(t,(i,a,s)=>{m(this.inputState)||(a.next(n=>(n.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),n)).next(Ta(this.view,this.displayBoundsStart.plane)).next(n=>({...n,handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,xScale:n.factor1,yScale:n.factor2};switch(n.action){case"start":case"update":this.emit("graphic-scale",r);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",r)}return n}),s.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this.displayBoundsStart,i=t.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,n=j(M.get(),e.origin);Ct(n,n,e.basis1,-i[0]),Ct(n,n,e.basis2,-i[1]);const r=P(M.get(),t.renderEnd,n),o=P(M.get(),t.renderStart,n),l=Fa(t.handle),d=ys(e),p=ys(this.displayBounds)/d,u=(g,v)=>{if(g===0)return 1;let f=Te(v),S=.5*g*Ei(v,r)/f;const w=S<0?-1:1;l&&(S+=(f-.5*g*Ei(v,o)/f)*w*p);const x=f<1.5*s?1:_r;return f=Math.max(f-s,_r),w>0&&(S-=a),w*Math.max(w*(S/f),x)};return{...t,factor1:u(i[0],e.basis1),factor2:u(i[1],e.basis2)}}}_resizeDragUpdateGeometry(){return t=>{const e=j(b(),this.mapBoundsStart.origin);Ct(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),Ct(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const i=ne(Vt(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);ca(i,i);const a=[];for(const r of this.editGeometryOperations.data.components)a.push(...r.vertices);const s=t.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS,n=this.editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,s,fn.REPLACE);return ut(this.mapBoundsStart,this.mapBounds),oa(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if(t.action!=="start")return;const e=wp(this.displayBounds,this.view.renderCoordsHelper,Ci.HEADING,hi()),i=this._calculatePickRay(t.screenPoint);ni(e,i,M.get())&&(ut(this.displayBounds,this.displayBoundsStart),ut(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return ze(t,(e,i,a)=>{const s=this.inputState;m(s)||(i.next(n=>(n.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),n)).next(Ta(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,angle:Oi(n.rotateAngle)};switch(n.action){case"start":case"update":this.emit("graphic-rotate",r);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",r)}return n}),a.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const i=Fi(t.rotatePlane),a=oo(e.renderStart,e.renderEnd,this.displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return t=>{const e=j(b(),this.mapBoundsStart.origin),i=[];for(const n of this.editGeometryOperations.data.components)i.push(...n.vertices);const a=t.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS,s=this.editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,fn.REPLACE);return ut(this.mapBoundsStart,this.mapBounds),oa(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=Ni(),i=fa(t);return ai(this.view.state.camera,i,e),re(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=Sp(this.displayBounds,se.get());Ep(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach((e,i)=>{xp(e,this.resizeHandles[i],t,this.displayBounds)})}_updateZMoveHandle(t,e){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:P(M.get(),i.origin,i.basis1),edge:2},s=se.get();bl(s,e,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=a.position}_cancel(){const t=this.editGeometryOperations.lastOperation;m(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,pr(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,pr(R(t),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,oa(R(t),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator,tooltip:this._tooltip}}};h([_({constructOnly:!0,nonNullable:!0})],ue.prototype,"view",void 0),h([_({constructOnly:!0,nonNullable:!0})],ue.prototype,"graphic",void 0),h([_({constructOnly:!0,nonNullable:!0})],ue.prototype,"enableZ",void 0),h([_()],ue.prototype,"enableRotation",void 0),h([_()],ue.prototype,"enableScaling",void 0),h([_({constructOnly:!0,type:Qe})],ue.prototype,"tooltipOptions",void 0),h([_()],ue.prototype,"preserveAspectRatio",null),h([_()],ue.prototype,"grabbing",void 0),h([_()],ue.prototype,"inputState",void 0),h([_({readOnly:!0})],ue.prototype,"type",void 0),h([_()],ue.prototype,"_moveUnit",null),ue=h([B("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],ue);const gr="draped-elevation-changes",Up=10,Hp=80,_r=1e-6,vu=Object.freeze(Object.defineProperty({__proto__:null,get DrawGraphicTool3D(){return Je},get GraphicMoveTool(){return He},get GraphicReshapeTool(){return ie},get GraphicTransformTool(){return pe},get ExtentTransformTool(){return ue}},Symbol.toStringTag,{value:"Module"}));export{mp as a,vu as e,Ic as f,Gs as h,lc as m,gp as t,ac as v};
