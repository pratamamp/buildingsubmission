import{eV as Pt,sk as Ze,sl as Ot,sm as De,sn as be,so as qt,sp as ot,sq as se,sr as Ht,sh as ct,ss as Ut,st as dt,m as ze,_ as Pe,su as Xe,sv as Wt,sw as Ie,ij as yt,ai as jt,c7 as Gt,S as ht,e as v,g as C,n as de,y as ut,u as Le,j as Oe,aH as fe,I as $,h as ie,pL as Jt,E as q,c9 as Qt,aT as Zt,b5 as Ce,sx as Xt,sy as Yt,sz as U,l6 as Kt,U as Ye,k6 as ne,bV as es,sA as ts,sB as ss,sC as is,sD as rs,sE as ls,sF as as,sG as ns,sH as os,sI as Ke,sJ as cs,eo as ds,sK as ys,sL as hs,sM as us,l as Ee,sN as ps,sO as et,m4 as ms,aG as fs,sP as xe,pq as c,sQ as he,sR as gs,sS as bs,sT as vs,sU as _s,sV as Ls,sW as ws,sX as tt,sY as Te,sZ as Ss,cT as O,pr as Ae,po as ve,s_ as Is,pp as qe,s$ as ge,t0 as Cs,t1 as Es,t2 as D,fI as Rs,z as $s}from"./index.deeeec5f.js";import{h as Vs}from"./EffectView.b3326d65.js";import{c as zs}from"./ExportImageParameters.0973eb2c.js";import{o as xs}from"./rendererConversion.530e994c.js";import{getSymbolLayerFill as Ts}from"./previewSymbol3D.8a743545.js";import"./floorFilterUtils.69500d62.js";import"./sublayerUtils.e7bab401.js";import"./webStyleSymbolUtils.d2fbc442.js";const As=(e,t)=>{const s=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t!=null&&t.levels?t.levels[s]:null};function ks(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const s=e.visualVariables.find(i=>i.type==="size"),r=As(t,s);return r?new Pt({field:s.field,minSize:r[2].size,minDataValue:r[2].value,maxSize:r[3].size,maxDataValue:r[3].value}):null}const st={HH:315,HL:45,LL:135,LH:225},Fs={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function Ms(e){if(!e)return;const{type:t}=e;if(t.includes("3d"))return Ts(e.symbolLayers.getItemAt(0));if(t==="simple-line"){const s=Ze(e);return s&&s.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const s=Ze(e);return s&&s.color}return Ot(e)}function Bs(e,t){const s=t.HH.label,r=t.LL.label,i=t.HL.label,l=t.LH.label;switch(e){case"HH":default:return{top:s,bottom:r,left:i,right:l};case"HL":return{top:i,bottom:l,left:r,right:s};case"LL":return{top:r,bottom:s,left:l,right:i};case"LH":return{top:l,bottom:i,left:s,right:r}}}function Ns(e){const{focus:t,infos:s,numClasses:r}=e,i=Fs[r],l={};s.forEach(n=>{l[n.value]={label:n.label,fill:Ms(n.symbol)}});const a=[];for(let n=0;n<r;n++){const o=[];for(let d=0;d<r;d++){const y=l[i[n][d]];o.push(y.fill)}a.push(o)}return{type:"relationship-ramp",numClasses:r,focus:t,colors:a,labels:Bs(t,l),rotation:pt(t)}}function pt(e){let t=st[e];return e&&t==null&&(t=st.HH),t||0}const ke=30,Fe=12,mt=[255,255,255],ft=[200,200,200],te=[128,128,128],Ds=20,Ps=5;function Os(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function qs(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function Hs(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function Us(e){return e.declaredClass==="esri.symbols.TextSymbol"}function Ws(e,t){const s=e.length-1;return e.map((r,i)=>Wt(r,i,s,t))}async function js(e,t,s,r,i,l){const a=t.legendOptions,n=a&&a.customValues,o=await Qs(e,s),d=!!o,y=!!n,p=t.minSize!=null&&t.maxSize!=null,h=t.stops&&t.stops.length>1,m=!!t.target;if(!d||!y&&!(p||h&&!m))return;const f=De(o);let _=null,g=null,u=null;g=f&&!h?be([t.minDataValue,t.maxDataValue]):n||await Xs(t,o,r,i);const w=e==null?void 0:e.authoringInfo,S=(w==null?void 0:w.type)==="univariate-color-size",I=S&&(w==null?void 0:w.univariateTheme)==="above-and-below";if(!g&&h&&(g=t.stops.map(V=>V.value),_=t.stops.some(V=>!!V.label),e.type==="flow"&&(g=be(g)),_&&(u=t.stops.map(V=>V.label))),f&&(g==null?void 0:g.length)>2&&!I&&(g=[g[0],g[g.length-1]]),!g)return null;S&&(g==null?void 0:g.length)!==5&&(g=vt({minSize:g[0],maxSize:g[g.length-1]}));const E=f?Gs(e,g):null,z=qt(o),k=_?null:Ws(g,l);return(await Promise.all(g.map(async(V,M)=>{const F=f?E[M]:await Y(t,o,V,r,i);return{value:V,symbol:ei(I&&e.type==="class-breaks"?Js(e,M):o,F),label:_?u[M]:k[M],size:F,outlineSize:z}}))).reverse()}function Gs(e,t){const s=e==null?void 0:e.authoringInfo,r=(s==null?void 0:s.type)==="univariate-color-size";let i=[Fe,ke];if(r){const l=t[0],a=t[t.length-1],n=Fe,o=ke;i=t.map(d=>n+(d-l)/(a-l)*(o-n))}return r&&(s==null?void 0:s.univariateTheme)==="below"&&i.reverse(),i}function Js(e,t){const s=e.classBreakInfos,r=s.length,i=r<2||!(t>=2)?s[0].symbol.clone():s[r-1].symbol.clone();return e.visualVariables.some(l=>l.type==="color")&&(i.type.includes("3d")?gt(i):bt(i)),i}async function Qs(e,t){var i;if(e.type==="flow")return ot(e,t);if(e.type==="pie-chart")return new se({color:null,outline:(i=e.outline)!=null&&i.width?e.outline:new Ht});let s=null,r=null;if(e.type==="simple")s=e.symbol;else if(e.type==="class-breaks"){const l=e.classBreakInfos;s=l&&l[0]&&l[0].symbol,r=l.length>1}else if(e.type==="unique-value"){const l=e.uniqueValueInfos;s=l&&l[0]&&l[0].symbol,r=l.length>1}return!s||Zs(s)?null:(s=s.clone(),(t||r)&&(s.type.includes("3d")?gt(s):bt(s)),s)}function Zs(e){return e?ct(e)?!!e.symbolLayers&&e.symbolLayers.some(t=>t&&t.type==="fill"):e.type.includes("fill"):!1}function gt(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:te}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource&&t.resource.href?t.material={color:ft}:(t.material={color:mt},t.outline={color:te,size:1.5})})}function bt(e){var s,r;const t=Ut();e.type==="cim"?dt(e,new ze(ft)):e.type.includes("line")?e.color=te:(e.color=t?te:mt,e.type==="simple-marker"&&(e.outline?((r=(s=e.outline)==null?void 0:s.color)==null?void 0:r.toHex())==="#ffffff"&&(e.outline.color=te):e.outline={color:te,width:1.5}))}async function Xs(e,t,s,r){const i=(await Pe(()=>import("./index.deeeec5f.js").then(n=>n.xZ),["assets/index.deeeec5f.js","assets/index.2c2ebad2.css"])).getSizeRangeAtScale(e,s,r),l=i&&vt(i);if(!i&&!l)return;let a=l.map(n=>Ys(n,e,i));a=be(a);for(let n=1;n<a.length-1;n++){const o=await Ks(e,t,a[n],a[n-1],s,r);o&&(a[n]=o[0],l[n]=o[1])}return a}function vt(e){const t=e.minSize,s=e.maxSize,r=Ps,i=(s-t)/(r-1),l=[];for(let a=0;a<r;a++)l.push(t+i*a);return l}function Ys(e,t,s){const r=s.minSize,i=s.maxSize,l=t.minDataValue,a=t.maxDataValue;let n=null;return e<=r?n=l:e>=i?n=a:n=(e-r)/(i-r)*(a-l)+l,n}async function Ks(e,t,s,r,i,l){const a=await Y(e,t,s,i,l),n=await Y(e,t,r,i,l),o=Xe(s),d=o.fractional,y=Ds;let p=o.integer,h=null,m=null;s>0&&s<1&&(h=10**d,p=Xe(s*=h).integer);for(let f=p-1;f>=0;f--){const _=10**f;let g=Math.floor(s/_)*_,u=Math.ceil(s/_)*_;h!=null&&(g/=h,u/=h);let w=(g+u)/2;[,w]=be([g,w,u],{indexes:[1]});const S=await Y(e,t,g,i,l),I=await Y(e,t,u,i,l),E=await Y(e,t,w,i,l),z=Ie(a,S,n,null),k=Ie(a,I,n,null),V=Ie(a,E,n,null);let M=z.previous<=y,F=k.previous<=y;if(M&&F&&(z.previous<=k.previous?(M=!0,F=!1):(F=!0,M=!1)),M?m=[g,S]:F?m=[u,I]:V.previous<=y&&(m=[w,E]),m)break}return m}async function Y(e,t,s,r,i){const{getSize:l}=await Pe(()=>import("./index.deeeec5f.js").then(a=>a.xZ),["assets/index.deeeec5f.js","assets/index.2c2ebad2.css"]);return l(e,s,{scale:r,view:i,shape:t.type==="simple-marker"?t.style:null})}function ei(e,t){const s=e.clone();if(ct(s))De(s)||s.symbolLayers.forEach(r=>{r.type!=="fill"&&(r.size=t)});else if(Os(s))s.size=t;else if(qs(s)){const r=s.width,i=s.height;s.height=t,s.width=t*(r/i)}else Hs(s)?s.width=t:Us(s)&&s.font&&(s.font.size=t);return s}function ti(e){const s=Math.floor(Math.log10(Math.abs(e)))+1,r=s<4||s>6?4:s,i=1e6,l=Math.abs(e)>=i?"compact":"standard";return yt(e,{notation:l,minimumSignificantDigits:2,maximumSignificantDigits:r})}const P=jt.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),si="https://utility.arcgis.com/sharing/tools/legend",ii="esri.layers.ImageryLayer",ri="esri.layers.ImageryTileLayer",li="esri.layers.WCSLayer",ue=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,ai=new Gt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),it={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},pe=new se({size:6,outline:{color:[128,128,128,.5],width:.5}}),ni=new ht({style:"solid"});function Me(e){return e.type==="flow"}function _t(e){return e.type==="vector-field"}function Lt(e){return e.type==="raster-colormap"}function wt(e){return e.type==="raster-stretch"}function St(e){return e.type==="raster-shaded-relief"}function K(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function ee(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function Be(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function It(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function oi(e){return He(e)||Ue(e)||We(e)||ci(e)}function ci(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function He(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function Ue(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function We(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Ct(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function Et(e){return e.declaredClass==="esri.renderers.PieChartRenderer"}function di(e,t){return K(e)||ee(e)||Be(e)||It(e)||Ct(e)||Et(e)?t.type==="2d"||xs(e):wt(e)||Lt(e)||St(e)||He(e)||Ue(e)||We(e)||_t(e)||Me(e)}function rt(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function yi(e){return e.declaredClass==="esri.layers.VoxelLayer"}function hi(e){return e.declaredClass==="esri.layers.WMSLayer"}function ui(e){return e.declaredClass==="esri.layers.WMTSLayer"}function lt(e){return e.declaredClass==="esri.layers.MapImageLayer"}function pi(e){return e.declaredClass==="esri.layers.TileLayer"}function mi(e){return e.declaredClass==="esri.layers.FeatureLayer"}function oe(e){return e.declaredClass===ii}function Re(e){return e.declaredClass===ri}function fi(e){return e.declaredClass===li}function gi(e){return e.type==="stretch-ramp"}function bi(e){var t;return((t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo))==null?void 0:t.type)==="univariate-color-size"}function vi(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"&&(t==null?void 0:t.univariateTheme)==="above-and-below"}const _i=new se({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let J={},x=class extends ut{constructor(e){super(e),this._handles=new Le,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new Oe,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([fe(()=>this.children,"change",t=>{const{added:s,removed:r}=t,i=this._handles;s.forEach(l=>{const a=`activeLayerInfo-ready-watcher-${l.layer.uid}`;i.add($(()=>l.ready,e,ie),a)}),r.forEach(l=>i.remove(l.layer.uid)),e()})]),this.keepCacheOnDestroy||(J={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(J=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new Vs,t.effect=e.effect,t.end(),t.scale=this.scale),t}get opacity(){var i;const e=this.layer.opacity,t=(i=this.parent)==null?void 0:i.opacity,s=this.layer.parent,r=s&&"uid"in s?this._getParentLayerOpacity(s):null;return t!=null?t*e:r!=null?r*e:e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if(e.featureReduction.type==="cluster")return!0;if(e.featureReduction.type==="binning"&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,s=>{if(mi(s))return this._getRendererLegendElements(s.renderer,{title:s.title});if(s.featureSet&&s.featureSet.features.length){const r=s.layerDefinition,i=r&&r.drawingInfo,l=i&&Jt(i.renderer),a=ai.read(r.geometryType);return l?this._getRendererLegendElements(l,{title:s.name,geometryType:a}):(P.warn("drawingInfo not available!"),null)}return null});try{const s=[];await q(t).then(r=>{r.forEach(({value:i})=>i&&s.push(...i))}),this.legendElements=s,this.notifyChange("ready")}catch(s){P.warn("error while building legend for layer!",s)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){P.warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){var t,s;const e=this.layer;if(yi(e))this._constructLegendElementsForVoxellayer();else if(ui(e))this._constructLegendElementsForWMTSlayer();else if(hi(e))await this._constructLegendElementsForWMSSublayers();else if(rt(e))await this._constructLegendElementsForBuildingSceneLayer();else if(lt(e)||pi(e)||rt(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let r="default";oe(e)&&(r=(((t=e==null?void 0:e.renderingRule)==null?void 0:t.functionName)||"default")+"_"+((s=e.bandIds)!=null&&s.length?e.bandIds.join(""):"###")),await this._getLegendLayers(`${e.uid}-${r}`).then(async i=>{this.legendElements=[],this.notifyChange("ready");const l=i.map(async a=>{if(oe(e)||Re(e)){const o=$(()=>["renderingRule"in e&&e.renderingRule,e.bandIds],()=>Qt(async()=>{J.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this._handles.add(o,"imageryLayers-watcher")}const n=this._generateSymbolTableElementForLegendLayer(a);n&&n.infos.length&&(oe(e)&&(n.title=e.title),this.legendElements.push(n)),this.notifyChange("ready")});await q(l)}).catch(i=>{P.warn("Request to server for legend has failed!",i)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,s=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!s&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await Zt(()=>!t.updating);const r=s?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return r.geometry=this.view.extent,(s?"queryFeatureCount"in t&&await t.queryFeatureCount(r):"queryFeatureCount"in e&&await e.queryFeatureCount(r))!==0}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some(t=>t.ready)}_isRendererScaleDriven(e){if(e.type==="dot-density")return!0;const t="valueExpression"in e&&e.valueExpression;if(ue.test(t))return!0;const s="visualVariables"in e&&e.visualVariables;return!!s&&s.some(r=>this._isScaleDrivenSizeVariable(r))}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,s=t.minSize,r=t.maxSize;return typeof s=="object"&&s?this._isScaleDrivenSizeVariable(s):typeof r=="object"&&r?this._isScaleDrivenSizeVariable(r):!!t.expression||ue.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(s=>this._isLayerScaleDriven(s));const t=e.parent;if(e.loaded===!1&&t&&lt(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const s of t.sourceJSON.layers)if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxellayer(){var l;this.legendElements=[],this._handles.remove("voxel-style-watcher");const e=this.layer;this._handles.add($(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");const t=Ce(e.getVariableStyle(null)),s=[];if(t){if((l=t.uniqueValues)!=null&&l.length){const a=[];t.uniqueValues.forEach(n=>{n.enabled&&a.push({label:n.label||`${n.value}`,value:n.value,symbol:new ht({color:n.color,outline:null})})}),a.length&&s.push({type:"symbol-table",title:t.label,infos:a})}else if(t.transferFunction){const{colorStops:a,stretchRange:n}=t.transferFunction,o=a.toArray().reverse(),d=n.map((p,h)=>`${h===0?Xt:Yt} ${ti(p)}`).reverse(),y=o.map(p=>({color:p.color,value:null,label:null}));y[0].label=d[0],y[y.length-1].label=d[1],s.push({type:"color-ramp",title:t.label,infos:y,preview:U(o.map(p=>p.color))})}}const r=e.opacity,i=s.reduce((a,n)=>a.concat(this._getAllInfos(n)),[]).filter(a=>!!(a!=null&&a.symbol)).map(a=>this._getSymbolPreview(a,r));await q(i),this.legendElements=s,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add($(()=>{const{layer:t}=this;return t&&"activeLayer"in t&&t.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some(s=>e.styleId===s.id&&(t=s.legendUrl,!0)),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add($(()=>{const{layer:s}=this;return s&&"sublayers"in s&&s.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const r=e.toArray();for(const i of r){const l=$(()=>[i.title,i.visible,i.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this._handles.add(l,"wms-sublayers-watcher"),!this.respectLayerVisibility||i.visible&&i.legendEnabled){const a=await this._generateSymbolTableElementForWMSSublayer(i,t);a&&a.infos.length&&s.unshift(a)}}return s}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(r=>r);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var a;let s=e.legendUrl;if(!s)return;const r={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(s=Kt(s,t));let i=null;const l=(a=e.layer)==null?void 0:a.opacity;try{i=(await Ye(s,{responseType:"image"})).data,i&&(i.style.opacity=l)}catch{}return r.infos.push({src:s,preview:i,opacity:l}),r}_getLegendLayers(e,t){const s=J&&J[e];return s?Promise.resolve(s):this._legendRequest(t).then(r=>{const i=r.layers;return J[e]=i,i})}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(oe(t)){const i=t.exportImageServiceParameters.renderingRule;if(i&&(s.renderingRule=JSON.stringify(i.rasterFunctionDefinition||i.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:l,viewId:a,customParameters:n}=t;s={raster:l,viewId:a,...s,...n}}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const i=r.indexOf("?");i>-1?r=r.substring(0,i)+"/legend"+r.substring(i):r+="/legend"}else{const i=r.toLowerCase().indexOf("/rest/"),l=r.substring(0,i)+r.substring(i+5,r.length);r=si+"?soapUrl="+encodeURI(l)+"&returnbytes=true"}return Ye(r,{query:s}).then(i=>i.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add($(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){P.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const r=e.toArray();for(const i of r){const l=$(()=>["renderer"in i&&i.renderer,i.opacity,i.title,i.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this._handles.add(l,"sublayers-watcher"),!this.respectLayerVisibility||i.visible){const a=i&&i.opacity!=null?i.opacity:null,n=a!=null?a*t:t;if(i.type==="building-group"){const o={type:"symbol-table",title:i.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(i.sublayers,n);o.infos.push(...d),s=[o,...s]}else i.renderer&&(s=[...await this._getRendererLegendElements(i.renderer,{title:i.title,opacity:n,sublayer:i}),...s])}}return s.filter(i=>!!i&&(!("infos"in i)||i.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add($(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){P.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForSublayers(e,t,s){const r=this.layer;let i=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let l=e.toArray();!s&&this.sublayerIds&&this.sublayerIds.length&&(l=this.sublayerIds.map(a=>r.findSublayerById(a)).filter(Boolean));for(const a of l){const n=$(()=>[a.renderer,a.opacity,a.title,a.visible,a.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this._handles.add(n,"sublayers-watcher"),!this.respectLayerVisibility||a.visible&&a.legendEnabled&&this._isSublayerInScale(a)){const o=a&&a.opacity!=null?a.opacity:null,d=o!=null?o*t:t;if(a.renderer&&!a.sublayers&&a.originIdOf("renderer")>ne.SERVICE)await a.load(),i=[...await this._getRendererLegendElements(a.renderer,{title:a.title,opacity:d,sublayer:a}),...i];else{const y=await this._generateSymbolTableElementForSublayer(a,d,s);y&&i.unshift(y)}}}return i.filter(a=>!!a&&(!("infos"in a)||a.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const i=this.layer,l=e.source;let a=null;if(!(!l||l.type==="map-layer"&&l.mapLayerId===e.id&&(!l.gdbVersion||l.gdbVersion===("gdbVersion"in i&&i.gdbVersion)))||e.originIdOf("renderer")>ne.SERVICE||e.originIdOf("labelingInfo")>ne.SERVICE||e.originIdOf("labelsVisible")>ne.SERVICE){const o=new zs({layer:this.layer});a=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const n=a||`${i.uid}-default`;(await this._getLegendLayers(n,a)).forEach(o=>s.set(o.layerId,o))}const r=s.get(e.id);if((!r||(r==null?void 0:r.subLayerIds)&&r.defaultVisibility)&&e.sublayers){const i=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendLayer(r,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){var n;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const r=t==null?void 0:t.renderer;let i=(t==null?void 0:t.title)||e.layerName;if(r&&(!t||(t==null?void 0:t.originIdOf("renderer"))>ne.SERVICE)){const o=(t==null?void 0:t.title)||this._getRendererTitle(r,t);o&&(i&&typeof o!="string"&&"title"in o&&(o.title=i),i=o)}const l={type:"symbol-table",title:i,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return((n=e.legendGroups)==null?void 0:n.length)>0?e.legendGroups.forEach(o=>{var y;const d={type:"symbol-table",title:o.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter(p=>p.groupId===o.id),e.layerId,s)};((y=d.infos)==null?void 0:y.length)>0&&l.infos.push(d)}):l.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,s),l.infos.length>0?l:null}_generateSymbolTableElementInfosForLegendLayer(e,t,s){return e.map(r=>{let i=r.url;if(r.imageData&&r.imageData.length>0)i=`data:image/png;base64,${r.imageData}`;else{if(i.indexOf("http")===0)return null;i=es(`${this.layer.url}/${t}/images/${i}`)}return{label:r.label,src:i,opacity:s==null?this.opacity:s,width:r.width,height:r.height}}).filter(r=>!!r)}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let r=null,i=null,l=!0;return!s.minScale&&s.minScale!==0||!s.maxScale&&s.maxScale!==0?(e.minScale===0&&s.tileInfo&&(r=s.tileInfo.lods[0].scale),e.maxScale===0&&s.tileInfo&&(i=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(r=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,i=Math.max(s.maxScale,e.maxScale)),(r>0&&r<this.scale||i>this.scale)&&(l=!1),l}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||e.length===0)return e;const s=t.renderer,r=e.some(a=>a.values);let i=null,l=null;return r&&e.some((a,n)=>(a.values||(i=n,l=a,l.label||(l.label="others")),l!=null)),s?s.type==="unique-value"?l&&(e.splice(i,1),e.push(l)):s.type==="class-breaks"&&(l&&e.splice(i,1),e.reverse(),l&&e.push(l)):l&&(e.splice(i,1),e.push(l)),e}async _getRendererLegendElements(e,t={}){return di(e,this.view)?oi(e)?this._constructPointCloudRendererLegendElements(e,t):Ct(e)?this._constructDotDensityRendererLegendElements(e):Et(e)?this._constructPieChartRendererLegendElements(e):this._constructRendererLegendElements(e,t):(P.warn(`Renderer of type '${e.type}' not supported!`),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const s=t.title,r=[];let i=null,l=null;if(He(e))i={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(n=>{i.infos.unshift({label:n.label||n.minValue+" - "+n.maxValue,value:[n.minValue,n.maxValue],symbol:this._getAppliedCloneSymbol(pe,n.color)})});else if(Ue(e)){const n=e.stops;let o=null;if(n.length&&(n.length===1&&(o=n[0].color),!o)){const y=n[0].value,p=n[n.length-1].value;y!=null&&p!=null&&(o=ts(y+(p-y)/2,n))}i={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(pe,o||pe.color)}]};const d=ss(e.stops);l={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:d,preview:U(d.map(y=>y.color))}}else We(e)&&(i={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach(n=>{i.infos.push({label:n.label||n.values.join(", "),value:n.values.join(", "),symbol:this._getAppliedCloneSymbol(pe,n.color)})}));i&&i.infos.length&&r.push(i),l&&l.infos.length&&r.push(l);const a=r.reduce((n,o)=>n.concat(o.infos),[]).filter(n=>!!n.symbol).map(n=>this._getSymbolPreview(n,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return q(a).then(()=>r)}_getElementInfoForDotDensity(e,t){var h;const{backgroundColor:s,outline:r,dotSize:i}=e,l=(h=this.effectList)==null?void 0:h.effects.map(m=>m.toJSON()),a=is(l),n=i+"-"+t+"-"+s+"-"+(r&&JSON.stringify(r.toJSON()))+"-"+a,o=this._dotDensityUrlCache,d=o.has(n)?o.get(n):rs(e,t);o.set(n,d);const y={shape:{type:"image",x:0,y:0,width:d.width,height:d.height,src:d.src},fill:null,stroke:null,offset:[0,0]},p=ls([[y]],[d.width,d.height],{effectView:this.effectList});return{opacity:1,src:d.src,preview:p,width:d.width,height:d.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions&&e.legendOptions.unit,r={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};return e.attributes.forEach(i=>{const l=this._getElementInfoForDotDensity(e,i.color);l.label=i.label||i.valueExpressionTitle||i.field,r.infos.push(l)}),Promise.resolve([r])}async _constructPieChartRendererLegendElements(e){var o,d,y,p;const t=this.layer.opacity,s=[],r="Others",i=e.outline;e.attributes.forEach(h=>{const m=new se({color:h.color,outline:i}),f=h.label||h.valueExpressionTitle||h.field;s.push({label:f,symbol:m})});const l=s.length?[...s]:[];if(((o=e.othersCategory)==null?void 0:o.color)&&((d=e.othersCategory)==null?void 0:d.threshold)!==0){const h=new se({color:e.othersCategory.color,outline:i});s.push({label:e.othersCategory.label||r,symbol:h})}if((y=e.defaultColor)!=null&&y.a){const h=new se({color:e.defaultColor,outline:i});s.push({label:e.defaultLabel,symbol:h})}const a=await this._getVisualVariableLegendElements(e,this.layer)||[];if(s.length){a.unshift({type:"symbol-table",title:null,infos:s});const h=l.filter(f=>f.label!==r).map(f=>f.symbol.color).filter(Boolean),m=as(h,{holePercentage:e.holePercentage,backgroundColor:(p=e.backgroundFillSymbol)==null?void 0:p.color,effectList:this.effectList,outline:i});a.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:s,preview:m})}const n=a.reduce((h,m)=>h.concat(this._getAllInfos(m)),[]).filter(h=>!!(h!=null&&h.symbol)&&!(h!=null&&h.preview)).map(h=>this._getSymbolPreview(h,t,{effectList:this.effectList}));return await q(n),a}async _constructRendererLegendElements(e,t={}){var g;const{title:s,sublayer:r}=t,i=r||this.layer;let l=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const a=await this._getVisualVariableLegendElements(l,i)||[],n={type:"symbol-table",title:s||this._getRendererTitle(l,i),infos:[]};let o=null,d=!1;const y=new Set;if(Me(l)&&!this._hasSizeRamp){const u=await ot(l);n.infos.push({label:null,symbol:u})}else if(bi(l)){let u=s;const w=vi(l)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",S=a.findIndex(V=>V.type==="color-ramp"),I=S!==-1?a.splice(S,1)[0]:null,E=a.findIndex(V=>V.type==="size-ramp"),z=E!==-1?a.splice(E,1)[0]:null,k=[];I&&(u=I.title,k.push(I)),z&&(u=z.title,k.push(z)),k.length>0&&a.push({type:w,title:u,infos:k})}else if(It(l)){const u=ns(l);a.push({type:"heatmap-ramp",title:s||((g=l.legendOptions)==null?void 0:g.title),infos:u,preview:U(u.map(w=>w.color),{effectList:this.effectList})})}else if(Be(l)){const u=l&&l.authoringInfo;if(u&&u.type==="relationship"){const{focus:w,numClasses:S,field1:I,field2:E}=u;if(S&&I&&E){const z=[I,E];let k=pt(w)||0;for(const M of z){const{field:F,normalizationField:ye,label:j}=M,Se=j||{field:this._getFieldAlias(F,i),normField:ye&&this._getFieldAlias(ye,i)},G=_i.clone();G.angle=k,n.infos.push({label:Se,symbol:G}),y.add(G),k+=90}const V=Ns({focus:w,numClasses:S,infos:l.uniqueValueInfos});a.unshift(V)}}else{const w=l.field;l.uniqueValueInfos.forEach(S=>{S.symbol&&n.infos.push({label:S.label||this._getDomainName(w,S.value,i)||S.value,value:S.value,symbol:S.symbol})})}l.defaultSymbol&&(n.infos.push({label:l.defaultLabel||"others",symbol:l.defaultSymbol}),d=!0)}else if(ee(l))o=this._isUnclassedRenderer(l),(!o||!this._hasSizeRamp)&&(l.classBreakInfos.forEach(u=>{u.symbol&&n.infos.unshift({label:u.label||(o?null:u.minValue+" - "+u.maxValue),value:[u.minValue,u.maxValue],symbol:u.symbol})}),o&&(n.title=null),this._updateInfosforClassedSizeRenderer(l,n.infos)),l.defaultSymbol&&!o&&(n.infos.push({label:l.defaultLabel||"others",symbol:l.defaultSymbol}),d=!0);else if(wt(l))if(Re(this.layer)||fi(this.layer)){const u=this._constructTileImageryStretchRendererElements(l);gi(u)?a.push(u):n.infos=u}else{const u=this.layer;let w,S;l.statistics&&l.statistics.length&&(w=l.statistics[0].min!=null?l.statistics[0].min:l.statistics[0][0],S=l.statistics[0].max!=null?l.statistics[0].max:l.statistics[0][1]);let I=[];const E=Ce(u.renderingRule?await u.generateRasterInfo(u.renderingRule):u.serviceRasterInfo),z=E.keyProperties.BandProperties,k=it[u.rasterInfo.pixelType.toLowerCase()];E.bandCount===1||u.bandIds&&u.bandIds.length===1?(w=w!=null?w:E.statistics?E.statistics[u.bandIds[0]].min:k[0],S=S!=null?S:E.statistics?E.statistics[u.bandIds[0]].max:k[1],w||S?a.push(this._getStretchLegendElements(l,{min:w,max:S})):this._getServerSideLegend()):E.bandCount>=3?z&&z.length>=E.bandCount?u.bandIds&&u.bandIds.length===3?(I=u.bandIds.map(V=>z[V].BandName),n.infos=this._createSymbolTableElementMultiBand(I)):u.format==="lerc"?(I=[0,1,2].map(V=>z[V].BandName),n.infos=this._createSymbolTableElementMultiBand(I)):this._getServerSideLegend():u.format==="lerc"?(I=["band1","band2","band3"],n.infos=this._createSymbolTableElementMultiBand(I)):this._getServerSideLegend():this._getServerSideLegend()}else if(Lt(l))l.colormapInfos.forEach(u=>{n.infos.push({label:u.label,value:u.value,symbol:this._getAppliedCloneSymbol(ni,u.color)})});else if(K(l)){let u=l.symbol;switch(t.geometryType){case"point":u="pointSymbol"in i&&i.pointSymbol;break;case"polyline":u="lineSymbol"in i&&i.lineSymbol;break;case"polygon":u="polygonSymbol"in i&&i.polygonSymbol}l.symbol&&!this._hasSizeRamp&&n.infos.push({label:l.label,symbol:u})}else if(_t(l)){l.outputUnit&&(this.title="("+l.toJSON().outputUnit+")"),n.title=l.attributeField;const u=l.getClassBreakInfos();u!=null&&u.length?u.forEach(w=>{n.infos.push({label:w.minValue+" - "+w.maxValue,symbol:w.symbol})}):n.infos.push({label:l.attributeField,symbol:l.getDefaultSymbol()})}else St(l)&&a.push(this._getStretchLegendElements(l,{min:0,max:255}));const p=l.defaultSymbol;!p||d||K(l)||o&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:l.defaultLabel||"others",symbol:p}]}),n.infos.length&&a.unshift(n);const h=t.opacity==null?this.opacity:t.opacity,m=this._isTallSymbol("visualVariables"in l&&l.visualVariables),f=oe(this.layer)||Re(this.layer),_=a.reduce((u,w)=>u.concat(this._getAllInfos(w)),[]).filter(u=>!!(u!=null&&u.symbol)).map(u=>this._getSymbolPreview(u,h,{isDefault:u.symbol===p,applyScaleDrivenSize:!y.has(u.symbol),symbolConfig:{isTall:m,isSquareFill:f},effectList:y.has(u.symbol)?null:this.effectList}));return l=null,await q(_),a}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e==null?void 0:e.infos;return t?t.reduce((s,r)=>s.concat(this._getAllInfos(r)),[]):[e]}_constructTileImageryStretchRendererElements(e){var y,p;const t=this.layer,s=t.rasterInfo,r=s.bandCount||e.statistics.length;let i,l,a=[];const n=s.keyProperties&&s.keyProperties.BandProperties,o=(y=e==null?void 0:e.statistics)!=null&&y.length?e.statistics:s==null?void 0:s.statistics;if(o)i=o[0].min!==void 0?o[0].min:o[0][0],l=o[0].max||o[0][1];else{const h=it[t.rasterInfo.pixelType.toLowerCase()];i=h[0],l=h[1]}if(t.hasStandardTime()&&(i=t.getStandardTimeValue(i),l=t.getStandardTimeValue(l)),s.bandCount===1||((p=t.bandIds)==null?void 0:p.length)===1)return this._getStretchLegendElements(e,{min:i,max:l});function d(h){var f;const m=((f=t==null?void 0:t.bandIds)!=null&&f.length?t.bandIds:Array.from(Array(Math.min(s.bandCount,3)).keys())).map(_=>h&&h[_]&&h[_].BandName||"band"+(_+1));return m.length<3?m.push(m[1]):m.length>3&&m.splice(3),m}return a=n&&n.length>=r?d(n):d(),this._createSymbolTableElementMultiBand(a)}_getStretchLegendElements(e,t){const s=e.colorRamp,r=os(s,t);return{type:"stretch-ramp",title:"",infos:r,preview:U(r.map(i=>i.color))}}async _getSizeLegendElement(e,t,s,r){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await js(s,t,await Ke(s),this.scale,this.view.type,r)}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach((r,i)=>{var l;t.push({label:{colorName:s[i],bandName:r},src:cs[i],opacity:(l=this.opacity)!=null?l:1})}),t}_updateInfosforClassedSizeRenderer(e,t){const s=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",r=e.classBreakInfos.some(i=>De(i.symbol));if(s&&r){const i=ke,l=Fe,a=e.classBreakInfos.length,n=(i-l)/(a>1?a-1:a);t.forEach((o,d)=>{o.size=i-n*d})}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let r=0;r<e.length&&(!t||!s);r++){const i=e[r];i.type==="size"&&(i.axis==="height"&&(t=!0),i.axis==="width-and-depth"&&(s=!0))}return t&&s}async _getSymbolPreview(e,t,s){let r=!(s!=null&&s.isDefault)&&e.size==null&&this._hasSizeRamp?ds(ys.size):e.size;if(this._scaleDrivenSizeVariable&&(s==null?void 0:s.applyScaleDrivenSize)){const{getSize:i}=await Pe(()=>import("./index.deeeec5f.js").then(l=>l.xZ),["assets/index.deeeec5f.js","assets/index.2c2ebad2.css"]);r=i(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return hs(e.symbol,{size:r,opacity:t,scale:!1,symbolConfig:s==null?void 0:s.symbolConfig,effectView:s==null?void 0:s.effectList}).then(i=>(e.preview=i,e)).catch(()=>(e.preview=null,e))}async _loadRenderer(e){var l,a;const t=[],s=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const r="visualVariables"in e&&((l=e.visualVariables)==null?void 0:l.some(n=>n.type==="size"&&n.target!=="outline"&&!ue.test(n.valueExpression)));if(e&&"visualVariables"in e&&!r&&"featureReduction"in s&&((a=s.featureReduction)==null?void 0:a.type)==="cluster"){const n=this.layerView._effectiveRenderer,o=Ce(ks(n,this.view));if(o){const d=s.featureReduction;if("clusterMinSize"in d&&"clusterMaxSize"in d){const{clusterMinSize:p,clusterMaxSize:h}=d;o.legendOptions=new us({showLegend:p!==h})}const y=e.visualVariables||[];e.visualVariables=y.concat([o]),this._hasClusterSizeVariable=!0}}const i=await Ke(e);if(ee(e)||Be(e)){const n=(e.classBreakInfos||e.uniqueValueInfos).map(o=>this._fetchSymbol(o.symbol,i).then(d=>{o.symbol=d}).catch(()=>{o.symbol=null}));Array.prototype.push.apply(t,n)}return t.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:i).then(n=>{this._applySymbolToRenderer(e,n,K(e))}).catch(()=>{this._applySymbolToRenderer(e,null,K(e))})),q(t).then(()=>e)}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if(e.type==="web-style"){const s=this._webStyleSymbolCache;try{const r=await(this.view.type==="2d"?e.fetchCIMSymbol({cache:s}):e.fetchSymbol({cache:s}));return this._getAppliedCloneSymbol(r,t)}catch{throw P.warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const s=e.clone(),r=t&&t.toRgba();return s.type.includes("3d")?this._applyColorTo3dSymbol(s,r):s.type==="cim"?dt(s,t):s.color&&(s.color=new ze(r||s.color)),s}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(s=>{s&&(s.material||(s.material={}),s.material.color=new ze(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||e.type==="vector-field")return null;const s=e.visualVariables,r=[],i=[],l=[];for(const y of s)y.type==="color"?r.push(y):y.type==="size"?i.push(y):y.type==="opacity"&&l.push(y);const a=[...r,...i,...l];let n,o;if(r.length===0&&ee(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const y=e.classBreakInfos[0];n=y&&y.symbol}if(r.length===0&&K(e)&&(n=e.symbol),n)if(n.type.includes("3d")){const y=n.symbolLayers.getItemAt(0);y.type==="water"?Ee(y.color)&&(o=y.color):Ee(y.material)&&Ee(y.material.color)&&(o=y.material.color)}else n.url||(o=n.color);const d=this.effectList;return(await Promise.all(a.map(async y=>{if(!y.legendOptions||y.legendOptions.showLegend!==!1){const p=Me(e)?y.field:this._getRampTitle(y,t);let h=null;const m="getField"in t&&t.getField&&t.getField(y.field),f=m&&ps(m);if(y.type==="color"){const _=await et(y,null,f);h={type:"color-ramp",title:p,infos:_,preview:U(_.map(g=>g.color),{effectList:d})},this._hasColorRamp||(this._hasColorRamp=!(h.infos==null||!h.infos.length))}else if(y.type==="size"&&y.target!=="outline")ue.test(y.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=y):(h=await this._getSizeLegendElement(p,y,e,f),this._hasSizeRamp||(this._hasSizeRamp=!(h.infos==null||!h.infos.length)));else if(y.type==="opacity"){const _=await et(y,o,f);h={type:"opacity-ramp",title:p,infos:_,preview:U(_.map(g=>g.color),{effectList:d})},this._hasOpacityRamp||(this._hasOpacityRamp=!(h.infos==null||!h.infos.length))}return h&&h.infos?h:null}}))).filter(y=>!!y)}_getDomainName(e,t,s){if(e&&typeof e!="function"){const r="getField"in s&&s.getField&&s.getField(e),i=r&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(r.name):null;return i&&i.type==="coded-value"?i.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const r=t.featureReduction,i="popupTemplate"in r&&r.popupTemplate,l=i&&i.fieldInfos;if(l){for(const a of l)if(a.fieldName===s)return s==="cluster_count"?a.label||{showCount:!0}:a.label}}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,r=e.normalizationField,i=!1,l=!1,a=!1,n=null;s=typeof s=="function"?null:s,r=typeof r=="function"?null:r;const o=e.legendOptions&&e.legendOptions.title;if(o!=null)n=o;else if(e.valueExpressionTitle)n=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const d=t.renderer.authoringInfo.visualVariables;for(let y=0;y<d.length;y++){const p=d[y];if(p.type==="color"){if(p.style==="ratio"){i=!0;break}if(p.style==="percent"){l=!0;break}if(p.style==="percent-of-total"){a=!0;break}}}}n={field:s&&this._getFieldAlias(s,t),normField:r&&this._getFieldAlias(r,t),ratio:i,ratioPercent:l,ratioPercentTotal:a}}return n}_getRendererTitle(e,t){const s=e;if(s.legendOptions&&s.legendOptions.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let r=s.field,i=null,l=null;ee(s)&&(i=s.normalizationField,l=s.normalizationType==="percent-of-total"),r=typeof r=="function"?null:r,i=typeof i=="function"?null:i;let a=null;return(r||i)&&(a={field:r&&this._getFieldAlias(r,t),normField:i&&this._getFieldAlias(i,t),normByPct:l}),a}_getFieldAlias(e,t){const s="popupTemplate"in t&&t.popupTemplate,r=s&&s.fieldInfos;let i=null;r&&r.some(o=>e===o.fieldName&&(i=o,!0));let l=null;"getField"in t&&t.getField?l=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(l=t.fieldsIndex.get(e));const a=i||l;let n=null;return a&&(n=i&&i.label||l&&l.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName),n}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return ee(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(s=e.field?t.some(r=>!(!r||e.field!==r.field||(e.normalizationField||r.normalizationField)&&e.normalizationField!==r.normalizationField)):!!t.length),s}};v([C()],x.prototype,"children",void 0),v([C({readOnly:!0})],x.prototype,"effectList",null),v([C()],x.prototype,"layerView",void 0),v([C()],x.prototype,"layer",void 0),v([C()],x.prototype,"legendElements",void 0),v([C({readOnly:!0})],x.prototype,"opacity",null),v([C()],x.prototype,"parent",void 0),v([C({readOnly:!0,dependsOn:[]})],x.prototype,"ready",null),v([C()],x.prototype,"hideLayersNotInCurrentView",void 0),v([C()],x.prototype,"keepCacheOnDestroy",void 0),v([C()],x.prototype,"respectLayerVisibility",void 0),v([C({readOnly:!0})],x.prototype,"scale",null),v([C()],x.prototype,"sublayerIds",void 0),v([C({readOnly:!0})],x.prototype,"isScaleDriven",null),v([C()],x.prototype,"title",void 0),v([C({readOnly:!0,dependsOn:["ready"],value:0})],x.prototype,"version",null),v([C()],x.prototype,"view",void 0),x=v([de("esri.widgets.Legend.support.ActiveLayerInfo")],x);const Rt=x,H={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},$t=Oe.ofType(Rt),Li=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer"],Vt="view.basemapView.baseLayerViews",zt="view.groundView.layerViews",xt="view.basemapView.referenceLayerViews",wi=[Vt,zt,"view.layerViews",xt];let B=class extends ut{constructor(e){super(e),this._handles=new Le,this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Oe,this.activeLayerInfos=new $t,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this._handles.add($(()=>this.view,()=>this._viewHandles(),ie),H.view),this._handles.add(ms(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}_viewHandles(){this._handles.remove(H.state),this.view&&this._handles.add($(()=>this.state,()=>this._stateHandles(),ie),H.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this._handles.remove([H.allLayerViews,H.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this._handles.remove(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t&&t.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{allLayerViews:e}=this.view;e.length&&this._refresh(),this._handles.add(e.on("change",t=>this._allLayerViewsChangeHandle(t)),H.allLayerViews),this._handles.add($(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),H.legendProperties)}_allLayerViewsChangeHandle(e){e.removed.forEach(t=>this._destroyViewActiveLayerInfo(t.uid)),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){if(e.length<2)return;const t=[];e.forEach(r=>{if(!r.parent){const i=r.layer.parent,l=i&&"uid"in i&&this._layerViewByLayerId[i.uid],a=l&&this._activeLayerInfosByLayerViewId[l.uid];a&&e.includes(a)&&(t.push(r),r.parent=a,a.children.add(r),this._sortActiveLayerInfos(a.children))}}),e.removeMany(t);const s={};this.view.allLayerViews.forEach((r,i)=>s[r.layer.uid]=i),e.sort((r,i)=>{const l=s[r.layer.uid]||0;return(s[i.layer.uid]||0)-l})}_generateLayerViews(){const e=[];return wi.filter(this._filterLayerViews,this).map(this.get,this).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===Vt||e===xt),s=!this.groundLegendVisible&&e===zt;return!t&&!s}_collectLayerViews(e,t){const s=r=>(r&&r.forEach(i=>{t.push(i),s(i[e])}),t);return s}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(s=>this._hasLayerInfo(s,e))}_hasLayerInfo(e,t){const s=this._isLayerUIDMatching(e.layer,t.layer.uid);return s&&(this._layerInfosByLayerViewId[t.uid]=e),s}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(s=>this._isLayerUIDMatching(s,t))}_isLayerViewSupported(e){return!!Li.includes(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),this._handles.add($(()=>{var t;return[e.legendEnabled,(t=e.layer)==null?void 0:t.legendEnabled]},()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.get("layer.legendEnabled")}_buildActiveLayerInfo(e){var a;const t=e.layer,s=e.uid,r=this._layerInfosByLayerViewId[s];let i=this._activeLayerInfosByLayerViewId[s];if(!i){const n=r&&r.title!==void 0&&r.layer.uid===t.uid;i=new Rt({layer:t,layerView:e,title:n?r.title:t.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:r&&r.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[s]=i}const l=t.parent&&"uid"in t.parent&&this._layerViewByLayerId[(a=t.parent)==null?void 0:a.uid];if(i.parent=this._activeLayerInfosByLayerViewId[l==null?void 0:l.uid],!this._handles.has(s)){const n=[$(()=>t.title,o=>this._titleHandle(o,i)),$(()=>[t.opacity,"renderer"in t&&t.renderer,"pointSymbol"in t&&t.pointSymbol,"lineSymbol"in t&&t.lineSymbol,"polygonSymbol"in t&&t.polygonSymbol],()=>this._constructLegendElements(i)),fs(()=>{var o;return((o=this.view)==null?void 0:o.stationary)===!0},()=>this._scaleHandle(i),ie),$(()=>e._effectiveRenderer,()=>this._constructLegendElements(i)),$(()=>"effect"in t&&t.effect,()=>this._constructLegendElements(i))];if(this.respectLayerVisibility){const o=$(()=>e.legendEnabled,y=>this._legendEnabledHandle(y,i)),d=$(()=>t.legendEnabled,y=>this._legendEnabledHandle(y,i));n.push(o,d)}this._handles.add(n,s)}i.isScaleDriven||this._constructLegendElements(i),this._addActiveLayerInfo(i)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){var r;const{layerView:t,layer:s}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){const i=e.parent;if(i)i.children.includes(e)||i.children.push(e),this._sortActiveLayerInfos(i.children);else{const l=(r=this.layerInfos)==null?void 0:r.some(a=>a.layer.uid===s.uid);s.parent&&"uid"in s.parent&&!l?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const l=[];this._activeLayerInfosWithNoParent.forEach(a=>{const n=a.layer.parent,o=n&&"uid"in n&&this._layerViewByLayerId[n==null?void 0:n.uid],d=this._activeLayerInfosByLayerViewId[o==null?void 0:o.uid];d&&(l.push(a),a.parent=d)}),l.length&&(this._activeLayerInfosWithNoParent.removeMany(l),l.forEach(a=>this._addActiveLayerInfo(a)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){var s;const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"featureReduction"in t&&((s=t.featureReduction)==null?void 0:s.type)==="binning"&&"renderer"in t.featureReduction?e.buildLegendElementsForRenderer(t.featureReduction.renderer):"renderer"in t&&t.renderer?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url?e.buildLegendElementsForTools():e.children.forEach(r=>this._constructLegendElements(r))}};v([C({type:$t})],B.prototype,"activeLayerInfos",void 0),v([C()],B.prototype,"basemapLegendVisible",void 0),v([C()],B.prototype,"groundLegendVisible",void 0),v([C()],B.prototype,"hideLayersNotInCurrentView",void 0),v([C()],B.prototype,"keepCacheOnDestroy",void 0),v([C()],B.prototype,"respectLayerVisibility",void 0),v([C()],B.prototype,"layerInfos",void 0),v([C({readOnly:!0})],B.prototype,"state",null),v([C()],B.prototype,"view",void 0),B=v([de("esri.widgets.Legend.LegendViewModel")],B);const Si=B,Ii="http://www.w3.org/2000/svg",R={diamondContainer:"esri-relationship-ramp--diamond__container",diamondLeftCol:"esri-relationship-ramp--diamond__left-column",diamondRightCol:"esri-relationship-ramp--diamond__right-column",diamondMidCol:"esri-relationship-ramp--diamond__middle-column",diamondMidColLabel:"esri-relationship-ramp--diamond__middle-column--label",diamondMidColRamp:"esri-relationship-ramp--diamond__middle-column--ramp",squareTable:"esri-relationship-ramp--square__table",squareTableRow:"esri-relationship-ramp--square__table-row",squareTableCell:"esri-relationship-ramp--square__table-cell",squareTableLabel:"esri-relationship-ramp--square__table-label",squareTableLabelLeftBottom:"esri-relationship-ramp--square__table-label--left-bottom",squareTableLabelRightBottom:"esri-relationship-ramp--square__table-label--right-bottom",squareTableLabelLeftTop:"esri-relationship-ramp--square__table-label--left-top",squareTableLabelRightTop:"esri-relationship-ramp--square__table-label--right-top"};function Tt(e,t,s,r){const{focus:i,labels:l}=e,a=!!i,n=Ci(e,t,s,r),o={justifyContent:"center"},d=xe();return a?c("div",{class:R.diamondContainer,styles:o},c("div",{class:R.diamondLeftCol},d?l.right:l.left),c("div",{class:R.diamondMidCol},c("div",{class:R.diamondMidColLabel},l.top),n,c("div",{class:R.diamondMidColLabel},l.bottom)),c("div",{class:R.diamondRightCol},d?l.left:l.right)):c("div",{class:R.squareTable},c("div",{class:R.squareTableRow},c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelRightBottom)},d?l.top:l.left),c("div",{class:R.squareTableCell}),c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelLeftBottom)},d?l.left:l.top)),c("div",{class:R.squareTableRow},c("div",{class:R.squareTableCell}),n,c("div",{class:R.squareTableCell})),c("div",{class:R.squareTableRow},c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelRightTop)},d?l.right:l.bottom),c("div",{class:R.squareTableCell}),c("div",{class:he(R.squareTableCell,R.squareTableLabel,R.squareTableLabelLeftTop)},d?l.bottom:l.right)))}function at(e,t,s){const r=`${s}_arrowStart`,i=`${s}_arrowEnd`,l=e==="left",a={markerStart:null,markerEnd:null};switch(t){case"HL":l?a.markerStart=`url(#${i})`:a.markerEnd=`url(#${r})`;break;case"LL":a.markerStart=`url(#${i})`;break;case"LH":l?a.markerEnd=`url(#${r})`:a.markerStart=`url(#${i})`;break;default:a.markerEnd=`url(#${r})`}return a}function Ci(e,t,s,r,i=60){const{focus:l,numClasses:a,colors:n,rotation:o}=e,d=!!l,y=Math.sqrt(i**2+i**2)+(d?0:5),p=[],h=[],m=[],f=(i||75)/a;for(let F=0;F<a;F++){const ye=F*f;for(let j=0;j<a;j++){const Se=j*f,G=gs(n[F][j]),Dt=bs(null),Qe={type:"rect",x:Se,y:ye,width:f,height:f};p.push(vs(G)),h.push(_s(Qe,G.fill,Dt,null)),m.push(Ls(Qe))}}const _=10,g=15,u=15,w=10;let S=null;d||(S="margin: -15px -15px -18px -15px");const I=at("left",l,t),E=at("right",l,t),z=ws(m),k=tt(z,y,y,0,!1,o,!1),V=tt(z,y,y,0,!1,d?-45:null,!1),M={filter:Te(r),opacity:s==null?null:`${s}`};return c("div",{styles:M,class:d?R.diamondMidColRamp:R.squareTableCell},c("svg",{xmlns:Ii,width:y,height:y,style:S},c("defs",null,c("marker",{id:`${t}_arrowStart`,markerWidth:"10",markerHeight:"10",refX:"5",refY:"5",markerUnits:"strokeWidth",orient:"auto"},c("polyline",{points:"0,0 5,5 0,10",fill:"none",stroke:"#555555","stroke-width":"1"})),c("marker",{id:`${t}_arrowEnd`,markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",markerUnits:"strokeWidth",orient:"auto"},c("polyline",{points:"5,0 0,5 5,10",fill:"none",stroke:"#555555","stroke-width":"1"})),p),c("g",{transform:k},h),c("g",{transform:V},c("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":I.markerStart,"marker-end":I.markerEnd,x1:-_,y1:i-g,x2:-_,y2:g}),c("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":E.markerStart,"marker-end":E.markerEnd,x1:u,y1:i+w,x2:i-u,y2:i+w}))))}const Ei=Ss(),At=10,je=20,we=10,Ge=20,Je={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Ri(e="vertical"){const t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?c("svg",{height:"4",width:"10"},c("line",{x1:"0",y1:"2",x2:"10",y2:"2",style:t})):c("svg",{height:"10",width:"10"},c("line",{x1:"5",y1:"0",x2:"5",y2:"10",style:t}))}function $i(e,t="vertical"){const s=document.createElement("div");return s.style.height=`${je}px`,s.className=Je.univariateAboveAndBelowSymbol,e!=null&&(s.style.opacity=e.toString()),Ei.append(s,Ri.bind(null,t)),s}function kt(e,t,s="vertical",r){e.infos.forEach((i,l)=>{if(r&&l===2)i.preview=$i(t,s);else{const a=O(i.size)+(s==="horizontal"?Ge:we),n=i.preview.tagName.toLowerCase()==="div",o=n?i.preview:document.createElement("div");o.className=Je.univariateAboveAndBelowSymbol,s==="horizontal"?o.style.width=`${a}px`:o.style.height=`${a}px`,n||o.appendChild(i.preview),i.preview=o}})}function _e(e,t="classic"){const s=e.infos;return t==="classic"?(O(s[0].size)+we)/2:(O(s[0].size)-O(s[s.length-1].size))/2}function re(e,t){if(!e)return null;const s=e.infos.map(i=>i.color),r=U(t.type==="full"?s:t.type==="above"?s.slice(0,3):s.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList});return r.className=Je.colorRamp,t.opacity!=null&&(r.style.opacity=t.opacity.toString()),r}function Ne(e,t,s,r="vertical"){let i=0;const l=e.infos,a=Math.floor(l.length/2),n=t==="full"||t==="above"?0:a,o=t==="full"||t==="below"?l.length-1:a;for(let d=n;d<=o;d++)s&&d===a?i+=r==="horizontal"?At:je:i+=O(l[d].size)+(r==="horizontal"?Ge:we);return Math.round(i)}function le(e,t,s,r="vertical"){const i=Ne(e,t,s,r),l=e.infos,a=Math.floor(l.length/2),n=t==="full"||t==="above"?0:a,o=t==="full"||t==="below"?l.length-1:a,d=t==="full"?l[n].size+l[o].size:t==="above"?l[n].size:l[o].size,y=s?r==="vertical"?je:At:0,p=r==="vertical"?we*(t==="full"?2:1):Ge*(t==="full"?2:1);return Math.round(i-(O(d)/2+y/2+p/2))}function Ft(e,t,s="vertical"){const r=e.infos;let i=r.find(({type:a})=>a==="size-ramp"),l=r.find(({type:a})=>a==="color-ramp");return i&&(i={...i},i.infos=[...i.infos],kt(i,t,s,!0)),l&&(l={...l},l.infos=[...l.infos]),s==="horizontal"&&(i==null||i.infos.reverse(),l==null||l.infos.reverse()),{sizeRampElement:i,colorRampElement:l}}function Mt(e,t="vertical"){const s=e.infos;let r=s.find(({type:l})=>l==="size-ramp"),i=s.find(({type:l})=>l==="color-ramp");return r&&(r={...r},r.infos=[...r.infos],kt(r,null,t,!1)),i&&(i={...i},i.infos=[...i.infos]),t==="horizontal"&&(r==null||r.infos.reverse(),i==null||i.infos.reverse()),{sizeRampElement:r,colorRampElement:i}}function Vi(e,t){return t}function T(e){const t=this;e.appendChild(t)}function ae(e,t,s){if(!t)return;if(typeof t=="string"||typeof t=="number")return t;if("value"in t||"unit"in t)return Ae(e.dotValue,t);if("colorName"in t||"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:null;let r=null;return Vi(t,s)?r=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:Bt(t,s)&&(r=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),r?Ae(r==="showField"?"{field}":e[r],{field:t.field,normField:t.normField}):null}function Bt(e,t){return!t}function Nt(e,t){return!!(t&&t==="Stretched"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}const b={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",pieChartRampPreview:"esri-legend--card__pie-chart-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},zi=25,xi=25,Ti=768,Ai=100;var ce;(function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"})(ce||(ce={}));const ki="#ddd",Q=window.devicePixelRatio;function Fi(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),r=s.resource&&s.resource.primitive;return r==="circle"||r==="cross"||r==="kite"||r==="sphere"||r==="cube"||r==="diamond"}{const t=e.style;return t==="circle"||t==="diamond"||t==="cross"}}}function Mi(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return s==="triangle"||s==="cone"||s==="tetrahedron"}return e.style==="triangle"}}let N=class extends qe{constructor(e,t){super(e,t),this._handles=new Le,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=ce.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own($(()=>this.activeLayerInfos,e=>{this._handles.removeAll(),this._watchForSectionChanges(e)}))}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators=this.layout===ce.Auto&&this.view.container.clientWidth<=Ti||this.layout===ce.Stack;const e=this.activeLayerInfos,t=e&&e.toArray().map(n=>this._renderLegendForLayer(n)).filter(n=>!!n);this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,r=this._sectionNames.map((n,o)=>{const d=Ae(this.messagesCommon.pagination.pageText,{index:o+1,total:s});return c("div",{key:n,role:"tab",id:n,"aria-label":d,"aria-controls":`${n}-panel`,"aria-selected":(this._selectedSectionName===n).toString(),tabIndex:this._selectedSectionName===n?0:-1,title:d,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(b.indicator,{[b.activated]:this._selectedSectionName===n}),"data-section-name":n})}),i=this._hasIndicators&&s>1?c("div",{class:b.indicatorContainer,key:"carousel-navigation",role:"tablist"},r):null,l=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,a={[b.stacked]:this._hasIndicators};return c("div",{class:this.classes(b.base,a)},l||c("div",{class:b.message},this.messages.noLegend),i)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s=t==="ArrowLeft"?-1:1,r=e.target.getAttribute("data-section-name"),i=this._sectionNames.indexOf(r),l=this._sectionNames;let a=null;i!==-1&&(l[i+s]?a=document.getElementById(l[i+s]):t==="ArrowLeft"?a=document.getElementById(l[l.length-1]):t==="ArrowRight"&&(a=document.getElementById(l[0])),a&&a.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach(s=>{const r=`activeLayerInfo-${s.layer.uid}-version-change`;this._handles.remove(r),this._watchForSectionChanges(s.children),this._handles.add($(()=>s.version,()=>this._generateSectionNames()),r)});const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",()=>this._watchForSectionChanges(e)),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))})}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map(s=>this._renderLegendForLayer(s)).toArray();return c("div",{key:e.layer.uid,class:this.classes(b.service,b.groupLayer)},c("div",{class:b.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some(l=>l.type==="relationship-ramp"),r=t.map((l,a)=>this._renderLegendForElement(l,e,a,s)).filter(l=>!!l);if(!r.length)return null;const i={[b.groupLayerChild]:!!e.parent};return c("div",{key:e.layer.uid,class:this.classes(b.service,i)},c("div",{class:b.serviceCaptionContainer},c("div",{class:b.serviceCaptionText},e.title)),c("div",{class:b.serviceContent},r))}}_renderLegendForElement(e,t,s,r=!1){const i=e.type==="color-ramp",l=e.type==="opacity-ramp",a=e.type==="size-ramp",n=t.layer;let o=null;if(typeof e.title=="string")o=e.title;else if(e.title){const f=e.title,_=ae(this.messages,f,i||l);o=f.title?`${f.title} (${_})`:_}const d=this._getSectionName(n,e,s),y=this._hasIndicators?c("div",null,c(ge,{level:this.headingLevel,class:b.carouselTitle},t.title),c(ge,{level:Cs(this.headingLevel),class:b.layerCaption},o)):o?c(ge,{level:this.headingLevel,class:b.layerCaption},o):null,p=t.effectList;let h=null;if(e.type==="symbol-table"){const f=e.infos.map((_,g)=>this._renderLegendForElementInfo(_,t,e.legendType,g)).filter(_=>!!_);if(f.length){const _=f[0].properties.classes&&f[0].properties.classes[b.symbolRow],g={[b.labelContainer]:!_&&!r,[b.relationshipLabelContainer]:r};h=c("div",{class:this.classes(g)},f)}}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"?h=this._renderLegendForRamp(e,n.opacity,p):a?h=this._renderSizeRamp(e,n.opacity):e.type==="pie-chart-ramp"?h=this._renderPieChartRamp(e):e.type==="relationship-ramp"?h=Tt(e,this.id,n.opacity,p):e.type==="univariate-above-and-below-ramp"?h=this._renderUnivariateAboveAndBelowRamp(e,n.opacity,p):e.type==="univariate-color-size-ramp"&&(h=this._renderUnivariateColorSizeRamp(e,n.opacity,p));if(!h)return null;const m=c("div",{key:d,class:b.section,id:`${d}-panel`,role:"tabpanel","aria-labelledby":d,tabIndex:0},[y,h]);return this._sectionMap.set(d,m),m}_renderPieChartRamp(e){return c("div",{class:b.pieChartRampPreview,bind:e.preview,afterCreate:T})}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:r,colorRampElement:i}=Ft(e,t,"horizontal");if(!r)return null;const l=Ne(r,"full",!0,"horizontal"),a=le(r,"above",!0,"horizontal"),n=le(r,"below",!0,"horizontal"),o=12,d=re(i,{width:a,height:o,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s}),y=re(i,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s}),p=_e(r,"card"),h=r.infos.map(S=>S.label),m=h.length-1,f=h.map((S,I)=>I===0||I===m?c("div",{key:I},S):null),_={display:"flex",flexDirection:"column"},g={display:"flex",flexDirection:"row"},u={marginTop:"3px",display:"flex"};xe(this.container)?u.marginRight=`${p}px`:u.marginLeft=`${p}px`;const w={width:`${l}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return c("div",{class:b.layerRow,key:"size-ramp-preview",styles:_},c("div",{class:this.classes(b.symbolContainer,b.sizeRampHorizontal),styles:g},r.infos.map((S,I)=>c("div",{key:I,class:b.symbol,bind:S.preview,afterCreate:T}))),d?c("div",{class:b.univariateAboveAndBelowColorRamp,styles:u,key:"color-ramp-preview"},c("div",{bind:d,afterCreate:T}),c("div",{bind:y,afterCreate:T})):null,c("div",{class:b.layerInfo},c("div",{class:b.rampLabelsContainer,styles:w},f)))}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:r,colorRampElement:i}=Mt(e,"horizontal");if(!r)return null;const l=Ne(r,"full",!1,"horizontal"),a=le(r,"full",!1,"horizontal"),n=re(i,{width:a,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s}),o=_e(r,"card"),d=r.infos.length-1,y=r.infos.map((_,g)=>g===0||g===d?c("div",{key:g},_.label):null),p={display:"flex",flexDirection:"column"},h={display:"flex",flexDirection:"row"},m={marginTop:"3px",display:"flex"};xe(this.container)?m.marginRight=`${o}px`:m.marginLeft=`${o}px`;const f={width:`${l}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return c("div",{class:b.layerRow,key:"size-ramp-preview",styles:p},c("div",{class:this.classes(b.symbolContainer,b.sizeRampHorizontal),styles:h},r.infos.map((_,g)=>c("div",{key:g,class:b.symbol,bind:_.preview,afterCreate:T}))),c("div",{class:b.univariateAboveAndBelowColorRamp,styles:m,key:"color-ramp-preview"},c("div",{bind:n,afterCreate:T})),c("div",{class:b.layerInfo},c("div",{class:b.rampLabelsContainer,styles:f},y)))}_renderLegendForElementInfo(e,t,s,r){var a,n;const i=t.layer;if(e.type)return this._renderLegendForElement(e,t,r);const l=Nt(i,s);if(e.preview){if(!e.symbol||!e.symbol.type.includes("simple-fill")){if(!e.label)return c("div",{key:r,bind:e.preview,afterCreate:T});const E={[b.symbolCell]:this._hasIndicators};return c("div",{key:r,class:this.classes(b.layerRow,{[b.symbolRow]:this._hasIndicators})},c("div",{class:this.classes(E),bind:e.preview,afterCreate:T}),c("div",{class:this.classes(b.imageLabel,{[b.labelCell]:this._hasIndicators})},ae(this.messages,e.label,!1)||""))}let o=255,d=255,y=255,p=0,h=255,m=255,f=255,_=0;const g=e.symbol.color&&e.symbol.color.a,u=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;g&&(o=e.symbol.color.r,d=e.symbol.color.g,y=e.symbol.color.b,p=e.symbol.color.a*i.opacity),u&&(h=e.symbol.outline.color.r,m=e.symbol.outline.color.g,f=e.symbol.outline.color.b,_=e.symbol.outline.color.a*i.opacity);const w=(n=(a=e.symbol.color)==null?void 0:a.isBright)!=null?n:!0,S=w?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",I={background:g?`rgba(${o}, ${d}, ${y}, ${p})`:"none",color:w?"black":"white",textShadow:`-1px -1px 0 ${S},
                                              1px -1px 0 ${S},
                                              -1px 1px 0 ${S},
                                              1px 1px 0 ${S}`,border:u?`1px solid rgba(${h}, ${m}, ${f}, ${_})`:"none",filter:Te(t.effectList)};return c("div",{key:r,class:b.layerRow},c("div",{class:b.labelElement,styles:I}," ",e.label," "))}if(e.src){const o=this._renderImage(e,i,l);return c("div",{key:r,class:b.layerRow},o,c("div",{class:b.imageLabel},e.label||""))}}_renderImage(e,t,s){const{label:r,src:i,opacity:l}=e,a={[b.imageryLayerStretchedImage]:s,[b.symbol]:!s},n={opacity:`${l!=null?l:t.opacity}`};return c("img",{alt:ae(this.messages,r,!1),src:i,border:0,width:e.width,height:e.height,class:this.classes(a),styles:n})}_renderSizeRampLines(e){const t=e.infos,s=t[0],r=t[t.length-1],i=s.symbol,l=this._hasIndicators,a=O(s.size+s.outlineSize)*Q,n=O(r.size+r.outlineSize)*Q,o=l?a:a+50*Q,d=l?a/2+50*Q:a,y=Mi(i),p=Fi(i),h=document.createElement("canvas");h.width=o,h.height=d,h.style.width=h.width/Q+"px",h.style.height=h.height/Q+"px";const m=h.getContext("2d");if(l){m.beginPath();const f=0,_=0,g=o/2-n/2,u=d;m.moveTo(f,_),m.lineTo(g,u);const w=o,S=0,I=o/2+n/2,E=d;m.moveTo(w,S),m.lineTo(I,E)}else{m.beginPath();const f=0,_=d/2-n/2,g=o,u=0;m.moveTo(f,_),m.lineTo(g,u);const w=0,S=d/2+n/2,I=o,E=d;m.moveTo(w,S),m.lineTo(I,E)}return m.strokeStyle=ki,m.stroke(),c("div",{bind:h,afterCreate:T,styles:l?{display:"flex",marginTop:`-${y?0:p?a/2:0}px`,marginBottom:`-${y?n:p?n/2:0}px`}:{display:"flex",marginRight:`-${y?0:p?a/2:0}px`,marginLeft:`-${y?0:p?n/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,r=s[0].label,i=s[s.length-1].label;let l=s[0].preview,a=s[s.length-1].preview;const n=this._hasIndicators,o={"flex-direction":n?"column":"row-reverse"};l&&(l=l.cloneNode(!0),l.style.display="flex"),a&&(a=a.cloneNode(!0),a.style.display="flex");const d={opacity:t!=null?`${t}`:""};return c("div",{class:this.classes(b.layerRow,{[b.sizeRampRow]:n})},c("div",{class:b.rampLabel},n?r:i),c("div",{class:b.sizeRampContainer,styles:o},c("div",{bind:l,afterCreate:T,class:b.sizeRampPreview,styles:d}),this._renderSizeRampLines(e),c("div",{bind:a,afterCreate:T,class:b.sizeRampContainer,styles:d})),c("div",{class:b.rampLabel},n?i:r))}_renderLegendForRamp(e,t,s){const r=e.infos,i=e.type==="heatmap-ramp",l=r.length-1,a=xi,n=l>2&&!i?zi*l:Ai,o=n+20,d=10,y=r.slice(0).reverse();y.forEach((E,z)=>{E.offset=i?E.ratio:z/l});const p=y.length-1,h=y.length%2!=0&&y[y.length/2|0],m=h&&c("div",{class:b.intervalSeparatorsContainer},c("div",{class:b.intervalSeparator},"|"),c("div",{class:b.rampLabel},h.label)),f=r[r.length-1].label,_=r[0].label,g=[[{shape:{type:"path",path:`M0 ${a/2} L${d} 0 L${d} ${a} Z`},fill:y[0].color,stroke:{width:0}},{shape:{type:"rect",x:d,y:0,width:n,height:a},fill:{type:"linear",x1:d,y1:0,x2:n+d,y2:0,colors:y},stroke:{width:0}},{shape:{type:"path",path:`M${n+d} 0 L${o} ${a/2} L${n+d} ${a} Z`},fill:y[p].color,stroke:{width:0}}]],u=Es(g,o,a),{messages:w}=this,S={filter:Te(s),opacity:t==null?null:`${t}`},I={justifyContent:"center"};return c("div",{class:b.layerRow,styles:I},c("div",{class:b.rampLabel},i?w[f]:f),c("div",{class:b.symbolContainer},c("div",{styles:S},u),m),c("div",{class:b.rampLabel},i?w[_]:_))}};v([C()],N.prototype,"activeLayerInfos",void 0),v([C()],N.prototype,"headingLevel",void 0),v([C()],N.prototype,"layout",void 0),v([C(),ve("esri/widgets/Legend/t9n/Legend")],N.prototype,"messages",void 0),v([C(),ve("esri/t9n/common")],N.prototype,"messagesCommon",void 0),v([C({readOnly:!0})],N.prototype,"type",void 0),v([C()],N.prototype,"view",void 0),v([Is()],N.prototype,"_selectSection",null),N=v([de("esri.widgets.Legend.styles.Card")],N);const $e=N,L={service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label",message:"esri-legend__message",header:"esri-widget__heading",hidden:"esri-hidden"},Bi="esri-legend__",Ni=24,nt={display:"flex",alignItems:"flex-start"},Ve={marginLeft:"3px"},Z={display:"table-cell",verticalAlign:"middle"};let W=class extends qe{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const e=this.activeLayerInfos,t=e&&e.toArray().map(s=>this._renderLegendForLayer(s)).filter(s=>!!s);return c("div",null,t&&t.length?t:c("div",{class:L.message},this.messages.noLegend))}_renderLegendForLayer(e){if(!e.ready)return null;const t=!!e.children.length,s=`${Bi}${e.layer.uid}-version-${e.version}`,r=e.title?ge({level:this.headingLevel,class:this.classes(L.header,L.label)},e.title):null;if(t){const i=e.children.map(l=>this._renderLegendForLayer(l)).toArray();return c("div",{key:s,class:this.classes(L.service,L.groupLayer)},r,i)}{const i=e.legendElements;if(i&&!i.length)return null;const l=i.map(n=>this._renderLegendForElement(n,e.layer,e.effectList)).filter(n=>!!n);if(!l.length)return null;const a={[L.groupLayerChild]:!!e.parent};return c("div",{key:s,class:this.classes(L.service,a),tabIndex:0},r,c("div",{class:L.layer},l))}}_renderLegendForElement(e,t,s,r){const i=e.type==="color-ramp",l=e.type==="opacity-ramp",a=e.type==="size-ramp";let n=null;if(e.type==="symbol-table"||a){const m=e.infos.map(f=>this._renderLegendForElementInfo(f,t,s,a,e.legendType)).filter(f=>!!f);m.length&&(n=c("div",{class:L.layerBody},m))}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"||e.type==="stretch-ramp"?n=this._renderLegendForRamp(e,t.opacity):e.type==="relationship-ramp"?n=Tt(e,this.id,t.opacity,s):e.type==="pie-chart-ramp"?n=this._renderPieChartRamp(e):e.type==="univariate-above-and-below-ramp"?n=this._renderUnivariateAboveAndBelowRamp(e,t.opacity,s):e.type==="univariate-color-size-ramp"&&(n=this._renderUnivariateColorSizeRamp(e,t.opacity,s));if(!n)return null;const o=e.title;let d=null;if(typeof o=="string")d=o;else if(o){const m=ae(this.messages,o,i||l);d=Bt(o,i||l)&&o.title?`${o.title} (${m})`:m}const y=r?L.layerChildTable:L.layerTable,p=d?c("div",{class:L.layerCaption},d):null,h={[L.layerTableSizeRamp]:a||!r};return c("div",{class:this.classes(y,h)},p,n)}_renderPieChartRamp(e){return c("div",{bind:e.preview,afterCreate:T})}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:r,colorRampElement:i}=Ft(e,t);if(!r)return null;const l=le(r,"above",!0),a=le(r,"below",!0),n=12,o=re(i,{width:n,height:l,rampAlignment:"vertical",opacity:t,type:"above",effectList:s}),d=re(i,{width:n,height:a,rampAlignment:"vertical",opacity:t,type:"below",effectList:s}),y=_e(r),p=r.infos.map(I=>I.label),h=p.map((I,E)=>E===0?c("div",{key:E,class:I?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},I):E===2?c("div",null):null),m=p.length-1,f=Math.floor(p.length/2),_=p.map((I,E)=>E===f||E===m?c("div",{key:E,class:I?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},I):null),g={display:"table-cell",verticalAlign:"middle"},u={marginTop:`${y}px`},w={height:`${l}px`},S={height:`${a}px`};return c("div",{key:"univariate-above-and-below-ramp-preview",styles:nt},c("div",{class:L.layerBody},r.infos.map((I,E)=>c("div",{class:this.classes(L.layerRow,L.sizeRamp)},c("div",{class:L.symbol,styles:g,bind:I.preview,afterCreate:T}),o||E%2!=0?null:c("div",{class:L.layerInfo},p[E])))),o?c("div",{styles:u,key:"color-ramp-preview"},c("div",{styles:Ve},c("div",{styles:Z},c("div",{class:L.rampContainer,bind:o,afterCreate:T})),c("div",{styles:Z},c("div",{class:L.rampLabelsContainer,styles:w},h))),c("div",{styles:Ve},c("div",{styles:Z},c("div",{class:L.rampContainer,bind:d,afterCreate:T})),c("div",{styles:Z},c("div",{class:L.rampLabelsContainer,styles:S},_)))):null)}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:r,colorRampElement:i}=Mt(e);if(!r)return null;const l=_e(r),a=12,n=le(r,"full",!1),o=re(i,{width:a,height:n,rampAlignment:"vertical",opacity:t,type:"full",effectList:s}),d=r.infos.length-1,y=r.infos.map((f,_)=>_===0||_===d?c("div",{key:_,class:f.label?i?L.univariateAboveAndBelowLabel:L.rampLabel:null},f.label):null),p={display:"table-cell",verticalAlign:"middle"},h={marginTop:`${l}px`},m={height:`${n}px`};return c("div",{key:"univariate-above-and-below-ramp-preview",styles:nt},c("div",{class:L.layerBody},r.infos.map(f=>c("div",{class:this.classes(L.layerRow,L.sizeRamp)},c("div",{class:L.symbol,styles:p,bind:f.preview,afterCreate:T})))),c("div",{styles:h,key:"color-ramp-preview"},c("div",{styles:Ve},c("div",{styles:Z},c("div",{class:L.rampContainer,bind:o,afterCreate:T})),c("div",{styles:Z},c("div",{class:L.rampLabelsContainer,styles:m},y)))))}_renderLegendForRamp(e,t){const s=e.infos,r=e.type==="opacity-ramp",i=e.type==="heatmap-ramp",l=e.type==="stretch-ramp",a=e.preview,n=r?L.opacityRamp:"";a.className=`${L.colorRamp} ${n}`,t!=null&&(a.style.opacity=t.toString());const o=s.map(p=>c("div",{class:p.label?L.rampLabel:null},i?this.messages[p.label]||p.label:l?this._getStretchStopLabel(p):p.label)),d={width:`${Ni}px`},y={height:a.style.height};return c("div",{class:L.layerRow},c("div",{class:L.symbolContainer,styles:d},c("div",{class:L.rampContainer,bind:a,afterCreate:T})),c("div",{class:L.layerInfo},c("div",{class:L.rampLabelsContainer,styles:y},o)))}_getStretchStopLabel(e){return e.label?this.messages[e.label]+": "+(typeof e.value=="string"?e.value:yt(e.value,{style:"decimal",notation:e.value.toString().includes("e")?"scientific":"standard"})):""}_renderLegendForElementInfo(e,t,s,r,i){if(e.type)return this._renderLegendForElement(e,t,s,!0);let l=null;const a=Nt(t,i);if(e.preview?l=c("div",{class:L.symbol,bind:e.preview,afterCreate:T}):e.src&&(l=this._renderImage(e,t,a)),!l)return null;const n={[L.imageryLayerInfoStretched]:a},o={[L.imageryLayerInfoStretched]:a,[L.sizeRamp]:!a&&r};return c("div",{class:L.layerRow},c("div",{class:this.classes(L.symbolContainer,o)},l),c("div",{class:this.classes(L.layerInfo,n)},ae(this.messages,e.label,!1)||""))}_renderImage(e,t,s){const{label:r,src:i,opacity:l}=e,a={[L.imageryLayerStretchedImage]:s,[L.symbol]:!s},n={opacity:`${l!=null?l:t.opacity}`};return c("img",{alt:ae(this.messages,r,!1),src:i,border:0,width:e.width,height:e.height,class:this.classes(a),styles:n})}};v([C()],W.prototype,"activeLayerInfos",void 0),v([C()],W.prototype,"headingLevel",void 0),v([C(),ve("esri/widgets/Legend/t9n/Legend")],W.prototype,"messages",void 0),v([C({readOnly:!0})],W.prototype,"type",void 0),W=v([de("esri.widgets.Legend.styles.Classic")],W);const X=W,me={base:"esri-legend",widget:"esri-widget",panel:"esri-widget--panel",widgetIcon:"esri-icon-layer-list"};let A=class extends qe{constructor(e,t){super(e,t),this._handles=new Le,this.activeLayerInfos=null,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.headingLevel=3,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.iconClass=me.widgetIcon,this.label=void 0,this.layerInfos=null,this.messages=null,this.style=new X,this.view=null,this.viewModel=new Si}initialize(){this.own([fe(()=>this.view,"resize",()=>this.scheduleRender()),fe(()=>this.activeLayerInfos,"change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),$(()=>this.headingLevel,e=>{const{style:t}=this;t&&(t.headingLevel=e)}),$(()=>this.style,(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)},ie)])}destroy(){this._handles=$s(this._handles)}castStyle(e){if(e instanceof $e||e instanceof X)return e;if(typeof e=="string")return e==="card"?new $e:new X;if(e&&typeof e.type=="string"){const t={...e};return delete t.type,new(e.type==="card"?$e:X)(t)}return new X}render(){return c("div",{class:this.classes(me.base,me.widget,this.style instanceof X?me.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){this._handles.removeAll(),e.forEach(t=>this._renderOnActiveLayerInfoChange(t)),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){const t=$(()=>e.version,()=>this.scheduleRender());this._handles.add(t,`version_${e.layer.uid}`);const s=fe(()=>e.children,"change",()=>e.children.forEach(r=>this._renderOnActiveLayerInfoChange(r)),ie);this._handles.add(s,`children_${e.layer.uid}`),e.children.forEach(r=>this._renderOnActiveLayerInfoChange(r))}};v([D("viewModel.activeLayerInfos")],A.prototype,"activeLayerInfos",void 0),v([D("viewModel.basemapLegendVisible")],A.prototype,"basemapLegendVisible",void 0),v([D("viewModel.groundLegendVisible")],A.prototype,"groundLegendVisible",void 0),v([C()],A.prototype,"headingLevel",void 0),v([D("viewModel.hideLayersNotInCurrentView")],A.prototype,"hideLayersNotInCurrentView",void 0),v([D("viewModel.keepCacheOnDestroy")],A.prototype,"keepCacheOnDestroy",void 0),v([D("viewModel.respectLayerVisibility")],A.prototype,"respectLayerVisibility",void 0),v([C()],A.prototype,"iconClass",void 0),v([C({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],A.prototype,"label",void 0),v([D("viewModel.layerInfos")],A.prototype,"layerInfos",void 0),v([C(),ve("esri/widgets/Legend/t9n/Legend")],A.prototype,"messages",void 0),v([C()],A.prototype,"style",void 0),v([Rs("style")],A.prototype,"castStyle",null),v([D("viewModel.view")],A.prototype,"view",void 0),v([C()],A.prototype,"viewModel",void 0),A=v([de("esri.widgets.Legend")],A);const Gi=A;export{Gi as default};
