import{s as k}from"./CircularArray.cd244cd7.js";import{w as f,l as d,b5 as j,de as N,a6 as q,C as P,e as y,n as b,ai as x,g as S,bO as A,l6 as R,s as a,l7 as L,eE as E,U,cd as D,_ as W,P as B,an as F,aR as $,k as G,iP as I}from"./index.46140dee.js";const M="__esri_stream_id__",O="__esri_timestamp__",C=1e3;class K{constructor(e,s,r,o,i=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=r,this._purgeOptions=o,this.store=e,this.objectIdField=s,this.purgeInterval=i,this._useGeneratedIds=this.objectIdField===M}add(e){if(this._useGeneratedIds){const o=this._nextId();e.attributes[this.objectIdField]=o,e.objectId=o}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return f(this._trackIdLessObservations)&&(this._trackIdLessObservations=new k(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);const s=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(s)){const o=d(this._purgeOptions)&&this._purgeOptions.maxObservations!=null?this._purgeOptions.maxObservations:C,i=N(o,0,C);this._trackIdToObservations.set(s,new k(i))}const r=this._trackIdToObservations.get(s).enqueue(e.objectId);d(r)&&(this._addOrUpdated.has(r)?this._addOrUpdated.delete(r):this._removed.push(r))}checkForUpdates(){const e=this._getToAdd(),s=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);const o=[];if(d(s))for(const i of s){const c=this.store.removeById(i);d(c)&&o.push(c)}if(d(e))for(const i of e)i.attributes[O]=r,this.store.add(i);(e||o)&&this.store.update(e,o)}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let s=0;return this._addOrUpdated.forEach(r=>e[s++]=r),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const s=this._purgeOptions;d(s)&&(this._purgeSomeByDisplayCount(s),this._purgeByAge(s),this._purgeByAgeReceived(e,s),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let s=this.store.size;if(s>e.displayCount){if(this._timeInfo.trackIdField){for(const r of this._trackIdToObservations.values())if(s>e.displayCount&&r.size){const o=j(r.dequeue());this._removed.push(o),s--}}if(d(this._trackIdLessObservations)){let r=s-e.displayCount;for(;r-- >0;){const o=this._trackIdLessObservations.dequeue();d(o)&&this._removed.push(o)}}}}_purgeByAge(e){var o;if(!e.age||!((o=this._timeInfo)!=null&&o.startTimeField))return;const s=60*e.age*1e3,r=this._maxAge-s;this.store.forEach(i=>{i.attributes[this._timeInfo.startTimeField]<r&&this._removed.push(i.objectId)})}_purgeByAgeReceived(e,s){if(!s.ageReceived)return;const r=e-60*s.ageReceived*1e3;this.store.forEach(o=>{o.attributes[O]<r&&this._removed.push(o.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,s)=>{e.size===0&&this._trackIdToObservations.delete(s)})}}let m=class extends q.EventedMixin(P){onFeature(t){this.emit("feature",t)}};m=y([b("esri.layers.graphics.sources.connections.StreamConnection")],m);const J=m,l=x.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var p;(function(t){t[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CLOSING=2]="CLOSING",t[t.CLOSED=3]="CLOSED"})(p||(p={}));let g=class extends J{constructor(t){super(),this.errorString=null;const{geometryType:e,spatialReference:s,sourceSpatialReference:r}=t;this._config=t,this._featureZScaler=A(e,r,s),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){d(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(f(this._websocket))return"disconnected";switch(this._websocket.readyState){case p.CONNECTING:case p.OPEN:return"connected";case p.CLOSING:case p.CLOSED:return"disconnected"}}async _tryCreateWebSocket(t=this._config.source.path,e=1e3,s=0){try{if(this.destroyed)return;const r=R(t,this._config.customParameters);this._websocket=await this._createWebSocket(r),this.notifyChange("connectionStatus")}catch(r){const o=e/1e3;return this._config.maxReconnectionAttempts&&s>=this._config.maxReconnectionAttempts?(l.error(new a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(l.error(new a("websocket-connection",`Failed to connect. Attempting to reconnect in ${o}s`,r)),await L(e),this._tryCreateWebSocket(t,Math.min(1.5*e,1e3*this._config.maxReconnectionInterval),s+1))}}_createWebSocket(t){return new Promise((e,s)=>{const r=new WebSocket(t);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=o=>this._onClose(o),r.onerror=o=>this._onError(o),r.onmessage=o=>this._onMessage(o),e(r)},r.onclose=o=>{r.onopen=r.onclose=null,s(o)}})}async _handshake(t=1e4){const e=this._websocket;if(f(e))return;const s=E(),r=e.onmessage,{filter:o,outFields:i,spatialReference:c}=this._config;return s.timeout(t),e.onmessage=h=>{var n;let u=null;try{u=JSON.parse(h.data)}catch{}u&&typeof u=="object"||(l.error(new a("websocket-connection","Protocol violation. Handshake failed - malformed message",h.data)),s.reject(),this.destroy()),((n=u.spatialReference)==null?void 0:n.wkid)!==(c==null?void 0:c.wkid)&&(l.error(new a("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${c.wkid}`,h.data)),s.reject(),this.destroy()),u.format!=="json"&&(l.error(new a("websocket-connection","Protocol violation. Handshake failed - format is not set",h.data)),s.reject(),this.destroy()),o&&u.filter!==o&&l.error(new a("websocket-connection","Tried to set filter, but server doesn't support it")),i&&u.outFields!==i&&l.error(new a("websocket-connection","Tried to set outFields, but server doesn't support it")),e.onmessage=r,s.resolve()},e.send(JSON.stringify({filter:o,outFields:i,format:"json",spatialReference:{wkid:c.wkid}})),s.promise}_onMessage(t){try{const e=JSON.parse(t.data);if(e.type!=="featureResult")throw new a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",e);for(const s of e.features)d(this._featureZScaler)&&this._featureZScaler(s.geometry),this.onFeature(s)}catch(e){return l.error(new a("websocket-connection","Failed to parse message",e)),void this.destroy()}}_onError(t){const e="Encountered an error over WebSocket connection";this._set("errorString",e),l.error("websocket-connection",e)}_onClose(t){this._websocket=null,this.notifyChange("connectionStatus"),t.code!==1e3&&l.error("websocket-connection",`WebSocket closed unexpectedly with error code ${t.code}`),this.destroyed||this._open()}};y([S()],g.prototype,"connectionStatus",null),y([S()],g.prototype,"errorString",void 0),g=y([b("esri.layers.graphics.sources.connections.WebSocketConnection")],g);const _=x.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),z=1e4,Q={maxQueryDepth:5,maxRecordCountFactor:3};let w=class extends g{constructor(t){super({...Q,...t})}async _open(){const t=await this._fetchServiceDefinition(this._config.source);t.timeInfo.trackIdField||_.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const e=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(e);const{filter:s,outFields:r}=this._config;this.destroyed||this._setFilter(s,r)}_onMessage(t){let e;try{e=this._enrich(JSON.parse(t.data)),d(this._featureZScaler)&&this._featureZScaler(e.geometry)}catch(s){return void _.error(new a("geoevent-connection","Failed to parse message",s))}this.onFeature(e)}async _fetchServiceDefinition(t){const e={f:"json",...this._config.customParameters},s=U(t.path,{query:e,responseType:"json"}),r=(await s).data;return this._serviceDefinition=r,r}_fetchWebSocketUrl(t,e){const s=t[0],{urls:r,token:o}=s,i=this._inferWebSocketBaseUrl(r);return R(`${i}/subscribe`,{outSR:""+e.wkid,token:o})}_inferWebSocketBaseUrl(t){if(t.length===1)return t[0];for(const e of t)if(e.includes("wss"))return e;return _.error(new a("geoevent-connection","Unable to infer WebSocket url",t)),null}async _setFilter(t,e){const s=this._websocket;if(f(s)||f(t)&&f(e))return;const r=JSON.stringify({filter:this._serializeFilter(t,e)});let o=!1;const i=E(),c=()=>{o||(this.destroyed||this._websocket!==s||_.error(new a("geoevent-connection","Server timed out when setting filter")),i.reject())},h=u=>{const n=JSON.parse(u.data);n.filter&&(n.error&&(_.error(new a("geoevent-connection","Failed to set service filter",n.error)),this._set("errorString",`Could not set service filter - ${n.error}`),i.reject(n.error)),s.onmessage=this._onMessage.bind(this),o=!0,i.resolve())};return s.onmessage=h,s.send(r),setTimeout(c,z),i.promise}_serializeFilter(t,e){const s={};if(f(t)&&f(e))return s;if(d(t)&&t.geometry)try{const r=D(t.geometry);if(r.type!=="extent")throw new a(`Expected extent but found type ${r.type}`);s.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){_.error(new a("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return d(t)&&t.where&&t.where!=="1 = 1"&&(s.where=t.where),d(e)&&(s.outFields=e.join(",")),s}_enrich(t){if(!this._relatedFeatures)return t;const e=this._serviceDefinition.relatedFeatures.joinField,s=t.attributes[e];if(!this._relatedFeatures.has(s))return _.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",t),t;const{attributes:r,geometry:o}=this._relatedFeatures.get(s);for(const i in r)t.attributes[i]=r[i];return o&&(t.geometry=o),t.geometry||t.centroid||_.error(new a("geoevent-connection","Found malformed feature - no geometry found",t)),t}async _queryBuddyServices(){try{const{relatedFeatures:t,keepLatestArchive:e}=this._serviceDefinition,s=this._queryRelatedFeatures(t),r=this._queryArchive(e);await s;const o=await r;if(!o)return;for(const i of o.features)this.onFeature(this._enrich(i))}catch(t){_.error(new a("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}}async _queryRelatedFeatures(t){if(!t)return;const e=await this._queryBuddy(t.featuresUrl);this._addRelatedFeatures(e)}async _queryArchive(t){if(t)return this._queryBuddy(t.featuresUrl)}async _queryBuddy(t){const e=new(await W(()=>import("./index.46140dee.js").then(T=>T.x$),["assets/index.46140dee.js","assets/index.2c2ebad2.css"])).default({url:t}),{capabilities:s}=await e.load(),r=s.query.supportsMaxRecordCountFactor,o=s.query.supportsPagination,i=s.query.supportsCentroid,c=this._config.maxRecordCountFactor,h=e.capabilities.query.maxRecordCount,u=r?h*c:h,n=new B;if(n.outFields=F(this._config.outFields,["*"]),n.where=F($(this._config.filter,"where"),"1=1"),n.returnGeometry=!0,n.returnExceededLimitFeatures=!0,n.outSpatialReference=G.fromJSON(this._config.spatialReference),i&&(n.returnCentroid=!0),r&&(n.maxRecordCountFactor=c),o)return n.num=u,e.destroy(),this._queryPages(t,n);const v=await I(t,n,this._config.sourceSpatialReference);return e.destroy(),v.data}async _queryPages(t,e,s=[],r=0){e.start=d(e.num)?r*e.num:null;const{data:o}=await I(t,e,this._config.sourceSpatialReference);return o.exceededTransferLimit&&r<this._config.maxQueryDepth?(o.features.forEach(i=>s.push(i)),this._queryPages(t,e,s,r+1)):(s.forEach(i=>o.features.push(i)),o)}_addRelatedFeatures(t){const e=new Map,s=t.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const o of s){const i=o.attributes[r];e.set(i,o)}this._relatedFeatures=e}};w=y([b("esri.layers.graphics.sources.connections.GeoEventConnection")],w);const Z=w;function X(t,e,s,r,o,i,c,h){const u=t.path.indexOf("wss://")===0||t.path.indexOf("ws://")===0,n={source:t,sourceSpatialReference:e,spatialReference:s,geometryType:r,filter:o,maxReconnectionAttempts:i,maxReconnectionInterval:c,customParameters:h};return u?new g(n):new Z(n)}export{K as h,X as t};
