import{c9 as l,aG as o,w as m,e as h,n as p}from"./index.deeeec5f.js";import{q as c}from"./DynamicLayerView3D.74ae632f.js";import{m as g}from"./ImageryLayerView.669e5459.js";import"./LayerView3D.c5251fa1.js";import"./projectExtentUtils.25830a05.js";import"./LayerView.01f05af6.js";import"./RefreshableLayerView.92abe7be.js";import"./popupUtils.06b99c9e.js";let s=class extends g(c){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=l(async e=>{this.redraw((a,t)=>this._redrawImage(a,t),e)},2e3)}initialize(){this.handles.add([o(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))]),this.updatingHandles.add(()=>{var e,a;return(a=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:a.version},()=>{this.updatingHandles.addPromise(this.refreshDebounced())}),this.updatingHandles.add(()=>this.timeExtent,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){const e=this.view.basemapTerrain.spatialReference,a=this.layer.fullExtent;!a||e.equals(a.spatialReference),this.maximumDataResolution={x:this.layer.pixelSizeX,y:this.layer.pixelSizeY}}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,a,t){a.imageElement?e.image=a.imageElement:(e.image=document.createElement("canvas"),e.pixelData=a.pixelData,await this._redrawImage(e,t))}async _redrawImage(e,a){if(!(e.image instanceof HTMLCanvasElement)||m(e.pixelData))throw new Error;const t=e.image,r=t.getContext("2d"),d=await this.layer.applyRenderer(e.pixelData,{signal:a}),i=this.layer.applyFilter(d).pixelBlock;if(m(i))throw new Error;t.width=i.width,t.height=i.height;const n=r.createImageData(i.width,i.height);n.data.set(i.getAsRGBA()),r.putImageData(n,0,0)}};s=h([p("esri.views.3d.layers.ImageryLayerView3D")],s);const v=s;export{v as default};
