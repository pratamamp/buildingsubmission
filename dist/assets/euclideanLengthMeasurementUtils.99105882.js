import{w as P,aJ as D,ax as j,l as d,ne as J,j$ as H,c9 as F,e as E,y as K,aK as L,g as I,n as Q,iz as A,nk as W,nl as U,aV as M,i3 as O,aU as X,at as z}from"./index.46140dee.js";import{r as Y}from"./dehydratedFeatureComparison.e934c649.js";import{G as N}from"./InteractiveToolBase.8fb2c02d.js";import{e as $}from"./SnappingContext.5a2828cb.js";import{o as h}from"./quantityUtils.c8da0946.js";import{i as V}from"./measurementUtils.f53ec32e.js";class ut{constructor(){this.next=new N}createSnapDragEventPipelineStep({predicate:n=()=>!0,cancel:e,snappingManager:r,snappingContext:s,updatingHandles:c}){if(P(r))return a=>a;let p=null,o=null;const y=()=>{p=H(p),r.doneSnapping(),d(o)&&o.frameTask.remove(),o=null};e.next(a=>(y(),a)),this.next=new N;const C=F(async({frameTask:a,point:u,context:v,event:m,dx:R,dy:Z},x)=>{const _=await a.schedule(()=>r.snap(u,v,x),x);if(_.valid){let w=await a.schedule(()=>_.apply(),x);u!==f&&(w=r.update(f,v)),Y(w,g)||(m.mapEnd.x=w.x+R,m.mapEnd.y=w.y+Z,this.next.execute(m))}});let f,g;return a=>{if(!n(a))return a;if(a.action==="start"){const u=r.view.type==="3d"?r.view.resourceController.scheduler.registerTask(D.SNAPPING):j;o={context:new $({editGeometryOperations:s.editGeometryOperations,elevationInfo:s.elevationInfo,pointer:s.pointer,vertexHandle:d(a.info)?a.info.handle:null,excludeFeature:s.excludeFeature,visualizer:s.visualizer}),originalPos:d(a.snapOrigin)?s.coordinateHelper.vectorToDehydratedPoint(a.snapOrigin):a.mapStart,frameTask:u}}if(d(o)){const u=o.context.coordinateHelper.vectorToDehydratedPoint(o.context.coordinateHelper.arrayToVector([o.originalPos.x,o.originalPos.y,o.originalPos.z]));u.x+=a.mapEnd.x-a.mapStart.x,u.y+=a.mapEnd.y-a.mapStart.y;const v=a.mapStart.x-o.originalPos.x,m=a.mapStart.y-o.originalPos.y,R={...a,action:"update"},Z=o.context,x=r.update(u,o.context);if(g=x,a.mapEnd.x=x.x+v,a.mapEnd.y=x.y+m,f=u,a.action!=="end"){const _=o.frameTask;d(p)||(p=new AbortController),c.addPromise(J(C({frameTask:_,event:R,context:Z,point:u,dx:v,dy:m},p.signal)))}}return a.action==="end"&&y(),a}}}let T=class extends K{constructor(t){super(t),this.stagedPoint=null,this._abortController=null,this._snap=F(async(n,e,r,s)=>{const c=await this._frameTask.schedule(()=>e.snap(n,r,s),s);c.valid&&await this._frameTask.schedule(()=>{this.stagedPoint=c.apply(),n!==this._snapMapPoint&&(this.stagedPoint=e.update(this._snapMapPoint,r))},s)})}initialize(){var n,e;const t=this.view.type==="3d"?(e=(n=this.view)==null?void 0:n.resourceController)==null?void 0:e.scheduler:null;this._frameTask=d(t)?t.registerTask(D.SNAPPING):j}destroy(){this._abortController=H(this._abortController),this._frameTask=L(this._frameTask)}async snap(t,n,e){return this.stagedPoint=n.update(t,e),this._snapMapPoint=t,P(this._abortController)&&(this._abortController=new AbortController),this._snap(t,n,e,this._abortController.signal)}abort(){this._abortController=H(this._abortController)}};E([I({constructOnly:!0})],T.prototype,"view",void 0),E([I()],T.prototype,"stagedPoint",void 0),T=E([Q("esri.views.interactive.snapping.SnappingOperation")],T);function pt(t){return q(t,"direct")}function dt(t){return q(t,"horizontal")}function q(t,n){const{hasZ:e,spatialReference:r}=t,s=V(r);let c=0;const p=U(s);if(P(p))return null;const o=n==="direct"?nt:B;for(const y of t.paths){if(y.length<2)continue;const C=y.length-1;for(let f=0;f<C;++f){const g=y[f];i[0]=g[0],i[1]=g[1],i[2]=e?g[2]:0;const a=y[f+1];l[0]=a[0],l[1]=a[1],l[2]=e?a[2]:0;const u=o(i,l,r);if(P(u))return null;c+=u.value}}return h(c,p)}function ft(t,n){const{spatialReference:e}=t;return A(e,n.spatialReference)?(i[0]=t.x,i[1]=t.y,i[2]=t.hasZ?t.z:0,l[0]=n.x,l[1]=n.y,l[2]=n.hasZ?n.z:0,tt(i,l,e)):null}function ht(t,n){const{spatialReference:e}=t;return A(e,n.spatialReference)?(i[0]=t.x,i[1]=t.y,i[2]=t.hasZ?t.z:0,l[0]=n.x,l[1]=n.y,l[2]=n.hasZ?n.z:0,B(i,l,e)):null}function yt(t,n){const{spatialReference:e}=t;return A(e,n.spatialReference)?(i[0]=t.x,i[1]=t.y,i[2]=t.hasZ?t.z:0,l[0]=n.x,l[1]=n.y,l[2]=n.hasZ?n.z:0,et(i,l,e)):null}function xt(t){return i[0]=t.x,i[1]=t.y,i[2]=t.hasZ?t.z:0,rt(i,t.spatialReference)}function tt(t,n,e){const r=S(t,n,e);return d(r)?{direct:h(r.direct,r.unit),horizontal:h(r.horizontal,r.unit),vertical:h(r.vertical,r.unit)}:null}function nt(t,n,e){const r=S(t,n,e,"direct");return d(r)?h(r.direct,r.unit):null}function B(t,n,e){const r=S(t,n,e,"horizontal");return d(r)?h(r.horizontal,r.unit):null}function et(t,n,e){const r=S(t,n,e,"vertical");return d(r)?h(r.verticalSigned,r.unit):null}function rt(t,n){const e=W(n);return d(e)?h(t[2],e):null}function S(t,n,e,r){const s=V(e),c=U(s);if(P(c))return null;const p=n[2]-t[2];if(r==="vertical")return{verticalSigned:p,unit:c};if(!M(t,e,G,s)||!M(n,e,b,s))return null;if(r==="direct")return{direct:O(b,G),unit:c};if(X(k,t[0],t[1],n[2]),!M(k,e,k,s))return null;const o=O(k,b);return r==="horizontal"?{horizontal:o,unit:c}:{direct:O(b,G),horizontal:o,vertical:Math.abs(p),unit:c}}const i=z(),l=z(),G=z(),b=z(),k=z();export{B as Z,dt as a,yt as b,ut as d,pt as f,et as g,T as h,ft as m,xt as v,nt as x,ht as y};
