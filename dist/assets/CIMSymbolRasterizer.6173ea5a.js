import{c2 as W,ae as j,fz as q,U as B,eD as f,cT as M,us as K,m as Q,fw as Z,ut as $,uu as N,dJ as U,dN as ee}from"./index.ffdd6b96.js";import{Y as te,s as ae}from"./cimAnalyzer.950d7376.js";import{d as re,s as ie}from"./CIMSymbolHelper.d25c3642.js";import{m as se}from"./Rasterizer.3af7a8b9.js";import"./enums.05a6ea95.js";import"./definitions.8fc39ccc.js";import"./BidiEngine.ec67919b.js";import"./alignmentUtils.63b4d661.js";import"./number.08b65821.js";import"./GeometryUtils.814cb798.js";var F;(function(m){m.Legend="legend",m.Preview="preview"})(F||(F={}));const D=(m,e,t)=>{if(m&&m.targetSize){let s;if(t){const r=Math.max(t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin);s=m.targetSize/M(r)}else s=m.targetSize/e.referenceSize;return s}return m&&m.scaleFactor?m.scaleFactor:1},J={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class Me{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new re,this._cimResourceManager=new ie,this._rasterizer=new se(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,s,r,a,i,o,n){r=r||(t?t.centroid!=null?"esriGeometryPolygon":W(t.geometry):null)||oe(e);const c=await this.analyzeCIMSymbol(e,t?ne(t.attributes):null,s,r,n);return this.rasterizeCIMSymbol(c,t,r,a,i,o)}async analyzeCIMSymbol(e,t,s,r,a){const i=[],o=t?{geometryType:r,spatialReference:this._spatialReference,fields:t}:null;let n;await te(e.data,o,this._cimResourceManager,i,this._avoidSDF),j(a);for(const c of i)c.cim.type!=="CIMPictureMarker"&&c.cim.type!=="CIMPictureFill"&&c.cim.type!=="CIMPictureStroke"||(n||(n=[]),n.push(this._fetchPictureMarkerResource(c,a))),s&&c.type==="text"&&typeof c.text=="string"&&c.text.includes("[")&&(c.text=q(s,c.text,c.cim.textCase));return n&&await Promise.all(n),i}async _fetchPictureMarkerResource(e,t){const s=e.materialHash;if(!this._pictureMarkerCache.get(s)){const r=(await B(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(s,r)}}rasterizeCIMSymbol(e,t,s,r,a,i){const o=[];for(const n of e){r&&typeof r.scaleFactor=="function"&&(r.scaleFactor=r.scaleFactor(t,a,i));const c=this._getRasterizedResource(n,t,s,r,a,i);if(!c)continue;let p=0,I=c.anchorX||0,y=c.anchorY||0,l=!1,g=0,h=0;if(s==="esriGeometryPoint"){const u=D(r,n,null);if(g=f(n.offsetX,t,a,i)*u||0,h=f(n.offsetY,t,a,i)*u||0,n.type==="marker")p=f(n.rotation,t,a,i)||0,l=!!n.rotateClockwise&&n.rotateClockwise;else if(n.type==="text"){if(p=f(n.angle,t,a,i)||0,n.horizontalAlignment!==void 0)switch(n.horizontalAlignment){case"left":I=-.5;break;case"right":I=.5;break;default:I=0}if(n.verticalAlignment!==void 0)switch(n.verticalAlignment){case"top":y=.5;break;case"bottom":y=-.5;break;case"baseline":y=-.25;break;default:y=0}}}c!=null&&o.push({angle:p,rotateClockWise:l,anchorX:I,anchorY:y,offsetX:g,offsetY:h,rasterizedResource:c})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),s=t.getContext("2d");let r=0,a=0,i=0,o=0;const n=[];for(let y=0;y<e.length;y++){const l=e[y],g=l.rasterizedResource;if(!g)continue;const h=g.size,u=l.offsetX,d=l.offsetY,C=l.anchorX,P=l.anchorY,z=l.rotateClockWise||!1;let _=l.angle,x=M(u)-h[0]*(.5+C),w=M(d)-h[1]*(.5+P),b=x+h[0],S=w+h[1];if(_){z&&(_=-_);const k=Math.sin(_*Math.PI/180),v=Math.cos(_*Math.PI/180),Y=x*v-w*k,A=x*k+w*v,X=x*v-S*k,G=x*k+S*v,H=b*v-S*k,L=b*k+S*v,O=b*v-w*k,V=b*k+w*v;x=Math.min(Y,X,H,O),w=Math.min(A,G,L,V),b=Math.max(Y,X,H,O),S=Math.max(A,G,L,V)}r=x<r?x:r,a=w<a?w:a,i=b>i?b:i,o=S>o?S:o;const T=s.createImageData(g.size[0],g.size[1]);T.data.set(new Uint8ClampedArray(g.image.buffer));const E={offsetX:u,offsetY:d,rotateClockwise:z,angle:_,rasterizedImage:T,anchorX:C,anchorY:P};n.push(E)}t.width=i-r,t.height=o-a;const c=-r,p=o;for(let y=0;y<n.length;y++){const l=n[y],g=this._imageDataToCanvas(l.rasterizedImage),h=l.rasterizedImage.width,u=l.rasterizedImage.height,d=c-h*(.5+l.anchorX),C=p-u*(.5-l.anchorY);if(l.angle){const P=(360-l.angle)*Math.PI/180;s.save(),s.translate(M(l.offsetX),-M(l.offsetY)),s.translate(c,p),s.rotate(P),s.translate(-c,-p),s.drawImage(g,d,C),s.restore()}else s.drawImage(g,d+M(l.offsetX),C-M(l.offsetY))}const I=new K({x:c/t.width-.5,y:p/t.height-.5});return{imageData:t.width!==0&&t.height!==0?s.getImageData(0,0,t.width,t.height):s.createImageData(1,1),anchorPosition:I}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,s=t.getContext("2d");return t.width=e.width,t.height=e.height,s.putImageData(e,0,0),t}_imageTo32Array(e,t,s,r){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,i=a.getContext("2d");if(a.width=t,a.height=s,i.drawImage(e,0,0,t,s),r){i.save();const o=new Q(r);i.fillStyle=o.toHex(),i.globalCompositeOperation="multiply",i.fillRect(0,0,t,s),i.globalCompositeOperation="destination-atop",i.drawImage(e,0,0,t,s),i.restore()}return new Uint32Array(i.getImageData(0,0,t,s).data.buffer)}_getRasterizedResource(e,t,s,r,a,i){let o,n,c,p,I=null,y=null;if(s==="esriGeometryPolyline"||s==="esriGeometryPolygon"){const g=r&&r.style?r.style:F.Legend,h=s==="esriGeometryPolyline"?J.stroke[g]:J.fill[g];if(e.type==="line"){if(e.cim.type!=="CIMSolidStroke"){if(e.cim.type==="CIMPictureStroke"){const u=f(e.width,t,a,i),d=f(e.color,t,a,i),{image:C,width:P,height:z}=this._getPictureResource(e,u,d);return this._rasterizePictureResource(e,C,P,z,h,u)}return null}({analyzedCIM:o,hash:c}=R(e,t,a,i)),n=this._embedCIMLayerInVectorMarker(o,h)}else if(e.type==="marker"){if(e.cim.type==="CIMPictureMarker"){const u=f(e.size,t,a,i),d=f(e.color,t,a,i),{image:C,width:P,height:z}=this._getPictureResource(e,u,d);return this._rasterizePictureResource(e,C,P,z,h,u)}if(e.cim.type!=="CIMVectorMarker")return null;e.cim.offsetX=f(e.offsetX,t,a,i),e.cim.offsetY=f(e.offsetY,t,a,i),e.cim.rotation=f(e.rotation,t,a,i),e.cim.markerPlacement=e.markerPlacement,{analyzedCIM:o}=R(e,t,a,i),c=Z(JSON.stringify(o)).toString(),n=this._embedCIMLayerInVectorMarker(o,h),I=f(e.size,t,a,i),y=e.path}else{if(e.type==="text")return null;if(e.type==="fill"){if(e.cim.type==="CIMHatchFill"||e.cim.type==="CIMVectorMarker"||e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill"){const u=e.cim.size||e.cim.height;let d,C,P;if(e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill")({image:d,width:C,height:P}=this._getPictureResource(e,u,f(e.color,t,a,i)));else{({analyzedCIM:o,hash:c}=R(e,t,a,i));const z=this._rasterizer.rasterizeJSONResource({cim:o,type:e.type,url:e.url,mosaicHash:c,size:u,path:y},1,this._avoidSDF);d=z.image,C=z.size[0],P=z.size[1]}return this._rasterizePictureResource(e,d,C,P,h,null)}if(e.cim.type!=="CIMSolidFill")return null;({analyzedCIM:o,hash:c}=R(e,t,a,i)),n=this._embedCIMLayerInVectorMarker(o,h)}}}else{if(e.type==="text")return p=this._rasterizeTextResource(e,t,r,a,i),p;({analyzedCIM:o,hash:c}=R(e,t,a,i));const g=D(r,e,null);if(e.cim.type==="CIMPictureMarker"){const h=f(e.size,t,a,i)*g,{image:u,width:d,height:C}=this._getPictureResource(e,h,f(e.color,t,a,i));return p={image:u,size:[d,C],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},p}$(o,g,{preserveOutlineWidth:!1}),n=o}c+=s,r&&(c+=JSON.stringify(r));const l=this._resourceCache;return l.has(c)?l.get(c):(p=this._rasterizer.rasterizeJSONResource({cim:n,type:e.type,url:e.url,mosaicHash:c,size:I,path:y},window.devicePixelRatio||1,this._avoidSDF),l.set(c,p),p)}_rasterizeTextResource(e,t,s,r,a){const i=D(s,e,null),o=f(e.text,t,r,a);if(!o||o.length===0)return null;const n=f(e.fontName,t,r,a),c=f(e.style,t,r,a),p=f(e.weight,t,r,a),I=f(e.decoration,t,r,a),y=f(e.size,t,r,a)*i,l=f(e.horizontalAlignment,t,r,a),g=f(e.verticalAlignment,t,r,a),h=N(f(e.color,t,r,a)),u=N(f(e.outlineColor,t,r,a)),d={color:h,size:y,horizontalAlignment:l,verticalAlignment:g,font:{family:n,style:c,weight:p,decoration:I},halo:{size:f(e.outlineSize,t,r,a)||0,color:u,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,d)}_rasterizePictureResource(e,t,s,r,a,i){const o=document.createElement("canvas"),n=o.getContext("2d");o.height=M(Math.max(a.frame.ymax-a.frame.ymin,i)),o.width=M(a.frame.xmax-a.frame.xmin);const c=n.createImageData(s,r);c.data.set(new Uint8ClampedArray(t.buffer));const p=this._imageDataToCanvas(c),I=n.createPattern(p,"repeat"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),l=Math.sin((-e.cim.rotation||0)*Math.PI/180);I.setTransform({m11:y,m12:l,m21:-l,m22:y,m41:M(e.cim.offsetX)||0,m42:M(e.cim.offsetY)||0});const g=a.canvasPaths;let h,u,d;U(g)?(h=g.rings,n.fillStyle=I,u=n.fill,d=["evenodd"]):ee(g)&&(h=g.paths,n.strokeStyle=I,n.lineWidth=i,u=n.stroke,h[0][0][1]=o.height/2,h[0][1][1]=o.height/2),n.beginPath();for(const z of h){const _=z?z.length:0;if(_>1){let x=z[0];n.moveTo(M(x[0]),M(x[1]));for(let w=1;w<_;++w)x=z[w],n.lineTo(M(x[0]),M(x[1]));n.closePath()}}u.apply(n,d);const C=n.getImageData(0,0,o.width,o.height),P=new Uint8Array(C.data);return{size:[o.width,o.height],image:new Uint32Array(P.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,s){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const a=r.height/r.width,i=t?a>1?M(t):M(t)/a:r.width,o=t?a>1?M(t)*a:M(t):r.height;return{image:this._imageTo32Array(r,i,o,s),width:i,height:o}}_embedCIMLayerInVectorMarker(e,t){const s=U(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",r=t.frame;return{type:"CIMVectorMarker",frame:r,size:r.ymax-r.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:s,symbolLayers:[e]}}]}}}function ne(m){return(m?Object.keys(m):[]).map(e=>({name:e,alias:e,type:typeof m[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}function oe(m){if(!(m&&m.data&&m.data.symbol))return null;switch(m.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function R(m,e,t,s){let r,a;return typeof m.materialHash=="function"?(r=(0,m.materialHash)(e,t,s),a=ae(m.cim,m.materialOverrides)):(r=m.materialHash,a=m.cim),{analyzedCIM:a,hash:r}}export{Me as CIMSymbolRasterizer,F as GeometryStyle};
